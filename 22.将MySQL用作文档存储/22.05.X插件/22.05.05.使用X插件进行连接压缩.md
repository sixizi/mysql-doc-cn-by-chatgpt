### 22.5.5 使用X插件进行连接压缩

从MySQL 8.0.19版本开始，X插件支持对通过X协议连接发送的消息进行压缩。只有在服务器和客户端达成共同支持的压缩算法协议时，连接才可以进行压缩。启用压缩可以减少通过网络发送的字节数，但会为服务器和客户端的压缩和解压缩操作增加额外的CPU成本。因此，压缩的好处主要在网络带宽较低、网络传输时间主导压缩和解压缩操作成本的情况下，以及结果集较大时才会发挥作用。

> **注意**
>
> 不同的MySQL客户端以不同的方式实现对连接压缩的支持；请查阅您的客户端文档以获取详细信息。例如，对于经典的MySQL协议连接，请参阅第4.2.8节，“连接压缩控制”。

- [配置X插件的连接压缩](#配置X插件的连接压缩)
- [X插件的连接压缩特性](#X插件的连接压缩特性)
- [监控X插件的连接压缩](#监控X插件的连接压缩)

#### 配置X插件的连接压缩

默认情况下，X插件支持zstd、LZ4和Deflate压缩算法。使用Deflate算法进行压缩时，会使用zlib软件库，因此X协议连接的deflate_stream压缩算法设置等效于经典MySQL协议连接的zlib设置。

在服务器端，您可以通过设置mysqlx_compression_algorithms系统变量来禁止任何压缩算法，仅包括允许的那些。算法名称zstd_stream、lz4_message和deflate_stream可以以任何组合指定，顺序和大小写不重要。如果系统变量值为空字符串，则不允许任何压缩算法，连接将不进行压缩。

以下表格比较了不同压缩算法的特性，并显示了它们的优先级。默认情况下，服务器选择服务器和客户端共同允许的最高优先级算法；客户端可以按后面描述的方式更改优先级。客户在指定这些算法时可以使用算法的短格式别名。

**表格 20.1 X协议压缩算法特性**

| 算法           | 别名    | 压缩比率 | 吞吐量 | CPU成本 | 默认优先级 |
| -------------- | ------- | -------- | ------ | ------- | ---------- |
| zstd_stream    | zstd    | 高       | 高     | 中等    | 第一       |
| lz4_message    | lz4     | 低       | 高     | 最低    | 第二       |
| deflate_stream | deflate | 高       | 低     | 最高    | 第三       |

X协议允许的压缩算法集（无论是用户指定的还是默认的）与MySQL服务器为经典MySQL协议连接允许的压缩算法集是独立的，后者由protocol_compression_algorithms服务器系统变量指定。如果不指定mysqlx_compression_algorithms系统变量，X插件不会回退到使用经典MySQL协议连接的压缩设置。相反，其默认设置是允许表格20.1中显示的所有算法，“X协议压缩算法特性”。这与TLS上下文的情况不同，如果未设置X插件系统变量，则会使用MySQL服务器设置，如第20.5.3节“使用X插件进行加密连接”所述。有关经典MySQL协议连接的压缩信息，请参阅第4.2.8节“连接压缩控制”。

在客户端，X协议连接请求可以指定用于压缩控制的多个参数：

- 压缩模式。

- 压缩级别（从MySQL 8.0.20版本开始）。

- 按优先级顺序列出的允许压缩算法列表（从MySQL 8.0.22版本开始）。

  > **注意：**
  >
  > 某些客户端或连接器可能不支持某些压缩控制功能。例如，仅MySQL Shell支持为X协议连接指定压缩级别，而其他MySQL客户端或连接器不支持。有关支持的功能以及如何使用它们的详细信息，请参阅特定产品的文档。

连接模式有以下允许的值：

- disabled：连接未经过压缩。
- preferred：服务器和客户端协商以找到他们都允许的压缩算法。如果没有共同的算法可用，连接将不经过压缩。这是默认模式，如果没有明确指定，则使用此模式。

- required：与preferred模式一样进行压缩算法协商，但如果没有共同的算法可用，连接请求将以错误终止。

除了为每个连接达成压缩算法的协议，服务器和客户端还可以就适用于达成协议算法的数字范围达成一致的压缩级别。随着算法的压缩级别的提高，数据的压缩比率也会提高，从而减少了发送消息到客户端所需的网络带宽和传输时间。但是，数据压缩所需的工作量也会增加，占用服务器上的时间、CPU和内存资源。压缩工作量的增加与压缩比率的增加之间没有线性关系。

在MySQL 8.0.19中，X插件始终使用每个算法的库默认压缩级别（zstd为3，LZ4为0，Deflate为6），客户端无法协商此级别。从MySQL 8.0.20开始，客户端可以在与服务器进行X协议连接的能力协商过程中请求特定的压缩级别。

从MySQL 8.0.20版本开始，X插件使用了经过性能测试选择的默认压缩级别，这些级别在压缩时间和网络传输时间之间取得了良好的折衷。这些默认设置不一定与每个算法的库默认设置相同。如果客户端不为算法请求压缩级别，则默认压缩级别最初设置为zstd的3，LZ4的2和Deflate的3。您可以使用mysqlx_zstd_default_compression_level、mysqlx_lz4_default_compression_level和mysqlx_deflate_default_compression_level系统变量来调整这些设置。

为了防止服务器上的资源过度消耗，X插件为每个算法设置了服务器允许的最大压缩级别。如果客户端请求的压缩级别超过了此设置，服务器将使用其允许的最大压缩级别（只有MySQL Shell支持客户端的压缩级别请求）。最大压缩级别最初设置为zstd的11，LZ4的8和Deflate的5。您可以使用mysqlx_zstd_max_client_compression_level、mysqlx_lz4_max_client_compression_level和mysqlx_deflate_max_client_compression_level系统变量来调整这些设置。

如果服务器和客户端允许多个共同的算法，那么在协商过程中选择算法的默认优先级顺序如表格20.1，“X协议压缩算法特性”所示。从MySQL 8.0.22版本开始，对于支持指定压缩算法的客户端，连接请求可以包含由客户端允许的算法列表，使用算法名称或其别名指定。列表中这些算法的顺序被服务器视为优先级顺序。在这种情况下使用的算法是在客户端列表中第一个也被服务器允许的算法。但是，压缩算法选项受压缩模式的影响：

- 如果压缩模式为disabled，则忽略压缩算法选项。
- 如果压缩模式为preferred，但客户端允许的算法在服务器端不被允许，则连接不进行压缩。
- 如果压缩模式为required，但客户端允许的算法在服务器端不被允许，则会发生错误。

要监视消息压缩的效果，请使用“监控X插件连接压缩”中描述的X插件状态变量。您可以使用这些状态变量来计算使用当前设置的消息压缩的好处，并使用该信息来调整您的设置。

#### X插件的连接压缩特性

X协议连接的压缩操作具有以下行为和限制：

- 算法名称中的_stream和_message后缀指的是两种不同的操作模式：在流模式下，单个连接中的所有X协议消息被压缩成连续的流，并且必须以相同的方式进行解压缩——按照它们被压缩的顺序进行解压缩，不能跳过任何消息。在消息模式下，每个消息都会单独独立地进行压缩，而且不需要按照它们被压缩的顺序进行解压缩。此外，消息模式不要求所有压缩的消息都必须解压缩。

- 不会对在身份验证成功之前发送的任何消息应用压缩。

- 不会对控制流消息应用压缩，例如Mysqlx.Ok、Mysqlx.Error和Mysqlx.Sql.StmtExecuteOk消息。

- 如果服务器和客户端在能力协商期间就共同允许的压缩算法达成一致意见，那么所有其他X协议消息都可以进行压缩。如果客户端在该阶段没有请求压缩，则服务器和客户端都不会对消息应用压缩。

- 当通过X协议连接发送的消息被压缩时，仍然适用mysqlx_max_allowed_packet系统变量指定的限制。消息有效载荷解压缩后，网络数据包必须小于此限制。如果超过了限制，X插件会返回一个解压缩错误并关闭连接。

  以下是仅由MySQL Shell支持的客户端的压缩级别请求的相关点：

  - 客户端必须将压缩级别指定为整数。如果提供了其他类型的值，连接将以错误关闭。

  - 如果客户端指定了算法但未指定压缩级别，服务器将使用该算法的默认压缩级别。

  - 如果客户端请求的算法压缩级别超过了服务器允许的最大级别，则服务器将使用允许的最大级别。

  - 如果客户端请求的算法压缩级别低于服务器允许的最小级别，则服务器将使用允许的最小级别。


#### 监控X插件的连接压缩

您可以使用X插件的状态变量来监控消息压缩的效果。当使用消息压缩时，会话中的Mysqlx_compression_algorithm状态变量显示当前X协议连接使用的压缩算法，Mysqlx_compression_level显示所选的压缩级别。这些会话状态变量从MySQL 8.0.20开始可用。

从MySQL 8.0.19开始，X插件的状态变量可以用于计算所选压缩算法的效率（数据压缩比），以及使用消息压缩的整体效果。使用以下计算中的状态变量的会话值，可以查看消息压缩对具有已知压缩算法的特定会话的好处。或者使用状态变量的全局值来检查使用X协议连接的服务器的整体消息压缩效果，包括用于这些会话的所有压缩算法以及没有使用消息压缩的所有会话。然后，可以通过调整允许的压缩算法、最大压缩级别和默认压缩级别来调整消息压缩，如“配置X插件的连接压缩”中所述。

当使用消息压缩时，Mysqlx_bytes_sent状态变量显示从服务器发送的总字节数，包括压缩后测量的压缩消息有效载荷、压缩消息中未压缩的项目（例如X协议标头）以及任何未压缩的消息。Mysqlx_bytes_sent_compressed_payload状态变量显示以压缩消息有效载荷形式发送的总字节数，测量在压缩之后，而Mysqlx_bytes_sent_uncompressed_frame状态变量显示相同消息有效载荷的总字节数，但在压缩之前测量。因此，可以使用以下表达式来计算压缩算法的效率：

```
mysqlx_bytes_sent_uncompressed_frame / mysqlx_bytes_sent_compressed_payload
```

对于服务器从客户端接收的消息，Mysqlx_bytes_received_compressed_payload状态变量显示以压缩消息有效载荷形式接收的总字节数，测量在解压缩之前，而Mysqlx_bytes_received_uncompressed_frame状态变量显示相同消息有效载荷的总字节数，但在解压缩之后测量。Mysqlx_bytes_received状态变量包括压缩消息有效载荷在解压缩之前测量的字节数、压缩消息中未压缩的项目以及任何未压缩的消息。

对于服务器发送的X协议消息的压缩效果，可以使用以下表达式进行计算：

```
 (mysqlx_bytes_sent - mysqlx_bytes_sent_compressed_payload + mysqlx_bytes_sent_uncompressed_frame) / mysqlx_bytes_sent
```

这些状态变量和计算可以帮助您监测和评估消息压缩的效果以及压缩算法的性能。