## 17.3 InnoDB 多版本控制

InnoDB 是一个多版本存储引擎。它保留了有关已更改行的旧版本的信息，以支持并发和回滚等事务特性。这些信息存储在名为回滚段的数据结构中的撤销表空间中。请参见第 15.6.3.4 节，“撤销表空间”。InnoDB 使用回滚段中的信息来执行事务回滚所需的撤销操作。它还使用这些信息构建行的早期版本以进行一致的读取。请参见第 15.7.2.3 节，“一致的非锁定读取”。

在内部，InnoDB 在数据库中存储的每一行中添加了三个字段：

- 一个 6 字节的 DB_TRX_ID 字段，表示最后插入或更新该行的事务标识符。此外，删除在内部被视为更新，其中一行中的一个特殊位被设置为标记其为已删除。

- 一个 7 字节的 DB_ROLL_PTR 字段，称为回滚指针。回滚指针指向写入回滚段的撤销日志记录。如果行被更新，则撤销日志记录包含重建更新前行内容所需的信息。

- 一个 6 字节的 DB_ROW_ID 字段包含一个递增的行 ID，随着新行的插入而递增。如果 InnoDB 自动生成聚集索引，则索引包含行 ID 值。否则，DB_ROW_ID 列不会出现在任何索引中。

回滚段中的撤销日志分为插入和更新撤销日志。插入撤销日志仅在事务回滚中需要，并且一旦事务提交即可丢弃。更新撤销日志也用于一致读取，但只有在没有事务存在 InnoDB 为其分配了可能需要更新撤销日志中的信息来构建数据库行的早期版本的快照时，才能丢弃它们。有关撤销日志的更多信息，请参见第 15.6.6 节，“撤销日志”。

建议您定期提交事务，包括仅发出一致读取的事务。否则，InnoDB 无法从更新撤销日志中丢弃数据，回滚段可能会变得过大，填满其所在的撤销表空间。有关管理撤销表空间的信息，请参见第 15.6.3.4 节，“撤销表空间”。

回滚段中撤销日志记录的物理大小通常小于相应插入或更新的行。您可以使用此信息来计算回滚段所需的空间。

在 InnoDB 的多版本控制方案中，当您使用 SQL 语句删除行时，该行并不会立即从数据库中物理移除。InnoDB 只有在丢弃为删除所写的更新撤销日志记录时，才会物理移除相应的行及其索引记录。这种移除操作称为清除（*purge*），通常非常快，通常与执行删除的 SQL 语句所需的时间相同。

如果您以相对较小的批次以大致相同的速率在表中插入和删除行，则清除线程可能开始落后，由于所有的“死”行，表可能会变得越来越大，使一切都受限于磁盘并非常缓慢。在这种情况下，减缓新行操作，并通过调整 innodb_max_purge_lag 系统变量为清除线程分配更多资源。有关更多信息，请参见第 15.8.9 节，“清除配置”。

**多版本控制和二级索引**

InnoDB 多版本并发控制 (MVCC) 对二级索引的处理方式与聚集索引不同。聚集索引中的记录是就地更新的，它们的隐藏系统列指向撤销日志条目，从中可以重建记录的早期版本。与聚集索引记录不同，二级索引记录不包含隐藏的系统列，也不是就地更新的。

当更新二级索引列时，旧的二级索引记录被标记为删除，同时插入新记录，并且最终清除标记为删除的记录。当二级索引记录被标记为删除或二级索引页面被更新事务更新时，InnoDB 会在聚集索引中查找数据库记录。在聚集索引中，会检查记录的 DB_TRX_ID，并且如果记录在读取事务启动后被修改，则从撤销日志中检索正确版本的记录。

如果二级索引记录被标记为删除或二级索引页面被更新事务更新，则不使用覆盖索引技术。InnoDB 不是从索引结构返回值，而是在聚集索引中查找记录。

然而，如果启用了索引条件下推 (ICP) 优化，并且 WHERE 条件的部分可以仅使用索引中的字段来评估，则 MySQL 服务器仍然将这部分 WHERE 条件下推到存储引擎，在那里使用索引进行评估。如果没有找到匹配的记录，则避免了聚集索引查找。如果找到了匹配的记录，即使是被标记为删除的记录，InnoDB 也会在聚集索引中查找记录。