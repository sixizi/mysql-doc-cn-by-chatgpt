#### 17.9.1.2 创建压缩表

压缩表可以在文件每表表空间或通用表空间中创建。InnoDB 系统表空间不支持表压缩。系统表空间（空间 0，.ibdata 文件）可以包含用户创建的表，但它还包含内部系统数据，这些数据永远不会被压缩。因此，压缩仅适用于存储在文件每表或通用表空间中的表（和索引）。

##### 在文件每表表空间中创建压缩表

要在文件每表表空间中创建压缩表，必须启用 `innodb_file_per_table`（默认启用）。您可以在 MySQL 配置文件（my.cnf 或 my.ini）中设置此参数，或使用 SET 语句动态设置。

配置了 `innodb_file_per_table` 选项后，指定 `CREATE TABLE` 或 `ALTER TABLE` 语句中的 `ROW_FORMAT=COMPRESSED` 子句或 `KEY_BLOCK_SIZE` 子句，或两者，以在文件每表表空间中创建压缩表。

例如，您可能使用以下语句：

```sql
SET GLOBAL innodb_file_per_table=1;
CREATE TABLE t1
 (c1 INT PRIMARY KEY)
 ROW_FORMAT=COMPRESSED
 KEY_BLOCK_SIZE=8;
```

##### 在通用表空间中创建压缩表

要在通用表空间中创建压缩表，必须为通用表空间定义 `FILE_BLOCK_SIZE`，在创建表空间时指定。`FILE_BLOCK_SIZE` 值必须是相对于 `innodb_page_size` 值的有效压缩页面大小，并且压缩表的页面大小，由 `CREATE TABLE` 或 `ALTER TABLE` 的 `KEY_BLOCK_SIZE` 子句定义，必须等于 `FILE_BLOCK_SIZE/1024`。例如，如果 `innodb_page_size=16384` 并且 `FILE_BLOCK_SIZE=8192`，则表的 `KEY_BLOCK_SIZE` 必须为 8。更多信息，请参见第 17.6.3.3 节，“通用表空间”。

以下示例演示了创建通用表空间并添加压缩表。示例假定默认的 `innodb_page_size` 为 16K。`FILE_BLOCK_SIZE` 为 8192 要求压缩表的 `KEY_BLOCK_SIZE` 为 8。

```sql
mysql> CREATE TABLESPACE `ts2` ADD DATAFILE 'ts2.ibd' FILE_BLOCK_SIZE = 8192 Engine=InnoDB;

mysql> CREATE TABLE t4 (c1 INT PRIMARY KEY) TABLESPACE ts2 ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8;
```

##### 注意

- 从 MySQL 8.0 开始，压缩表的表空间文件使用物理页面大小而不是 InnoDB 页面大小创建，这使得空压缩表的表空间文件的初始大小比以前的 MySQL 版本更小。
- 如果指定 `ROW_FORMAT=COMPRESSED`，可以省略 `KEY_BLOCK_SIZE`；`KEY_BLOCK_SIZE` 设置默认为 `innodb_page_size` 值的一半。
- 如果指定了有效的 `KEY_BLOCK_SIZE` 值，则可以省略 `ROW_FORMAT=COMPRESSED`；自动启用压缩。
- 要确定 `KEY_BLOCK_SIZE` 的最佳值，通常您会使用不同值为此子句创建相同表的几个副本，然后测量生成的 .ibd 文件的大小，并查看每个文件在现实工作负载下的表现如何。对于通用表空间，请记住，删除表不会减少通用表空间 .ibd 文件的大小，也不会将磁盘空间返回给操作系统。更多信息，请参见第 17.6.3.3 节，“通用表空间”。

压缩表的限制

- 压缩表不能存储在 InnoDB 系统表空间中。
- 通用表空间可以包含多个表，但压

缩和非压缩表不能在同一个通用表空间内共存。
- 压缩适用于整个表及其所有相关索引，而不是单个行，尽管子句名称为 `ROW_FORMAT`。
- InnoDB 不支持压缩临时表。当启用 `innodb_strict_mode`（默认）时，如果指定了 `ROW_FORMAT=COMPRESSED` 或 `KEY_BLOCK_SIZE`，`CREATE TEMPORARY TABLE` 会返回错误。如果禁用 `innodb_strict_mode`，则会发出警告，并使用非压缩行格式创建临时表。对临时表的 `ALTER TABLE` 操作也适用相同的限制。

```