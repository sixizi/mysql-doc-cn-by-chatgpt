#### 17.9.1.4 在运行时监控InnoDB表压缩

整体应用性能、CPU与I/O利用率以及磁盘文件的大小是衡量压缩对您的应用有效性的好指标。本节基于第17.9.1.3节“为InnoDB表调优压缩”的性能调优建议，并展示如何找到在初步测试中可能未出现的问题。

为了更深入地探讨压缩表的性能考虑因素，您可以使用第17.1例“使用压缩信息模式表”中描述的信息模式表，在运行时监控压缩性能。这些表反映了内存的内部使用情况和整体使用的压缩率。

INNODB_CMP表报告每个使用中的压缩页面大小（KEY_BLOCK_SIZE）的压缩活动信息。这些表中的信息是系统范围的：它汇总了数据库中所有压缩表的压缩统计信息。通过在没有其他压缩表被访问时检查这些表，您可以使用这些数据来帮助决定是否压缩一个表。它在服务器上涉及的开销相对较低，所以您可能会定期在生产服务器上查询它，以检查压缩功能的整体效率。

INNODB_CMP_PER_INDEX表报告单个表和索引的压缩活动信息。这些信息更加针对性，对于评估压缩效率和一次诊断一个表或索引的性能问题更有用。（因为每个InnoDB表都表示为一个聚集索引，MySQL在这个上下文中不会在表和索引之间做出大的区分。）INNODB_CMP_PER_INDEX表确实涉及到相当大的开销，因此它更适合开发服务器，您可以在其中比较不同的工作负载、数据和压缩设置的效果。为了防止意外施加这种监控开销，您必须在能查询INNODB_CMP_PER_INDEX表之前启用innodb_cmp_per_index_enabled配置选项。

要考虑的关键统计数据是执行压缩和解压缩操作的数量及所花费的时间。由于MySQL在修改后的压缩数据太满而无法容纳在B-tree节点中时会拆分B-tree节点，比较“成功”的压缩操作数量与总体操作数量。根据INNODB_CMP和INNODB_CMP_PER_INDEX表中的信息以及整体应用性能和硬件资源利用情况，您可能会更改硬件配置、调整缓冲池大小、选择不同的页面大小或选择一组不同的表进行压缩。

如果压缩和解压缩所需的CPU时间很高，更换为更快或多核CPU可以帮助在相同的数据、应用工作负载和压缩表集合下提高性能。增加缓冲池的大小也可能有助于性能，这样更多的未压缩页面可以留在内存中，减少了需要解压缩只以压缩形式存在于内存中的页面的需求。

总体上压缩操作的数量（与您的应用中的INSERT、UPDATE和DELETE操作的数量以及数据库的大小相比）可能表明您的一些压缩表更新过于频繁，无法有效压缩。如果是这样，选择更大的页面大小，或更加挑剔地选择您要压缩的表。

如果“成功”压缩操作的数量（COMPRESS_OPS_OK）占总压缩操作数量（COMPRESS_OPS）的比例很高，则系统可能运行良好。如果这个比例较低，则MySQL更频繁地重新组织、重新压缩和拆分B-tree节点，这是不可取的。在这种情况下，避免压缩某些表，或为某些压缩表增加KEY_BLOCK_SIZE。您可能会关闭那些导致您的应用中“压缩失败”的数量超过总数的1%或2%的表的压缩。（在临时操作，如数据加载期间，这种失败比率可能是可以接受的）。
