#### 17.9.1.3 为InnoDB表调优压缩

InnoDB 数据存储和压缩的内部优化通常确保系统能够很好地运行压缩数据。然而，由于压缩效率依赖于数据的性质，你可以做出影响压缩表性能的决策：

- 哪些表进行压缩。
- 使用什么压缩页面大小。
- 根据运行时性能特征（如系统花费在数据压缩和解压缩上的时间量）来调整缓冲池的大小。工作负载更像是数据仓库（主要是查询）还是 OLTP 系统（查询和 DML 的混合）。
- 如果系统在压缩表上执行 DML 操作，并且数据分布方式导致运行时昂贵的压缩失败，你可能需要调整其他高级配置选项。

使用本节中的指南来帮助做出这些架构和配置选择。当你准备进行长期测试并将压缩表投入生产时，请参见第 17.9.1.4 节，“在运行时监控 InnoDB 表压缩”，以验证这些选择在实际条件下的有效性。

##### 何时使用压缩

通常，对于包含相当数量的字符字符串列的表，以及数据被读取的次数远多于写入的情况，压缩效果最佳。因为没有确切的方法预测压缩是否有益于特定情况，总是需要针对特定工作负载和数据集在代表性配置上进行测试。决定哪些表进行压缩时，考虑以下因素。

##### 数据特性和压缩

压缩效率的一个关键决定因素是数据本身的性质。记住，压缩的工作原理是识别数据块中重复的字节串。完全随机化的数据是最坏的情况。典型的数据通常有重复值，因此可以有效压缩。字符字符串通常压缩得很好，无论是在 CHAR、VARCHAR、TEXT 或 BLOB 列中定义。另一方面，主要包含二进制数据（整数或浮点数）或已经压缩的数据（例如 JPEG 或 PNG 图像）的表可能通常不会压缩得很好，甚至根本不会压缩。

你可以选择是否为每个 InnoDB 表启用压缩。表及其所有索引使用相同的（压缩的）页面大小。可能主键（聚簇）索引，它包含表的所有列数据，比次级索引压缩得更有效。在有长行的情况下，使用压缩可能导致长列值被存储在“页面外”，如 DYNAMIC 行格式中所讨论的。这些溢出页面可能压缩得很好。鉴于这些考虑，对于许多应用程序，一些表比其他表压缩得更有效，你可能会发现只有一部分表进行压缩时，你的工作负载表现最佳。

为了确定是否压缩特定表，请进行实验。你可以通过使用实现 LZ77 压缩的实用程序（如 gzip 或 WinZip）对未压缩表的 .ibd 文件副本进行压缩，来大致估计数据可以被压缩的效率。由于 MySQL 是基于页面大小（默认为 16KB）压缩数据块，因此你可以期望从 MySQL 压缩表获得的压缩量少于基于文件的压缩工具。除用户数据外，页面格式还包

括一些内部系统数据，这部分数据不会被压缩。基于文件的压缩工具可以检查更大的数据块，因此可能在巨大文件中找到比 MySQL 在单个页面中能找到的更多重复字符串。

另一种测试特定表压缩的方法是将一些数据从你的未压缩表复制到一个相似的压缩表（具有所有相同的索引）在每个表的表空间中，并查看结果的 .ibd 文件的大小。例如：

```sql
USE test;
SET GLOBAL innodb_file_per_table=1;
SET GLOBAL autocommit=0;

-- 创建一个包含百万或两百万行的未压缩表。
CREATE TABLE big_table AS SELECT * FROM information_schema.columns;
INSERT INTO big_table SELECT * FROM big_table; -- 重复多次
COMMIT;
ALTER TABLE big_table ADD id int unsigned NOT NULL PRIMARY KEY auto_increment;

SHOW CREATE TABLE big_table\G

select count(id) from big_table;

-- 检查未压缩表所需的空间。
\! ls -l data/test/big_table.ibd

CREATE TABLE key_block_size_4 LIKE big_table;
ALTER TABLE key_block_size_4 key_block_size=4 row_format=compressed;

INSERT INTO key_block_size_4 SELECT * FROM big_table;
commit;

-- 检查具有特定压缩设置的压缩表所需的空间。
\! ls -l data/test/key_block_size_4.ibd
```

此实验产生了以下数字，这些数字当然可能因你的表结构和数据而有很大差异：

```plaintext
-rw-rw----  1 cirrus  staff  310378496 Jan  9 13:44 data/test/big_table.ibd
-rw-rw----  1 cirrus  staff  83886080 Jan  9 15:10 data/test/key_block_size_4.ibd
```

要看压缩是否对你的特定工作负载有效：

- 对于简单测试，使用没有其他压缩表的 MySQL 实例，并运行针对信息模式 INNODB_CMP 表的查询。
- 对于涉及多个压缩表的工作负载的更复杂测试，运行针对信息模式 INNODB_CMP_PER_INDEX 表的查询。因为收集 INNODB_CMP_PER_INDEX 表中的统计信息成本很高，你必须在查询该表之前启用配置选项 innodb_cmp_per_index_enabled，并且你可能将此类测试限制在开发服务器或非关键副本服务器上。

运行一些典型的 SQL 语句针对你正在测试的压缩表。

通过查询 INFORMATION_SCHEMA.INNODB_CMP 或 INFORMATION_SCHEMA.INNODB_CMP_PER_INDEX，检查成功压缩操作与总压缩操作的比率，并比较 COMPRESS_OPS 与 COMPRESS_OPS_OK。

如果大比例的压缩操作成功完成，表可能是压缩的好候选。

如果你获得了高比例的压缩失败，你可以调整 innodb_compression_level、innodb_compression_failure_threshold_pct 和 innodb_compression_pad_pct_max 选项，如第 17.9.1.6 节所述，“OLTP 工作负载的压缩”，并进行进一步测试。

##### 数据库压缩与应用程序压缩

决定是在应用程序中压缩数据还是在表中；不要对同一数据使用这两种压缩类型。当你在应用程序中压缩数据并将结果存储在压缩表中时，额外的空间节省极不可能，双重压缩只是浪费 CPU 周期。

##### 在数据库中压缩

当启用时，MySQL 表压缩是自动的，并适用于所有列和索引值。列仍然可以使用诸如 LIKE 之类的运算符进行测试，即使索引值被压缩时，排序操作仍然可以使用索引。因为索引通常是

数据库总大小的一个重要部分，压缩可能在存储、I/O 或处理器时间上节省显著的空间。压缩和解压缩操作发生在数据库服务器上，这很可能是一个强大的系统，配置足以处理预期负载。

##### 在应用程序中压缩

如果你在插入数据库之前在应用程序中压缩诸如文本的数据，你可能通过压缩某些列而不是其他列来节省不压缩良好的数据的开销。这种方法使用客户机而不是数据库服务器的 CPU 周期进行压缩和解压缩，这可能适用于有许多客户端的分布式应用程序，或者客户机有空闲的 CPU 周期。

##### 混合方法

当然，可以结合这些方法。对于某些应用程序，使用一些压缩表和一些未压缩表可能是合适的。最好对一些数据进行外部压缩（并将其存储在未压缩的表中）并允许 MySQL 压缩应用程序中的（一些）其他表。如同往常一样，前期设计和实际测试对于做出正确的决策非常有价值。

##### 工作负载特性和压缩

除了选择哪些表进行压缩（和页面大小）外，工作负载是性能的另一个关键决定因素。如果应用程序主要是读取而不是更新，那么需要重新组织和重新压缩的页面较少，因为索引页面用完每页的“修改日志”空间后，就不需要重新组织和重新压缩。如果更新主要改变非索引列或那些包含 BLOBs 或大字符串并且恰好存储在“页面外”的列，压缩的开销可能是可以接受的。如果对表的唯一更改是使用单调递增的主键进行 INSERT，并且几乎没有次级索引，则几乎不需要重新组织和重新压缩索引页面。由于 MySQL 可以通过修改未压缩的数据“就地”对压缩页面上的行进行“删除标记”和删除，因此 DELETE 操作在表上相对高效。

对于某些环境，加载数据所需的时间与运行时检索一样重要。尤其是在数据仓库环境中，许多表可能是只读或主要是读取。在这些情况下，除非由于减少磁盘读取或存储成本的节省显著，否则可能接受或不接受压缩的价格，即增加加载时间。

从根本上说，当 CPU 时间可用于压缩和解压缩数据时，压缩效果最好。因此，如果你的工作负载是 I/O 绑定的，而不是 CPU 绑定的，你可能会发现压缩可以改善整体性能。当你用不同的压缩配置测试应用程序性能时，要在与生产系统计划配置类似的平台上测试。

##### 配置特性和压缩

从磁盘读取和写入数据库页面是系统性能最慢的方面。压缩试图通过使用 CPU 时间来压缩和解压缩数据来减少 I/O，当 I/O 相对于处理器周期来说是相对稀缺资源时，最有效。

这通常尤其在运行在具有快速多核 CPU 的多用户环境中的情况下。当压缩表的页面在内存中时，MySQL 通常在缓冲池中使用额外的内存，通常是 16KB，用于页面的未压缩副本。自适应 LRU 算法尝试平衡内存的使用，介于压缩页面和未压缩页面之间，以考虑工作负载是以 I/O 绑定方式还是 CPU 绑定方式运行。不过，将更多内存分配给缓冲池的配置在使用压缩表时表现更好，而不是内存高度受限的配置。

##### 选择压缩页面大小

压缩页面大小的最佳设置取决于表及其索引包含的数据类型和分布。压缩页面大小应始终大于最大记录大小，否则操作可能失败，如 B-树页面的压缩中所述。

设置压缩页面大小过大会浪费一些空间，但页面不需要经常压缩。如果设置的压缩页面大小太小，插入或更新可能需要耗时的重新压缩，而且 B-树节点可能需要更频繁地分裂，导致数据文件更大，索引效率降低。

通常，你会将压缩页面大小设置为 8K 或 4K 字节。鉴于 InnoDB 表的最大行大小约为 8K，`KEY_BLOCK_SIZE=8` 通常是一个安全的选择。