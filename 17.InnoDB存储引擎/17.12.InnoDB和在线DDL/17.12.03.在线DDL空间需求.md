### 17.12.3 在线 DDL 的空间需求

在线 DDL 操作的磁盘空间需求如下所述。这些要求不适用于即时执行的操作。

- 临时日志文件：

  当在线 DDL 操作创建索引或修改表时，一个临时日志文件记录并发的 DML。临时日志文件根据 `innodb_sort_buffer_size` 的值按需扩展，直到达到 `innodb_online_alter_log_max_size` 指定的最大值。如果操作耗时很长，并且并发的 DML 修改了表，以至于临时日志文件的大小超过了 `innodb_online_alter_log_max_size` 的值，在线 DDL 操作将因 DB_ONLINE_LOG_TOO_BIG 错误失败，并回滚未提交的并发 DML 操作。较大的 `innodb_online_alter_log_max_size` 设置允许在线 DDL 操作期间进行更多的 DML，但它也延长了 DDL 操作结束时锁定表以应用记录的 DML 的时间。

  `innodb_sort_buffer_size` 变量还定义了临时日志文件读缓冲区和写缓冲区的大小。

- 临时排序文件：

  重建表的在线 DDL 操作在创建索引期间将临时排序文件写入 MySQL 临时目录（Unix 上的 $TMPDIR，Windows 上的 %TEMP%，或由 --tmpdir 指定的目录）。临时排序文件不在包含原始表的目录中创建。每个临时排序文件足够大，可以容纳一列数据，每个排序文件在其数据被合并到最终表或索引中时被移除。涉及临时排序文件的操作可能需要等于表加索引中数据量的临时空间。如果在线 DDL 操作使用了数据目录所在文件系统的所有可用磁盘空间，将报告错误。

  如果 MySQL 临时目录不足以容纳排序文件，请将 tmpdir 设置为不同的目录。或者，使用 `innodb_tmpdir` 为在线 DDL 操作定义一个单独的临时目录。引入此选项是为了帮助避免由于大型临时排序文件导致的临时目录溢出。

- 中间表文件：

  一些重建表的在线 DDL 操作在与原始表相同的目录中创建一个临时的中间表文件。一个中间表文件可能需要等于原始表大小的空间。中间表文件名以 #sql-ib 前缀开头，在在线 DDL 操作期间只会短暂出现。

  `innodb_tmpdir` 选项不适用于中间表文件。