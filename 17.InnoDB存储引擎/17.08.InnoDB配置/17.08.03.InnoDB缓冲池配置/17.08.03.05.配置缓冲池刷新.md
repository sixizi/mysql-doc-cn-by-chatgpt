#### 17.8.3.5 配置缓冲池刷新

InnoDB在后台执行某些任务，包括从缓冲池中刷新脏页。脏页是指已经被修改但尚未写入磁盘数据文件的页面。

在MySQL 8.0中，缓冲池刷新由页面清理线程执行。页面清理线程的数量由 `innodb_page_cleaners` 变量控制，其默认值为4。然而，如果页面清理线程的数量超过缓冲池实例的数量，`innodb_page_cleaners` 会自动设置为与 `innodb_buffer_pool_instances` 相同的值。

当脏页的百分比达到由 `innodb_max_dirty_pages_pct_lwm` 变量定义的低水位标记值时，会启动缓冲池刷新。默认的低水位标记是缓冲池页面的10%。`innodb_max_dirty_pages_pct_lwm` 值为0时，禁用这种早期刷新行为。

`innodb_max_dirty_pages_pct_lwm` 阈值的目的是控制缓冲池中脏页的百分比，并防止脏页的数量达到 `innodb_max_dirty_pages_pct` 变量定义的阈值，其默认值为90。如果缓冲池中脏页的百分比达到 `innodb_max_dirty_pages_pct` 阈值，InnoDB将积极刷新缓冲池页面。

配置 `innodb_max_dirty_pages_pct_lwm` 时，其值应始终低于 `innodb_max_dirty_pages_pct` 值。

其他变量允许对缓冲池刷新行为进行微调：

- `innodb_flush_neighbors` 变量定义从缓冲池刷新页面时是否也刷新同一区(extent)中的其他脏页。
- 默认设置为0，禁用 `innodb_flush_neighbors`。同一区中的脏页不会被刷新。对于非旋转存储（SSD）设备，此设置是推荐的，因为寻道时间不是重要因素。
- 设置为1时，会刷新同一区中连续的脏页。
- 设置为2时，会刷新同一区中的脏页。
- 当表数据存储在传统的HDD存储设备上时，一次性刷新相邻页减少了I/O开销（主要是磁盘寻道操作）与分别刷新单独页相比。对于存储在SSD上的表数据，寻道时间不是重要因素，您可以禁用此设置以分散写操作。

- `innodb_lru_scan_depth` 变量指定每个缓冲池实例的LRU列表中页面清理线程查找要刷新的脏页的深度。这是页面清理线程每秒执行一次的后台操作。
- 小于默认值的设置通常适合大多数工作负载。远高于必要的值可能会影响性能。只有在典型工作负载下有额外的I/O容量时，才考虑增加该值。相反，如果写入密集型工作负载使您的I/O容量饱和，降低该值，尤其是在大缓冲池的情况下。
- 在调整 `innodb_lru_scan_depth` 时，从较低的值开始，逐步增加设置，目标是很少看到零空闲页。同时，在更改缓冲池实例数量时也要考虑调整 `innodb_lru_scan_depth`，因为 `innodb_lru_scan_depth * innodb_buffer_pool_instances` 定义了页面清理线程每秒执行的工作量。

`innodb_flush_neighbors` 和 `innodb_lru_scan_depth` 变

量主要针对写入密集型工作负载。在重DML活动中，如果刷新不够积极，可能会落后，或者如果刷新过于积极，磁盘写入可能会使I/O容量饱和。理想的设置取决于您的工作负载、数据访问模式和存储配置（例如，数据是存储在HDD还是SSD设备上）。

#### 自适应刷新

InnoDB使用自适应刷新算法来动态调整刷新速率，基于重做日志的生成速度和当前的刷新速率。目的是通过确保刷新活动跟上当前工作负载的步伐来平滑整体性能。自动调整刷新率有助于避免由于缓冲池刷新导致的I/O活动突增而发生的吞吐量突然下降。

例如，由于生成大量重做条目的写入密集型工作负载通常与锐利检查点相关联，可能导致吞吐量的突然变化。当InnoDB希望重用日志文件的一部分时，会发生锐利检查点。在此之前，必须刷新日志文件中该部分的所有脏页。如果日志文件已满，会发生锐利检查点，导致吞吐量暂时下降。即使未达到 `innodb_max_dirty_pages_pct` 阈值，也可能发生这种情况。

自适应刷新算法通过跟踪缓冲池中的脏页数量和生成重做日志记录的速率来避免此类情况。根据这些信息，它决定每秒从缓冲池中刷新多少脏页，从而可以管理突发的工作负载变化。

`innodb_adaptive_flushing_lwm` 变量定义了重做日志容量的低水位标记。当达到该阈值时，即使 `innodb_adaptive_flushing` 变量被禁用，也会启用自适应刷新。

内部基准测试表明，该算法不仅能够保持一段时间的吞吐量，而且还可以显著提高整体吞吐量。然而，自适应刷新可能会显著影响工作负载的I/O模式，在所有情况下可能都不适用。只有在重做日志即将填满时，它才能带来最大的好处。如果自适应刷新不适合您工作负载的特点，您可以禁用它。自适应刷新由 `innodb_adaptive_flushing` 变量控制，该变量默认启用。

`innodb_flushing_avg_loops` 定义了InnoDB保留先前计算的刷新状态快照的迭代次数，控制自适应刷新对前台工作负载变化的响应速度。较高的 `innodb_flushing_avg_loops` 值意味着InnoDB保留先前计算的快照时间更长，因此自适应刷新响应更慢。设置较高值时，重要的是确保重做日志利用率不会达到75%（异步刷新开始的硬编码限制），并且 `innodb_max_dirty_pages_pct` 阈值保持脏页数量在适合工作负载的水平。

在稳定工作负载、大的日志文件大小（`innodb_log_file_size`）和不会达到75%日志空间利用率的小峰值的系统中，应使用高 `innodb_flushing_avg_loops` 值以保持刷新