#### 17.6.1.4 移动或复制InnoDB表

本节描述了将部分或全部InnoDB表移动或复制到不同服务器或实例的技术。例如，您可能需要将整个MySQL实例移动到一个更大、更快的服务器；或者将整个MySQL实例克隆到新的复制服务器；也可能需要将单个表复制到另一个实例以开发和测试应用程序，或者复制到数据仓库服务器以产生报告。

在Windows上，InnoDB总是在内部将数据库和表名存储为小写。要以二进制格式从Unix移动数据库到Windows，或者从Windows到Unix，请使用小写名称创建所有数据库和表。一种方便的方法是在创建任何数据库或表之前，在my.cnf或my.ini文件的[mysqld]部分添加以下行：

```plaintext
[mysqld]
lower_case_table_names=1
```

> **注意**
>
> 禁止在服务器初始化时使用与初始化时不同的lower_case_table_names设置启动服务器。

移动或复制InnoDB表的技术包括：

- [导入表](#导入表)
- [MySQL企业备份](#MySQL企业备份)
- [复制数据文件（冷备份方法）](#复制数据文件（冷备份方法）)
- [从逻辑备份恢复](#从逻辑备份恢复)

##### 导入表

存储在文件每表表空间中的表可以使用可移植表空间特性，从另一个MySQL服务器实例或备份中导入。参见15.6.1.3节，“导入InnoDB表”。

##### MySQL企业备份

MySQL企业备份产品可以在对运行中的MySQL数据库的操作干扰最小的情况下进行备份，同时产生数据库的一致快照。当MySQL企业备份正在复制表时，可以继续进行读写操作。此外，MySQL企业备份可以创建压缩的备份文件，并且支持备份表的子集。结合MySQL二进制日志，您可以执行时间点恢复。MySQL企业备份是MySQL企业订阅的一部分。

有关MySQL企业备份的更多详情，请参见30.2节，“MySQL企业备份概览”。

##### 复制数据文件（冷备份方法）

您可以通过复制15.18.1节“InnoDB备份”下列出的所有相关文件，简单地移动一个InnoDB数据库。

InnoDB数据和日志文件在所有具有相同浮点数格式的平台上都是二进制兼容的。如果浮点格式不同，但您在表中没有使用FLOAT或DOUBLE数据类型，那么过程是相同的：简单地复制相关文件。

当您移动或复制文件每表.ibd文件时，源系统和目标系统上的数据库目录名称必须相同。存储在InnoDB共享表空间中的表定义包括数据库名称。存储在表空间文件中的事务ID和日志序列号也会在数据库之间不同。

要将.ibd文件及其关联表从一个数据库移动到另一个数据库，请使用RENAME TABLE语句：

```plaintext
RENAME TABLE db1.tbl_name TO db2.tbl_name;
```

如果您有一个.ibd文件的“干净”备份，可以按照以下方式将其还原到它起源的MySQL安装中：

- 由于复制.ibd文件后，表不能被删除或截断，因为这样会改变存储在表空间内的表ID。
- 使用此ALTER TABLE语句来删除当前的.ibd文件：

```plaintext
ALTER TABLE tbl_name DISCARD TABLESPACE;
```

- 将备份的.ibd文件复制到适当的数据库目录。
- 使用此ALTER TABLE语句告诉InnoDB使用新的.ibd文件作为表：

```plaintext
ALTER TABLE tbl_name IMPORT TABLESPACE;
```

> **注意**
>
> ALTER TABLE ... IMPORT TABLESPACE功能不会对导入数据执行外键约束。

在这个上下文中，“干净”的.ibd文件备份需要满足以下要求：

- .ibd文件中没有未提交的事务修改。
- .ibd文件中没有未合并的插入缓冲条目。
- 清除程序已从.ibd文件中删除所有标记为删除的索引记录。
- mysqld已将.ibd文件的所有修改页面从缓冲池刷新到文件。

您可以使用以下方法制作干净的备份.ibd文件：

- 停止mysqld服务器的所有活动，并提交所有事务。
- 等到SHOW ENGINE INNODB STATUS显示数据库中没有活动事务，并且InnoDB的主线程状态为等待服务器活动。然后，您可以复制.ibd文件。

使用MySQL企业备份产品制作.ibd文件干净副本的另一种方法是：

- 使用MySQL企业备份来备份InnoDB安装。
- 在备份上启动第二个mysqld服务器，并让它清理备份中的.ibd文件。

##### 从逻辑备份恢复

您可以使用mysqldump之类的工具进行逻辑备份，这将产生一组SQL语句，可以执行这些语句来复制原始数据库对象定义和表数据，以便传输到另一个SQL服务器。使用这种方法，无论格式是否不同或者您的表是否包含浮点数据都无所谓。

为了提高此方法的性能，导入数据时请禁用自动提交。仅在导入整个表或表的一部分后执行提交。
