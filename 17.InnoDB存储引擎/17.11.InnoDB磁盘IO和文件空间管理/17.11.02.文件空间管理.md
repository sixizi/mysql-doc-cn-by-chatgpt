### 17.11.2 文件空间管理

您在配置文件中使用 `innodb_data_file_path` 配置选项定义的数据文件形成了 InnoDB 系统表空间。这些文件在逻辑上被串联起来形成系统表空间。没有使用条带化。您不能定义表在系统表空间内的分配位置。在新创建的系统表空间中，InnoDB 从第一个数据文件开始分配空间。

为了避免将所有表和索引存储在系统表空间内带来的问题，您可以启用 `innodb_file_per_table` 配置选项（默认值），该选项将每个新创建的表存储在一个单独的表空间文件（扩展名为 `.ibd`）中。以这种方式存储的表，在磁盘文件内的碎片化更少，当表被截断时，空间会返回给操作系统，而不是仍然由 InnoDB 在系统表空间内保留。有关更多信息，请参见第 17.6.3.2 节，“文件每表表空间”。

您也可以将表存储在通用表空间中。通用表空间是使用 `CREATE TABLESPACE` 语法创建的共享表空间。它们可以在 MySQL 数据目录之外创建，能够容纳多个表，并支持所有行格式的表。有关更多信息，请参见第 17.6.3.3 节，“通用表空间”。

#### 页面、扩展、段和表空间

每个表空间由数据库页面组成。MySQL 实例中的每个表空间都有相同的页面大小。默认情况下，所有表空间的页面大小为 16KB；通过指定创建 MySQL 实例时的 `innodb_page_size` 选项，您可以将页面大小减小到 8KB 或 4KB。您也可以将页面大小增加到 32KB 或 64KB。有关更多信息，请参考 `innodb_page_size` 文档。

页面被分组成扩展（*Extents*），对于最多 16KB 大小的页面，扩展的大小为 1MB（64个连续的 16KB 页面，或 128个 8KB 页面，或 256个 4KB 页面）。对于 32KB 的页面大小，扩展大小为 2MB。对于 64KB 的页面大小，扩展大小为 4MB。在 InnoDB 中，表空间内的“文件”被称为段（*Segments*）。（这些段与实际包含许多表空间段的回滚段不同。）

当一个段在表空间内增长时，InnoDB 一次分配前 32 页给它。之后，InnoDB 开始为段分配整个扩展。InnoDB 可以一次为大段添加多达 4 个扩展，以确保数据的良好顺序性。

InnoDB 为每个索引分配两个段。一个用于 B-树的非叶节点，另一个用于叶节点。保持叶节点在磁盘上连续，可以实现更好的顺序 I/O 操作，因为这些叶节点包含实际的表数据。

表空间中的一些页面包含其他页面的位图，因此在 InnoDB 表空间中的一些扩展不能作为整体分配给段，而只能作为单个页面分配。

当您通过发出 `SHOW TABLE STATUS` 语句询问表空间中可用的空闲空间时，InnoDB 报告表空间中确实空闲的扩展。InnoDB 总是为清理和其他内部目的保留一些扩展；这些保留的扩展不包括在空闲空间中。

当您从表中删除数据时，InnoDB 收缩相应的 B-树索引。释放的空间是否可供其他用户使用取决于删除模式是否释放了表空间的单个页面或扩展。删除表或从中删除所有行保证将空间释放给其他用户，但请记住，删除的行只有在不再需要用于事务回滚或一致读取后的某个时间由清除操作物理移除。（参见第 17.3 节，“InnoDB 多版本控制”。）

#### 配置保留文件段页面的百分比

`innodb_segment_reserve_factor` 变量，在 MySQL 8.0.26 中引入，是一个高级功能，允许定义作为空白页面保留的表空间文件段页面的百分比。保留一定百分比的页面用于未来增长，以便可以连续地分配 B-树中的页面。修改保留页面百分比的能力允许对 InnoDB 进行微调，以解决数据碎片化或存储空间使用不当的问题。

该设置适用于文件每表和通用表空间。`innodb_segment_reserve_factor` 的默认设置为 12.5%，这是在以前的 MySQL 版本中保留的页面的相同百分比。

`innodb_segment_reserve_factor` 变量是动态的，可以使用 SET 语句进行配置。例如：

```
mysql> SET GLOBAL innodb_segment_reserve_factor=10;
```

#### 页面与表行的关系

对于 4KB、8KB、16KB 和 32KB 的 `innodb_page_size` 设置，最大行长度略小于数据库页面大小的一半。例如，对于默认的 16KB InnoDB 页面大小，最大行长度略小于 8KB。对于 64KB `innodb_page_size` 设置，最大行长度略小于 16KB。

如果一行没有超过最大行长度，它的所有内容都存储在页面内部。如果一行超过了最大行长度，选择变长列进行外部离页存储，直到行符合最大行长度限制。变长列的外部离页存储根据行格式有所不同：

- **COMPACT 和 REDUNDANT 行格式**

  当选择变长列进行外部离页存储时，InnoDB 在行内本地存储前 768 字节，其余部分外部存储到溢出页面中。每个这样的列都有自己的溢出页面列表。768 字节前缀伴随着一个 20 字节的值，该值存储列的真实长度，并指向溢出列表中存储其余值的位置。参见第 17.10 节，“InnoDB 行格式”。

- **DYNAMIC 和 COMPRESSED 行格式**

  当选择变长列进行外部离页存储时，InnoDB 在行内本地存储一个 20 字节的指针，其余部分外部存储到溢出页面中。参见第 17.10 节，“InnoDB 行格式”。


LONGBLOB 和 LONGTEXT 列必须小于 4GB，并且包括 BLOB 和 TEXT 列在内的总行长度必须小于 4GB。