**29.4.6 按线程预过滤**



threads 表包含每个服务器线程的一行。每行包含有关线程的信息，并指示是否为其启用监控。要让 Performance Schema 监控线程，必须满足以下条件：



​	•	setup_consumers 表中的 thread_instrumentation 消费者必须为 YES。

​	•	threads.INSTRUMENTED 列必须为 YES。

​	•	监控仅适用于那些在 setup_instruments 表中启用的监控项产生的线程事件。



threads 表还指示每个服务器线程是否执行历史事件日志记录。这包括等待、阶段、语句和事务事件，并影响日志记录到以下表中：



​	•	events_waits_history

​	•	events_waits_history_long

​	•	events_stages_history

​	•	events_stages_history_long

​	•	events_statements_history

​	•	events_statements_history_long

​	•	events_transactions_history

​	•	events_transactions_history_long



要执行历史事件日志记录，必须满足以下条件：



​	•	setup_consumers 表中的相应历史相关消费者必须启用。例如，events_waits_history 和 events_waits_history_long 表中的等待事件日志记录需要相应的 events_waits_history 和 events_waits_history_long 消费者为 YES。

​	•	threads.HISTORY 列必须为 YES。

​	•	日志记录仅适用于那些在 setup_instruments 表中启用的监控项产生的线程事件。



对于前台线程（由客户端连接产生），threads 表中 INSTRUMENTED 和 HISTORY 列的初始值由与线程关联的用户帐户是否与 setup_actors 表中的任何行匹配决定。值来自匹配的 setup_actors 表行中的 ENABLED 和 HISTORY 列。



对于后台线程，没有关联的用户。INSTRUMENTED 和 HISTORY 的默认值为 YES，且不会查询 setup_actors。



setup_actors 的初始内容如下所示：



mysql> SELECT * FROM performance_schema.setup_actors;

+------+------+------+---------+---------+

| HOST | USER | ROLE | ENABLED | HISTORY |

+------+------+------+---------+---------+

| %  | %  | %  | YES   | YES   |

+------+------+------+---------+---------+



HOST 和 USER 列应包含字面主机名或用户名，或使用 % 匹配任何名称。



ENABLED 和 HISTORY 列指示是否为匹配的线程启用监控和历史事件日志记录，但仍需满足之前描述的其他条件。



当 Performance Schema 检查每个新前台线程是否在 setup_actors 中匹配时，它首先尝试找到更具体的匹配，使用 USER 和 HOST 列（ROLE 未使用）：



​	1.	USER='literal' 和 HOST='literal' 的行。

​	2.	USER='literal' 和 HOST='%' 的行。

​	3.	USER='%' 和 HOST='literal' 的行。

​	4.	USER='%' 和 HOST='%' 的行。



匹配发生的顺序很重要，因为不同的 setup_actors 行可能具有不同的 USER 和 HOST 值。这允许根据 ENABLED 和 HISTORY 列的值，有选择地按主机、用户或帐户（用户和主机组合）应用监控和历史事件日志记录：



​	•	当最佳匹配是 ENABLED=YES 的行时，线程的 INSTRUMENTED 值变为 YES。当最佳匹配是 HISTORY=YES 的行时，线程的 HISTORY 值变为 YES。

​	•	当最佳匹配是 ENABLED=NO 的行时，线程的 INSTRUMENTED 值变为 NO。当最佳匹配是 HISTORY=NO 的行时，线程的 HISTORY 值变为 NO。

​	•	当没有找到匹配时，线程的 INSTRUMENTED 和 HISTORY 值变为 NO。



setup_actors 行中的 ENABLED 和 HISTORY 列可以相互独立地设置为 YES 或 NO。这意味着可以单独启用监控，而无需收集历史事件。



默认情况下，所有新前台线程的监控和历史事件收集均已启用，因为 setup_actors 表最初包含 HOST 和 USER 都为 % 的一行。要进行更有限的匹配，例如仅为某些前台线程启用监控，您必须更改此行，因为它匹配任何连接，并为更具体的 HOST/USER 组合添加行。



假设您对 setup_actors 进行如下修改：



UPDATE performance_schema.setup_actors

SET ENABLED = 'NO', HISTORY = 'NO'

WHERE HOST = '%' AND USER = '%';

INSERT INTO performance_schema.setup_actors

(HOST,USER,ROLE,ENABLED,HISTORY)

VALUES('localhost','joe','%','YES','YES');

INSERT INTO performance_schema.setup_actors

(HOST,USER,ROLE,ENABLED,HISTORY)

VALUES('hosta.example.com','joe','%','YES','NO');

INSERT INTO performance_schema.setup_actors

(HOST,USER,ROLE,ENABLED,HISTORY)

VALUES('%','sam','%','NO','YES');



UPDATE 语句更改了默认匹配，禁用监控和历史事件收集。INSERT 语句为更具体的匹配添加了行。



现在，Performance Schema 根据以下条件确定如何设置新连接线程的 INSTRUMENTED 和 HISTORY 值：



​	•	如果 joe 从本地主机连接，连接将匹配第一个插入的行。线程的 INSTRUMENTED 和 HISTORY 值变为 YES。

​	•	如果 joe 从 hosta.example.com 连接，连接将匹配第二个插入的行。线程的 INSTRUMENTED 值变为 YES，HISTORY 值变为 NO。

​	•	如果 joe 从任何其他主机连接，则没有匹配。线程的 INSTRUMENTED 和 HISTORY 值变为 NO。

​	•	如果 sam 从任何主机连接，连接将匹配第三个插入的行。线程的 INSTRUMENTED 值变为 NO，HISTORY 值变为 YES。

​	•	对于其他任何连接，HOST 和 USER 设置为 % 的行将匹配。此行的 ENABLED 和 HISTORY 现在设置为 NO，因此线程的 INSTRUMENTED 和 HISTORY 值变为 NO。



对 setup_actors 表的修改仅影响修改后创建的前台线程，不影响现有线程。要影响现有线程，请修改 threads 表行中的 INSTRUMENTED 和 HISTORY 列。