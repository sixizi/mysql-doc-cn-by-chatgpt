# 29.12.2.3 `setup_instruments` 表

`setup_instruments` 表列出可收集事件的检测对象类别：

```sql
mysql> SELECT * FROM performance_schema.setup_instruments\G
```

每个添加到源代码中的检测项目（instrument）都会在 `setup_instruments` 表中添加一行，即使该检测代码未执行也是如此。当启用并执行检测时，会创建检测实例，这些实例可在 `xxx_instances` 表中查看，例如 `file_instances` 或 `rwlock_instances`。

对大多数 `setup_instruments` 行的修改会立即影响监控。对于某些检测项目，仅在服务器启动时更改才生效，尤其是服务器中的互斥锁、条件变量和读写锁。

有关 `setup_instruments` 表在事件过滤中的作用，请参阅[29.4.3 事件预过滤](#)。

## `setup_instruments` 表的列

- **`NAME`**  
  检测名称。检测名称可能包含多个部分并形成层次结构。执行检测产生的事件将使用该检测名称的 `EVENT_NAME` 值。

- **`ENABLED`**  
  是否启用检测。值为 `YES` 或 `NO`。禁用的检测不会生成事件。此列可以修改，但对已创建的检测对象设置 `ENABLED` 无效。

- **`TIMED`**  
  检测是否计时。值为 `YES`、`NO` 或 `NULL`。此列可修改，但对已创建的检测对象设置 `TIMED` 无效。  
  `TIMED` 为 `NULL` 表示该检测不支持计时，例如内存操作不计时。  
  启用的检测对象如果不计时，其计时器不会激活，生成的事件的 `TIMER_START`、`TIMER_END` 和 `TIMER_WAIT` 值为 `NULL`。

- **`PROPERTIES`**  
  检测的属性。此列使用 `SET` 数据类型，可以包含以下多个标记之一：
    - `controlled_by_default`：该检测对象的内存默认会被收集。
    - `global_statistics`：检测对象只生成全局汇总，无法提供更细粒度的数据。
    - `mutable`：该检测对象可以“变异”成更具体的对象，主要用于语句检测。
    - `progress`：检测对象可报告进度数据，仅适用于阶段检测。
    - `singleton`：检测对象仅有一个实例，例如大多数全局互斥锁。
    - `user`：检测对象直接与用户工作负载相关联。

- **`FLAGS`**  
  检测对象内存是否受控。此标记仅适用于非全局内存检测对象。

- **`VOLATILITY`**  
  检测的易变性。范围从低到高，对应 `mysql/psi/psi_base.h` 头文件中的 `PSI_VOLATILITY_xxx` 常量。  
  易变性较低的检测对象（例如 `PERMANENT = 1`）在服务器启动时创建，只在服务器关闭时销毁。高易变性检测对象（如 `SESSION = 5`）会在每个用户会话中创建和销毁。

- **`DOCUMENTATION`**  
  描述检测目的的字符串。值为 `NULL` 表示没有可用描述。

## `setup_instruments` 表的索引

- 主键索引：(`NAME`)

不允许对 `setup_instruments` 表执行 `TRUNCATE TABLE` 操作。

### 导出检测线程名称

从 MySQL 8.0.27 起，`性能模式` 可将检测线程的名称导出到操作系统，以便在调试器和 `ps` 命令等工具中显示具体的线程名称而不是统一的 "mysqld"。例如，`ps -C mysqld H -o "pid tid cmd comm"` 命令可显示如下输出：

```plaintext
  PID   TID CMD                         COMMAND
27668 27668 /usr/sbin/mysqld            mysqld
27668 27671 /usr/sbin/mysqld            ib_io_ibuf
27668 27672 /usr/sbin/mysqld            ib_io_log
27668 27673 /usr/sbin/mysqld            ib_io_rd-1
...
```

这样，不同的线程实例在名称上编号以确保唯一性。