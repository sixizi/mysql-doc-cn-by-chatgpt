### 29.12.13.3 metadata_locks 表

MySQL 使用元数据锁（Metadata Locking）来管理对数据库对象的并发访问并确保数据一致性。元数据锁不仅适用于表，还包括模式（Schema）、存储程序（过程、函数、触发器、计划事件）、表空间、通过 GET_LOCK() 函数获取的用户级锁，以及锁定服务中描述的锁。

Performance Schema 通过 metadata_locks 表提供元数据锁信息：
- 显示已授予的锁，表明哪些会话拥有当前元数据锁。
- 显示已请求但尚未授予的锁，表明哪些会话正在等待元数据锁。
- 显示被死锁检测器终止的锁请求。
- 显示已超时且等待被请求会话放弃的锁请求。

此信息可帮助了解会话之间的元数据锁依赖关系，不仅可以看到某个会话正在等待的锁，还可以看到当前持有该锁的会话。

#### 表操作说明

- metadata_locks 表是只读的，无法更新。
- 默认自动调整大小，可通过在服务器启动时设置 performance_schema_max_metadata_locks 系统变量来配置表大小。
- 元数据锁仪器使用 wait/lock/metadata/sql/mdl 仪器，默认启用。

#### 启用或禁用元数据锁仪器

- **在 my.cnf 文件中配置**  
  **启用：**
  [mysqld]
  performance-schema-instrument='wait/lock/metadata/sql/mdl=ON'

  **禁用：**
  [mysqld]
  performance-schema-instrument='wait/lock/metadata/sql/mdl=OFF'

- **在运行时更新 setup_instruments 表**  
  **启用：**
  UPDATE performance_schema.setup_instruments
  SET ENABLED = 'YES', TIMED = 'YES'
  WHERE NAME = 'wait/lock/metadata/sql/mdl';

  **禁用：**
  UPDATE performance_schema.setup_instruments
  SET ENABLED = 'NO', TIMED = 'NO'
  WHERE NAME = 'wait/lock/metadata/sql/mdl';

#### metadata_locks 表的状态值

元数据锁的状态通过 LOCK_STATUS 列指示：
- **PENDING**：锁已请求但尚未获得。
- **GRANTED**：锁已授予。
- **VICTIM**：死锁检测器终止的锁请求（ER_LOCK_DEADLOCK）。
- **TIMEOUT**：锁请求超时（ER_LOCK_WAIT_TIMEOUT）。
- **KILLED**：被终止的已授予锁或锁请求。
- **PRE_ACQUIRE_NOTIFY** 和 **POST_RELEASE_NOTIFY**：短暂状态，表示锁获取或释放操作中通知相关存储引擎的阶段。

#### metadata_locks 表的列

- **OBJECT_TYPE**  
  锁的对象类型，可能的值包括：
  - GLOBAL
  - SCHEMA
  - TABLE
  - FUNCTION
  - PROCEDURE
  - TRIGGER（当前未使用）
  - EVENT
  - COMMIT
  - USER LEVEL LOCK（通过 GET_LOCK() 获取的用户级锁）
  - TABLESPACE
  - BACKUP LOCK
  - LOCKING SERVICE（使用锁定服务获取的锁）

- **OBJECT_SCHEMA**  
  包含对象的模式（Schema）。

- **OBJECT_NAME**  
  被监控对象的名称。

- **OBJECT_INSTANCE_BEGIN**  
  被监控对象在内存中的地址。

- **LOCK_TYPE**  
  元数据锁的类型，可能的值包括：
  - INTENTION_EXCLUSIVE
  - SHARED
  - SHARED_HIGH_PRIO
  - SHARED_READ
  - SHARED_WRITE
  - SHARED_UPGRADABLE
  - SHARED_NO_WRITE
  - SHARED_NO_READ_WRITE
  - EXCLUSIVE

- **LOCK_DURATION**  
  元数据锁的持续时间，可能的值包括：
  - STATEMENT：语句结束时释放。
  - TRANSACTION：事务结束时释放。
  - EXPLICIT：显式释放（如 FLUSH TABLES WITH READ LOCK 获得的全局锁）。

- **LOCK_STATUS**  
  锁的状态，可能的值包括：
  - PENDING
  - GRANTED
  - VICTIM
  - TIMEOUT
  - KILLED
  - PRE_ACQUIRE_NOTIFY
  - POST_RELEASE_NOTIFY

- **SOURCE**  
  包含生成事件的代码的源文件名称及其所在的行号。

- **OWNER_THREAD_ID**  
  请求元数据锁的线程 ID。

- **OWNER_EVENT_ID**  
  请求元数据锁的事件 ID。

#### 索引

- 主键：OBJECT_INSTANCE_BEGIN
- 索引：OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME
- 索引：OWNER_THREAD_ID, OWNER_EVENT_ID

#### 特别说明

- 不允许对 metadata_locks 表执行 TRUNCATE TABLE 操作。