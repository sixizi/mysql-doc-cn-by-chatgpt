### 29.12.8 性能模式连接表

#### 29.12.8.1 `accounts` 表  
#### 29.12.8.2 `hosts` 表  
#### 29.12.8.3 `users` 表  

当客户端连接到 MySQL 服务器时，它会使用特定的用户名并从特定的主机连接。性能模式提供了关于这些连接的统计信息，并通过以下表按账户（用户和主机组合）、用户名和主机名分别跟踪连接：

- **`accounts`**：按客户端账户的连接统计信息  
- **`hosts`**：按客户端主机名的连接统计信息  
- **`users`**：按客户端用户名的连接统计信息  

#### 账户的定义
在连接表中，“账户”的定义类似于 MySQL 系统数据库 `mysql` 的授权表中对账户的定义，即指用户和主机的组合。不同之处在于：
- 对授权表来说，账户的主机部分可以是模式（如 `%`）。  
- 对性能模式表来说，主机值始终是具体的非模式化主机名。

#### 表结构和连接统计
每个连接表都有以下列，用于统计每个“跟踪值”基础上的当前连接数和总连接数：
- `CURRENT_CONNECTIONS`：当前连接数。
- `TOTAL_CONNECTIONS`：总连接数。

表的区别在于跟踪值：
- **`accounts` 表**：通过 `USER` 和 `HOST` 列按用户和主机组合跟踪连接。  
- **`users` 表**：通过 `USER` 列按用户名跟踪连接。  
- **`hosts` 表**：通过 `HOST` 列按主机名跟踪连接。

性能模式还统计内部线程和未能通过认证的用户会话的线程，这些记录的 `USER` 和 `HOST` 列值为 `NULL`。

#### 示例
假设名为 `user1` 和 `user2` 的客户端分别从 `hosta` 和 `hostb` 各连接一次：
- **`accounts` 表**：包含四行，分别为 `user1/hosta`、`user1/hostb`、`user2/hosta` 和 `user2/hostb`，每行计数一个账户的连接数。  
- **`hosts` 表**：包含两行，分别为 `hosta` 和 `hostb`，每行计数主机名的两个连接数。  
- **`users` 表**：包含两行，分别为 `user1` 和 `user2`，每行计数用户名的两个连接数。

当客户端连接时，性能模式确定每个连接表中适用的行，并递增该行的 `CURRENT_CONNECTIONS` 和 `TOTAL_CONNECTIONS`。当客户端断开连接时，性能模式递减该行的 `CURRENT_CONNECTIONS`，而 `TOTAL_CONNECTIONS` 保持不变。

---

### `TRUNCATE TABLE` 的效果
允许对连接表执行 `TRUNCATE TABLE` 操作，其效果如下：
- **删除**：没有当前连接的账户、主机或用户的行（`CURRENT_CONNECTIONS = 0` 的行）。  
- **重置**：未删除的行会重置为仅统计当前连接数：`TOTAL_CONNECTIONS` 被重置为 `CURRENT_CONNECTIONS`。  

依赖连接表的汇总表会被隐式截断，详见下文。

---

### 汇总表
性能模式维护了汇总表，用于根据账户、主机或用户统计各种事件类型的连接统计。这些表名包含 `_summary_by_account`、`_summary_by_host` 或 `_summary_by_user`。  
使用以下查询可标识这些表：
```sql
mysql> SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES
       WHERE TABLE_SCHEMA = 'performance_schema'
       AND TABLE_NAME REGEXP '_summary_by_(account|host|user)'
       ORDER BY TABLE_NAME;
+------------------------------------------------------+
| TABLE_NAME                                           |
+------------------------------------------------------+
| events_errors_summary_by_account_by_error            |
| events_errors_summary_by_host_by_error               |
| events_errors_summary_by_user_by_error               |
| events_stages_summary_by_account_by_event_name       |
| events_stages_summary_by_host_by_event_name          |
| events_stages_summary_by_user_by_event_name          |
| events_statements_summary_by_account_by_event_name   |
| events_statements_summary_by_host_by_event_name      |
| events_statements_summary_by_user_by_event_name      |
| events_transactions_summary_by_account_by_event_name |
| events_transactions_summary_by_host_by_event_name    |
| events_transactions_summary_by_user_by_event_name    |
| events_waits_summary_by_account_by_event_name        |
| events_waits_summary_by_host_by_event_name           |
| events_waits_summary_by_user_by_event_name           |
| memory_summary_by_account_by_event_name              |
| memory_summary_by_host_by_event_name                 |
| memory_summary_by_user_by_event_name                 |
+------------------------------------------------------+