### 29.12.3.4 `rwlock_instances` 表

`rwlock_instances` 表列出了服务器执行过程中 `Performance Schema` 记录的所有 `rwlock`（读写锁）实例。`rwlock` 是一种同步机制，用于确保多个线程在特定时间内可以按照一定规则访问共享资源。资源被称为“受 `rwlock` 保护”。访问方式可以是：

- 共享模式（多个线程可同时获取读锁）
- 排他模式（同一时间只有一个线程可以获取写锁）
- 共享-排他模式（一个线程可以获取写锁，同时允许其他线程进行不一致的读取）。共享-排他访问又称为 `sxlock`，用于优化读写工作负载的并发性和可扩展性。

根据请求锁的线程数量和锁请求的类型，访问模式可以为共享模式、排他模式、共享-排他模式，或不授予任何访问权限（需等待其他线程完成后才能访问）。

`rwlock_instances` 表包含以下列：

- **NAME**  
  与锁关联的检测名（instrument name）。

- **OBJECT_INSTANCE_BEGIN**  
  锁在内存中的地址。

- **WRITE_LOCKED_BY_THREAD_ID**  
  当某个线程当前以排他（写）模式锁定 `rwlock` 时，`WRITE_LOCKED_BY_THREAD_ID` 为持有锁的线程的 `THREAD_ID`，否则为 `NULL`。

- **READ_LOCKED_BY_COUNT**  
  当某个线程当前以共享（读）模式锁定 `rwlock` 时，`READ_LOCKED_BY_COUNT` 计数器加 1。此字段仅为计数器，无法直接用于识别持有读锁的线程，但可以用于查看某个 `rwlock` 是否存在读锁竞争，以及当前有多少读取者活跃。

`rwlock_instances` 表具有以下索引：

- 主键：`(OBJECT_INSTANCE_BEGIN)`
- 索引：`(NAME)`
- 索引：`(WRITE_LOCKED_BY_THREAD_ID)`

不允许对 `rwlock_instances` 表执行 `TRUNCATE TABLE` 操作。

通过对以下两个表进行查询，监控应用程序或 DBA 可以检测到涉及锁的线程之间的某些瓶颈或死锁情况：

- `events_waits_current`：查看某个线程正在等待哪个 `rwlock`
- `rwlock_instances`：查看当前哪个线程持有某个 `rwlock`

#### 限制
`rwlock_instances` 只能用于识别持有写锁的线程，无法识别持有读锁的线程。