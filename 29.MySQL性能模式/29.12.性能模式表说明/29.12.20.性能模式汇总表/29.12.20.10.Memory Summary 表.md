#### 29.12.20.10 Memory Summary 表

`Performance Schema` 对内存使用进行监控并汇总内存使用统计信息，按以下因素进行详细分类：

- 使用的内存类型（各种缓存、内部缓冲区等）
- 间接执行内存操作的线程、帐户、用户、主机

`Performance Schema` 监控内存使用的以下方面：

- 使用的内存大小
- 操作计数
- 低水位和高水位标记

内存大小有助于理解或调整服务器的内存消耗。

操作计数有助于理解或调整服务器对内存分配器的总体压力，这会影响性能。每百万次分配一个字节与分配其他数据量的影响不同。

低水位和高水位标记对于检测工作负载峰值、整体工作负载稳定性和可能的内存泄漏至关重要。

内存摘要表不包含时间信息，因为内存事件没有时间戳。

有关收集内存使用数据的信息，请参阅内存仪表化行为。

示例内存事件摘要信息：

```sql
mysql> SELECT *
       FROM performance_schema.memory_summary_global_by_event_name
       WHERE EVENT_NAME = 'memory/sql/TABLE'\G
*************************** 1. row ***************************
                  EVENT_NAME: memory/sql/TABLE
                 COUNT_ALLOC: 1381
                  COUNT_FREE: 924
   SUM_NUMBER_OF_BYTES_ALLOC: 2059873
    SUM_NUMBER_OF_BYTES_FREE: 1407432
              LOW_COUNT_USED: 0
          CURRENT_COUNT_USED: 457
             HIGH_COUNT_USED: 461
    LOW_NUMBER_OF_BYTES_USED: 0
CURRENT_NUMBER_OF_BYTES_USED: 652441
   HIGH_NUMBER_OF_BYTES_USED: 669269
```

每个内存摘要表都有一个或多个分组列，用于指示表格如何聚合事件。事件名称指的是 `setup_instruments` 表中的事件仪器名称：

- `memory_summary_by_account_by_event_name` 表具有 `USER`、`HOST` 和 `EVENT_NAME` 列。每一行总结了给定帐户（用户和主机组合）和事件名称的事件。
- `memory_summary_by_host_by_event_name` 表具有 `HOST` 和 `EVENT_NAME` 列。每一行总结了给定主机和事件名称的事件。
- `memory_summary_by_thread_by_event_name` 表具有 `THREAD_ID` 和 `EVENT_NAME` 列。每一行总结了给定线程和事件名称的事件。
- `memory_summary_by_user_by_event_name` 表具有 `USER` 和 `EVENT_NAME` 列。每一行总结了给定用户和事件名称的事件。
- `memory_summary_global_by_event_name` 表具有 `EVENT_NAME` 列。每一行总结了给定事件名称的事件。

每个内存摘要表都有以下汇总列，包含聚合的值：

- `COUNT_ALLOC`, `COUNT_FREE`
  
  内存分配和释放函数调用的汇总次数。
  
- `SUM_NUMBER_OF_BYTES_ALLOC`, `SUM_NUMBER_OF_BYTES_FREE`
  
  已分配和释放内存块的汇总大小。

- `CURRENT_COUNT_USED`
  
  当前分配但尚未释放的内存块的汇总数量。此列为便捷列，等于 `COUNT_ALLOC − COUNT_FREE`。

- `CURRENT_NUMBER_OF_BYTES_USED`
  
  当前分配但尚未释放的内存块的汇总大小。此列为便捷列，等于 `SUM_NUMBER_OF_BYTES_ALLOC − SUM_NUMBER_OF_BYTES_FREE`。

- `LOW_COUNT_USED`, `HIGH_COUNT_USED`
  
  对应 `CURRENT_COUNT_USED` 列的低水位和高水位标记。

- `LOW_NUMBER_OF_BYTES_USED`, `HIGH_NUMBER_OF_BYTES_USED`
  
  对应 `CURRENT_NUMBER_OF_BYTES_USED` 列的低水位和高水位标记。

内存摘要表具有以下索引：

- `memory_summary_by_account_by_event_name`:
  
  - 主键是 `(USER, HOST, EVENT_NAME)`。

- `memory_summary_by_host_by_event_name`:
  
  - 主键是 `(HOST, EVENT_NAME)`。

- `memory_summary_by_thread_by_event_name`:
  
  - 主键是 `(THREAD_ID, EVENT_NAME)`。

- `memory_summary_by_user_by_event_name`:
  
  - 主键是 `(USER, EVENT_NAME)`。

- `memory_summary_global_by_event_name`:
  
  - 主键是 `(EVENT_NAME)`。

`TRUNCATE TABLE` 对内存摘要表是允许的。它有以下效果：

- 一般来说，截断会重置统计数据的基线，但不会改变服务器状态。也就是说，截断内存表不会释放内存。

- `COUNT_ALLOC` 和 `COUNT_FREE` 会被重置为新的基线，通过将每个计数器减少相同的值。

- 同样，`SUM_NUMBER_OF_BYTES_ALLOC` 和 `SUM_NUMBER_OF_BYTES_FREE` 会被重置为新的基线。

- `LOW_COUNT_USED` 和 `HIGH_COUNT_USED` 会被重置为 `CURRENT_COUNT_USED`。

- `LOW_NUMBER_OF_BYTES_USED` 和 `HIGH_NUMBER_OF_BYTES_USED` 会被重置为 `CURRENT_NUMBER_OF_BYTES_USED`。

此外，每个按帐户、主机、用户或线程聚合的内存摘要表，会通过截断它所依赖的连接表或 `memory_summary_global_by_event_name` 的截断而隐式地被截断。有关详细信息，请参见第 29.12.8 节，“Performance Schema 连接表”。