# 29.12.20.8 表 I/O 和锁等待汇总表

以下小节描述了表 I/O 和锁等待汇总表：

- **table_io_waits_summary_by_index_usage**: 按索引统计的表 I/O 等待
- **table_io_waits_summary_by_table**: 按表统计的表 I/O 等待
- **table_lock_waits_summary_by_table**: 按表统计的表锁等待

## 29.12.20.8.1 **table_io_waits_summary_by_table** 表

**table_io_waits_summary_by_table** 表汇总了所有由 `wait/io/table/sql/handler` 工具生成的表 I/O 等待事件，按表分组。

### 分组列
此表使用以下分组列来标识事件的汇总方式：
- **OBJECT_TYPE**
- **OBJECT_SCHEMA**
- **OBJECT_NAME**

这些列的含义与 **events_waits_current** 表中的相同，标识该行所对应的表。

### 汇总列
此表包含以下汇总列，其中一些列是更高层次的聚合值，等于更细粒度列值的总和。例如，汇总所有写操作的列等于插入、更新和删除操作列的总和。

- **COUNT_STAR, SUM_TIMER_WAIT, MIN_TIMER_WAIT, AVG_TIMER_WAIT, MAX_TIMER_WAIT**: 汇总所有 I/O 操作，相当于相关的 `xxx_READ` 和 `xxx_WRITE` 列的总和。
- **COUNT_READ, SUM_TIMER_READ, MIN_TIMER_READ, AVG_TIMER_READ, MAX_TIMER_READ**: 汇总所有读操作，相当于 `xxx_FETCH` 列的总和。
- **COUNT_WRITE, SUM_TIMER_WRITE, MIN_TIMER_WRITE, AVG_TIMER_WRITE, MAX_TIMER_WRITE**: 汇总所有写操作，相当于 `xxx_INSERT`、`xxx_UPDATE` 和 `xxx_DELETE` 列的总和。
- **COUNT_FETCH, SUM_TIMER_FETCH, MIN_TIMER_FETCH, AVG_TIMER_FETCH, MAX_TIMER_FETCH**: 汇总所有获取操作。
- **COUNT_INSERT, SUM_TIMER_INSERT, MIN_TIMER_INSERT, AVG_TIMER_INSERT, MAX_TIMER_INSERT**: 汇总所有插入操作。
- **COUNT_UPDATE, SUM_TIMER_UPDATE, MIN_TIMER_UPDATE, AVG_TIMER_UPDATE, MAX_TIMER_UPDATE**: 汇总所有更新操作。
- **COUNT_DELETE, SUM_TIMER_DELETE, MIN_TIMER_DELETE, AVG_TIMER_DELETE, MAX_TIMER_DELETE**: 汇总所有删除操作。

### 索引
- **唯一索引**: `(OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME)`

> **提示**: 对表 I/O 汇总表允许使用 `TRUNCATE TABLE`，这会将汇总列重置为零而不是删除行。截断此表也会同时截断 **table_io_waits_summary_by_index_usage** 表。

## 29.12.20.8.2 **table_io_waits_summary_by_index_usage** 表

**table_io_waits_summary_by_index_usage** 表汇总了所有由 `wait/io/table/sql/handler` 工具生成的表索引 I/O 等待事件，按表索引分组。

### 列定义
此表的列与 **table_io_waits_summary_by_table** 表几乎相同，唯一的区别是增加了以下分组列：
- **INDEX_NAME**: 表示记录表 I/O 等待事件时使用的索引名称。
  - **PRIMARY**: 表示表 I/O 使用了主索引。
  - **NULL**: 表示表 I/O 未使用索引。

插入操作计入 `INDEX_NAME = NULL`。

### 索引
- **唯一索引**: `(OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, INDEX_NAME)`

> **提示**: 对表 I/O 汇总表允许使用 `TRUNCATE TABLE`，这会将汇总列重置为零而不是删除行。截断 **table_io_waits_summary_by_table** 表也会同时截断此表。此外，任何改变表索引结构的 DDL 操作可能会重置每个索引的统计数据。

## 29.12.20.8.3 **table_lock_waits_summary_by_table** 表

**table_lock_waits_summary_by_table** 表汇总了所有由 `wait/lock/table/sql/handler` 工具生成的表锁等待事件，按表分组。

### 锁类型
此表包含以下信息：
1. **内部锁**: 对应 SQL 层的锁，通过调用 `thr_lock()` 实现。事件行中，这些锁通过 **OPERATION** 列区分，可能的值包括：
   - 读操作：`read normal`, `read with shared locks`, `read high priority`, `read no insert`
   - 写操作：`write allow write`, `write concurrent insert`, `write delayed`, `write low priority`, `write normal`
2. **外部锁**: 对应存储引擎层的锁，通过调用 `handler::external_lock()` 实现。事件行中，这些锁通过 **OPERATION** 列区分，可能的值包括：
   - `read external`
   - `write external`

### 分组列
此表使用以下分组列来标识事件的汇总方式：
- **OBJECT_TYPE**
- **OBJECT_SCHEMA**
- **OBJECT_NAME**

这些列的含义与 **events_waits_current** 表中的相同，标识该行所对应的表。

### 汇总列
此表包含以下汇总列：
- **COUNT_STAR, SUM_TIMER_WAIT, MIN_TIMER_WAIT, AVG_TIMER_WAIT, MAX_TIMER_WAIT**: 汇总所有锁操作，相当于 `xxx_READ` 和 `xxx_WRITE` 列的总和。
- **COUNT_READ, SUM_TIMER_READ, MIN_TIMER_READ, AVG_TIMER_READ, MAX_TIMER_READ**: 汇总所有读锁操作，包括 `xxx_READ_NORMAL`、`xxx_READ_WITH_SHARED_LOCKS`、`xxx_READ_HIGH_PRIORITY` 和 `xxx_READ_NO_INSERT`。
- **COUNT_WRITE, SUM_TIMER_WRITE, MIN_TIMER_WRITE, AVG_TIMER_WRITE, MAX_TIMER_WRITE**: 汇总所有写锁操作，包括 `xxx_WRITE_ALLOW_WRITE`、`xxx_WRITE_CONCURRENT_INSERT`、`xxx_WRITE_LOW_PRIORITY` 和 `xxx_WRITE_NORMAL`。
- **COUNT_READ_EXTERNAL, COUNT_WRITE_EXTERNAL** 等列分别汇总外部锁的读写操作。

### 索引
- **唯一索引**: `(OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME)`

> **提示**: 对表锁汇总表允许使用 `TRUNCATE TABLE`，这会将汇总列重置为零而不是删除行。