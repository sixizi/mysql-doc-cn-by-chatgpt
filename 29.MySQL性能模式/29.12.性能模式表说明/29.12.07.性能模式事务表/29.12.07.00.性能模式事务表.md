### 29.12.7 性能模式事务表

#### 29.12.7.1 `events_transactions_current` 表  
#### 29.12.7.2 `events_transactions_history` 表  
#### 29.12.7.3 `events_transactions_history_long` 表  

性能模式（Performance Schema）监控事务。在事件层级中，等待事件嵌套在阶段事件内，阶段事件嵌套在语句事件内，语句事件嵌套在事务事件内。

以下表存储事务事件：
- **`events_transactions_current`**：每个线程当前的事务事件。  
- **`events_transactions_history`**：每个线程最近结束的事务事件。  
- **`events_transactions_history_long`**：全局范围（所有线程）最近结束的事务事件。  

以下章节描述事务事件表。此外，还有汇总表，用于聚合事务事件的信息；参见 [29.12.20.5 事务汇总表](#29.12.20.5-transaction-summary-tables)。  

关于三个事务事件表之间关系的更多信息，请参见 [29.9 当前和历史事件的性能模式表](#29.9-performance-schema-tables-for-current-and-historical-events)。

---

### 配置事务事件采集

#### 配置采集事务事件
要控制是否采集事务事件，请设置相关监控项和消费者的状态：

- **`setup_instruments` 表**  
  包含名为 `transaction` 的监控项。使用此监控项启用或禁用单个事务事件类别的采集。  

- **`setup_consumers` 表**  
  包含与当前和历史事务事件表名对应的消费者值。使用这些消费者过滤事务事件的采集。

事务监控项 `transaction` 和事务消费者 `events_transactions_current`、`events_transactions_history` 默认启用：  

```sql
mysql> SELECT NAME, ENABLED, TIMED
       FROM performance_schema.setup_instruments
       WHERE NAME = 'transaction';
+-------------+---------+-------+
| NAME        | ENABLED | TIMED |
+-------------+---------+-------+
| transaction | YES     | YES   |
+-------------+---------+-------+

mysql> SELECT *
       FROM performance_schema.setup_consumers
       WHERE NAME LIKE 'events_transactions%';
+----------------------------------+---------+
| NAME                             | ENABLED |
+----------------------------------+---------+
| events_transactions_current      | YES     |
| events_transactions_history      | YES     |
| events_transactions_history_long | NO      |
+----------------------------------+---------+
```

```markdown
### 29.12.7 性能模式事务表

#### 29.12.7.1 `events_transactions_current` 表  
#### 29.12.7.2 `events_transactions_history` 表  
#### 29.12.7.3 `events_transactions_history_long` 表  

性能模式（Performance Schema）监控事务。在事件层级中，等待事件嵌套在阶段事件内，阶段事件嵌套在语句事件内，语句事件嵌套在事务事件内。

以下表存储事务事件：
- **`events_transactions_current`**：每个线程当前的事务事件。  
- **`events_transactions_history`**：每个线程最近结束的事务事件。  
- **`events_transactions_history_long`**：全局范围（所有线程）最近结束的事务事件。  

以下章节描述事务事件表。此外，还有汇总表，用于聚合事务事件的信息；参见 [29.12.20.5 事务汇总表](#29.12.20.5-transaction-summary-tables)。  

关于三个事务事件表之间关系的更多信息，请参见 [29.9 当前和历史事件的性能模式表](#29.9-performance-schema-tables-for-current-and-historical-events)。

---

### 配置事务事件采集

#### 配置采集事务事件
要控制是否采集事务事件，请设置相关监控项和消费者的状态：

- **`setup_instruments` 表**  
  包含名为 `transaction` 的监控项。使用此监控项启用或禁用单个事务事件类别的采集。  

- **`setup_consumers` 表**  
  包含与当前和历史事务事件表名对应的消费者值。使用这些消费者过滤事务事件的采集。

事务监控项 `transaction` 和事务消费者 `events_transactions_current`、`events_transactions_history` 默认启用：  

```sql
mysql> SELECT NAME, ENABLED, TIMED
       FROM performance_schema.setup_instruments
       WHERE NAME = 'transaction';
+-------------+---------+-------+
| NAME        | ENABLED | TIMED |
+-------------+---------+-------+
| transaction | YES     | YES   |
+-------------+---------+-------+

mysql> SELECT *
       FROM performance_schema.setup_consumers
       WHERE NAME LIKE 'events_transactions%';
+----------------------------------+---------+
| NAME                             | ENABLED |
+----------------------------------+---------+
| events_transactions_current      | YES     |
| events_transactions_history      | YES     |
| events_transactions_history_long | NO      |
+----------------------------------+---------+
```

#### 在服务器启动时控制事务事件采集

启用事务事件采集的 `my.cnf` 配置示例：
```ini
[mysqld]
performance-schema-instrument='transaction=ON'
performance-schema-consumer-events-transactions-current=ON
performance-schema-consumer-events-transactions-history=ON
performance-schema-consumer-events-transactions-history-long=ON
```

禁用事务事件采集的 `my.cnf` 配置示例：
```ini
[mysqld]
performance-schema-instrument='transaction=OFF'
performance-schema-consumer-events-transactions-current=OFF
performance-schema-consumer-events-transactions-history=OFF
performance-schema-consumer-events-transactions-history-long=OFF
```

#### 在运行时控制事务事件采集

启用：
```sql
UPDATE performance_schema.setup_instruments
SET ENABLED = 'YES', TIMED = 'YES'
WHERE NAME = 'transaction';

UPDATE performance_schema.setup_consumers
SET ENABLED = 'YES'
WHERE NAME LIKE 'events_transactions%';
```

禁用：
```sql
UPDATE performance_schema.setup_instruments
SET ENABLED = 'NO', TIMED = 'NO'
WHERE NAME = 'transaction';

UPDATE performance_schema.setup_consumers
SET ENABLED = 'NO'
WHERE NAME LIKE 'events_transactions%';
```

要仅为特定事务事件表采集事务事件，可启用事务监控项并仅启用对应表的事务消费者。

---

### 事务边界

在 MySQL 服务器中，事务可通过以下语句显式启动：
- `START TRANSACTION` | `BEGIN` | `XA START` | `XA BEGIN`

事务也可以隐式启动，例如当系统变量 `autocommit` 启用时，每个语句的开始都会启动一个新事务。  

事务显式结束的语句包括：
- `COMMIT` | `ROLLBACK` | `XA COMMIT` | `XA ROLLBACK`

事务也可能因执行 DDL 语句、锁定语句或服务器管理语句而隐式结束。  

性能模式中事务事件的定义与服务器类似，事务事件的开始和结束与服务器的状态转换紧密相关：
- **显式事务**：在 `START TRANSACTION` 语句的处理过程中开始事务事件。  
- **隐式事务**：在前一个事务结束后，第一次使用事务引擎的语句开始事务事件。  

---

### 事务监控

事务具有以下三个属性：
- **访问模式**：只读或读写。
- **隔离级别**：如 `SERIALIZABLE`、`REPEATABLE READ` 等。
- **事务模式**：隐式（`autocommit` 启用）或显式（`autocommit` 禁用）。

---

### 事务和嵌套事件

事务事件的父级是启动事务的事件。例如：
- 对于显式事务：包括 `START TRANSACTION` 和 `COMMIT AND CHAIN`。  
- 对于隐式事务：是前一个事务结束后第一个使用事务引擎的语句。

---

### 事务与存储程序

- **存储过程**  
  存储过程可以在事务中启动，也可以在其中启动或结束事务。
- **存储函数**  
  存储函数不能显式或隐式提交或回滚事务。
- **触发器**  
  触发器是语句事件的子事件，与其关联表上的操作相关联。
- **计划事件**  
  计划事件的执行发生在新连接中，不与父事务嵌套。

---

### 事务与保存点

保存点语句作为单独的语句事件记录。事务事件包括以下语句的计数器：
- `SAVEPOINT`
- `ROLLBACK TO SAVEPOINT`
- `RELEASE SAVEPOINT`

---

### 事务与错误

事务中的错误和警告记录在语句事件中，而不记录在事务事件中。这包括事务相关的错误和警告（如非事务表的回滚错误或 GTID 一致性错误）。
```