### 18.6.4 组复制 IP 地址权限

当且仅当使用 XCom 通信堆栈用于建立组通信（`group_replication_communication_stack=XCOM`）时，组复制插件允许您指定一个允许列表（allowlist），列出可以接受传入的组通信系统连接的主机。如果您在服务器 s1 上指定了一个允许列表，那么当服务器 s2 建立连接到 s1 以参与组通信时，s1 首先检查允许列表，然后再接受来自 s2 的连接。如果 s2 在允许列表中，s1 接受连接，否则 s1 拒绝 s2 的连接尝试。从 MySQL 8.0.22 开始，使用系统变量 `group_replication_ip_allowlist` 来指定允许列表，而在 MySQL 8.0.22 之前的版本中，使用系统变量 `group_replication_ip_whitelist`。新系统变量的工作方式与旧系统变量相同，只是术语发生了变化。

> **注意**
>
> 当使用 MySQL 通信堆栈用于建立组通信（`group_replication_communication_stack=MYSQL`）时，`group_replication_ip_allowlist` 和 `group_replication_ip_whitelist` 的设置将被忽略。请参见第 18.6.1 节，“连接安全管理的通信堆栈”。

如果您没有明确指定允许列表，组通信引擎（XCom）将自动扫描主机上的活动接口，并识别具有私有子网地址的接口，以及为每个接口配置的子网掩码。这些地址和 IPv4 和（从 MySQL 8.0.14 开始）IPv6 的 localhost IP 地址被用来创建自动的组复制允许列表。因此，自动允许列表包括在适用子网掩码后为主机找到的以下范围内的任何 IP 地址：

```ini
IPv4 (as defined in RFC 1918)
10/8 prefix       (10.0.0.0 - 10.255.255.255) - Class A
172.16/12 prefix  (172.16.0.0 - 172.31.255.255) - Class B
192.168/16 prefix (192.168.0.0 - 192.168.255.255) - Class C

IPv6 (as defined in RFC 4193 and RFC 5156)
fc00:/7 prefix    - unique-local addresses
fe80::/10 prefix  - link-local unicast addresses

127.0.0.1 - localhost for IPv4
::1       - localhost for IPv6
```

错误日志中会添加一个条目，声明主机自动允许的地址。

私有地址的自动允许列表不能用于来自私有网络外部服务器的连接，因此即使服务器在公共 IP 上有接口，默认情况下也不允许来自外部主机的组复制连接。对于位于不同机器上的服务器实例之间的组复制连接，您必须提供公共 IP 地址，并将这些指定为明确的允许列表。如果您指定了允许列表的任何条目，则不会自动添加私有和 localhost 地址，因此如果您使用任何这些地址，必须明确指定它们。

要手动指定允许列表，请使用系统变量 `group_replication_ip_allowlist`（MySQL 8.0.22 及更高版本）或 `group_replication_ip_whitelist`。在 MySQL 8.0.24 之前，您不能在服务器作为复制组的活跃成员时更改允许列表。如果成员是活跃的，您必须在更改允许列表之前执行 STOP GROUP_REPLICATION，并在之后执行 START GROUP_REPLICATION。从 MySQL 8.0.24 开始，您可以在组复制运行时更改允许列表。

允许列表必须包含每个成员的 `group_replication_local_address` 系统变量中指定的 IP 地址或主机名。这个地址不同于 MySQL 服务器 SQL 协议的主机和端口，并且不在服务器实例的 `bind_address` 系统变量中指定。如果作为服务器实例的组复制本地地址使用的主机名解析为 IPv4 和 IPv6 地址，组复制连接会优先使用 IPv4 地址。

作为分布式恢复端点指定的 IP 地址和用于分布式恢复的成员的标准 SQL 客户端连接（这是默认设置）的 IP 地址不需要添加到允许列表中。允许列表仅用于每个成员的 `group_replication_local_address` 指定的地址。加入成员必须通过允许列表允许其初始连接到组，以检索分布式恢复的地址或地址。

在允许列表中，您可以指定以下任意组合：

- IPv4 地址（例如，198.51.100.44）
- 带 CIDR 表示法的 IPv4 地址（例如，192.0.2.21/24）
- IPv6 地址，从 MySQL 8.0.14 开始（例如，2001:db8:85a3:8d3:1319:8a2e:370:7348）
- 带 CIDR 表示法的 IPv6 地址，从 MySQL 8.0.14 开始（例如，2001:db8:85a3:8d3::/64）
- 主机名（例如，example.org）
- 带 CIDR 表示法的主机名（例如，www.example.com/24）

在 MySQL 8.0.14 之前，主机名只能解析为 IPv4 地址。从 MySQL 8.0.14 开始，主机名可以解析为 IPv4地址、IPv6 地址或两者。如果主机名解析为 IPv4 和 IPv6 地址，则组复制连接始终使用 IPv4 地址。您可以结合使用 CIDR 表示法和主机名或 IP 地址来允许具有特定网络前缀的 IP 地址块，但请确保指定子网中的所有 IP 地址都在您的控制之下。

> **注意**
>
> 当 IP 地址的连接尝试因为地址不在允许列表中而被拒绝时，拒绝消息总是以 IPv6 格式打印 IP 地址。在此格式中，IPv4 地址前面带有 ::ffff:（一个 IPV4 映射的 IPv6 地址）。您不需要在允许列表中使用此格式指定 IPv4 地址；对它们使用标准的 IPv4 格式。

允许列表中的每个条目必须用逗号分隔。例如：

```sql
mysql> SET GLOBAL group_replication_ip_allowlist="192.0.2.21/24,198.51.100.44,203.0.113.0/24,2001:db8:85a3:8d3:1319:8a2e:370:7348,example.org,www.example.com/24";
```

要加入复制组，服务器需要在其请求加入组的种子成员上获得许可。通常，这将是复制组的引导成员，但它可以是服务器加入组的配置中由 `group_replication_group_seeds` 选项列出的任何服务器。如果组的任何种子成员在加入成员有 IPv4 `group_replication_local_address` 时以 IPv6 地址列在 `group_replication_group_seeds` 选项中，反之亦然，则您还必须为加入成员设置并允许种子成员提供的协议的备用地址（或解析为该协议的地址的主机名）。这是因为当服务器加入复制组时，它必须使用种子成员在 `group_replication_group_seeds` 选项中宣传的协议进行最初的联系，无论是 IPv4 还是 IPv6。如果加入成员没有适当协议的允许地址，则其连接尝试将被拒绝。有关管理混合 IPv4 和 IPv6 复制组的更多信息，请参见第 18.5.5 节，“支持 IPv6 和混合 IPv6 和 IPv4 组”。

当复制组重新配置时（例如，当选举出新的主成员或成员加入或离开时），组成员之间重新建立连接。如果组成员仅被重新配置后不再是复制组一部分的服务器允许，则它无法重新连接到不允许它的剩余复制组中的服务器。为了完全避免这种情况，请为复制组的所有服务器指定相同的允许列表。

> **注意**
>
> 根据您的安全要求，可以在不同的组成员上配置不同的允许列表，例如，为了保持不同子网的隔离。如果您需要配置不同的允许列表以满足您的安全要求，请确保复制组中的允许列表之间有足够的重叠，以最大限度地增加服务器在没有原始种子成员的情况下能够重新连接的可能性。

对于主机名，仅在另一台服务器发出连接请求时进行名称解析。无法解析的主机名不会被考虑用于允许列表验证，并且错误日志中会写入警告消息。对已解析的主机名进行正向确认的反向 DNS（FCrDNS）验证。

> **警告**
>
> 主机名在允许列表中本质上不如 IP 地址安全。FCrDNS 验证提供了良好的保护水平，但可能会受到某些类型攻击的影响。仅在绝对必要时在您的允许列表中指定主机名，并确保用于名称解析的所有组件，如 DNS 服务器，都在您的控制之下。您还可以使用 hosts 文件实现本地名称解析，以避免使用外部组件。