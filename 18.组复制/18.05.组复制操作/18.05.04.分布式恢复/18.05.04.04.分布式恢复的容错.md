#### 18.5.4.4 分布式恢复的容错机制

组复制的分布式恢复过程中内置了多种措施，以确保在过程中出现任何问题时的容错能力。

分布式恢复的捐赠者是从当前视图中现有的合适在线组成员列表中随机选取的。随机选择捐赠者意味着当多个成员加入组时，相同的服务器不会被多次选中。从MySQL 8.0.17开始，对于从二进制日志的状态传输，加入者只选择运行低于或等于自己的MySQL服务器补丁版本的捐赠者。对于早期版本，所有在线成员都允许成为捐赠者。对于远程克隆操作，加入者只选择运行与自己相同补丁版本的捐赠者。请注意，当加入成员在操作结束时重启，它会与一个新的捐赠者建立连接以进行从二进制日志的状态传输，这可能是不同于最初用于远程克隆操作的捐赠者。

在以下情况下，组复制会检测到分布式恢复中的错误，自动切换到新的捐赠者，并重试状态传输：

- 连接错误 -  存在身份验证问题或与候选捐赠者建立连接的其他问题。
- 复制错误 - 用于从二进制日志进行状态传输的复制线程（接收者或应用者线程）失败。由于此状态传输方法使用现有的MySQL复制框架，一些瞬态错误可能会导致接收者或应用者线程出错。
- 远程克隆操作错误 - 远程克隆操作失败或在完成前被停止。
- 捐赠者离开组 - 捐赠者离开组，或者在状态传输过程中停止了组复制。

Performance Schema表 `replication_applier_status_by_worker` 显示了导致最后一次重试的错误。在这些情况下，错误后的新连接会尝试与新的候选捐赠者建立。在错误发生时选择不同的捐赠者意味着新的候选捐赠者可能没有相同的错误。如果安装了克隆插件，组复制首先尝试与每个合适的在线支持克隆的捐赠者进行远程克隆操作。如果所有这些尝试都失败，组复制会尝试依次与所有合适的捐赠者进行从二进制日志的状态传输（如果可能的话）。

> **警告**
>
> 对于远程克隆操作，接收方（加入成员）上的用户创建的表空间和数据在远程克隆操作开始传输捐赠者的数据之前会被删除。如果远程克隆操作开始但未完成，加入成员可能会留下一部分原始数据文件，或者没有用户数据。如果克隆操作在数据完全克隆之前被停止，捐赠者传输的数据将从接收方删除。可以通过重试克隆操作来修复这种情况，组复制会自动进行。

在以下情况下，分布式恢复过程无法完成，加入成员将离开组：

- 已清除的事务 - 加入成员所需的事务不存在于任何在线组成员的二进制日志文件中，并且无法通过远程克隆操作获取数据（因为未安装克隆插件，或者尝试了所有可能的捐赠者但失败）。因此，加入成员无法赶上组。
- 额外的事务 - 加入成员已包含组中不存在的一些事务。如果进行了远程克隆操作，这些事务将被删除并丢失，因为加入成员上的数据目录将被擦除。如果进行了捐赠者二进制日志的状态传输，则这些事务可能与组的事务冲突。有关处理此情况的建议，请参见额外的事务。

- 达到连接重试限制 - 加入成员已进行了 `group_replication_recovery_retry_count` 系统变量允许的所有连接尝试（参见第18.5.4.3节，“配置分布式恢复”）。
- 没有更多的捐赠者 - 加入成员先后尝试了每个在线支持克隆的捐赠者（如果安装了克隆插件），然后尝试了从二进制日志进行状态传输的每个合适的在线捐赠者，但均未成功。
- 加入成员离开组 - 加入成员离开组，或者在状态传输过程中停止了组复制。

如果加入成员无意中离开了组，即上述情况中的任何一种（除了最后一种），它会采取由 `group_replication_exit_state_action` 系统变量指定的操作。