#### 18.5.4.2 分布式恢复的克隆

MySQL服务器的克隆插件从MySQL 8.0.17开始提供。如果您想在组中使用远程克隆操作进行分布式恢复，必须事先为现有成员和加入成员设置以支持此功能。如果您不想在组中使用此功能，请不要设置它，在这种情况下，组复制只使用来自二进制日志的状态传输。

要使用克隆，至少需要一个现有的组成员和加入成员事先设置以支持远程克隆操作。作为最低要求，您必须在捐赠者和加入成员上安装克隆插件，授予分布式恢复的复制用户`BACKUP_ADMIN`权限，并将`group_replication_clone_threshold`系统变量设置为适当的水平。为了确保捐赠者的最大可用性，建议设置所有当前和未来的组成员以支持远程克隆操作。

请注意，远程克隆操作在从捐赠者传输数据之前会移除加入成员上的用户创建的表空间和数据。如果操作在进行中停止，加入成员可能会留下部分数据或没有数据。可以通过重试远程克隆操作来修复这个问题，组复制会自动执行。

##### 18.5.4.2.1 克隆的先决条件

有关设置和配置克隆插件的完整说明，请参见第5.6.7节“克隆插件”。远程克隆操作的详细先决条件见第5.6.7.3节“克隆远程数据”。对于组复制，注意以下关键点和差异：

- 捐赠者（现有的组成员）和接收者（加入成员）必须安装并激活克隆插件。有关如何执行此操作的说明，请参见第5.6.7.1节“安装克隆插件”。

- 捐赠者和接收者必须运行相同的操作系统，并且必须拥有相同的MySQL服务器版本（必须是MySQL 8.0.17或以上版本以支持克隆插件）。因此，克隆不适合运行不同MySQL服务器版本的组成员。

- 捐赠者和接收者必须安装并激活组复制插件，任何在捐赠者上激活的其他插件（如密钥环插件）也必须在接收者上激活。

- 如果配置分布式恢复以使用SSL（`group_replication_recovery_use_ssl=ON`），组复制将此设置应用于远程克隆操作。组复制自动配置克隆SSL选项（`clone_ssl_ca`、`clone_ssl_cert`和`clone_ssl_key`）的设置，以匹配您对相应的组复制分布式恢复选项（`group_replication_recovery_ssl_ca`、`group_replication_recovery_ssl_cert`和`group_replication_recovery_ssl_key`）的设置。

- 您不需要为加入复制组的目的在`clone_valid_donor_list`系统变量中设置有效的捐赠者列表。组复制在从现有组成员中选择捐赠者后会自动为您配置此设置。请注意，远程克隆操作使用服务器的SQL协议主机名和端口。

- 克隆插件有许多系统变量来管理远程克隆操作的网络负载和性能影响。组复制不配置这些设置，因此您可以查看它们并根据需要设置它们，或者允许它们默认。请注意，当远程克隆操作用于分布式

恢复时，克隆插件的`clone_enable_compression`设置适用于操作，而不是组复制的压缩设置。

- 为了在接收者上调用远程克隆操作，组复制使用内部的`mysql.session`用户，该用户已经具有`CLONE_ADMIN`权限，因此您不需要设置此权限。

- 作为远程克隆操作中捐赠者的克隆用户，组复制使用您为分布式恢复设置的复制用户（在第18.2.1.3节“分布式恢复的用户凭证”中有说明）。因此，您必须在所有支持克隆的组成员上向此复制用户授予`BACKUP_ADMIN`权限。当您为组复制配置加入成员时，也要向复制用户授予权限，因为他们在加入组后可以充当捐赠者。每个组成员上的分布式恢复都使用相同的复制用户。要向现有成员上的复制用户授予此权限，您可以在每个组成员上单独禁用二进制日志的情况下发出以下语句，或者在一个组成员上启用二进制日志的情况下发出此语句：

  ```
  GRANT BACKUP_ADMIN ON *.* TO rpl_user@'%';
  ```

- 如果您使用`START GROUP_REPLICATION`来指定复制用户凭证在之前使用`CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO`提供用户凭证的服务器上，请确保在任何远程克隆操作发生之前从复制元数据存储库中删除用户凭证。同时确保在加入成员上设置`group_replication_start_on_boot=OFF`。有关说明，请参见第18.6.3节“保护分布式恢复连接”。如果您不取消设置用户凭证，它们将在远程克隆操作期间传输给加入成员。然后，`group_replication_recovery`通道可能会在原始成员或从其克隆的成员上无意中使用存储的凭证启动。服务器启动时（包括远程克隆操作后）自动启动组复制将使用存储的用户凭证，如果操作员未在`START GROUP_REPLICATION`命令上指定分布式恢复凭证，也将使用这些凭证。

##### 18.5.4.2.2 克隆的阈值

当组成员已经设置为支持克隆时，`group_replication_clone_threshold`系统变量指定一个阈值，以事务数量表示，用于在分布式恢复中使用远程克隆操作。如果捐赠者的事务与加入成员的事务之间的差距大于此数字，当技术上可能时，将使用远程克隆操作对加入成员进行状态传输。组复制基于现有组成员的`gtid_executed`集合来计算是否超过了阈值。在大事务差距的情况下使用远程克隆操作，使您能够在不手动将组的数据传输到服务器的情况下向组中添加新成员，也使非常过时的成员能够更有效地追赶。

`group_replication_clone_threshold`组复制系统变量的默认设置非常高（GTID中事务的最大允许序列号），因此它在从二进制日志的状态传输可能的情况下有效地停用了克隆。要启用组复制在更合适的情况下选择远程克隆操作进行状态传输，请设置系统变量以指定一个事务差距，超过该事务差距您希望进行克隆。

> 警告
> 不要在活跃的组中为

`group_replication_clone_threshold`设置较低的值。如果在远程克隆操作进行期间，组中发生超过阈值的事务数量，加入成员在重启后可能会再次触发远程克隆操作，并可能无限期地继续这一过程。为避免这种情况，请确保将阈值设置为高于您预期在远程克隆操作所需时间内组中可能发生的事务数量。

即使您的阈值未达到，只要从捐赠者的二进制日志进行状态传输变得不可能（例如因为加入成员所需的事务在任何现有组成员的二进制日志中不可用），组复制也会尝试执行远程克隆操作。组复制基于现有组成员的`gtid_purged`集合来识别这一点。当所需的事务在任何成员的二进制日志文件中不可用时，您无法使用`group_replication_clone_threshold`系统变量停用克隆，因为在那种情况下，克隆是将数据手动传输给加入成员的唯一替代方案。

##### 18.5.4.2.3 克隆操作

当组成员和加入成员为克隆设置好后，组复制会为您管理远程克隆操作。远程克隆操作可能需要一些时间才能完成，具体取决于数据的大小。有关监控过程的信息，请参见第5.6.7.10节“监控克隆操作”。

> 注意
> 当状态传输完成后，组复制会重启加入成员以完成过程。如果在加入成员上设置了`group_replication_start_on_boot=OFF`，例如因为您在`START GROUP_REPLICATION`语句上指定了复制用户凭证，您必须在此重启后再次手动发出`START GROUP_REPLICATION`。如果设置了`group_replication_start_on_boot=ON`，并且其他启动组复制所需的设置已在配置文件中设置或使用`SET PERSIST`语句设置，您无需干预，过程会自动继续，使加入成员上线。

如果远程克隆程序花费很长时间，在MySQL 8.0.22之前的版本中，积累的用于组的认证信息集合可能会变得过大而无法传输给加入成员。在这种情况下，加入成员会记录错误消息并不加入组。从MySQL 8.0.22开始，组复制以不同的方式管理应用事务的垃圾收集过程，以避免这种情况。在早期版本中，如果您看到这个错误，在远程克隆操作完成后，请等待两分钟以进行一轮垃圾收集，以减少组的认证信息的大小。然后在加入成员上发出以下语句，使其停止尝试应用先前的认证信息集合：

  ```
  RESET SLAVE FOR CHANNEL group_replication_recovery;
  ```
  或者从MySQL 8.0.22开始：
  ```
  RESET REPLICA FOR CHANNEL group_replication_recovery;
  ```
远程克隆操作将从捐赠者克隆到接收者的设置和数据，这些设置存储在表中。组复制管理与组复制通道特别相关的设置。组复制成员在配置文件中持久化的设置，如组复制本地地址，不会被克隆，也不会在加入成员上更改。组复制还保留与SSL使用相关的通道设置，因此这些对每个成员都是独特的。

如果捐赠者用于`group_replication_recovery`复制通道的复制用户凭证已使用`CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO`

语句存储在复制元数据仓库中，这些凭证会在克隆后被传输到加入成员并在那里使用，它们必须在那里有效。存储的凭证意味着所有通过远程克隆操作接收状态传输的组成员因此自动接收分布式恢复的复制用户和密码。如果您在`START GROUP_REPLICATION`语句中指定了复制用户凭证，则这些凭证用于启动远程克隆操作，但克隆后不会被传输到加入成员并使用。如果您不希望凭证传输到新加入者并在那里记录，请确保在远程克隆操作发生之前取消设置它们，如第18.6.3节“保护分布式恢复连接”中所述，并使用`START GROUP_REPLICATION`来提供它们。

如果使用了`PRIVILEGE_CHECKS_USER`帐户来帮助保护复制应用程序（见第17.3.3.2节“组复制通道的权限检查”），从MySQL 8.0.19开始，捐赠者的`PRIVILEGE_CHECKS_USER`帐户和相关设置会被克隆到加入成员。如果加入成员设置为启动组复制，则它会自动在适当的复制通道上使用该帐户进行权限检查。（在MySQL 8.0.18中，由于一些限制，建议不要在组复制通道中使用`PRIVILEGE_CHECKS_USER`帐户。）

##### 18.5.4.2.4 其他目的的克隆

组复制启动和管理分布式恢复的克隆操作。已设置为支持克隆的组成员也可能参与用户手动启动的克隆操作。例如，您可能希望通过从组成员（作为捐赠者）克隆来创建一个新的服务器实例，但您不希望新服务器实例立即加入组，或者可能永远不会加入。

在所有支持克隆的版本中，您可以手动启动涉及已停止组复制的组成员的克隆操作。请注意，由于克隆要求捐赠者和接收者的活动插件必须匹配，即使您不打算让该服务器实例加入组，组复制插件也必须在另一个服务器实例上安装并激活。您可以通过发出以下语句来安装插件：

```
INSTALL PLUGIN group_replication SONAME 'group_replication.so';
```

在MySQL 8.0.20之前的版本中，如果操作涉及正在运行组复制的组成员，您无法手动启动克隆操作。从MySQL 8.0.20开始，您可以这样做，前提是克隆操作不会移除并替换接收者的数据。因此，如果组复制正在运行，则启动克隆操作的语句必须包含`DATA DIRECTORY`子句。