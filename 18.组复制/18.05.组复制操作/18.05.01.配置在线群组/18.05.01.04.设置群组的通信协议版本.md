#### 18.5.1.4 设置群组的通信协议版本

从 MySQL 8.0.16 开始，群组复制引入了群组的通信协议概念。群组复制通信协议版本可以显式管理，并设置为支持您希望群组支持的最旧的 MySQL 服务器版本。这使得可以由不同版本的 MySQL 服务器版本组成的成员形成群组，同时确保向后兼容。

- MySQL 5.7.14 及更高版本支持消息压缩（参见第 18.7.4 节，“消息压缩”）。

- MySQL 8.0.16 及更高版本还支持消息分片（参见第 18.7.5 节，“消息分片”）。

- MySQL 8.0.27 及更高版本还允许群组通信引擎在群组处于单主模式且 `group_replication_paxos_single_leader` 设置为 true 时操作单一共识领导者（参见第 18.7.3 节，“单一共识领导者”）。


群组的所有成员必须使用相同的通信协议版本，以便群组成员可以在不同的 MySQL 服务器版本上运行，但只发送所有群组成员都能理解的消息。

如果群组的通信协议版本小于或等于 X，则版本 X 的 MySQL 服务器才能加入复制群组并达到在线状态。当新成员加入复制群组时，它会检查群组现有成员宣布的通信协议版本。如果加入成员支持该版本，它会加入群组并使用群组宣布的通信协议，即使该成员支持额外的通信能力。如果加入成员不支持通信协议版本，它将被从群组中驱逐。

如果两个成员尝试在同一成员更改事件中加入，则只有当两个成员的通信协议版本已与群组的通信协议版本兼容时，他们才能加入。具有不同于群组的通信协议版本的成员必须单独加入。例如：

- 一个 MySQL 服务器 8.0.16 实例可以成功加入使用通信协议版本 5.7.24 的群组。

- 一个 MySQL 服务器 5.7.24 实例不能成功加入使用通信协议版本 8.0.16 的群组。

- 两个 MySQL 服务器 8.0.16 实例不能同时加入使用通信协议版本 5.7.24 的群组。

- 两个 MySQL 服务器 8.0.16 实例可以同时加入使用通信协议版本 8.0.16 的群组。


您可以使用 `group_replication_get_communication_protocol()` 函数检查群组使用的通信协议，该函数返回群组支持的最旧 MySQL 服务器版本。群组的所有现有成员返回相同的通信协议版本。例如：

```sql
SELECT group_replication_get_communication_protocol();
+------------------------------------------------+
| group_replication_get_communication_protocol() |
+------------------------------------------------+
| 8.0.16                                         |
+------------------------------------------------+
```

请注意，`group_replication_get_communication_protocol()` 函数返回群组支持的最低 MySQL 版本，这可能与传递给 `group_replication_set_communication_protocol()` 函数的版本号不同，也可能与您在成员上使用该函数的 MySQL 服务器版本不同。

如果您需要更改群组的通信协议版本，以便更早版本的成员可以加入，请使用 `group_replication_set_communication_protocol()` 函数指定您希望允许的最旧成员的 MySQL 服务器版本。这使得群组可以回退到兼容的通信协议版本（如果可能）。使用此功能需要 `GROUP_REPLICATION_ADMIN` 权限，并且在您发出声明

时，所有现有群组成员必须在线且没有丧失多数。例如：

```sql
SELECT group_replication_set_communication_protocol("5.7.25");
```

如果您将复制群组的所有成员升级到新的 MySQL 服务器版本，群组的通信协议版本不会自动升级以匹配。如果您不再需要支持更早版本的成员，您可以使用 `group_replication_set_communication_protocol()` 函数将通信协议版本设置为您已升级成员的新 MySQL 服务器版本。例如：

```sql
SELECT group_replication_set_communication_protocol("8.0.16");
```

`group_replication_set_communication_protocol()` 函数作为群组操作实现，因此在群组的所有成员上同时执行。群组操作开始缓冲消息，并等待已在进行中的任何外发消息的传递完成，然后更改通信协议版本并发送缓冲的消息。如果在您更改通信协议版本之后的任何时间有成员试图加入群组，群组成员会宣布新的协议版本。

MySQL InnoDB 集群在使用 AdminAPI 操作更改集群拓扑时，会自动且透明地管理其成员的通信协议版本。InnoDB 集群始终使用当前属于集群或加入集群的所有实例支持的最新通信协议版本。有关详细信息，请参阅 InnoDB 集群和群组复制协议。