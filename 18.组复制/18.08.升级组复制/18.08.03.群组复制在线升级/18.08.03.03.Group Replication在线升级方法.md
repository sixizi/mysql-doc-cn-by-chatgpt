#### 18.8.3.3 Group Replication Online Upgrade Methods

选择以下一种方法来升级 Group Replication 组：

##### 滚动内部升级

只要较新版本的服务器不在组中生成工作负载，就支持此方法。换句话说，具有较新版本的服务器只能作为辅助成员加入组。在此方法中，只有一个组，每个服务器实例都会从组中移除，升级，然后重新加入组。

这种方法非常适合单主组。在单主模式下，如果您要求主成员在整个过程中保持不变（除非它本身正在升级），则应该将其升级为最后一个成员。主成员不能保持为主成员，除非它运行的 MySQL Server 版本是组中最低的。在主成员升级后，您可以使用 `group_replication_set_as_primary()` 函数将其重新指定为主成员。如果不介意哪个成员是主要成员，那么可以以任何顺序升级成员。组会根据需要从运行最低 MySQL Server 版本的成员中选择新的主成员，遵循第 18.1.3.1 节“单主模式”的选举策略。

对于以多主模式运行的组，在进行组内滚动升级期间，主要成员的数量会减少，从而导致写入可用性降低。这是因为如果成员在组运行的 MySQL Server 版本高于现有组成员运行的最低版本时加入组，它会自动保持为只读模式（super_read_only=ON）。注意，运行 MySQL 8.0.17 或更高版本的成员在检查此时会考虑发布的补丁版本，但运行 MySQL 8.0.16 或更低版本，或运行 MySQL 5.7 的成员只考虑主版本。从 MySQL 8.0.17 开始，当组中的所有成员都升级到相同的发布版时，它们都会自动切换回读写模式。对于早期的版本，您必须在升级后的每个成员上手动设置 super_read_only=OFF，以使其可以作为主成员运行。

有关组内版本兼容性和在升级过程中组行为如何受此影响的详细信息，请参阅第 18.8.1 节“在组中合并不同的成员版本”。

##### 滚动迁移升级

在这种方法中，您将成员从组中移除，然后升级它们，然后使用升级后的成员创建第二个组。对于以多主模式运行的组，在此过程中主要成员的数量会减少，导致写入可用性降低。这不会影响以单主模式运行的组。

由于在升级成员时，运行较旧版本的组仍然在线，因此您需要运行较新版本的组赶上执行升级后的成员时的任何事务。因此，新组中的一台服务器被配置为较旧组的主服务器的副本。这确保新组赶上较旧组。由于此方法依赖于用于从一个组复制数据到另一个组的异步复制通道，因此它在异步源-副本复制的相同假设和要求下受支持，详情请参见第 17 章“复制”。对于以单主模式运行的组，到旧组的异步复制连接必须将数据发送到新组的主要成员，对于多主组，异步复制通道可以连接到任何主要成员。

过程如下：

- 逐个从运行较旧服务器版本的原始组中删除成员，详见第 18.8.3.2 节“升级 Group Replication 成员”。

- 升级在成员上运行的服务器版本，详见第 2.10 节“升级 MySQL”。您可以选择在升级中使用原地升级或预配方法。

- 使用升级后的成员创建新组，详见第 18 章“Group Replication”。在这种情况下，您需要在每个成员上配置新组名称（因为旧组仍在运行并使用旧名称），引导初始升级成员，然后添加其余的升级成员。

- 在旧组和新组之间设置异步复制通道，详见第 17.1.3.4 节“使用 GTID 设置复制”。将较旧的主服务器配置为异步复制源服务器，将新组成员配置为基于 GTID 的副本。

在将应用程序重定向到新组之前，必须确保新组有足够数量的成员，以便例如组能够处理成员的故障。发出 `SELECT * FROM performance_schema.replication_group_members` 命令并比较初始组大小和新组大小。等待直到旧组的所有数据传播到新组，然后删除异步复制连接并升级任何丢失的成员。

##### 滚动复制升级

在这种方法中，您创建一个由运行较新版本的成员组成的第二个组，并将较旧组缺失的数据复制到较新组。这假定您有足够的服务器来同时运行两个组。由于在此过程中，运行较新版本的组的主要成员数量不减少，因此对于以多主模式运行的组，写入可用性不会降低。这使滚动复制升级非常适用于以多主模式运行的组。

这不会影响以单主模式运行的组。

由于在升级成员的同时在线运行较旧版本的组，因此您需要运行较新版本的组赶上执行升级成员时的任何事务。因此，新组中的一台服务器被配置为较旧组的主服务器的副本。这确保新组赶上较旧组。由于此方法依赖于用于从一个组复制数据到另一个组的异步复制通道，因此它在异步源-副本复制的相同假设和要求下受支持，详情请参见第 17 章“复制”。对于以单主模式运行的组，到旧组的异步复制连接必须将数据发送到新组的主要成员，对于多主组，异步复制通道可以连接到任何主要成员。

过程如下：

- 部署足够数量的成员，以便运行较新版本的组可以处理成员的故障。

- 从组的一员中获取现有数据的备份。

- 使用从较旧成员获取的备份来为新组的成员提供服务，详见第 18.8.3.4 节“使用 mysqlbackup 升级 Group Replication”。 

   > **注意**
   > 您必须将备份还原到与备份所采用的 MySQL 版本相同的版本，然后执行原地升级。有关说明，请参见第 2.10 节“升级 MySQL”。

- 使用升级后的成员创建新组，详见第 18 章“Group Replication”。在这种情况下，您需要在每个成员上配置新组名称（因为旧组仍在运行并使用旧名称），引导初始升级成员，然后添加其余的升级成员。

- 在旧组和新组之间设置异步复制通道，详见第 17.1.3.4 节“使用 GTID 设置复制”。将较旧的主服务器配置为异步复制源服务器，将新组成员配置为基于 GTID 的副本。

一旦较新组中缺失的数据足够小，可以快速传输，您必须将写操作重定向到新组。等待直到旧组的所有数据传播到新组，然后删除异步复制连接。