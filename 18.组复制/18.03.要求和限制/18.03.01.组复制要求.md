### 18.3.1 群组复制要求

[基础设施](#基础设施)

[服务器实例配置](#服务器实例配置)

用于群组复制的服务器实例必须满足以下要求。

#### 基础设施

- **InnoDB存储引擎**：数据必须存储在InnoDB事务存储引擎中。事务是乐观地执行的，然后在提交时检查冲突。如果存在冲突，为了在整个群组中保持一致性，某些事务会被回滚。这意味着需要一个事务存储引擎。此外，InnoDB提供了一些额外的功能，使得在与群组复制一起操作时更好地管理和处理冲突。使用其他存储引擎（包括临时的MEMORY存储引擎）可能会导致群组复制中出现错误。在使用实例进行群组复制之前，将其他存储引擎中的表转换为InnoDB。您可以通过在群组成员上设置`disabled_storage_engines`系统变量来防止使用其他存储引擎，例如：

  ```ini
  disabled_storage_engines="MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY"
  ```

- **主键**：每个要由群组复制的表必须有一个定义的主键，或非空唯一键作为主键等价物。这些键作为表中每行的唯一标识符是必需的，使系统能够通过识别每个事务修改了哪些行来确定哪些事务冲突。群组复制有自己的一套主键或主键等价物检查，并不使用`sql_require_primary_key`系统变量的检查。您可以为运行群组复制的服务器实例设置`sql_require_primary_key=ON`，也可以为群组复制通道设置`CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO`语句的`REQUIRE_TABLE_PRIMARY_KEY_CHECK`选项为ON。但请注意，您可能会发现一些在群组复制的内置检查下被允许的事务在设置`sql_require_primary_key=ON`或`REQUIRE_TABLE_PRIMARY_KEY_CHECK=ON`时不被允许。

- **网络性能**：MySQL群组复制设计用于在服务器实例彼此非常接近的集群环境中部署。群组的性能和稳定性可能受网络延迟和网络带宽的影响。所有群组成员之间必须始终保持双向通信。如果服务器实例的进站或出站通信被阻止（例如，通过防火墙或连接问题），该成员无法在群组中功能，并且群组成员（包括有问题的成员）可能无法为受影响的服务器实例报告正确的成员状态。

  从MySQL 8.0.14开始，您可以使用IPv4或IPv6网络基础设施，或两者的混合，进行远程群组复制服务器之间的TCP通信。也没有任何阻止群组复制通过虚拟私有网络（VPN）运行的情况。

  同样从MySQL 8.0.14开始，当群组复制服务器实例共同定位并共享本地群组通信引擎（XCom）实例时，会使用具有较低开销的专用输入通道进行通信，而不是TCP套接字。对于某些群组复制任务，需要在远程XCom实例之间进行通信，例如加入群组，仍然使用TCP网络，因此网络性能影响群组的性能。

#### 服务器实例配置

作为群组成员的服务器实例必须按照如下所示进行配置。

- **唯一服务器标识符**：使用`server_id`系统变量为服务器配置唯一的服务器ID，这对所有复制拓扑中的服务器都是必需的。服务器ID必须是1和$(2^{32})−1$之间的正整数，并且必须与复制拓扑中任何其他服务器使用的任何其他服务器ID不同。

- **激活二进制日志**：设置`--log-bin[=log_file_name]`。从MySQL 8.0开始，默认启用二进制日志，除非您想更改二进制日志文件的名称，否则无需指定此选项。群组复制复制二进制日志的内容，因此需要开启二进制日志才能操作。参见第5.4.4节，“二进制日志”。

- **记录复制更新**：设置`log_replica_updates=ON`（从MySQL 8.0.26开始）或`log_slave_updates=ON`（在MySQL 8.0.26之前）。从MySQL 8.0开始，此设置是默认值，因此您无需指定它。群组成员需要记录在加入时从其赠予者接收并通过复制应用程序应用的事务，并记录他们从群组接收并应用的所有事务。这使得群组复制能够通过从现有群组成员的二进制日志进行状态转移来进行分布式恢复。

- **二进制日志行格式**：设置`binlog_format=row`。此设置是默认设置，因此您无需指定它。群组复制依赖于基于行的复制格式，以在群组中的服务器之间一致地传播更改，并提取检测在群组中的不同服务器上并发执行的事务之间冲突所需的信息。从MySQL 8.0.19开始，`REQUIRE_ROW_FORMAT`设置会自动添加到群组复制的通道中，以强制在应用事务时使用基于行的复制。参见第17.2.1节，“复制格式”和第17.3.3节，“复制权限检查”。

- **关闭二进制日志校验和（至MySQL 8.0.20）**：截至MySQL 8.0.20及之前的版本，设置`binlog_checksum=NONE`。在这些版本中，群组复制无法使用校验和，也不支持二进制日志中存在校验和。从MySQL 8.0.21开始，群组复制支持校验和，因此群组成员可以使用默认设置`binlog_checksum=CRC32`，您无需指定它。

- **开启全局事务标识符**：设置`gtid_mode=ON`和`enforce_gtid_consistency=ON`。这些设置不是默认值。GTID基础的复制是群组复制所需的，它使用全局事务标识符来跟踪在群组中的每个服务器实例上提交的事务。参见第17.1.3节，“带全局事务标识符的复制”。

- **复制信息存储库**：设置`master_info_repository=TABLE`和`relay_log_info_repository=TABLE`。在MySQL 8.0中，这些设置是默认的，FILE设置已弃用。从MySQL 8.0.23开始，使用这些系统变量已弃用，因此省略系统变量，只允许默认值。复制应用程序需要将复制元数据写入`mysql.slave_master_info`和`mysql.slave_relay_log_info`系统表，以确保群组复制插件具有一致的恢复能力和对复制元数据的事务管理。参见第17.2.4.2节，“复制元数据存储库”。

- **事务写集提取**：设置`transaction_write_set_extraction=XXHASH64`，以便在收集行记录到二进制日志时，服务器也收集写集。在MySQL 8.0中，此设置是默认的，并且从MySQL 8.0.26开始，使用该系统变量已弃用。写集基于每行的主键，是唯一标识被更改行的简化和紧凑的视图。群组复制使用此信息进行冲突检测和所有群组成员的认证。

- **默认表加密**：在所有群组成员上将`default_table_encryption`设置为相同的值。默认的架构和表空间加密可以启用（ON）或禁用（OFF，默认），只要所有成员的设置相同即可。

- **表名小写**：在所有群组成员上将`lower_case_table_names`设置为相同的值。对于使用InnoDB存储引擎（群组复制所需）的情况，设置为1是正确的。请注意，这个设置并非在所有平台上都是默认的。

- **二进制日志依赖性跟踪**：将`binlog_transaction_dependency_tracking`设置为WRITESET可以提高群组成员的性能，这取决于群组的工作负载。虽然群组复制在从中继日志应用事务时执行自己的并行化，与为`binlog_transaction_dependency_tracking`设置的任何值无关，但此值会影响事务写入群组复制成员的二进制日志的方式。这些日志中的依赖信息用于协助分布式恢复的状态转移过程，即从捐赠者的二进制日志中进行，每当成员加入或重新加入群组时都会发生。

  > **注意**  
  >
  > 当`replica_preserve_commit_order`为ON时，将`binlog_transaction_dependency_tracking`设置为WRITESET与将其设置为WRITESET_SESSION具有相同的效果。

- **多线程应用程序**：群组复制成员可以配置为多线程复制，使事务能够并行应用。从MySQL 8.0.27开始，默认情况下，所有复制都配置为多线程。系统变量`replica_parallel_workers`（从MySQL 8.0.26开始）或`slave_parallel_workers`（在MySQL 8.0.26之前）的非零值在成员上启用多线程应用程序。从MySQL 8.0.27开始，默认值为4个并行应用程序线程，最多可以指定1024个并行应用程序线程。对于多线程复制，还需要以下设置，这些设置从MySQL 8.0.27开始是默认的：

  - `replica_preserve_commit_order=ON`（从MySQL 8.0.26开始）或`slave_preserve_commit_order=ON`（在MySQL 8.0.26之前）
  
    此设置是为了确保并行事务的最终提交顺序与原始事务相同。群组复制依赖于围绕所有参与成员以相同顺序接收和应用已提交事务的保证所构建的一致性机制。

  - `replica_parallel_type=LOGICAL_CLOCK`（从MySQL 8.0.26开始）或`slave_parallel_type=LOGICAL_CLOCK`（在MySQL 8.0.26之前）
  
    与`replica_preserve_commit_order=ON`或`slave_preserve_commit_order=ON`一起使用时需要此设置。它指定了用于决定哪些事务可以在复制上并行执行的策略。

  将`replica_parallel_workers=0`或`slave_parallel_workers=0`设置为禁用并行执行，为复制提供单个应用程序线程和没有协调线程。在这种设置下，`replica_parallel_type`或`slave_parallel_type`和`replica_preserve_commit_order`或`slave_preserve_commit_order`选项无效并被忽略。从MySQL 8.0.27开始，如果在使用GTIDs的复制上禁用了并行执行，复制实际上使用一个并行工作线程，以利用不访问文件位置重试事务的方法。然而，这种行为对用户来说并没有改变。

- **分离的XA事务**：MySQL 8.0.29及更高版本支持分离的XA事务。分离的事务是指一旦准备好，就不再与当前会话连接的事务。这会在执行XA PREPARE时自动发生。准备好的XA事务可以由另一个连接提交或回滚，当前会话然后可以启动另一个XA事务或本地事务，而不必等待刚刚准备好的事务完成。

  当启用了分离的XA事务支持（`xa_detach_on_prepare = ON`）时，任何连接到此服务器的连接都可以列出（使用XA RECOVER）、回滚或提交任何准备好的XA事务。此外，您不能在分离的XA事务中使用临时表。

  您可以通过将`xa_detach_on_prepare`设置为OFF来禁用分离的XA事务支持，但不推荐这样做。特别是，如果此服务器正在作为MySQL群组复制中的实例设置，您应该将此变量保留为其默认值（ON）。

  有关更多信息，请参见第13.3.8.2节，“XA事务状态”。

