### 18.3.2 组复制限制

[组大小的限制](#组大小的限制)

[事务大小的限制](#事务大小的限制)

以下是群组复制的已知限制。请注意，对多主模式群组所描述的限制和问题在单主模式集群的故障转移事件期间也可能适用，此时新选举的主节点正在清空旧主节点的应用队列。

> **提示**
>
> 群组复制建立在基于GTID的复制上，因此您还应该了解第17.1.3.7节，“带GTIDs的复制限制”。

- **--upgrade=MINIMAL选项**：使用MINIMAL选项（--upgrade=MINIMAL）进行MySQL服务器升级后，无法启动群组复制，该选项不升级复制内部所依赖的系统表。

- **间隙锁**：群组复制的并发事务认证过程不考虑间隙锁，因为关于间隙锁的信息在InnoDB外部不可用。有关更多信息，请参见间隙锁。

  > **注意**
  >
  > 对于多主模式的群组，除非您依赖于应用程序中的REPEATABLE READ语义，我们建议在群组复制中使用READ COMMITTED隔离级别。InnoDB在READ COMMITTED中不使用间隙锁，这使得InnoDB内部的本地冲突检测与群组复制执行的分布式冲突检测一致。对于单主模式的群组，只有主节点接受写入，因此READ COMMITTED隔离级别对群组复制来说不重要。

- **表锁和命名锁**：认证过程不考虑表锁（参见第13.3.6节，“LOCK TABLES和UNLOCK TABLES语句”）或命名锁（参见GET_LOCK()）。

- **二进制日志校验和**：截至MySQL 8.0.20，群组复制无法使用校验和，也不支持在二进制日志中存在校验和，因此您必须在配置服务器实例成为群组成员时设置binlog_checksum=NONE。从MySQL 8.0.21开始，群组复制支持校验和，因此群组成员可以使用默认设置binlog_checksum=CRC32。所有群组成员的binlog_checksum设置不必相同。

  当可用校验和时，群组复制不使用它们来验证group_replication_applier通道上的传入事件，因为这些事件是从多个来源写入该中继日志，并在实际写入来源服务器的二进制日志之前写入，这是生成校验和的时候。校验和用于验证group_replication_recovery通道上以及群组成员上的任何其他复制通道上的事件的完整性。

- **SERIALIZABLE隔离级别**：默认情况下，多主模式群组不支持SERIALIZABLE隔离级别。将事务隔离级别设置为SERIALIZABLE会配置群组复制拒绝提交该事务。

- **并发DDL与DML操作**：在多主模式下，不支持对同一对象但在不同服务器上执行的并发数据定义语句和数据操作语句。在对象上执行数据定义语言（DDL）语句时，在不同服务器实例上对同一对象执行并发数据操作语言（DML）有风险，即在不同实例上执行的冲突DDL可能无法被检测到。

- **具有级联约束的外键**：多主模式群组（所有成员均配置为group_replication_single_primary_mode=OFF）不支持具有多级外键依赖关系的表，特别是定义了级联外键约束的表。这是因为由多主模式群组执行的导致级联操作的外键约束可能导致未检测到的冲突，并导致群组成员之间的数据不一致。因此，我们建议在多主模式群组中使用的服务器实例上设置`group_replication_enforce_update_everywhere_checks=ON`，以避免未检测到的冲突。

- 在单主模式下这不是问题，因为它不允许对群组的多个成员进行并发写入，因此不存在未检测到的冲突的风险。

- **多主模式死锁**：当群组以多主模式运行时，SELECT .. FOR UPDATE语句可能导致死锁。这是因为锁不在群组的成员之间共享，因此对于这样的语句可能无法达到预期效果。

- **复制过滤器**：在配置为群组复制的MySQL服务器实例上不能使用全局复制过滤器，因为在一些服务器上过滤事务会使群组无法就一致状态达成一致。可以在与群组复制没有直接关系的复制通道上使用通道特定的复制过滤器，例如群组成员还充当群组外源的副本。它们不能用于group_replication_applier或group_replication_recovery通道。

- **加密连接**：从MySQL 8.0.16开始，如果MySQL使用OpenSSL 1.1.1或更高版本编译，则MySQL Server支持TLSv1.3协议。在MySQL 8.0.16和MySQL 8.0.17中，如果服务器支持TLSv1.3，则该协议不受群组通信引擎支持，不能由群组复制使用。群组复制从MySQL 8.0.18开始支持TLSv1.3，在那里它可以用于群组通信连接和分布式恢复连接。

  在MySQL 8.0.18中，TLSv1.3可以在群组复制中用于分布式恢复连接，但group_replication_recovery_tls_version和group_replication_recovery_tls_ciphersuites系统变量不可用。因此，捐赠服务器必须允许使用至少一种默认启用的TLSv1.3密码套件，如第6.3.2节所列，“加密连接TLS协议和密码套件”。从MySQL 8.0.19开始，您可以使用选项配置客户端支持任何选择的密码套件，包括仅非默认密码套件（如果您愿意）。

- **克隆操作**：群组复制启动并管理分布式恢复的克隆操作，但已设置为支持克隆的群组成员也可以参与用户手动启动的克隆操作。在MySQL 8.0.20之前的版本中，如果操作涉及运行群组复制的群组成员，则无法手动启动克隆操作。从MySQL 8.0.20开始，您可以这样做，前提是克隆操作不会移除并替换接收者的数据。因此，如果群组复制正在运行，则启动克隆操作的语句必须包含DATA DIRECTORY子句。有关更多信息，请参见第18.5.4.2.4节，“其他目的的克隆”。

#### 组大小的限制

单个复制群组中可以是成员的MySQL服务器的最大数量是9。如果有更多成员尝试加入群组，他们的请求将被拒绝。这个限制是通过测试和基准测试确定的，作为群组在稳定的局域网上可靠地运行的安全边界。

#### 事务大小的限制

如果单个事务导致消息内容足够大以至于消息无法在5秒的窗口内通过网络在群组成员之间复制，成员可能会因忙于处理事务而被怀疑失败，然后被驱逐。大型事务还可能因内存分配问题导致系统变慢。为避免这些问题，请使用以下缓解措施：

- 如果由于大型消息而发生不必要的驱逐，请使用系统变量`group_replication_member_expel_timeout`来在怀疑成员失败之前允许更多时间。您可以允许在最初5秒的检测期后多达一个小时的时间，然后再将可疑成员从群组中驱逐。从MySQL 8.0.21开始，默认情况下允许额外5秒。
- 尽可能在群组复制处理之前限制事务的大小。例如，将用于LOAD DATA的文件分割成更小的块。
- 使用系统变量`group_replication_transaction_size_limit`来指定群组接受的最大事务大小。在MySQL 8.0中，此系统变量默认为最大事务大小为150000000字节（约143MB）。超过此大小的事务将被回滚，并且不会发送到群组复制的群组通信系统（GCS）进行分发到群组。根据您需要群组容忍的最大消息大小调整此变量的值，同时请记住，处理事务所需的时间与其大小成正比。
- 使用系统变量`group_replication_compression_threshold`来指定应用压缩的消息大小。此系统变量默认为1000000字节（1MB），因此大型消息将自动压缩。在接收到由group_replication_transaction_size_limit设置允许但超过group_replication_compression_threshold设置的消息时，群组复制的群组通信系统（GCS）执行压缩。有关更多信息，请参见第18.7.4节，“消息压缩”。
- 使用系统变量`group_replication_communication_max_message_size`来指定将消息分片的消息大小。此系统变量默认为10485760字节（10MiB），因此大型消息将自动分片。如果压缩后的消息仍超过group_replication_communication_max_message_size限制，则GCS在压缩后执行分片。为了使复制群组使用分片，所有群组成员必须在MySQL 8.0.16或更高版本，并且群组正在使用的群组复制通信协议版本必须允许分片。有关更多信息，请参见第18.7.5节，“消息分片”。

最大事务大小、消息压缩和消息分片都可以通过为相关系统变量指定零值来停用。如果您已停用所有这些保障措施，则群组成员上的应用程序线程可以处理的消息的上限大小是成员的replica_max_allowed_packet或slave_max_allowed_packet系统变量的值，其默认值和最大值为1073741824字节（1GB）。超过此限制的消息在接收成员尝试处理时会失败。群组成员可以发起并尝试向群组传输的消息的上限大小为4294967295字节（约4GB）。这是群组复制的群组通信引擎（XCom，Paxos变体）接受的数据包大小的硬限制，该引擎在GCS处理消息后接收消息。当发起成员尝试广播超过此限制的消息时，消息将失败。