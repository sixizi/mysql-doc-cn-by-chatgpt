### 19.5.3 升级复制拓扑

在升级参与复制拓扑的服务器时，您需要考虑每个服务器在拓扑中的角色，并注意复制特有的问题。有关升级 MySQL 服务器实例的一般信息和指导，请参见第 3 章，“升级 MySQL”。

正如第 19.5.2 节“MySQL 版本间的复制兼容性”中所解释的，MySQL 支持从一个发行系列的源到下一个更高发行系列的副本进行复制，但不支持从后来发行系列的源到较早发行系列的副本进行复制。较早版本的副本可能没有处理源在后来版本中可以处理的事务所需的功能。因此，您必须先将复制拓扑中所有的副本升级到目标 MySQL 服务器版本，然后再将源服务器升级到目标版本。这样，您将永远不会处于副本仍处于较早版本而尝试处理来自较晚版本源的事务的情况。

在具有多个源的复制拓扑（多源复制）中，无论源或副本 MySQL 服务器的数量如何，不支持使用超过两个 MySQL 服务器版本。这一限制不仅适用于发行系列，也适用于同一发行系列内的版本号。例如，在这样的设置中，您不能同时使用 MySQL 8.0.22、MySQL 8.0.24 和 MySQL 8.0.28，尽管您可以使用其中任意两个版本一起使用。

如果需要降级复制拓扑中的服务器，必须先降级源，然后再降级副本。在副本上，您必须确保已完全处理二进制日志和中继日志，并在继续降级之前将其删除。

#### 发行版本间的行为变化

虽然这种升级顺序是正确的，但在从尚未升级的较早版本源复制到已升级的较晚版本副本时，仍可能遇到复制困难。如果源使用的语句或依赖的行为在副本安装的较晚版本中不再支持，就会发生这种情况。您可以使用 MySQL Shell 的升级检查器工具 `util.checkForServerUpgrade()` 来检查 MySQL 5.7 或 MySQL 8.0 服务器实例是否可以升级到 GA MySQL 8.0 版本。该工具将识别需要修复的任何问题，以便在升级后不会引起问题，包括在较晚版本中不再可用的功能和行为。有关升级检查器工具的信息，请参见“升级检查器工具”。

如果您正在将现有的复制设置从不支持全局事务标识符（GTIDs）的 MySQL 版本升级到支持 GTIDs 的版本，仅在确保设置满足基于 GTID 的复制的所有要求后才在源和副本上启用 GTIDs。有关使用 GTIDs 设置复制的信息，请参见第 19.1.3.4 节，“使用 GTIDs 设置复制”。

在严格 SQL 模式（STRICT_TRANS_TABLES 或 STRICT_ALL_TABLES）中影响操作的变化可能导致升级后的副本复制失败。如果使用基于语句的日志记录（binlog_format=STATEMENT），如果在源之前升级副本，源执行在那里成功但可能在副本上失败的语句，从而导致复制停止。为了处理这种情况，停止源上的所有新语句并等待副本赶上，然后升级副本。或者，如果您无法停止新语句，

暂时在源上更改为基于行的日志记录（binlog_format=ROW），并等待所有副本处理直到此更改点产生的所有二进制日志，然后升级副本。

MySQL 8.0 中默认字符集从 latin1 更改为 utf8mb4。在从 MySQL 5.7 升级到 8.0 的复制设置中，建议在升级之前将默认字符集更改回 MySQL 5.7 中使用的字符集。升级完成后，可以将默认字符集更改为 utf8mb4。假设之前使用了默认设置，一种保留它们的方法是在 my.cnf 文件中启动服务器时使用以下行：

```ini
[mysqld]
character_set_server=latin1
collation_server=latin1_swedish_ci
```

#### 标准升级程序

按照以下总体程序，根据第 3 章“升级 MySQL”中的指导，为每个单独的 MySQL 服务器实例升级复制拓扑：

1. 首先升级副本。在每个副本实例上：

   - 执行第 3.6 节“为升级准备您的安装”中描述的初步检查和步骤。


   - 关闭 MySQL 服务器。


   - 升级 MySQL 服务器二进制文件或包。


   - 重启 MySQL 服务器。


   - 如果您升级到的版本早于 MySQL 8.0.16，请手动调用 mysql_upgrade 来升级系统表和模式。当服务器以全局事务标识符（GTIDs）启用（gtid_mode=ON）运行时，不要启用 mysql_upgrade 的二进制日志记录（所以不要使用 --write-binlog 选项）。然后关闭并重启服务器。


   - 如果您升级到 MySQL 8.0.16 或更高版本，不要调用 mysql_upgrade。从该版本开始，MySQL 服务器执行整个 MySQL 升级过程，升级期间禁用二进制日志记录。
   - 使用 START REPLICA 或 START SLAVE 语句重启复制。

2. 当所有副本都已升级后，按照相同的步骤升级并重启源服务器，但不包括 START REPLICA 或 START SLAVE 语句。如果您进行了基于行的日志记录或默认字符集的临时更改，现在可以恢复更改。

#### 带表修复或重建的升级程序

某些升级可能需要您在从一个 MySQL 系列移动到下一个系列时删除并重新创建数据库对象。例如，排序规则更改可能需要重建表索引。如果必要，可以在第 3.5 节“MySQL 8.0 中的更改”中详细说明这些操作。在副本和源上单独执行这些操作，并禁用从源到副本的这些操作的复制是最安全的。为实现这一点，请使用以下程序：

1. 停止所有副本并升级二进制文件或包。使用 --skip-slave-start 选项或从 MySQL 8.0.24 开始，skip_slave_start 系统变量重新启动它们，使它们不连接到源。执行任何需要的表修复或重建操作来重新创建数据库对象，例如使用 REPAIR TABLE 或 ALTER TABLE，或转储并重载表或触发器。

2. 在源上禁用二进制日志。要在不重新启动源的情况下执行此操作，请执行 SET sql_log_bin = OFF 语句。或者，停止源并重新启动它，使用 --skip-log-bin 选项。如果您重新启动源，您还可能希望禁止客户端连接。例如，如果所有客户端使用 TCP/IP 连接，请在重新启动源时启用 skip_networking 系统变量。

3. 禁用二进制日志后，执行任何需要的表修复或重建操作来重新创建数据库对象。在此步骤中必须禁用二进制日志，以防止这些操作稍后被记录并发送到副本。

4. 在源上重新启用二进制日志。如果您之前将 sql_log_bin 设置为 OFF，执行 SET sql_log_bin = ON 语句。如果您重新启动源以禁用二进制日志，请在没有 --skip-log-bin 的情况下重新启动，并且不启用 skip_networking 系统变量，以便客户端和副本可以连接。

5. 重新启动副本，这次没有 --skip-slave-start 选项或 skip_slave_start 系统变量。