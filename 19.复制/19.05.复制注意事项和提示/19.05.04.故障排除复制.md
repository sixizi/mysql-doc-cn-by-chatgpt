19.5.4 故障排除复制问题

如果您已按照指示操作但您的复制设置未能正常工作，首先要做的是检查错误日志中的消息。许多用户在遇到问题后没有尽快这样做而浪费了时间。

如果您无法从错误日志中判断问题所在，请尝试以下技术：

通过执行 `SHOW MASTER STATUS` 语句来验证源是否启用了二进制日志记录。二进制日志记录默认是启用的。如果启用了二进制日志记录，`Position` 是非零的。如果未启用二进制日志记录，请验证您是否使用了任何禁用二进制日志记录的设置，例如 `--skip-log-bin` 选项。

验证在源和副本上都在启动时设置了 `server_id` 系统变量，并且每个服务器的 ID 值都是唯一的。

验证副本是否正在运行。使用 `SHOW REPLICA STATUS` 来检查 `Replica_IO_Running` 和 `Replica_SQL_Running` 值是否都是“是”。如果不是，请验证启动副本服务器时使用的选项。例如，命令行选项 `--skip-slave-start` 或从 MySQL 8.0.24 开始的 `skip_slave_start` 系统变量，会阻止复制线程启动，直到您发出 `START REPLICA` 命令。

如果副本正在运行，请检查它是否与源建立了连接。使用 `SHOW PROCESSLIST`，找到 I/O（接收者）和 SQL（应用者）线程并检查它们的 `State` 列显示的内容。参见第 19.2.3 节，“复制线程”。如果接收线程状态显示“Connecting to master”，请检查以下内容：

- 验证源上复制用户的权限。
- 检查源的主机名是否正确，以及您是否使用正确的端口连接到源。用于复制的端口与用于客户端网络通信的端口相同（默认是 3306）。对于主机名，请确保名称解析到正确的 IP 地址。
- 检查配置文件，看是否在源或副本上启用了 `skip_networking` 系统变量以禁用网络。如果是，注释掉该设置或将其移除。
- 如果源设置了防火墙或 IP 过滤配置，请确保用于 MySQL 的网络端口未被过滤。
- 检查您是否可以通过使用 ping 或 traceroute/tracert 来到达主机。

如果副本之前正在运行但已停止，原因通常是某些在源上成功的语句在副本上失败了。如果您已经正确地获取了源的快照，并且从未在复制线程之外修改过副本上的数据，这种情况永远不应该发生。如果副本意外停止，这是一个错误，或者您遇到了第 19.5.1 节“复制功能和问题”中描述的已知复制限制之一。如果是一个错误，请参见第 19.5.5 节“如何报告复制错误或问题”，了解如何报告它。

如果在源上成功的语句拒绝在副本上运行，如果不可行进行完整的数据库重新同步（通过删除副本的数据库并从源复制新的快照），请尝试以下程序：

确定副本上的受影响表是否与源表不同。尝试理解这是如何发生的。然后使副本的表与源的表相同，并运行 `START REPLICA`。

如果前面的步骤不起作用或不适用，请尝试理解是否可以安全地手动进行更新（如果需要），然后忽略来自源的下一条语句。

如果您决定副本可以跳过来自源的下一条语

句，请发出以下语句：

```sql
mysql> SET GLOBAL sql_slave_skip_counter = N;
mysql> START SLAVE;
```

或从 MySQL 8.0.26 开始：
```sql
mysql> SET GLOBAL sql_replica_skip_counter = N;
mysql> START REPLICA;
```
如果下一条来自源的语句不使用 `AUTO_INCREMENT` 或 `LAST_INSERT_ID()`，`N` 的值应为 1。否则，值应为 2。对于使用 `AUTO_INCREMENT` 或 `LAST_INSERT_ID()` 的语句，使用值 2 的原因是它们在源的二进制日志中占用两个事件。

另见 `SET GLOBAL sql_slave_skip_counter` 语法。

如果您确定副本最初与源完美同步，并且没有人在复制线程之外更新涉及的表，则假定差异是由于一个错误引起的。如果您正在运行 MySQL 的最新版本，请报告此问题。如果您正在运行较旧版本，请尝试升级到最新的生产版本以确定问题是否仍然存在。