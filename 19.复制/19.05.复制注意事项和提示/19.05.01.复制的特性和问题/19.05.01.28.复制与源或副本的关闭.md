#### 19.5.1.28 复制与源或副本的关闭

关闭复制源服务器并稍后重新启动它是安全的。当副本失去与源的连接时，副本会立即尝试重新连接，并在失败后定期重试。默认每60秒重试一次。这可以通过 `CHANGE REPLICATION SOURCE TO` 语句（从 MySQL 8.0.23 开始）或 `CHANGE MASTER TO` 语句（在 MySQL 8.0.23 之前）进行更改。副本还能够处理网络连接中断。然而，副本只有在源发送的数据中断达到 `replica_net_timeout` 或 `slave_net_timeout` 秒后才会注意到网络中断。如果您的中断时间很短，您可能希望减小 `replica_net_timeout` 或 `slave_net_timeout` 的值。有关处理副本意外停机的更多信息，请参见第 19.4.2 节，“处理副本的意外停止”。

源侧的非正常关闭（例如，崩溃）可能会导致源的二进制日志的最终位置小于副本读取的最新位置，因为源的二进制日志文件未被刷新。这可能导致源重新启动后副本无法进行复制。在源服务器的 `my.cnf` 文件中设置 `sync_binlog=1` 有助于最小化这个问题，因为它会使源更频繁地刷新其二进制日志。为了在使用 InnoDB 与事务的复制设置中获得尽可能高的持久性和一致性，您还应该设置 `innodb_flush_log_at_trx_commit=1`。通过这个设置，InnoDB 重做日志缓冲区的内容会在每次事务提交时写出到日志文件，并将日志文件刷新到磁盘。请注意，即使使用此设置，事务的持久性仍然无法得到保证，因为操作系统或磁盘硬件可能会告诉 `mysqld` 已经进行了刷新到磁盘的操作，即使实际上并未发生。

干净地关闭副本是安全的，因为它会跟踪它停止的位置。然而，要注意副本是否有打开的临时表；请参见第 19.5.1.31 节，“复制与临时表”。非正常关闭可能会产生问题，特别是如果磁盘缓存在问题发生前没有被刷新到磁盘：

- 对于事务，副本提交后更新 `relay-log.info`。如果在这两个操作之间发生意外退出，中继日志处理会比信息文件指示的更进一步，副本在重启后会重新执行中继日志中的最后一个事务的事件。

- 如果副本更新了 `relay-log.info`，但服务器主机在写入被刷新到磁盘之前崩溃，则可能发生类似的问题。为了最小化这种情况的发生，可以在副本的 `my.cnf` 文件中设置 `sync_relay_log_info=1`。将 `sync_relay_log_info` 设置为 0 不会强制写入被刷新到磁盘，服务器依赖操作系统不时刷新文件。


如果您有一个好的不间断电源供应，那么您的系统对这类问题的容错能力将大大增强。