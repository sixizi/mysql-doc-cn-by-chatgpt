#### 19.5.1.35 复制与事务

**在同一事务中混合使用事务性和非事务性语句。**一般来说，你应该避免在复制环境中更新事务性和非事务性表的事务。你还应避免使用访问事务性（或临时）和非事务性表并对任何表进行写操作的语句。

服务器使用以下规则进行二进制日志记录：

- 如果事务中的初始语句是非事务性的，它们将立即写入二进制日志。事务中的其余语句被缓存，直到事务提交时才写入二进制日志。（如果事务被回滚，缓存的语句只有在它们进行了无法回滚的非事务性更改时才写入二进制日志。否则，它们被丢弃。）

- 对于基于语句的日志记录，非事务性语句的记录受到系统变量 `binlog_direct_non_transactional_updates` 的影响。当此变量为 OFF（默认值）时，记录情况如前所述。当此变量为 ON 时，事务中任何位置的非事务性语句的记录都会立即进行。其他语句保留在事务缓存中，并在事务提交时记录。`binlog_direct_non_transactional_updates` 对行格式或混合格式的二进制日志记录没有影响。

**事务性、非事务性和混合语句。**服务器将只更改非事务性表的语句视为非事务性，将只更改事务性表的语句视为事务性。引用非事务性和事务性表并更新任何涉及表的语句被视为“混合”语句。混合语句，像事务性语句一样，被缓存并在事务提交时记录。

如果混合语句更新事务性表，并且该语句还执行以下任一操作，则该语句被认为是不安全的：
- 更新或读取临时表
- 读取非事务性表且事务隔离级别低于 `REPEATABLE_READ`

在事务中更新事务性表后的混合语句被认为是不安全的，如果它执行以下任一操作：
- 更新任何表并从任何临时表中读取
- 更新非事务性表且 `binlog_direct_non_transactional_updates` 为 OFF

有关二进制日志中安全和不安全语句的确定，请参见 19.2.1.3 节，“二进制日志中安全和不安全语句的确定”。

> **注意**
>
> 混合语句与混合二进制日志格式无关。
>

在事务中混合更新事务性和非事务性表的情况下，二进制日志中语句的顺序是正确的，所有需要的语句即使在回滚的情况下也会写入二进制日志。然而，当第二个连接在第一个连接事务完成前更新非事务性表时，因为第二个连接更新在执行后立即被写入，无论第一个连接的事务状态如何，语句可能会被记录在不同的顺序中。

**在源和副本上使用不同的存储引擎。**可以在源使用事务性表的情况下，在副本上使用非事务性表进行复制。例如，你可以将源的 InnoDB 表复制为副本的 MyISAM 表。然而，如果你这样做，在 `BEGIN ... COMMIT` 块中间停止副本可能会有问题，因为副本在 `BEGIN` 块的开始重新启动。

从源的 MyISAM 表到副本的事务性表（如使用 InnoDB 存储引擎的表）的事务复制也是安全的。在这种情况下，在源发出的 `AUTOCOMMIT=1` 语句被复制，从而在副本上强制执行 `AUTOCOMMIT` 模式。

当副本的存储引擎类型为非事务性时，应避免在源上混合更新事务性和非事务性表的事务，因为它们可能导致源事务性表与副本非事务性表之间的数据不一致。即这种事务可能导致源存储引擎特定的行为，可能导致复制失去同步。MySQL 不会就此发出警告，因此在将事务性表从源复制到副本的非事务性表时需要特别小心。

**在事务中更改二进制日志格式。**`binlog_format` 和 `binlog_checksum` 系统变量在事务进行中是只读的。

每个事务（包括自动提交事务）在二进制日志中的记录就像它以 `BEGIN` 语句开始，并以 `COMMIT` 或 `ROLLBACK` 语句结束。即使是影响使用非事务性存储引擎（如 MyISAM）的表的语句也是如此。

> **注意**
>
> 关于 XA 事务的特定限制，请参见 15.3.8.3 节，“XA 事务的限制”。