#### 19.5.1.36 复制和触发器

使用基于语句的复制时，在源服务器上执行的触发器也会在副本上执行。使用基于行的复制时，在源服务器上执行的触发器不会在副本上执行。相反，由触发器执行引起的源服务器上的行更改被复制并应用于副本。

这种行为是设计如此。如果在基于行的复制下，副本也应用了触发器以及由它们引起的行更改，这些更改将在副本上实际应用两次，导致源和副本的数据不同。

如果你希望触发器在源和副本上都执行，比如因为你在源和副本上有不同的触发器，你必须使用基于语句的复制。然而，启用副本端的触发器并不必须仅使用基于语句的复制。只需在你希望此效果的语句中切换到基于语句的复制，其余时间使用基于行的复制即可。

调用触发器（或函数）的语句，如果导致 `AUTO_INCREMENT` 列更新，使用基于语句的复制无法正确复制。MySQL 8.0 将此类语句标记为不安全。（错误 #45677）

触发器可以有不同组合的触发事件（INSERT、UPDATE、DELETE）和操作时间（BEFORE、AFTER），并且允许有多个触发器。

为简洁起见，“多个触发器”在此是“具有相同触发事件和操作时间的多个触发器”的简称。

**升级。**MySQL 5.7 之前的版本不支持多个触发器。如果你在复制拓扑中升级使用早于 MySQL 5.7 的版本的服务器，请先升级副本，然后升级源。如果升级后的复制源服务器仍然有使用不支持多个触发器的 MySQL 版本的旧副本，如果在源上为已有触发器的表创建触发器，且触发器具有相同的触发事件和操作时间，则会在这些副本上发生错误。

**降级。**如果你将支持多个触发器的服务器降级到旧版本，降级将有以下影响：

- 对于每个有触发器的表，所有触发器定义都在表的 `.TRG` 文件中。然而，如果有多个具有相同触发事件和操作时间的触发器，服务器在触发事件发生时只执行其中一个。有关 `.TRG` 文件的信息，请参见 MySQL 服务器 Doxygen 文档中的表触发器存储部分，网址为 https://dev.mysql.com/doc/index-other.html。

- 如果在降级后为表添加或删除触发器，服务器会重写表的 `.TRG` 文件。重写的文件仅保留每种触发事件和操作时间组合的一个触发器；其他的将丢失。

为避免这些问题，在降级前修改你的触发器。对于每个具有每种触发事件和操作时间组合的多个触发器的表，将每组触发器转换为一个触发器，操作如下：

1. 对于每个触发器，创建一个包含所有触发器代码的存储例程。使用 NEW 和 OLD 访问的值可以使用参数传递给例程。如果触发器需要代码的单一结果值，你可以将代码放入一个存储函数中，并让函数返回值。如果触发器需要代码的多个结果值，你可以将代码放入一个存储过程中，并使用 OUT 参数返回值。

2. 删除表的所有触发器。

3. 为表创建一个新触发器，调用刚创建的存储例程。因此，这个触发器的效果与它替换的多个触发器相同。
