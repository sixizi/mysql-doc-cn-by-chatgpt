#### 19.3.2.3 二进制日志主密钥轮换

当启用二进制日志加密时，您可以在服务器运行时随时通过发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 语句来轮换二进制日志主密钥。当使用此语句手动轮换二进制日志主密钥时，新的及后续文件的密码将使用新的二进制日志主密钥加密，同时，现有加密的二进制日志文件和中继日志文件的文件密码也会使用新的二进制日志主密钥重新加密，因此完全更新了加密。您可以定期轮换二进制日志主密钥，以符合您组织的安全政策，也可以在怀疑当前或任何之前的二进制日志主密钥可能已经泄露时进行轮换。

当您手动轮换二进制日志主密钥时，MySQL 服务器将依次采取以下行动：

- 生成一个新的二进制日志加密密钥，该密钥具有下一个可用的序列号，存储在密钥环上，并用作新的二进制日志主密钥。
- 在所有通道上轮换二进制日志和中继日志文件。
- 使用新的二进制日志主密钥加密新的二进制日志和中继日志文件的文件密码，以及随后的文件，直到密钥再次更改。
- 使用新的二进制日志主密钥依次重新加密服务器上现有加密的二进制日志文件和中继日志文件的文件密码，从最近的文件开始。任何未加密的文件将被跳过。
- 从密钥环中移除不再用于任何文件的二进制日志加密密钥。

发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 需要 `BINLOG_ENCRYPTION_ADMIN` 权限，如果 `binlog_encryption` 系统变量设置为 `OFF`，则不能使用该语句。

在二进制日志主密钥轮换过程的最后一步中，所有不再适用于任何保留的二进制日志文件或中继日志文件的二进制日志加密密钥都将从密钥环中清除。如果保留的二进制日志文件或中继日志文件无法为重新加密而初始化，相关的二进制日志加密密钥不会被删除，以防将来可以恢复这些文件。例如，如果二进制日志索引文件中列出的文件当前不可读，或者如果通道无法初始化，可能会出现这种情况。如果服务器 UUID 发生变化，例如使用 MySQL Enterprise Backup 创建的备份用于设置新的副本，那么在新服务器上发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 不会删除包含原始服务器 UUID 的任何早期二进制日志加密密钥。

如果二进制日志主密钥轮换过程的前四个步骤中的任何一个无法正确完成，将发出错误消息，解释情况及其对二进制日志文件和中继日志文件加密状态的影响。以前加密的文件始终保持加密状态，但其文件密码可能仍使用旧的二进制日志主密钥加密。如果您看到这些错误，请首先通过再次发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 重试该过程。然后调查个别文件的状态，看看什么阻碍了该过程，特别是如果您怀疑当前或任何之前的二进制日志主密钥可能已经泄露。

如果二进制日志主密钥轮换过程的最后一步无法正确完成，将发出警告消息，解释情况。

警告消息标识过程是否未能清除密钥环中用于轮换二进制日志主密钥的辅助密钥，或未能清除未使用的二进制日志加密密钥。您可以选择忽略该消息，因为这些密钥是辅助密钥或不再使用，或者您可以再次发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 来重试该过程。

如果服务器停止并在二进制日志主密钥轮换过程中重新启动，且二进制日志加密仍设置为 `ON`，则重启后的新二进制日志文件和中继日志文件将使用新的二进制日志主密钥加密。然而，现有文件的重新加密不会继续，因此在服务器停止之前未得到重新加密的文件将继续使用先前的二进制日志主密钥加密。为完成重新加密并清理未使用的二进制日志加密密钥，请在重启后再次发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY`。

`ALTER INSTANCE ROTATE BINLOG MASTER KEY` 操作不会被写入二进制日志，并且不会在副本上执行。因此，可以在包括多个 MySQL 版本的复制环境中执行二进制日志主密钥轮换。要在所有适用的源服务器和副本服务器上定期轮换二进制日志主密钥，您可以在每个服务器上启用 MySQL 事件调度器，并使用 `CREATE EVENT` 语句发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 语句。如果您因为怀疑当前或任何之前的二进制日志主密钥可能已经泄露而轮换二进制日志主密钥，请在每个适用的源服务器和副本服务器上发出该语句。这样可以确保即使在副本延迟、属于多个复制拓扑或当前未在复制拓扑中活跃的情况下，也可以验证即时合规。

系统变量 `binlog_rotate_encryption_master_key_at_startup` 控制服务器重启时是否自动轮换二进制日志主密钥。如果此系统变量设置为 `ON`，每当服务器重启时，都会生成新的二进制日志加密密钥并用作新的二进制日志主密钥。如果设置为 `OFF`（默认值），重启后将再次使用现有的二进制日志主密钥。当在启动时轮换二进制日志主密钥时，新的二进制日志和中继日志文件的文件密码将使用新密钥加密。现有加密的二进制日志文件和中继日志文件的文件密码不会被重新加密，因此它们将继续使用旧密钥加密，旧密钥仍然可在密钥环上获取。