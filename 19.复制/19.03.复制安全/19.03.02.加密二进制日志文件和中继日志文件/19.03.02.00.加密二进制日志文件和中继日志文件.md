### 19.3.2 加密二进制日志文件和中继日志文件

- [19.3.2.1 二进制日志加密的范围](./19.03.02.01.二进制日志加密的范围.md)
- [19.3.2.2 二进制日志加密密钥](./19.03.02.02.二进制日志加密密钥.md)
- [19.3.2.3 二进制日志主密钥轮换](./19.03.02.03.二进制日志主密钥轮换.md)

从 MySQL 8.0.14 开始，二进制日志文件和中继日志文件可以进行加密，帮助保护这些文件及其中可能包含的敏感数据，防止被外部攻击者滥用，以及防止操作系统的用户未经授权查看。用于文件的加密算法是内置于 MySQL 服务器的 AES（高级加密标准）密码算法，无法配置。

您可以通过将 `binlog_encryption` 系统变量设置为 `ON` 来在 MySQL 服务器上启用此加密。默认值为 `OFF`。此系统变量会将加密设置为二进制日志文件和中继日志文件。服务器上不需要启用二进制日志记录就可以启用加密，因此您可以在没有二进制日志的副本上加密中继日志文件。要使用加密，必须安装并配置密钥环组件或插件以供应 MySQL 服务器的密钥环服务。有关如何做到这一点的指南，请参见第 8.4.4 节，“MySQL 密钥环”。任何支持的密钥环组件或插件都可以用来存储二进制日志加密密钥。

当您首次启动服务器并启用加密时，会在初始化二进制日志和中继日志之前生成一个新的二进制日志加密密钥。此密钥用于加密每个二进制日志文件（如果服务器启用了二进制日志记录）和中继日志文件（如果服务器有复制通道）的文件密码，并且从文件密码生成的进一步密钥用于加密文件中的数据。服务器上当前使用的二进制日志加密密钥称为二进制日志主密钥。二层加密密钥架构意味着可以根据需要轮换（用新主密钥替换）二进制日志主密钥，只需要用新主密钥重新加密每个文件的文件密码，而不是整个文件。中继日志文件在所有通道中都被加密，包括在激活加密后创建的新通道。二进制日志索引文件和中继日志索引文件从未被加密。

如果在服务器运行时激活加密，此时会生成一个新的二进制日志加密密钥。例外情况是如果服务器之前已经激活了加密然后被禁用，在这种情况下，将再次使用之前使用的二进制日志加密密钥。二进制日志文件和中继日志文件会立即轮换，新文件和所有后续的二进制日志文件及中继日志文件的文件密码都将使用这个二进制日志加密密钥进行加密。服务器上仍然存在的现有二进制日志文件和中继日志文件不会被加密，但如果它们不再需要，您可以清除它们。

如果通过将 `binlog_encryption` 系统变量设置为 `OFF` 来停用加密，二进制日志文件和中继日志文件会立即轮换，所有后续的记录都不会被加密。之前加密的文件不会自动解密，但服务器仍然能够读取它们。在服务器运行时激活或停用加密需要 `BINLOG_ENCRYPTION_ADMIN` 权限。

加密和未加密的二进制日志文件可以通过加密日志文件头部起始处的魔数（0xFD62696E）与未加密日志文件使用的魔数（0xFE62696E）来区分。`SHOW BINARY LOGS` 语句显示每个二进制日志文件是加密的还是未加密的。

当二进制日志文件被加密后，`mysqlbinlog` 不能直接读取它们，但可以通过使用 `--read-from-remote-server` 选项从服务器读取。从 MySQL 8.0.14 开始，如果您尝试直接读取加密的二进制日志文件，`mysqlbinlog` 会返回一个适当的错误，但旧版本的 `mysqlbinlog` 根本不识别文件为二进制日志文件。如果您使用 `mysqlbinlog` 备份加密的二进制日志文件，请注意，使用 `mysqlbinlog` 生成的文件副本以未加密格式存储。

二进制日志加密可以与二进制日志事务压缩（从 MySQL 8.0.20 开始提供）结合使用。有关二进制日志事务压缩的更多信息，请参见第 7.4.4.5 节，“二进制日志事务压缩”。