### 19.3.3 复制权限检查

#### 19.3.3.1 复制权限检查用户账户的权限
#### 19.3.3.2 针对群组复制通道的权限检查
#### 19.3.3.3 从失败的复制权限检查中恢复
默认情况下，MySQL复制（包括群组复制）在将其他服务器已接受的事务应用于副本或群组成员时不进行权限检查。从MySQL 8.0.18开始，您可以创建一个具有适当权限的用户账户来应用通常在通道上复制的事务，并将其指定为复制应用程序的`PRIVILEGE_CHECKS_USER`账户，使用`CHANGE REPLICATION SOURCE TO`语句（从MySQL 8.0.23开始）或`CHANGE MASTER TO`语句（在MySQL 8.0.23之前）。然后，MySQL会检查每个事务是否有用户账户的权限，以验证您是否授权了该通道的操作。该账户还可以安全地被管理员用来应用或重新应用来自mysqlbinlog输出的事务，例如用于从通道的复制错误中恢复。

使用`PRIVILEGE_CHECKS_USER`账户有助于保护复制通道免受未经授权或意外使用具有特权或不需要的操作的风险。在以下情况中，`PRIVILEGE_CHECKS_USER`账户提供了额外的安全层：

- 您正在组织网络上的服务器实例与另一个网络（例如云服务提供商提供的实例）上的服务器实例之间进行复制。
- 您希望将多个本地或异地部署作为独立单元管理，而不赋予一个管理员账户所有部署的权限。
- 您希望有一个管理员账户，使管理员只能执行与复制通道及其复制的数据库直接相关的操作，而不是在服务器实例上拥有广泛的权限。

当为复制通道指定`PRIVILEGE_CHECKS_USER`账户时，您可以通过在`CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO`语句中添加以下一个或两个选项来增加复制通道的安全性：

- `REQUIRE_ROW_FORMAT`选项（从MySQL 8.0.19开始可用）使复制通道只接受基于行的复制事件。设置`REQUIRE_ROW_FORMAT`时，源服务器上必须使用基于行的二进制日志记录（`binlog_format=ROW`）。在MySQL 8.0.18中，`REQUIRE_ROW_FORMAT`不可用，但仍强烈建议为安全的复制通道使用基于行的二进制日志记录。对于基于语句的二进制日志记录，`PRIVILEGE_CHECKS_USER`账户可能需要一些管理员级别的权限才能成功执行事务。

- `REQUIRE_TABLE_PRIMARY_KEY_CHECK`选项（从MySQL 8.0.20开始可用）使复制通道使用其自己的主键检查策略。设置为`ON`表示总是需要主键，设置为`OFF`表示永远不需要主键。默认设置`STREAM`，使用从源复制的每个事务的值设置会话值`sql_require_primary_key`系统变量。设置`PRIVILEGE_CHECKS_USER`时，将`REQUIRE_TABLE_PRIMARY_KEY_CHECK`设置为`ON`或`OFF`意味着用户账户无需会话管理级别的权限即可设置受限的会话变量，这些变量是更改`sql_require_primary_key`值所必需的。它还规范了不同来源的复制通道的行为。

授予`REPLICATION_APPLIER`权限，以启用用户账户作为复制应用程序线程的`PRIVILEGE_CHECKS_USER`，并执行由mysqlbinlog使用的内部用途`BINLOG`语句。`PRIVILEGE

_CHECKS_USER`账户的用户名和主机名必须遵循第8.2.4节“指定账户名”的语法，并且用户不能是匿名用户（用户名为空）或`CURRENT_USER`。要创建新账户，请使用`CREATE USER`。要授予此账户`REPLICATION_APPLIER`权限，请使用`GRANT`语句。例如，要创建一个用户账户`priv_repl`，该账户可以由管理员从example.com域中的任何主机手动使用，并要求加密连接，发出以下语句：

```sql
mysql> SET sql_log_bin = 0;
mysql> CREATE USER 'priv_repl'@'%.example.com' IDENTIFIED BY 'password' REQUIRE SSL;
mysql> GRANT REPLICATION_APPLIER ON *.* TO 'priv_repl'@'%.example.com';
mysql> SET sql_log_bin = 1;
```

`SET sql_log_bin`语句的使用是为了确保账户管理语句不被添加到二进制日志并发送到复制通道（参见第15.4.1.3节，“SET sql_log_bin语句”）。

重要提示
`caching_sha2_password`身份验证插件是从MySQL 8.0开始创建的新用户的默认选项（详情请参见第8.4.1.2节，“Caching SHA-2可插拔身份验证”）。要使用使用此插件认证的用户账户连接到服务器，您必须设置加密连接，如第19.3.1节“设置使用加密连接的复制”所述，或启用未加密连接以支持使用RSA密钥对的密码交换。

在设置用户账户后，使用`GRANT`语句授予额外权限，使用户账户能够进行您期望应用程序线程执行的数据库更改，例如更新服务器上的特定表。这些相同的权限也使管理员在需要时可以手动在复制通道上执行这些事务。如果尝试了未授权的操作，操作将被禁止，复制应用程序线程将停止并出错。第19.3.3.1节“复制权限检查用户账户的权限”解释了账户需要哪些额外的权限。例如，要授予`priv_repl`用户账户在db1中cust表上添加行的INSERT权限，请发出以下语句：

```sql
mysql> GRANT INSERT ON db1.cust TO 'priv_repl'@'%.example.com';
```