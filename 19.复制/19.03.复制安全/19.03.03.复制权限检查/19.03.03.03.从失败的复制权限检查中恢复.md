### 19.3.3.3 从失败的复制权限检查中恢复

如果对 `PRIVILEGE_CHECKS_USER` 账户的权限检查失败，事务将不会被执行，并且复制将停止在该通道。错误的详细信息和最后一个应用的事务被记录在性能模式的 `replication_applier_status_by_worker` 表中。遵循以下程序从错误中恢复：

1. **识别导致错误的复制事件**：验证该事件是否预期的，并且来自可信源。您可以使用 `mysqlbinlog` 来检索和显示错误发生时记录的事件。有关如何做到这一点的说明，请参见第9.5节，“点对点（增量）恢复”。

2. **检查和调查**：如果复制事件不是预期的或不是来自已知和可信的源，调查其原因。如果您能够识别事件发生的原因，并且没有安全考虑，按下述方法修复错误。

3. **授予权限**：
   - 如果 `PRIVILEGE_CHECKS_USER` 账户本应被允许执行事务，但配置错误，请授予账户缺失的权限，使用 `FLUSH PRIVILEGES` 语句或执行 `mysqladmin flush-privileges` 或 `mysqladmin reload` 命令重新加载授权表，然后重新启动该通道的复制。
   - 如果事务需要执行，并且您已验证它是可信的，但 `PRIVILEGE_CHECKS_USER` 账户通常不应具有此权限，您可以暂时授予 `PRIVILEGE_CHECKS_USER` 账户所需的权限。复制事件应用后，从账户中移除该权限，并采取必要措施确保如果可以避免，则不会再次发生该事件。

4. **跳过事务**：
   - 如果事务是一项应仅在源上执行而不在副本上执行的管理操作，或者应仅在单个复制组成员上执行，那么在停止复制的服务器上跳过事务，然后发出 `START REPLICA` 以在该通道上重启复制。为了避免未来发生类似情况，您可以在这些管理语句前后使用 `SET sql_log_bin = 0` 和 `SET sql_log_bin = 1`，使其不在源上被记录。
   - 如果事务是不应在源或副本上执行的 DDL 或 DML 语句，在停止复制的服务器或服务器上跳过事务，在原服务器上手动撤销事务，然后发出 `START REPLICA` 以重新启动复制。

5. **如何跳过事务**：
   - 如果使用 GTID，提交一个空事务，该事务具有失败事务的 GTID，例如：
     ```sql
     SET GTID_NEXT='aaa-bbb-ccc-ddd:N';
     BEGIN;
     COMMIT;
     SET GTID_NEXT='AUTOMATIC';
     ```
   - 如果没有使用 GTID，发出 `SET GLOBAL sql_replica_skip_counter` 或 `SET GLOBAL sql_slave_skip_counter` 语句来跳过事件。有关使用此替代方法和跳过事务的更多细节，请参见第19.1.7.3节，“跳过事务”。