19.2.1.3 在二进制日志中确定安全与不安全语句

在MySQL复制中，语句的“安全性”指的是该语句及其效果是否可以使用基于语句的格式正确复制。如果语句满足这一条件，我们称该语句为安全的；否则，我们称之为不安全的。

通常，如果语句是确定性的，则认为它是安全的；如果不是，则认为它是不安全的。然而，某些非确定性函数不被视为不安全（见本节后面的“不被视为不安全的非确定性函数”）。此外，使用浮点数学函数结果的语句——这些函数依赖于硬件——始终被认为是不安全的（见第19.5.1.12节，“复制与浮点值”）。

安全与不安全语句的处理。根据语句被视为安全与否，以及二进制日志格式（即binlog_format的当前值），语句会被不同地处理。

当使用基于行的日志时，不区分安全和不安全语句的处理。

当使用混合格式日志时，被标记为不安全的语句使用基于行的格式记录；被视为安全的语句使用基于语句的格式记录。

当使用基于语句的日志时，被标记为不安全的语句会生成相应的警告。安全语句正常记录。

每个被标记为不安全的语句都会生成一个警告。如果在源上执行了大量此类语句，可能会导致错误日志文件过大。为防止这种情况，MySQL具有警告抑制机制。每当在任何50秒时间内最近的50个ER_BINLOG_UNSAFE_STATEMENT警告被生成超过50次时，就会启用警告抑制。启用后，这些警告不会被写入错误日志；相反，每50个此类警告会在错误日志中写入一条“最后一个警告在过去S秒内重复了N次”的注意事项。只要最近50个此类警告在50秒或更短时间内被发布，就会继续这样做；一旦频率降低到此阈值以下，警告再次正常记录。警告抑制对于如何确定基于语句日志的语句的安全性，以及如何向客户端发送警告没有影响。MySQL客户端仍然会收到每个此类语句的一个警告。

有关更多信息，请参见第19.2.1节，“复制格式”。

被视为不安全的语句。具有以下特征的语句被视为不安全：

包含可能在副本上返回不同值的系统函数的语句。这些函数包括FOUND_ROWS()、GET_LOCK()、IS_FREE_LOCK()、IS_USED_LOCK()、LOAD_FILE()、MASTER_POS_WAIT()、RAND()、RELEASE_LOCK()、ROW_COUNT()、SESSION_USER()、SLEEP()、SOURCE_POS_WAIT()、SYSDATE()、SYSTEM_USER()、USER()、UUID()和UUID_SHORT()。

不被视为不安全的非确定性函数。尽管这些函数不是确定性的，但它们被视为安全的，适用于日志记录和复制：CONNECTION_ID()、CURDATE()、CURRENT_DATE()、CURRENT_TIME()、CURRENT_TIMESTAMP()、CURTIME()、LAST_INSERT_ID()、LOCALTIME()、LOCALTIMESTAMP()、NOW()、UNIX_TIMESTAMP()、UTC_DATE()、UTC_TIME()和UTC_TIMESTAMP()。

有关更多信息，请参见第19.5.1.14节，“复制与系统函数”。

引用系统变量。大多数系统变量使用基于语句的格式无法正确复制。见第19.5

.1.39节，“复制与变量”。例外情况，请参见第7.4.4.3节，“混合二进制日志格式”。

可加载函数。由于我们无法控制可加载函数的执行操作，我们必须假设它执行了不安全的语句。

全文插件。这个插件在不同的MySQL服务器上可能表现不同；因此，依赖它的语句可能有不同的结果。因此，所有依赖全文插件的语句在MySQL中都被视为不安全。

触发器或存储程序更新具有AUTO_INCREMENT列的表。这是不安全的，因为在源和副本上更新行的顺序可能不同。

此外，插入到具有复合主键的表中，该复合主键包含一个不是此复合键的第一列的AUTO_INCREMENT列的INSERT操作是不安全的。

有关更多信息，请参见第19.5.1.1节，“复制与AUTO_INCREMENT”。

对具有多个主键或唯一键的表执行INSERT ... ON DUPLICATE KEY UPDATE语句。当对包含多个主键或唯一键的表执行时，由于存储引擎检查键的顺序不是确定性的，MySQL Server选择更新哪些行取决于此顺序，因此这个语句被认为是不安全的。（Bug #11765650, Bug #58637）

使用LIMIT的更新。检索行的顺序未指定，因此被认为是不安全的。见第19.5.1.18节，“复制与LIMIT”。

访问或引用日志表。系统日志表的内容可能在源和副本之间不同。

事务操作后的非事务操作。在一个事务中，在任何事务性读取或写入后允许执行任何非事务性读取或写入被认为是不安全的。

有关更多信息，请参见第19.5.1.35节，“复制与事务”。

访问或引用自记录表。对自记录表的所有读取和写入都被认为是不安全的。在一个事务中，任何对自记录表的读取或写入后的语句也被认为是不安全的。

LOAD DATA语句。LOAD DATA被视为不安全的，当binlog_format=MIXED时，该语句以基于行的格式记录。当binlog_format=STATEMENT时，LOAD DATA不像其他不安全的语句那样生成警告。

XA事务。如果源上并行提交的两个XA事务在副本上以相反的顺序准备，则可能会发生锁定依赖关系，使用基于语句的复制无法安全解决，并且可能导致副本上的复制因死锁而失败。当binlog_format=STATEMENT设置时，XA事务中的DML语句被标记为不安全并生成警告。当binlog_format=MIXED或binlog_format=ROW设置时，XA事务中的DML语句使用基于行的复制记录，潜在问题不存在。

引用非确定性函数的DEFAULT子句。如果表达式默认值引用了非确定性函数，任何导致评估该表达式的语句都不适用于基于语句的复制。这包括INSERT、UPDATE和ALTER TABLE等语句。与大多数其他不安全的语句不同，这类语句不能以基于行的格式安全复制。当binlog_format设置为STATEMENT时，该语句被记录并执行，但警告消息被写入错误日志。当binlog_format设置为MIXED或ROW时，该语句不被执行，并且错误消息被写入错误日志。有关显式默认值处理的更多信息，请参见MySQL 8.0.13起的显式默认值处理。

有关更多信息，请参见第19.5.1节，“复制功能和问题”。
