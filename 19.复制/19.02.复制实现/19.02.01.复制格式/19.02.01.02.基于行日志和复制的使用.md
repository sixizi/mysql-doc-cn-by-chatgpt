#### 19.2.1.2 基于行的日志记录和复制的使用

MySQL 使用基于语句的日志记录（SBL）、基于行的日志记录（RBL）或混合格式日志记录。所使用的二进制日志类型会影响日志记录的大小和效率。因此，选择基于行的复制（RBR）还是基于语句的复制（SBR）取决于您的应用程序和环境。本节描述了使用基于行格式日志时的已知问题，并描述了在复制中使用它的一些最佳实践。

有关更多信息，请参阅第19.2.1节，“复制格式”，以及第19.2.1.1节，“基于语句和基于行复制的优势与劣势”。

有关特定于NDB集群复制（依赖于基于行复制）的问题的信息，请参阅第25.7.3节，“NDB集群复制中的已知问题”。

- **基于行的临时表日志记录。**如第19.5.1.31节“复制与临时表”中所述，使用基于行格式或（从MySQL 8.0.4开始）混合格式时，临时表不会被复制。有关更多信息，请参阅第19.2.1.1节，“基于语句和基于行复制的优势与劣势”。

  使用基于行或混合格式时，临时表不会被复制，因为没有必要。此外，因为临时表只能由创建它们的线程读取，所以即使使用基于语句的格式复制它们，也很少或根本不会获得任何好处。

  即使已创建临时表，您也可以在运行时从基于语句的日志记录格式切换到基于行的日志记录格式。然而，在MySQL 8.0中，由于之前模式中省略了任何`CREATE TEMPORARY TABLE`语句，因此无法在运行时从基于行或混合格式的二进制日志记录切换到基于语句的格式。

  MySQL服务器跟踪每个临时表创建时有效的日志记录模式。当给定的客户端会话结束时，如果临时表仍然存在且在使用基于语句的二进制日志记录时创建，则服务器会为每个临时表记录一个`DROP TEMPORARY TABLE IF EXISTS`语句。如果在创建表时使用的是基于行或混合格式的二进制日志记录，则不会记录`DROP TEMPORARY TABLE IF EXISTS`语句。在MySQL 8.0.4和5.7.25之前的版本中，无论有效的日志记录模式是什么，`DROP TEMPORARY TABLE IF EXISTS`语句都会被记录。

  使用`binlog_format=ROW`时，允许涉及临时表的非事务性DML语句，只要受语句影响的任何非事务性表都是临时表（Bug #14272672）。

- **RBL和非事务性表的同步。**当影响到许多行时，更改集被分割成几个事件；当语句提交时，所有这些事件都被写入二进制日志。在副本上执行时，会对涉及的所有表加表锁，然后以批处理模式应用这些行。这是否有效取决于副本表副本使用的引擎。

- **延迟和二进制日志大小。**RBL会将每行的更改写入二进制日志，因此其大小可能会迅速增加。这可能会显著增加在副本上进行与源相匹配的更改所需的时间。您应该意识到您的应用程序中可能存在这种延迟。

- **读取二进制日志。**`mysqlbinlog`使用`BINLOG`语句在二进制日志中显示基于行的事件。这个语句将一个事件显示为一个基于64编码的字符串，其含义并不明显。当使用`--base64-output=DECODE-ROWS`和`--verbose`选项调用时，`mysqlbinlog`将二进制日志的内容格式化为人类可读的形式。当二进制日志事件以基于行的格式写入，并且您希望从复制或数据库故障中读取或恢复时，您可以使用此命令来读取二进制日志的内容。有关更多信息，请参阅第6.6.9.2节，“mysqlbinlog行事件显示”。

- **二进制日志执行错误和副本执行模式。**通常，只有在MySQL NDB集群复制中使用`slave_exec_mode=IDEMPOTENT`才有用，对于该集群复制，`IDEMPOTENT`是默认值。（参见第25.7.10节，“NDB集群复制：双向和环形复制”）。当系统变量`replica_exec_mode`或`slave_exec_mode`设置为`IDEMPOTENT`时，由于无法找到原始行而导致无法应用RBL的更改不会触发错误或导致复制失败。这意味着更新可能不会在副本上应用，因此源和副本不再同步。当`replica_exec_mode`或`slave_exec_mode`设置为`IDEMPOTENT`时，延迟问题和使用非事务性表与RBR一起使用可能会导致源和副本进一步偏离。有关`replica_exec_mode`和`slave_exec_mode`的更多信息，请参阅第7.1.8节，“服务器系统变量”。

- **不支持基于服务器ID的过滤。**您可以通过对`CHANGE REPLICATION SOURCE TO`语句（从MySQL 8.0.23开始）或`CHANGE MASTER TO`语句（在MySQL 8.0.23之前）使用`IGNORE_SERVER_IDS`选项来基于服务器ID进行过滤。此选项适用于基于语句和基于行的日志记录格式，但在设置`GTID_MODE=ON`时不推荐使用。另一种在某些副本上过滤更改的方法是使用包含关系`@@server_id <> id_value`子句的`WHERE`子句，与`UPDATE`和`DELETE`语句一起使用。例如，`WHERE @@server_id <> 1`。然而，这与基于行的日志记录不正确地工作。要使用`server_id`系统变量进行语句过滤，请使用基于语句的日志记录。

- **RBL、非事务性表和停止的副本。**当使用基于行的日志记录时，如果副本服务器在副本线程更新非事务性表时停止，则副本数据库可能达到不一致状态。因此，建议您为使用基于行格式复制的所有表使用像InnoDB这样的事务性存储引擎。在关闭副本MySQL服务器之前使用`STOP REPLICA`或`STOP REPLICA SQL_THREAD`（在MySQL 8.0.22之前，使用`STOP slave`或`STOP SLAVE SQL_THREAD`）总是被推荐的，无论您使用哪种日志记录格式或存储引擎。