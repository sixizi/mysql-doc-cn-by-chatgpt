### 19.2.1 复制格式

- [19.2.1.1 基于语句和基于行复制的优缺点](./19.02.01.01.基于语句和基于行复制的优缺点.md)
- [19.2.1.2 基于行日志和复制的使用](./19.02.01.02.基于行日志和复制的使用.md)
- [19.2.1.3 在二进制日志中确定安全与不安全的语句](./19.02.01.03.在二进制日志中确定安全与不安全的语句.md)

复制工作的原理是，从源读取写入二进制日志的事件，然后在副本上处理这些事件。这些事件根据事件的类型以不同的格式记录在二进制日志内。使用的不同复制格式对应于记录源二进制日志中事件时使用的二进制日志格式。二进制日志格式和复制期间使用的术语之间的对应关系是：

- 使用基于语句的二进制日志时，源将 SQL 语句写入二进制日志。通过在副本上执行 SQL 语句，实现从源到副本的复制。这称为基于语句的复制（可以简称为 SBR），对应于 MySQL 基于语句的二进制日志格式。

- 使用基于行的日志时，源将事件写入二进制日志，这些事件指示单个表行是如何更改的。通过将代表表行更改的事件复制到副本，实现从源到副本的复制。这称为基于行的复制（可以简称为 RBR）。

  基于行的日志是默认方法。

- 您还可以配置 MySQL 使用基于语句和基于行日志的混合，这取决于记录更改时哪种方式最合适。这称为混合格式日志。使用混合格式日志时，默认使用基于语句的日志。根据某些语句，以及正在使用的存储引擎，日志会在特定情况下自动切换到基于行的。使用混合格式的复制被称为混合基础复制或混合格式复制。更多信息，请参见第7.4.4.3节，“混合二进制日志格式”。


**NDB 集群**。MySQL NDB 集群 8.0 中的默认二进制日志格式是 MIXED。应注意，NDB 集群复制总是使用基于行的复制，NDB 存储引擎与基于语句的复制不兼容。更多信息，请参见第25.7.2节，“NDB 集群复制的一般要求”。

使用 MIXED 格式时，二进制日志格式部分由正在使用的存储引擎和执行的语句决定。有关混合格式日志及支持不同日志格式的规则的更多信息，请参见第7.4.4.3节，“混合二进制日志格式”。

在运行中的 MySQL 服务器中，通过设置 `binlog_format` 服务器系统变量来控制日志格式。此变量可以设置为会话或全局作用域。新设置生效的时机和方式的规则与其他 MySQL 服务器系统变量相同。为当前会话设置变量只持续到该会话结束，其他会话不可见此更改。全局设置变量对于在更改之后连接的客户端生效，但对于任何当前客户端会话，包括更改变量设置的会话，不生效。要使全局系统变量设置永久生效，以便跨服务器重启应用，您必须在选项文件中设置它。更多信息，请参见第15.7.6.1节，“变量赋值的 SET 语法”。

在运行时更改二进制日志格式或这样做导致复制失败的情况下，您不能更改二进制日志格式。参见第7.4.4.2节，“设置二进制日志格式”。

更改全局 `binlog_format` 值需要足够的权限来设置全局系统变量。更改会话 `binlog_format` 值需要足够的权限来设置受限会话系统变量。参见第7.1.9.1节，“系统变量权限”。

> **注意**
>
> 从 MySQL 8.0.34 开始，更改二进制日志格式（`binlog_format` 系统变量）已被弃用。在 MySQL 的未来版本中，可以预期 `binlog_format` 将被完全移除，基于行的格式将成为 MySQL 使用的唯一日志格式。

基于语句和基于行的复制格式有不同的问题和限制。对于它们相对优缺点的比较，请参见第19.2.1.1节，“基于语句和基于行复制的优缺点”。

使用基于语句的复制时，您可能会遇到复制存储的例程或触发器的问题。您可以通过使用基于行的复制来避免这些问题。更多信息，请参见第27.7节，“存储程序二进制日志”。