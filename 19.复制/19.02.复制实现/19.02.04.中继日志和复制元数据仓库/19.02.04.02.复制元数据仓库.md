### 19.2.4.2 复制元数据仓库

副本服务器创建两个复制元数据仓库：连接元数据仓库和应用元数据仓库。这些复制元数据仓库可以在副本服务器关闭后保留。如果使用基于二进制日志文件位置的复制，在副本重新启动时，它会读取这两个仓库以确定它之前在从源读取二进制日志和处理自己的中继日志方面的进度。如果使用基于 GTID 的复制，则副本不会用这些复制元数据仓库来执行此目的，但这些仓库中包含的其他元数据仍然是必需的。

- 副本的连接元数据仓库包含复制 I/O（接收器）线程连接到复制源服务器并从源的二进制日志中检索事务所需的信息。此仓库中的元数据包括连接配置、复制用户账户详细信息、连接的 SSL 设置以及复制接收器线程当前从源的二进制日志中读取的文件名和位置。


- 副本的应用元数据仓库包含复制 SQL（应用器）线程从副本的中继日志中读取和应用事务所需的信息。此仓库中的元数据包括复制应用器线程已执行事务的中继日志的文件名和位置，以及源的二进制日志中的等效位置。它还包括应用事务过程中的元数据，例如工作线程数量和频道的 `PRIVILEGE_CHECKS_USER` 账户。


连接元数据仓库写入 `mysql` 系统架构中的 `slave_master_info` 表，应用元数据仓库写入 `mysql` 系统架构中的 `slave_relay_log_info` 表。如果 `mysqld` 无法初始化复制元数据仓库的表，将发出警告消息，但副本被允许继续启动。当从不支持表格存储仓库的 MySQL 版本升级到支持使用表格的版本时，最有可能发生这种情况。

> **重要提示
>
> 不要尝试手动更新或插入 `mysql.slave_master_info` 或 `mysql.slave_relay_log_info` 表中的行。这样做可能导致未定义的行为，并且不受支持。在复制进行时，禁止执行任何需要对 `slave_master_info` 或 `slave_relay_log_info` 表写锁的语句（尽管随时允许执行仅进行读取的语句）。

连接元数据仓库表 `mysql.slave_master_info` 的访问权限应限制为数据库管理员，因为它包含用于连接源的复制用户账户名和密码。使用受限访问模式保护包含此表的数据库备份。从 MySQL 8.0.21 开始，您可以从连接元数据仓库中清除复制用户账户凭据，并始终使用启动复制通道的 `START REPLICA` 语句或 `START GROUP_REPLICATION` 语句提供它们。这种方法意味着复制通道始终需要操作员干预才能重新启动，但账户名和密码不会记录在复制元数据仓库中。

`RESET REPLICA` 清除复制元数据仓库中的数据，除了复制连接参数（取决于 MySQL Server 版本）。有关详细信息，请参见 `RESET REPLICA` 的描述。

从 MySQL 8.0.27 开始，您可以在 `CHANGE REPLICATION SOURCE TO` 语句上设置 `GTID_ONLY` 选项，以停止复制通道在复制元数据仓库中持久化文件名和文件位置。这避免了在 GTID 基于复制实际不需要它们的情况下对表的

写入和读取。使用 `GTID_ONLY` 设置时，连接元数据仓库和应用元数据仓库在副本排队和应用事务事件时，或当复制线程停止和启动时，不会更新。文件位置在内存中跟踪，并且如果需要，可以使用 `SHOW REPLICA STATUS` 语句查看。复制元数据仓库仅在以下情况同步：

- 发出 `CHANGE REPLICATION SOURCE TO` 语句时。
- 发出 `RESET REPLICA` 语句时。`RESET REPLICA ALL` 会删除而不是更新仓库，因此它们会隐式同步。
- 初始化复制通道时。
- 如果复制元数据仓库从文件移至表。

在 MySQL 8.0 之前，要将复制元数据仓库创建为表，需要在服务器启动时指定 `master_info_repository=TABLE` 和 `relay_log_info_repository=TABLE`。否则，仓库将以 `master.info` 和 `relay-log.info` 的形式在数据目录中创建为文件，或者通过 `--master-info-file` 选项和 `relay_log_info_file` 系统变量指定的替代名称和位置创建。从 MySQL 8.0 开始，将复制元数据仓库创建为表是默认行为，所有这些系统变量的使用都已弃用。