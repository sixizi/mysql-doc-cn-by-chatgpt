### 19.2.4.1 中继日志

中继日志，如同二进制日志一样，包含了一组编号的文件，这些文件包含描述数据库变更的事件，以及一个包含所有使用过的中继日志文件名的索引文件。中继日志文件的默认位置是数据目录。

“中继日志文件”一词通常指的是包含数据库事件的单个编号文件。而“中继日志”一词则统称这组编号的中继日志文件及其索引文件。

中继日志文件与二进制日志文件具有相同的格式，可以使用`mysqlbinlog`工具读取（参见第6.6.9节，“mysqlbinlog — 处理二进制日志文件的实用工具”）。如果使用了二进制日志事务压缩（从MySQL 8.0.20开始提供），写入中继日志的事务有效载荷将以与二进制日志相同的方式被压缩。有关二进制日志事务压缩的更多信息，请参见第7.4.4.5节，“二进制日志事务压缩”。

对于默认复制通道，中继日志文件的默认形式为`host_name-relay-bin.nnnnnn`，其中`host_name`是副本服务器主机的名称，`nnnnnn`是一个序列号。连续的中继日志文件使用连续的序列号创建，从000001开始。对于非默认复制通道，默认的基本名称是`host_name-relay-bin-channel`，其中`channel`是记录在中继日志中的复制通道的名称。

副本使用索引文件来跟踪当前使用中的中继日志文件。默认的中继日志索引文件名为`host_name-relay-bin.index`，用于默认通道，对于非默认复制通道则为`host_name-relay-bin-channel.index`。

可以分别使用`relay_log`和`relay_log_index`系统变量（见第19.1.6节，“复制和二进制日志选项及变量”）覆盖默认的中继日志文件和中继日志索引文件的名称和位置。

如果副本使用基于主机的默认中继日志文件名，在复制设置后更改副本的主机名可能会导致复制失败，错误为Failed to open the relay log和Could not find target log during relay log initialization。这是一个已知问题（见Bug #2122）。如果你预计副本的主机名将来可能会改变（例如，如果副本的网络设置允许使用DHCP修改其主机名），可以通过在最初设置副本时使用`relay_log`和`relay_log_index`系统变量明确指定中继日志文件名来完全避免这个问题。这会使名称独立于服务器主机名的更改。

如果在复制已经开始后遇到这个问题，一种解决方法是停止副本服务器，将旧中继日志索引文件的内容添加到新文件中，然后重启副本。在Unix系统上，可以如下操作：

```
$> cat new_relay_log_name.index >> old_relay_log_name.index
$> mv old_relay_log_name.index new_relay_log_name.index
```

副本服务器在以下条件下创建新的中继日志文件：

- 每次复制I/O（接收）线程启动时。
- 当日志被刷新时（例如，使用`FLUSH LOGS`或`mysqladmin flush-logs`）。
- 当当前中继日志文件变得太大时，这是按以下方式确定的：
  - 如果`max_relay_log_size`的值大于0，则这是中继日志文件的最大大小。
  - 如果`max_relay_log_size`的值为0，则`max_binlog_size`决定中继日志文件的最大大小。

复制SQL（应用器）线程在执行完文件中的所有

事件并且不再需要它后自动删除每个中继日志文件。因为复制SQL线程会处理删除操作，所以没有显式的机制用于删除中继日志。然而，`FLUSH LOGS`会轮换中继日志，这会影响复制SQL线程何时删除它们。