### 19.2.5.3 复制过滤选项之间的交互

如果您使用数据库级和表级复制过滤选项的组合，副本首先使用数据库选项接受或忽略事件，然后根据表选项评估那些被允许的事件。这有时可能导致看似违反直觉的结果。同样重要的是注意，结果会根据操作使用的是基于语句还是基于行的二进制日志格式而有所不同。如果您希望您的复制过滤器始终以与二进制日志格式无关的方式操作，这一点尤其重要，如果您使用混合二进制日志格式，请遵循本主题中的指导。

复制过滤选项的效果因二进制日志格式的不同而异，这是由于确定数据库名称的方式不同。对于基于语句的格式，DML 语句是基于当前数据库处理的，由 `USE` 语句指定。对于基于行的格式，DML 语句是基于修改表所在的数据库处理的。DDL 语句总是基于当前数据库进行过滤，由 `USE` 语句指定，无论二进制日志格式如何。

涉及多个表的操作也可能根据二进制日志格式的不同而受到复制过滤选项的不同影响。需要注意的操作包括涉及多表更新语句的事务、触发器、级联外键、更新多个表的存储函数以及调用更新一个或多个表的存储函数的 DML 语句。如果这些操作同时更新了被过滤和未过滤的表，则结果可能会随二进制日志格式而变化。

如果您需要保证您的复制过滤器无论二进制日志格式如何都能一致地操作，特别是如果您使用混合二进制日志格式（`binlog_format=MIXED`），只使用表级复制过滤选项，不使用数据库级复制过滤选项。同时，不要使用同时更新被过滤和未过滤表的多表 DML 语句。

如果您需要使用数据库级和表级复制过滤器的组合，并希望这些尽可能一致地操作，请选择以下策略之一：

- 如果您使用基于行的二进制日志格式（`binlog_format=ROW`），对于 DDL 语句，依赖 `USE` 语句来设置数据库并且不指定数据库名称。您可以考虑更改为基于行的二进制日志格式以提高复制过滤的一致性。有关更改二进制日志格式的条件，请参见第 7.4.4.2 节，“设置二进制日志格式”。
  
- 如果您使用基于语句的或混合二进制日志格式（`binlog_format=STATEMENT` 或 `MIXED`），对于 DML 和 DDL 语句，依赖 `USE` 语句并且不使用数据库名称。同时，不要使用同时更新被过滤和未过滤表的多表 DML 语句。

**示例 19.7 `--replicate-ignore-db` 选项和 `--replicate-do-table` 选项**

在复制源服务器上，发出以下语句：

```sql
USE db1;
CREATE TABLE t2 LIKE t1;
INSERT INTO db2.t3 VALUES (1);
```

副本设置了以下复制过滤选项：

```plaintext
replicate-ignore-db = db1
replicate-do-table = db2.t3
```

DDL 语句 `CREATE TABLE` 在由前面的 `USE` 语句指定的 `db1` 中创建表。根据其 `--replicate-ignore-db = db1` 选项，副本过滤掉了这条语句，

因为 `db1` 是当前数据库。这个结果在复制源服务器的任何二进制日志格式下都是相同的。然而，DML `INSERT` 语句的结果根据二进制日志格式的不同而不同：

- 如果源上使用的是基于行的二进制日志格式（`binlog_format=ROW`），副本使用表所在的数据库 `db2` 来评估 `INSERT` 操作。因此首先评估的数据库级选项 `--replicate-ignore-db = db1` 不适用。表级选项 `--replicate-do-table = db2.t3` 适用，所以副本应用了对表 t3 的更改。

- 如果源上使用的是基于语句的二进制日志格式（`binlog_format=STATEMENT`），副本使用默认数据库来评估 `INSERT` 操作，该数据库由 `USE` 语句设置为 `db1` 并未更改。根据其数据库级 `--replicate-ignore-db = db1` 选项，因此忽略了该操作，并未对表 t3 应用更改。表级选项 `--replicate-do-table = db2.t3` 未被检查，因为语句已经匹配了数据库级选项并被忽略。

如果副本上的 `--replicate-ignore-db = db1` 选项是必需的，并且源上使用基于语句的（或混合的）二进制日志格式也是必需的，则可以通过省略 `INSERT` 语句中的数据库名称并依赖 `USE` 语句来使结果保持一致，如下所示：

```sql
USE db1;
CREATE TABLE t2 LIKE t1;
USE db2;
INSERT INTO t3 VALUES (1);
```

在这种情况下，副本总是基于数据库 `db2` 评估 `INSERT` 语句。无论操作是以基于语句还是基于行的二进制格式记录，结果都保持相同。