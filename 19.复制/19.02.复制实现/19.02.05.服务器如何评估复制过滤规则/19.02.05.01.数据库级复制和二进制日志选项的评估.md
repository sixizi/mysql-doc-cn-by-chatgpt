### 19.2.5.1 数据库级复制和二进制日志选项的评估

在评估复制选项时，副本首先检查是否有适用的 `--replicate-do-db` 或 `--replicate-ignore-db` 选项。使用 `--binlog-do-db` 或 `--binlog-ignore-db` 时，过程类似，但选项是在源上检查的。

检查匹配的数据库取决于正在处理的语句的二进制日志格式。如果语句使用行格式记录，则更改数据的数据库是被检查的数据库。如果语句使用语句格式记录，则检查的数据库是默认数据库（使用 `USE` 语句指定的）。

> **注意**  
> 只有 DML 语句可以使用行格式记录。DDL 语句始终以语句的形式记录，即使 `binlog_format=ROW` 也是如此。因此，所有 DDL 语句始终根据基于语句的复制规则进行过滤。这意味着您必须通过 `USE` 语句明确选择默认数据库，以便应用 DDL 语句。

对于复制，涉及的步骤如下：

使用的日志格式是什么？

- STATEMENT：测试默认数据库。
- ROW：测试受更改影响的数据库。

有 `--replicate-do-db` 选项吗？

- 是。数据库是否匹配其中任何一个？
  - 是。继续第 4 步。
  - 否。忽略更新并退出。
- 否。继续第 3 步。

有 `--replicate-ignore-db` 选项吗？

- 是。数据库是否匹配其中任何一个？
  - 是。忽略更新并退出。
  - 否。继续第 4 步。
- 否。继续第 4 步。

如果有表级复制选项，继续检查这些选项。有关这些选项的检查方式的描述，请参见第 19.2.5.2 节，“表级复制选项的评估”。

> **重要**  
> 在此阶段仍被允许的语句尚未实际执行。只有在所有表级选项（如果有的话）也被检查，并且该过程的结果允许执行语句时，语句才会被执行。

对于二进制日志，涉及的步骤如下：

有 `--binlog-do-db` 或 `--binlog-ignore-db` 选项吗？

- 是。继续第 2 步。
- 否。记录语句并退出。

有默认数据库吗（是否选择了任何数据库使用 `USE`）？

- 是。继续第 3 步。
- 否。忽略该语句并退出。

有默认数据库。有 `--binlog-do-db` 选项吗？

- 是。其中任何一个匹配数据库吗？
  - 是。记录该语句并退出。
  - 否。忽略该语句并退出。
- 否。继续第 4 步。

任何 `--binlog-ignore-db` 选项是否匹配数据库？

- 是。忽略该语句并退出。
- 否。记录该语句并退出。

> **重要**  
> 对于基于语句的记录，对于 `CREATE DATABASE`、`ALTER DATABASE` 和 `DROP DATABASE` 语句，在刚给出的规则中有一个例外。在这些情况下，正在创建、修改或删除的数据库取代默认数据库，以决定是否记录或忽略更新。

`--binlog-do-db` 有时意味着“忽略其他数据库”。例如，在使用基于语句的记录时，只有 `--binlog-do-db=sales` 运行的服务器不会记录默认数据库与 sales 不同的语句。在使用相同选项的基于行的记录时，服务器只记录更

改 sales 中数据的更新。