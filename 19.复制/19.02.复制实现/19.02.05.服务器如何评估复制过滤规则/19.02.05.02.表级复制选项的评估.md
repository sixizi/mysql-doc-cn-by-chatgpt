### 19.2.5.2 表级复制选项的评估

副本仅在以下两种情况之一为真时才检查和评估表选项：

- 没有找到匹配的数据库选项。
- 找到一个或多个数据库选项，并根据上一节中描述的规则评估以得出“执行”条件（参见第 19.2.5.1 节，“数据库级复制和二进制日志选项的评估”）。

首先，作为预备条件，副本检查是否启用了基于语句的复制。如果是这样，并且语句发生在存储函数中，副本就执行该语句并退出。如果启用了基于行的复制，副本不知道语句是否在源上的存储函数中发生，因此这个条件不适用。

> **注意**
>
> 对于基于语句的复制，复制事件代表语句（构成给定事件的所有更改都与单个 SQL 语句相关联）；对于基于行的复制，每个事件代表单个表行的更改（因此，如 `UPDATE mytable SET mycol = 1` 这样的单个语句可能产生许多基于行的事件）。从事件角度查看时，检查表选项的过程对于基于行和基于语句的复制是相同的。

到达这一点时，如果没有表选项，副本简单地执行所有事件。如果有任何 `--replicate-do-table` 或 `--replicate-wild-do-table` 选项，事件必须匹配其中之一才能被执行；否则，它被忽略。如果有任何 `--replicate-ignore-table` 或 `--replicate-wild-ignore-table` 选项，除了匹配这些选项的事件外，所有事件都被执行。

> **重要**
>
> 表级复制过滤器仅适用于查询中明确提到并操作的表。它们不适用于查询隐式更新的表。例如，一个 `GRANT` 语句，它更新了 `mysql.user` 系统表但没有提到该表，不会受到指定 `mysql.%` 为通配符模式的过滤器的影响。

以下步骤详细描述了此评估。起点是根据第 19.2.5.1 节中描述的数据库级选项的评估结束。

1. 有表复制选项吗？

   - 是。继续第 2 步。

   - 否。执行更新并退出。


2. 使用的日志格式是什么？

   - STATEMENT：对执行更新的每个语句执行剩余步骤。

   - ROW：对每个表行的更新执行剩余步骤。

3. 有 `--replicate-do-table` 选项吗？

   - 是。表是否匹配其中任何一个？
     - 是。执行更新并退出。
     - 否。继续第 4 步。

   - 否。继续第 4 步。


4. 有 `--replicate-ignore-table` 选项吗？

   - 是。表是否匹配其中任何一个？
     - 是。忽略更新并退出。
     - 否。继续第 5 步。

   - 否。继续第 5 步。


5. 有 `--replicate-wild-do-table` 选项吗？

   - 是。表是否匹配其中任何一个？
     - 是。执行更新并退出。
     - 否。继续第 6 步。

   - 否。继续第 6 步。


6. 有 `--replicate-wild-ignore-table` 选项吗？

   - 是。表是否匹配其中任何一个？
     - 是。忽略更新并退出。
     - 否。继续第 7 步。

   - 否。继续第 7 步。

7. 还有其他表要测试吗？

   - 是。回到第 3 步。


   - 否。继续第 8 步。


8. 有 `--replicate-do-table` 或 `--replicate-wild-do-table` 选项吗？

   - 是。忽略更新并退出。

   - 否。执行更新并退出。


> **注意** 
>
> 如果单个 SQL 语句操作既包括 `--replicate-do-table` 或 `--replicate-wild-do-table` 选项包含的表，也包括 `--replicate-ignore-table` 或 `--replicate-wild-ignore-table` 选项忽略的表，则基于语句的复制将停止。副本必须执行或忽略完整的语句（形成复制事件），逻辑上不能做到这一点。这也适用于基于行的复制中的 DDL 语句，因为无论生效的日志格式如何，DDL 语句始终作为语句记录。唯一可以更新既包括也忽略的表并且仍然可以成功复制的语句类型是以 `binlog_format=ROW` 记录的 DML 语句。