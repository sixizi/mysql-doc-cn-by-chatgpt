#### 19.1.2.6 设置副本

以下部分描述了如何设置副本。在您继续之前，请确保您已经：

- 为源配置了必要的配置属性。参见第19.1.2.1节，“设置复制源配置”。

- 获取了源状态信息，或在数据快照期间关闭时制作的源的二进制日志索引文件的副本。参见第19.1.2.4节，“获取复制源二进制日志坐标”。

- 在源上，释放了读锁：

  ```sql
  mysql> UNLOCK TABLES;
  ```

- 在副本上，编辑了 MySQL 配置。参见第19.1.2.2节，“设置副本配置”。

- 接下来的步骤取决于您是否有现有数据要导入到副本中。有关更多信息，请参见第19.1.2.5节，“选择数据快照方法”。选择以下之一：

- 如果您没有要导入的数据库快照，请参见第19.1.2.6.1节，“使用新源和副本设置复制”。

- 如果您有要导入的数据库快照，请参见第19.1.2.6.2节，“使用现有数据设置复制”。


##### 19.1.2.6.1 使用新源和副本设置复制

当没有要导入的先前数据库的快照时，配置副本以从新源开始复制。

要在源和新副本之间设置复制，请：

1. 启动副本。

2. 在副本上执行 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句来设置源配置。参见第19.1.2.7节，“在副本上设置源配置”。


对每个副本执行这些副本设置步骤。

如果您正在设置新服务器，但有来自不同服务器的数据库转储，并且您想将其加载到复制配置中，也可以使用此方法。通过将数据加载到新源中，数据自动复制到副本。

如果您正在使用来自不同现有数据库服务器的数据设置新的复制环境以创建新源，请在新源上运行该服务器生成的转储文件。数据库更新自动传播到副本：

```sh
$> mysql -h source < fulldb.dump
```

##### 19.1.2.6.2 使用现有数据设置复制

使用现有数据设置复制时，在开始复制之前将快照从源传输到副本。导入数据到副本的过程取决于您在源上创建数据快照的方式。

> **提示**
>
> 要部署多个 MySQL 实例，您可以使用 InnoDB Cluster，它使您能够在 MySQL Shell 中轻松管理一组 MySQL 服务器实例。InnoDB Cluster 将 MySQL Group Replication 包装在一个程序化环境中，使您可以轻松部署一组 MySQL 实例以实现高可用性。此外，InnoDB Cluster 与 MySQL Router 无缝接口，使您的应用程序能够连接到集群而无需编写自己的故障转移过程。对于不需要高可用性的类似用例，您可以使用 InnoDB ReplicaSet。MySQL Shell 的安装说明可以在此找到。

> **注意**
>
> 如果您要复制的复制源服务器或现有副本有任何计划事件，请确保在启动新副本之前禁用这些事件。如果在新副本上运行了已经在源上运行的事件，则重复操作会导致错误。事件调度器由 `event_scheduler` 系统变量控制，从 MySQL 8.0 开始，默认值为 ON，因此当新副本启动时，默认情况下原始服务器上的活动事件将运行。要停止在新副本上运行所有事件，请将新副本上的 `event_scheduler` 系统变量设置为 OFF 或 DISABLED。或者，您可以使用 `ALTER EVENT` 语句将单个事件设置为 DISABLE 或 DISABLE ON SLAVE，以防止它们在新副本上运行。您可以使用 `SHOW` 语句或 Information Schema EVENTS 表列出服务器上的事件。有关更多信息，请参见第19.5.1.16节，“复制调用特性”。

作为这种方式创建新副本的替代方法，可以使用 MySQL Server 的克隆插件从现有副本传输所有数据和复制设置到克隆。有关使用此方法的说明，请参见第7.6.7.7节，“复制克隆”。

按照以下程序使用现有数据设置复制：

1. 如果您使用了 MySQL Server 的克隆插件从现有副本创建了克隆（参见第7.6.7.7节，“复制克隆”），则数据已经传输。否则，请使用以下方法之一将数据导入副本。

   1. 如果您使用了 `mysqldump`，启动副本服务器，确保复制不会通过使用 `--skip-slave-start` 选项启动，或从 MySQL 8.0.24 开始，使用 `skip_slave_start` 系统变量。然后导入转储文件：

      ```sh
      $> mysql < fulldb.dump
      ```

   2. 如果您使用原始数据文件创建了快照，请将数据文件解压到副本的数据目录中。例如：

      ```sh
      $> tar xvf dbdump.tar
      ```

      您可能需要设置文件的权限和所有权，以便副本服务器可以访问和修改它们。然后启动副本服务器，确保复制不会通过使用 `--skip-slave-start` 选项启动，或从 MySQL 8.0.24 开始，使用 `skip_slave_start` 系统变量。

2. 使用源的复制坐标配置副本。这告诉副本复制需要从哪个二进制日志文件和文件内的位置开始。此外，还要使用源的登录凭据和主机名配置副本。有关所需的 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句的更多信息，请参见第19.1.2.7节，“在副本上设置源配置”。

3. 通过发出 `START REPLICA`（或在 MySQL 8.0.22 之前，`START SLAVE`）语句启动复制线程。


在执行此程序后，副本将连接到源，并复制自快照拍摄以来在源上发生的任何更新。如果副本因任何原因无法进行复制，副本的错误日志会发出错误消息。

副本使用其连接元数据仓库和应用元数据仓库中记录的信息来跟踪已处理的源二进制日志的量。从 MySQL 8.0 开始，默认情况下，这些仓库是 mysql 数据库中名为 `slave_master_info` 和 `slave_relay_log_info` 的表。除非您确切知道自己在做什么并完全理解后果，否则不要删除或编辑这些表。即使在这种情况下，也建议您使用 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句来更改复制参数。副本使用语句中指定的值自动更新复制元数据仓库。有关更多信息，请参见第19.2.4节，“中继日志和复制元数据仓库”。

> **注意**
>
> 副本的连接元数据仓库的内容会覆盖在命令行或 my.cnf 中指定的一些服务器选项。有关更多细节，请参见第19.1.6节，“复制和二进制日志选项与变量”。

对于源的单个快照，足以供多个副本使用。要设置额外的副本，请使用相同的源快照并按照刚才描述的副本部分的程序进行。