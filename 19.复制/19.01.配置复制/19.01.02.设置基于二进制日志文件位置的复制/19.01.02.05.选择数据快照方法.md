19.1.2.5 选择数据快照方法

如果源数据库包含现有数据，则需要将此数据复制到每个副本。有不同的方式可以从源数据库导出数据。以下部分描述了可能的选项。

要选择导出数据库的适当方法，请在以下选项之间选择：

使用 `mysqldump` 工具创建要复制的所有数据库的转储。这是推荐的方法，特别是在使用 InnoDB 时。

如果您的数据库存储在二进制便携式文件中，您可以将原始数据文件复制到副本。与使用 `mysqldump` 并在每个副本上导入文件相比，这可能更高效，因为它跳过了重新播放 `INSERT` 语句时更新索引的开销。对于如 InnoDB 这样的存储引擎，不推荐使用此方法。

使用 MySQL Server 的克隆插件将所有数据从现有副本传输到克隆。有关使用此方法的说明，请参见第7.6.7.7节，“复制克隆”。

提示：
要部署多个 MySQL 实例，您可以使用 InnoDB Cluster，它使您能够在 MySQL Shell 中轻松管理一组 MySQL 服务器实例。InnoDB Cluster 将 MySQL Group Replication 包装在一个程序化环境中，使您可以轻松部署一组 MySQL 实例以实现高可用性。此外，InnoDB Cluster 与 MySQL Router 无缝接口，使您的应用程序能够连接到集群而无需编写自己的故障转移过程。对于不需要高可用性的类似用例，您可以使用 InnoDB ReplicaSet。MySQL Shell 的安装说明可以在此找到。

19.1.2.5.1 使用 `mysqldump` 创建数据快照

要创建现有源数据库中数据的快照，请使用 `mysqldump` 工具。数据转储完成后，在启动复制过程之前，将此数据导入副本。

以下示例将所有数据库转储到名为 `dbdump.db` 的文件中，并包括 `--master-data` 选项，该选项自动附加副本上开始复制过程所需的 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句：

```sh
$> mysqldump --all-databases --master-data > dbdump.db
```

注意：
如果您不使用 `--master-data`，则需要在另一个会话中手动锁定所有表。参见第19.1.2.4节，“获取复制源二进制日志坐标”。

可以使用 `mysqldump` 工具排除转储中的某些数据库。如果您想选择要包括在转储中的数据库，请不要使用 `--all-databases`。选择以下选项之一：

使用 `--ignore-table` 选项排除数据库中的所有表。

仅命名您希望转储的数据库，使用 `--databases` 选项。

注意：
默认情况下，如果源上使用了 GTID（`gtid_mode=ON`），`mysqldump` 包括源上 `gtid_executed` 集中的 GTID 在转储输出中，以将它们添加到副本上的 `gtid_purged` 集。如果您仅转储特定数据库或表，重要的是要注意 `mysqldump` 包含的值包括源上 `gtid_executed` 集中所有事务的 GTID，即使是那些更改了被压制部分数据库或服务器上未包括在部分转储中的其他数据库的事务。检查 `mysqldump` 的 `--set-gtid-purged` 选项的描述，找出您使用的 MySQL 服务器版本的默认行为的结果，以及如何更改行为（如果此结果不适合您的情况）。

有关更多信息，请参见第6.5.4节，“mysqldump - 一个数据库备份程序”。

要导入数据，请将转储文件复制到副本上，或在远程连接到副本时从源访问文件。

19.1.2.5.2 使用原始数据文件创建数据快照

本节描述了如何使用构成数据库的原始文件创建数据快照。使用具有复杂缓存或日志算法的存储引擎的表进行此方法时，需要额外的步骤来产生完美的“时间点”快照：初始复制命令可能会遗漏缓存信息和日志更新，即使您已获取全局读锁。存储引擎对此的响应取决于其崩溃恢复能力。

如果您使用 InnoDB 表，可以使用 MySQL Enterprise Backup 组件的 `mysqlbackup` 命令产生一致的快照。此命令记录与快照相对应的日志名称和偏移量，以供副本使用。MySQL Enterprise Backup 是 MySQL Enterprise 订阅的一部分包含的商业产品。有关详细信息，请参见第32.1节，“MySQL Enterprise Backup 概述”。

此方法如果源和副本对于 `ft_stopword_file`、`ft_min_word_len` 或 `ft_max_word_len` 有不同的值，并且您正在复制具有全文索引的表时，也无法可靠地工作。

假设上述异常不适用于您的数据库，使用冷备份技术可以获得 InnoDB 表的可靠二进制快照：慢速关闭 MySQL 服务器，然后手动复制数据文件。

要在 MySQL 数据文件存在于单个文件系统上时为 MyISAM 表创建原始数据快照，您可以使用标准文件复制工具（如 `cp` 或 `copy`）、远程复制工具（如 `scp` 或 `rsync`）、归档工

具（如 `zip` 或 `tar`）或文件系统快照工具（如 `dump`）。如果您只复制特定数据库，请仅复制与这些表相关的文件。对于 InnoDB，所有数据库中的所有表都存储在系统表空间文件中，除非您启用了 `innodb_file_per_table` 选项。

以下文件不需要复制：

与 `mysql` 数据库相关的文件。

如果使用，副本的连接元数据仓库文件 `master.info`；现在不推荐使用此文件（参见第19.2.4节，“中继日志和复制元数据仓库”）。

源的二进制日志文件，如果您打算使用这些文件来定位副本的源二进制日志坐标，除了二进制日志索引文件外。

任何中继日志文件。

根据您是否使用 InnoDB 表，选择以下之一：

如果您使用 InnoDB 表，并且为了获得最一致的原始数据快照结果，如下在过程中关闭源服务器：

获取源的读锁并获取源的状态。参见第19.1.2.4节，“获取复制源二进制日志坐标”。

在另一个会话中，关闭源服务器：

```sh
$> mysqladmin shutdown
```

复制 MySQL 数据文件。以下示例显示了常用的方法之一。您只需要选择其中一个：

```sh
$> tar cf /tmp/db.tar ./data
$> zip -r /tmp/db.zip ./data
$> rsync --recursive ./data /tmp/dbdata
```

重启源服务器。

如果您不使用 InnoDB 表，您可以在不关闭服务器的情况下获取系统的快照，如下所述的步骤：

获取源的读锁并获取源的状态。参见第19.1.2.4节，“获取复制源二进制日志坐标”。

复制 MySQL 数据文件。以下示例显示了常用的方法之一。您只需要选择其中一个：

```sh
$> tar cf /tmp/db.tar ./data
$> zip -r /tmp/db.zip ./data
$> rsync --recursive ./data /tmp/dbdata
```

在您获取读锁的客户端中，释放锁：

```sql
mysql> UNLOCK TABLES;
```

一旦创建了数据库的归档或复制，就将文件复制到每个副本上，然后开始复制过程。