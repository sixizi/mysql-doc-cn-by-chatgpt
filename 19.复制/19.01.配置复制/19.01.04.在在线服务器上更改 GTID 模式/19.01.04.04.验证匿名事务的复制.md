19.1.4.4 验证匿名事务的复制

本节解释了如何监控复制拓扑并验证所有匿名事务已被复制。在在线更改复制模式时，这很有帮助，因为您可以验证更改为 GTID 事务是否安全。

等待事务复制有几种可能的方法：

最简单的方法，适用于任何拓扑，但依赖于时间是：如果您确定副本从不延迟超过 N 秒，那么只需等待略长于 N 秒的时间。或者等待一天，或者您认为对您的部署来说安全的任何时间段。

在不依赖时间的意义上更安全的方法：如果您只有一个源和一个或多个副本，执行以下操作：

在源上执行：

```
SHOW MASTER STATUS;
```

记下 File 和 Position 列中的值。

在每个副本上，使用源的文件和位置信息执行：

```
SELECT MASTER_POS_WAIT(file, position);
```

或从 MySQL 8.0.26 开始：

```
SELECT SOURCE_POS_WAIT(file, position);
```

如果您有一个源和多级副本，换句话说，您有副本的副本，从源开始，然后是所有直接副本，然后是所有副本的副本等，对每一级重复步骤 2。

如果您使用循环复制拓扑，其中多个服务器可能有写客户端，请对每个源-副本连接执行步骤 2，直到您完成了完整的圈。重复整个过程，以便您进行两次完整的循环。

例如，假设您有三个服务器 A、B 和 C，以圈的形式进行复制，使得 A -> B -> C -> A。然后，过程是：

在 A 上执行步骤 1，在 B 上执行步骤 2。

在 B 上执行步骤 1，在 C 上执行步骤 2。

在 C 上执行步骤 1，在 A 上执行步骤 2。

在 A 上执行步骤 1，在 B 上执行步骤 2。

在 B 上执行步骤 1，在 C 上执行步骤 2。

在 C 上执行步骤 1，在 A 上执行步骤 2。