#### 19.4.1.2 从副本备份原始数据

为了确保复制的文件的完整性，应在您的 MySQL 副本服务器关闭时备份原始数据文件。如果 MySQL 服务器仍在运行，后台任务可能仍在更新数据库文件，尤其是涉及具有后台进程的存储引擎（如 InnoDB）的文件。对于 InnoDB，这些问题应在崩溃恢复期间解决，但由于副本服务器可以在备份过程中关闭而不影响源的执行，因此利用这一功能是有意义的。

关闭服务器并备份文件：

1. 关闭副本 MySQL 服务器：

   ```shell
   $> mysqladmin shutdown
   ```

2. 复制数据文件。您可以使用任何合适的复制或归档工具，包括 cp、tar 或 WinZip。例如，假设数据目录位于当前目录下，您可以如下归档整个目录：

   ```shell
   $> tar cf /tmp/dbbackup.tar ./data
   ```

3. 再次启动 MySQL 服务器。在 Unix 下：

   ```shell
   $> mysqld_safe &
   ```

   在 Windows 下：

   ```shell
   C:\> "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysqld"
   ```


通常您应该备份副本 MySQL 服务器的整个数据目录。如果您想能够恢复数据并作为副本运行（例如，在副本失败的情况下），除了数据外，您还需要拥有副本的连接元数据仓库和应用程序元数据仓库以及中继日志文件。在恢复副本数据后，需要这些项来恢复复制。假设使用了表格来存储副本的连接元数据仓库和应用程序元数据仓库（参见第 19.2.4 节，“中继日志和复制元数据仓库”），这是 MySQL 8.0 中的默认设置，这些表格将与数据目录一起备份。如果使用了文件存储这些仓库，这种做法已被弃用，您必须单独备份这些文件。如果中继日志文件放置在与数据目录不同的位置，必须单独备份。

如果您丢失了中继日志但仍有 relay-log.info 文件，您可以检查它以确定复制 SQL 线程在源的二进制日志中执行到何处。然后，您可以使用 MySQL 8.0.23 的 `CHANGE REPLICATION SOURCE TO` 语句或 MySQL 8.0.23 之前的 `CHANGE MASTER TO` 语句，配合 `SOURCE_LOG_FILE | MASTER_LOG_FILE` 和 `SOURCE_LOG_POS | MASTER_LOG_POS` 选项，让副本从那个点重新读取二进制日志。这要求源服务器上仍然存在二进制日志。

如果您的副本正在复制 `LOAD DATA` 语句，您还应该备份副本用于此目的的目录中存在的任何 `SQL_LOAD-*` 文件。副本需要这些文件来恢复任何中断的 `LOAD DATA` 操作的复制。此目录的位置是系统变量 `replica_load_tmpdir`（从 MySQL 8.0.26 开始）或 `slave_load_tmpdir`（在 MySQL 8.0.26 之前）的值。如果服务器未设置该变量启动，则目录位置为 `tmpdir` 系统变量的值。