### 19.4.10 半同步复制

- [19.4.10.1 安装半同步复制](./19.04.10.01.安装半同步复制.md)
- [19.4.10.2 配置半同步复制](./19.04.10.02.配置半同步复制.md)
- [19.4.10.3 监控半同步复制](./19.04.10.03.监控半同步复制.md)

除了内置的异步复制，MySQL 8.0 还支持通过插件实现的半同步复制接口。本节讨论什么是半同步复制以及它是如何工作的。以下各节涵盖了半同步复制的管理接口以及如何安装、配置和监控它。

MySQL 复制默认是异步的。源将事件写入其二进制日志，副本在准备好时请求这些事件。源不知道副本是否或何时检索并处理了事务，也不能保证任何事件是否到达任何副本。在异步复制中，如果源崩溃，它已提交的事务可能尚未传输到任何副本。在这种情况下，从源故障转移到副本可能会导致转移到一个相对于源丢失事务的服务器。

在完全同步复制中，当源提交事务时，所有副本也在源返回执行事务的会话之前提交了事务。完全同步复制意味着可以在任何时候从源故障转移到任何副本。完全同步复制的缺点是完成事务可能需要很长时间。

半同步复制位于异步复制和完全同步复制之间。源等待至少一个副本已接收并记录了事件（可配置所需的副本数），然后提交事务。源不等待所有副本确认收到，只需要副本的确认，而不是事件已在副本端完全执行和提交。因此，半同步复制保证如果源崩溃，它已提交的所有事务都已传输到至少一个副本。

与异步复制相比，半同步复制提供了改进的数据完整性，因为当提交成功返回时，已知数据至少存在于两个位置。在半同步源收到所需数量的副本确认之前，事务被挂起并未提交。

与完全同步复制相比，半同步复制更快，因为它可以配置以平衡您对数据完整性的要求（确认事务收到的副本数）与提交的速度（由于需要等待副本而更慢）。

> **重要提示**
>
> 使用半同步复制时，如果源崩溃并且执行了故障转移到副本，应当废弃失败的源并不再将其用作复制源。它可能包含未被任何副本确认的事务，因此在故障转移前未提交。
>
> 如果您的目标是实现一个容错的复制拓扑，其中所有服务器按相同的顺序接收相同的事务，并且崩溃的服务器可以重新加入群组并自动更新到最新状态，您可以使用群组复制来实现这一点。有关信息，请参见第 20 章，群组复制。

与异步复制相比，半同步复制的性能影响是提高数据完整性的权衡。最少的延迟是 TCP/IP 往返时间，用于将提交发送到副本并等待副本确认收到。这意味着半同步复制最适合通过快速网络通信的近距离服务器，而对于通过慢速网络通信的远距离服务器效果最差。半同步复制还通过限制从源到副本发送二进制日志事件的速度为繁忙的会话设置了速率限制。当一个用户过于繁忙时，这会减慢其速度，这在某些部署情况下可能很有用。

半同步复制的工作方式如下：

- 副本在连接到源时指示它是否支持半同步。


- 如果源端启用了半同步复制并且至少有一个半同步副本，执行事务提交的线程会阻塞并等待，直到至少一个半同步副本确认已接收到事务的所有事件，或者直到发生超时。


- 副本仅在将事务的事件写入其中继日志并刷新到磁盘后才确认接收。


- 如果发生超时而没有任何副本确认事务，源将转为异步复制。当至少一个半同步副本赶上时，源返回半同步复制。


- 必须在源和副本端启用半同步复制。如果在源上禁用半同步复制，或者在源上启用但在没有副本上启用，源使用异步复制。


当源阻塞（等待副本的确认）时，它不会返回执行事务的会话。当阻塞结束时，源返回会话，此时可以继续执行其他语句。此时，事务已在源端提交，并且其事件已被至少一个副本确认接收。源必须接收到的每个事务的副本确认数量在返回会话之前是可配置的，默认为一个确认（见第 19.4.10.2 节，“配置半同步复制”）。

阻塞也发生在写入二进制日志的回滚之后，这发生在修改非事务性表的事务被回滚时。尽管回滚的事务对事务性表没有影响，回滚的事务还是被记录，因为对非事务性表的修改不能回滚并且必须发送到副本。

对于在事务性上下文之外发生的语句（即，没有使用 `START TRANSACTION` 或 `SET autocommit = 0` 启动事务时），自动提交被启用并且每个语句隐式提交。使用半同步复制时，源会为每个此类语句阻塞，就像它对显式事务提交一样。

默认情况下，源在将二进制日志同步到磁盘后等待副本确认事务收到，但在将事务提交到存储引擎之前。作为替代，您可以配置源，使源在将事务提交到存储引擎后等待副本确认，使用 `rpl_semi_sync_source_wait_point` 或 `rpl_semi_sync_master_wait_point` 系统变量。此设置影响复制特性及客户端在源上可以看到的数据。有关更多信息，请参见第 19.4.10.2 节，“配置半同步复制”。

从 MySQL 8.0.23 开始，您可以通过启用系统变量 `replication_sender_observe_commit_only` 来提高半同步复制的性能，该变量限制回调，并通过 `replication_optimize_for_static_plugin_config` 添加共享锁并避免不必要的锁获取。随着副本数量的增加，这些设置有助于改善性能，因为锁的争用可能会减慢性能。半同步复制源服务器也可以通过启用这些系统变量从中受益，因为它们使用与副本相同的锁机制。