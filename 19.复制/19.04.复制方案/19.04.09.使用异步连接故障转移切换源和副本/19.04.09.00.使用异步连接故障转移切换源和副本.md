### 19.4.9 切换源和副本的异步连接故障转移

- [19.4.9.1 源的异步连接故障转移](./19.04.09.01.源的异步连接故障转移.md)
- [19.4.9.2 副本的异步连接故障转移](./19.04.09.02.副本的异步连接故障转移.md)

从 MySQL 8.0.22 开始，您可以使用异步连接故障转移机制，在副本与其源的现有连接失败后，自动建立与新源之间的异步（源到副本）复制连接。异步连接故障转移机制可用于使副本与多个 MySQL 服务器或共享数据的服务器组保持同步。潜在源服务器的列表存储在副本上，在连接失败的情况下，根据您设置的加权优先级从列表中选择新的源。

从 MySQL 8.0.23 开始，异步连接故障转移机制还支持群组复制拓扑，通过自动监控群组成员资格的变化，并区分主服务器和辅助服务器。当您将群组成员添加到源列表并将其定义为托管群组的一部分时，异步连接故障转移机制会更新源列表以保持与成员资格变化一致，自动添加和删除随着他们加入或离开的群组成员。只有多数在线的群组成员才用于连接和获取状态。托管群组的最后一个剩余成员即使离开了群组也不会自动删除，以保留托管群组的配置。然而，如果不再需要托管群组，您可以手动删除它。

从 MySQL 8.0.27 开始，异步连接故障转移机制还使得作为托管复制群组一部分的副本在当前接收者（群组的主要成员）失败时自动重新连接到发送者。该功能与群组复制一起工作，在单主模式下配置的群组中，群组的主要成员是具有使用该机制的复制通道的副本。此功能旨在为发送者群组和接收者群组保持同步，即使某些成员暂时不可用。它还同步一个或多个不属于托管群组的发送者的接收者群组。不属于复制群组的副本不能使用此功能。

使用异步连接故障转移机制的要求如下：

- 源和副本必须使用 GTID（`gtid_mode=ON`），并且在副本上必须启用 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句的 `SOURCE_AUTO_POSITION | MASTER_AUTO_POSITION` 选项，以便为连接到源使用 GTID 自动定位。


- 所有源服务器上必须存在相同的复制用户帐户和密码，用于通道的源列表。这个帐户用于与每个源的连接。您可以为不同的通道设置不同的帐户。


- 复制用户帐户必须被授权在 Performance Schema 表上执行 SELECT，例如，通过发出 `GRANT SELECT ON performance_schema.* TO 'repl_user';`


- 复制用户帐户和密码不能在用于启动复制的语句上指定，因为它们需要在自动重启连接到替代源时可用。它们必须使用副本上的 `CHANGE REPLICATION SOURCE TO | CHANGE MASTER TO` 语句为通道设置，并记录在复制元数据仓库中。


- 如果使用异步连接故障转移机制的通道位于群组复制单主模式群组的主要服务器上，从 MySQL 8.0.27 开始，副本之间的异步连接故障转移也默认激活。在这种情况下，必须在复制群组的所有辅助服务器上，以及任何新加入的成员上设置复制通道和复制用户帐户及密码。如果新服务器使用 MySQL 的克隆功能配置，则所有这些都会自动发生。

  > **重要**
  >
  > 如果您不希望在这种情况下发生副本之间的异步连接故障转移，请通过使用 `group_replication_disable_member_action` 函数禁用群组的成员操作 `mysql_start_failover_channels_if_primary` 来禁用它。当此功能被禁用时，您不需要在辅助群组成员上配置复制通道，但如果主要服务器离线或进入错误状态，通道的复制将停止。

从 MySQL Shell 8.0.27 和 MySQL 8.0.27 开始，MySQL InnoDB ClusterSet 可用于通过将主要 InnoDB Cluster 与其自身的一个或多个副本链接在不同位置（如不同的数据中心）来为 InnoDB Cluster 部署提供灾难容忍。考虑使用这种解决方案来简化新的多群组部署的设置，用于复制、故障转移和灾难恢复。您可以将现有的群组复制部署作为 InnoDB Cluster 接受。

InnoDB ClusterSet 和 InnoDB Cluster 旨在抽象和简化设置、管理、监控、恢复和修复复制群组的程序。InnoDB ClusterSet 使用专用的 ClusterSet 复制通道自动管理从主群组到副本群组的复制。您可以使用管理员命令在主群组无法正常工作时触发受控切换或紧急故障转移。服务器和群组可以在初始设置后根据需求变化轻松地添加到或从 InnoDB ClusterSet 部署中删除。有关更多信息，请参阅 MySQL InnoDB ClusterSet。