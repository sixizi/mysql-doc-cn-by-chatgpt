### 19.4.5 使用复制进行扩展

您可以将复制用作扩展解决方案；也就是说，您希望将数据库查询的负载分散到多个数据库服务器上，同时保持在一定的合理限制内。

因为复制是从一个源到一个或多个副本的分发工作，所以在读操作多而写/更新操作少的环境中使用复制进行扩展效果最佳。大多数网站都属于这一类，用户在网站上浏览、阅读文章、帖子或查看产品。更新操作只在会话管理中发生，或者在进行购买或在论坛添加评论/消息时进行。

在这种情况下，复制允许您将读操作分布到副本上，同时仍然允许您的Web服务器在需要写操作时与源服务器通信。您可以在图 19.1 “使用复制在扩展时提升性能”中看到此场景的示例复制布局。

**图 19.1 使用复制在扩展时提升性能**

来自客户端的请求被引导到负载均衡器，负载均衡器将客户端数据分配给多个Web客户端。Web客户端发起的写操作被引导到单个MySQL源服务器，读操作被引导到三个MySQL副本服务器之一。复制从MySQL源服务器到三个MySQL副本服务器进行。

如果负责数据库访问的代码部分已经得到适当的抽象/模块化，那么将其转换为使用复制设置应该非常顺畅和简单。更改您的数据库访问实现，将所有写操作发送到源，将读操作发送到源或副本。如果您的代码没有这种抽象级别，设置复制系统为您提供了整理代码的机会和动机。首先创建一个包装库或模块，实现以下功能：

- `safe_writer_connect()`
- `safe_reader_connect()`
- `safe_reader_statement()`
- `safe_writer_statement()`

这里的 `safe_` 表示每个函数负责处理所有错误条件。您可以为这些函数使用不同的名称。重要的是拥有一个统一的界面，用于连接读取、连接写入、执行读取和执行写入。

然后将您的客户端代码转换为使用包装库。最初这可能是一个痛苦和可怕的过程，但从长远来看是值得的。所有使用上述方法的应用程序都能够利用源/副本配置，即使涉及多个副本。代码维护更加容易，添加故障排除选项也是微不足道的。您只需要修改一两个函数（例如，记录每个语句花费的时间，或者记录哪个发出的语句给您带来了错误）。

如果您编写了大量代码，您可能想通过编写转换脚本来自动化转换任务。理想情况下，您的代码使用一致的编程风格约定。如果不是，那么您可能最好还是重写代码，或者至少手动规范化它，使其使用一致的风格。