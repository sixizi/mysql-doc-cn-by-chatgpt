#### 15.6.2.3 排序索引构建

在创建或重建索引时，InnoDB执行批量加载，而不是一次插入一个索引记录。这种索引创建方法也称为排序索引构建。空间索引不支持排序索引构建。

索引构建分为三个阶段。在第一阶段，扫描聚集索引，生成索引条目并将其添加到排序缓冲区。当排序缓冲区满时，条目被排序并写入临时中间文件。这个过程也称为“运行（*run*）”。在第二阶段，当一个或多个运行写入临时中间文件后，对文件中的所有条目执行合并排序。在第三个也是最后一个阶段，将排序后的条目插入B树。

在引入排序索引构建之前，索引条目是通过使用插入API逐条记录插入B树中的。这种方法涉及到打开一个B树游标以找到插入位置，然后使用乐观插入将条目插入B树页面。如果由于页面满而插入失败，将执行悲观插入，涉及到打开B树游标以及根据需要分裂和合并B树节点以找到条目的空间。这种“自上而下”构建索引的方法的缺点是寻找插入位置的成本以及不断地分裂和合并B树节点。

排序索引构建使用“自下而上”的方法构建索引。使用这种方法，B树的所有级别都保留对最右侧叶页的引用。分配必要的B树深度的最右侧叶页，并根据它们的排序顺序插入条目。一旦叶页满了，就将节点指针附加到父页面，并为下一个插入分配一个兄弟叶页。这个过程持续到所有条目被插入，可能导致直到根级别的插入。当分配一个兄弟页时，先前固定的叶页的引用被释放，新分配的叶页成为最右侧的叶页和新的默认插入位置。

##### 为未来索引增长保留B树页面空间

要为未来的索引增长预留空间，可以使用innodb_fill_factor变量来保留B树页面的一定百分比空间。例如，将innodb_fill_factor设置为80，在排序索引构建期间为B树页面保留20%的空间。这个设置适用于B树的叶子页面和非叶子页面。它不适用于用于TEXT或BLOB条目的外部页面。保留的空间量可能不会完全按配置的来，因为innodb_fill_factor值被解释为提示，而不是硬限制。

##### 排序索引构建和全文索引支持

排序索引构建支持全文索引。以前，SQL被用来将条目插入全文索引。

##### 排序索引构建和压缩表

对于压缩表，以前的索引创建方法将条目附加到压缩和未压缩页面上。当修改日志（表示压缩页面上的可用空间）变满时，压缩页面将被重新压缩。如果由于空间不足而压缩失败，页面将被分裂。使用排序索引构建时，条目只被附加到未压缩页面。当未压缩页面变满时，它被压缩。自适应填充被用来确保在大多数情况下压缩成功，但如果压缩失败，页面将被分裂并再次尝试压缩。这个过程一直持续到压缩成功。有关B树页面压缩的更多信息，请参见第15.9.1.5节“InnoDB表的压缩工作原理”。

##### 排序索引构建和重做日志

在排序索引构建期间，重做日志被禁用。相反，有一个检查点确保索引构建可以承受意外退出或失败。检查点强制将所有脏页面写入磁盘。在排序索引构建期间，页面清理线程定期被通知以刷新脏页面，以确保检查点操作可以快速处理。通常，当干净页面的数量低于设定阈值时，页面清理线程会刷新脏页面。对于排序索引构建，脏页面被及时刷新，以减少检查点开销并并行化I/O和CPU活动。

##### 排序索引构建和优化器统计

排序索引构建可能导致与以前的索引创建方法生成的优化器统计数据不同。由于用于填充索引的不同算法，统计数据的差异不会影响工作负载性能。