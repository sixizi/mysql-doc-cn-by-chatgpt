### 15.5.1 缓冲池

缓冲池是主内存中的一个区域，InnoDB 在其中缓存访问的表和索引数据。缓冲池允许直接从内存中访问频繁使用的数据，从而加速处理。在专用服务器上，通常会将多达 80% 的物理内存分配给缓冲池。

为了提高大量读操作的效率，缓冲池被划分为可以容纳多个行的页面。为了缓存管理的效率，缓冲池实现为页面的链接列表；很少使用的数据通过最近最少使用（LRU）算法的变种从缓存中淘汰。

了解如何利用缓冲池将频繁访问的数据保留在内存中，是 MySQL 调优的重要方面。

#### 缓冲池 LRU 算法

缓冲池使用 LRU 算法的变种作为列表进行管理。当需要空间在缓冲池中添加新页面时，最近最少使用的页面被淘汰，新页面被添加到列表的中间。这种中点插入策略将列表视为两个子列表：

- 在头部，一个新的（“年轻”）页面的子列表，这些页面最近被访问过
- 在尾部，一个旧页面的子列表，这些页面较少被访问

图 15.2 缓冲池列表

![](innodb-buffer-pool-list.png)

该算法将频繁使用的页面保留在新子列表中。旧子列表包含不太频繁使用的页面；这些页面是淘汰的候选者。

默认情况下，算法如下操作：

- 缓冲池的 3/8 用于旧子列表。
- 列表的中点是新子列表的尾部与旧子列表的头部相遇的边界。
- 当 InnoDB 将页面读入缓冲池时，它最初将其插入中点（旧子列表的头部）。页面可能因为用户发起的操作（如 SQL 查询）或 InnoDB 自动执行的预读操作而被读取。
- 在旧子列表中访问页面会使其“年轻化”，将其移至新子列表的头部。如果页面是因为用户发起的操作而被读取，则第一次访问会立即发生，页面被立即变年轻。如果页面是由于预读操作而被读取，第一次访问可能不会立即发生，甚至可能在页面被淘汰之前都不会发生。
- 随着数据库的运行，缓冲池中未被访问的页面会通过向列表尾部移动来“老化”。新子列表和旧子列表中的页面都会随着其他页面变新而老化。旧子列表中的页面也会随着页面在中点插入而老化。最终，未被使用的页面会到达旧子列表的尾部并被淘汰。


默认情况下，查询读取的页面会立即移动到新子列表中，这意味着它们会在缓冲池中停留更长时间。例如，为 mysqldump 操作或没有 WHERE 子句的 SELECT 语句执行的表扫描，可能会将大量数据带入缓冲池，并淘汰等量的旧数据，即使新数据再也不会被使用。同样，由预读后台线程加载并且只被访问一次的页面会被移动到新列表的头部。这些情况可能会将频繁使用的页面推到旧子列表中，使它们面临被淘汰的风险。有关优化这种行为的信息，请参见第 15.8.3.3 节，“使缓冲池抗扫描”，以及第 15.8.3.4 节，“配置 InnoDB 缓冲池预读（预读）”。

InnoDB 标准监视器输出在 "BUFFER POOL AND MEMORY" 部分包含了有关缓冲池 LRU 算法运行的几个字段。详细信息请参见使用 InnoDB 标准监视器监控缓冲池。

#### 缓冲池配置

您可以配置缓冲池的各个方面以提高性能。

理想情况下，您应将缓冲池的大小设置为尽可能大的值，同时留出足够的内存供服务器上的其他进程运行，以避免过度分页。缓冲池越大，InnoDB 的行为就越像内存数据库，在第一次从磁盘读取数据后，随后的读取操作都从内存中访问数据。请参见第 15.8.3.1 节，“配置 InnoDB 缓冲池大小”。

在具有足够内存的 64 位系统上，您可以将缓冲池分割成多个部分，以最小化并发操作之间对内存结构的争用。详细信息请参见第 15.8.3.2 节，“配置多个缓冲池实例”。

您可以保留经常访问的数据在内存中，不受导致大量不常访问的数据进入缓冲池的操作的突然高峰的影响。详细信息请参见第 15.8.3.3 节，“使缓冲池抗扫描”。

您可以控制何时执行预读请求，以异步预取页面到缓冲池中，预期即将需要它们。详细信息请参见第 15.8.3.4 节，“配置 InnoDB 缓冲池预读（预读）”。

您可以控制何时进行背景刷新，以及是否根据工作负载动态调整刷新速率。有关详细信息，请参见第 15.8.3.5 节，“配置缓冲池刷新”。

您可以配置 InnoDB 如何保留当前缓冲池状态，以避免服务器重启后经历长时间的预热期。有关详细信息，请参见第 15.8.3.6 节，“保存和恢复缓冲池状态”。

#### 使用 InnoDB 标准监视器监控缓冲池

InnoDB 标准监视器输出（可以通过 SHOW ENGINE INNODB STATUS 访问）提供了有关缓冲池运行的指标。缓冲池指标位于 InnoDB 标准监视器输出的 “BUFFER POOL AND MEMORY” 部分：

```
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 2198863872
Dictionary memory allocated 776332
Buffer pool size   131072
Free buffers       124908
Database pages     5720
Old database pages 2071
Modified db pages  910
Pending reads 0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 4, not young 0
0.10 youngs/s, 0.00 non-youngs/s
Pages read 197, created 5523, written 5060
0.00 reads/s, 190.89 creates/s, 244.94 writes/s
Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not
0 / 1000
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read
ahead 0.00/s
LRU len: 5720, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
```

InnoDB 标准监视器报告的缓冲池指标的说明如下表所示。

InnoDB 标准监视器输出中提供的每秒平均值基于自上次打印 InnoDB 标准监视器输出以来的经过时间。

表 15.2 InnoDB 缓冲池指标

| Name                        | Description                                                  |
| --------------------------- | ------------------------------------------------------------ |
| Total memory allocated      | 分配给缓冲池的总内存量，单位为字节。                         |
| Dictionary memory allocated | 分配给 InnoDB 数据字典的总内存量，单位为字节。               |
| Buffer pool size            | 分配给缓冲池的总大小，以页面数计。                           |
| Free buffers                | 缓冲池空闲列表的总大小，以页面数计。                         |
| Database pages              | 缓冲池 LRU 列表的总大小，以页面数计。                        |
| Old database pages          | 缓冲池旧 LRU 子列表的总大小，以页面数计。                    |
| Modified db pages           | 缓冲池中当前修改的页面数。                                   |
| Pending reads               | 等待读入缓冲池的缓冲池页面数。                               |
| Pending writes LRU          | 缓冲池中等待从 LRU 列表底部写出的旧脏页面数。                |
| Pending writes flush list   | 检查点期间需要冲刷的缓冲池页面数。                           |
| Pending writes single page  | 缓冲池中等待独立页面写入的挂起页面数。                       |
| Pages made young            | 在缓冲池 LRU 列表中变为年轻的页面总数（移动到“新”页面子列表的顶部）。 |
| Pages made not young        | 在缓冲池 LRU 列表中未变为年轻的页面总数（页面保持在“旧”子列表中，未变为年轻）。 |
| youngs/s                    | 对缓冲池 LRU 列表中旧页面的访问次数每秒平均值，这些访问结果使页面变年轻。有关更多信息，请参阅本表后的注释。 |
| non-youngs/s                | 对缓冲池 LRU 列表中旧页面的访问次数每秒平均值，这些访问结果未使页面变年轻。有关更多信息，请参阅本表后的注释。 |
| Pages read                  | 从缓冲池读取的页面总数。                                     |
| Pages created               | 在缓冲池内创建的页面总数。                                   |
| Pages written               | 从缓冲池写出的页面总数。                                     |
| reads/s                     | 每秒缓冲池页面读取次数的平均值。                             |
| creates/s                   | 每秒创建的缓冲池页面数量的平均值。                           |
| writes/s                    | 每秒写入的缓冲池页面数量的平均值。                           |
| Buffer pool hit rate        | 从缓冲池读取页面与从磁盘存储读取页面的缓冲池页面命中率。     |
| young-making rate           | 页面访问导致页面变年轻的平均命中率。有关更多信息，请参阅本表后的注释。 |
| not (young-making rate) | 页面访问未导致页面变年轻的平均命中率。有关更多信息，请参阅本表后的注释。 |
| Pages read ahead | 预读操作的每秒平均次数。 |
| Pages evicted without access | 未被访问就从缓冲池中逐出的页面的每秒平均数。 |
| Random read ahead | 随机预读操作的每秒平均次数。 |
| LRU len | 缓冲池 LRU 列表的总大小，以页面数计。 |
| unzip_LRU len | 缓冲池 unzip_LRU 列表的长度（以页面计）。 |
| I/O sum | 访问的缓冲池 LRU 列表页面的总数。 |
| I/O cur | 当前间隔内访问的缓冲池 LRU 列表页面的总数。 |
| I/O unzip sum | 解压的缓冲池 unzip_LRU 列表页面的总数。 |
| I/O unzip cur | 当前间隔内解压的缓冲池 unzip_LRU 列表页面的总数。 |                     |

**注释：**

- youngs/s 指标仅适用于旧页面。它基于页面访问次数。给定页面可以有多次访问，所有这些都会被计算。如果在没有进行大量扫描时看到很低的 youngs/s 值，请考虑减少延迟时间或增加用于旧子列表的缓冲池的百分比。增加百分比会使旧子列表变大，因此页面在该子列表中移动到尾部所需的时间更长，这增加了这些页面再次被访问并变年轻的可能性。请参见第 15.8.3.3 节，“使缓冲池抗扫描”。
- non-youngs/s 指标也仅适用于旧页面。它基于页面访问次数。给定页面可以有多次访问，所有这些都会被计算。如果在执行大量表扫描时没有看到更高的 non-youngs/s 值（以及更高的 youngs/s 值），请增加延迟值。请参见第 15.8.3.3 节，“使缓冲池抗扫描”。
- 使页面年轻化的命中率考虑了所有缓冲池页面访问，而不仅仅是旧子列表中页面的访问。使页面年轻化的命中率和未使页面年轻化的命中率通常不会加起来等于整体缓冲池命中率。旧子列表中的页面命中会导致页面
- 移动到新子列表，但新子列表中的页面命中只有在页面离头部一定距离时才会导致页面移动到列表头部。

- 不是（使页面年轻化的命中率）是页面访问没有导致页面变年轻的平均命中率，这可能是因为未满足由 `innodb_old_blocks_time` 定义的延迟时间，或者是因为新子列表中的页面命中没有导致页面被移动到头部。这个比率考虑了所有缓冲池页面的访问，而不仅仅是旧子列表中页面的访问。缓冲池服务器状态变量和 `INNODB_BUFFER_POOL_STATS` 表提供了许多与 InnoDB 标准监视器输出中找到的相同的缓冲池指标。有关更多信息，请参见示例 15.10，“查询 `INNODB_BUFFER_POOL_STATS` 表”。

缓冲池服务器状态变量和 INNODB_BUFFER_POOL_STATS 表提供了许多在 InnoDB 标准监控器输出中发现的相同的缓冲池指标。欲了解更多信息，请参见示例 15.10，“查询 INNODB_BUFFER_POOL_STATS 表”。