### 8.4.5.4 审计日志文件格式

每当发生可审计事件时，MySQL 服务器调用审计日志插件将审计记录写入其日志文件。通常，在插件启动后写入的第一个审计记录包含服务器描述和启动选项。随后的元素表示事件，例如客户端连接和断开连接事件、执行的 SQL 语句等。仅记录顶层语句，不记录存储程序（如触发器或存储过程）中的语句。文件中不记录 `LOAD DATA` 等语句引用的文件内容。

要选择审计日志插件用来写入日志文件的格式，请在服务器启动时设置 `audit_log_format` 系统变量。可用的格式有：

- 新样式 XML 格式 (`audit_log_format=NEW`)：一种与 Oracle Audit Vault 兼容性更好的 XML 格式。MySQL 8.0 默认使用新样式 XML 格式。

- 旧样式 XML 格式 (`audit_log_format=OLD`)：旧版本 MySQL 系列默认使用的原始审计日志格式。

- JSON 格式 (`audit_log_format=JSON`)：将审计日志写为 JSON 数组。只有这种格式支持可选的查询时间和大小统计数据（从 MySQL 8.0.30 开始提供）。

默认情况下，审计日志文件内容以新样式 XML 格式写入，没有压缩或加密。

如果更改 `audit_log_format`，建议同时更改 `audit_log_file`。例如，如果将 `audit_log_format` 设置为 JSON，则将 `audit_log_file` 设置为 `audit.json`。否则，新的日志文件将具有不同的格式，但它们将具有相同的基本名称，并且没有指示格式更改的内容。

#### 新样式 XML 审计日志文件格式

以下是新样式 XML 格式（`audit_log_format=NEW`）的示例日志文件，稍作格式调整以提高可读性：

```xml
<?xml version="1.0" encoding="utf-8"?>
<AUDIT>
 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:06:33 UTC</TIMESTAMP>
  <RECORD_ID>1_2019-10-03T14:06:33</RECORD_ID>
  <NAME>Audit</NAME>
  <SERVER_ID>1</SERVER_ID>
  <VERSION>1</VERSION>
  <STARTUP_OPTIONS>/usr/local/mysql/bin/mysqld
    --socket=/usr/local/mysql/mysql.sock
    --port=3306</STARTUP_OPTIONS>
  <OS_VERSION>i686-Linux</OS_VERSION>
  <MYSQL_VERSION>5.7.21-log</MYSQL_VERSION>
 </AUDIT_RECORD>
 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:09:38 UTC</TIMESTAMP>
  <RECORD_ID>2_2019-10-03T14:06:33</RECORD_ID>
  <NAME>Connect</NAME>
  <CONNECTION_ID>5</CONNECTION_ID>
  <STATUS>0</STATUS>
  <STATUS_CODE>0</STATUS_CODE>
  <USER>root</USER>
  <OS_LOGIN/>
  <HOST>localhost</HOST>
  <IP>127.0.0.1</IP>
  <COMMAND_CLASS>connect</COMMAND_CLASS>
  <CONNECTION_TYPE>SSL/TLS</CONNECTION_TYPE>
  <CONNECTION_ATTRIBUTES>
   <ATTRIBUTE>
    <NAME>_pid</NAME>
    <VALUE>42794</VALUE>
   </ATTRIBUTE>
   ...
   <ATTRIBUTE>
    <NAME>program_name</NAME>
    <VALUE>mysqladmin</VALUE>
   </ATTRIBUTE>
  </CONNECTION_ATTRIBUTES>
  <PRIV_USER>root</PRIV_USER>
  <PROXY_USER/>
  <DB>test</DB>
 </AUDIT_RECORD>

 ...

 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:09:38 UTC</TIMESTAMP>
  <RECORD_ID>6_2019-10-03T14:06:33</RECORD_ID>
  <NAME>Query</NAME>
  <CONNECTION_ID>5</CONNECTION_ID>
  <STATUS>0</STATUS>
  <STATUS_CODE>0</STATUS_CODE>
  <USER>root[root] @ localhost [127.0.0.1]</USER>
  <OS_LOGIN/>
  <HOST>localhost</HOST>
  <IP>127.0.0.1</IP>
  <COMMAND_CLASS>drop_table</COMMAND_CLASS>
  <SQLTEXT>DROP TABLE IF EXISTS t</SQLTEXT>
 </AUDIT_RECORD>

 ...

 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:09:39 UTC</TIMESTAMP>
  <RECORD_ID>8_2019-10-03T14:06:33</RECORD_ID>
  <NAME>Quit</NAME>
  <CONNECTION_ID>5</CONNECTION_ID>
  <STATUS>0</STATUS>
  <STATUS_CODE>0</STATUS_CODE>
  <USER>root</USER>
  <OS_LOGIN/>
  <HOST>localhost</HOST>
  <IP>127.0.0.1</IP>
  <COMMAND_CLASS>connect</COMMAND_CLASS>
  <CONNECTION_TYPE>SSL/TLS</CONNECTION_TYPE>
 </AUDIT_RECORD>

 ...

 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:09:43 UTC</TIMESTAMP>
  <RECORD_ID>11_2019-10-03T14:06:33</RECORD_ID>
  <NAME>Quit</NAME>
  <CONNECTION_ID>6</CONNECTION_ID>
  <STATUS>0</STATUS>
  <STATUS_CODE>0</STATUS_CODE>
  <USER>root</USER>
  <OS_LOGIN/>
  <HOST>localhost</HOST>
  <IP>127.0.0.1</IP>
  <COMMAND_CLASS>connect</COMMAND_CLASS>
  <CONNECTION_TYPE>SSL/TLS</CONNECTION_TYPE>
 </AUDIT_RECORD>
 <AUDIT_RECORD>
  <TIMESTAMP>2019-10-03T14:09:45 UTC</TIMESTAMP>
  <RECORD_ID>12_2019-10-03T14:06:33</RECORD_ID>
  <NAME>NoAudit</NAME>
  <SERVER_ID>1</SERVER_ID>
 </AUDIT_RECORD>
</AUDIT>
```

审计日志文件以 XML 格式写入，使用 UTF-8 编码（每个字符最多 4 个字节）。根元素是 `<AUDIT>`。根元素包含 `<AUDIT_RECORD>` 元素，每个元素提供有关审计事件的信息。当审计日志插件开始写入新的日志文件时，它写入 XML 声明和打开的 `<AUDIT>` 根元素标签。当插件关闭日志文件时，它写入关闭的 `</AUDIT>` 根元素标签。文件打开时不会出现关闭标签。

`<AUDIT_RECORD>` 元素内的元素具有以下特征：

- 一些元素出现在每个 `<AUDIT_RECORD>` 元素中。其他元素是可选的，可能会根据审计记录类型出现。
- `<AUDIT_RECORD>` 元素内的元素顺序不保证。
- 元素值不是固定长度的。长值可能会被截断，如后面的元素描述所示。
- `<`、`>`、`"` 和 `&` 字符编码为 `&lt;`、`&gt;`、`&quot;` 和 `&amp;`。NUL 字节（U+00）编码为 `?` 字符。
- 非法 XML 字符使用数字字符引用编码。有效的 XML 字符为：`#x9 | #xA | #xD | [#x20-#xD7FF] | [#xE000-#xFFFD] | [#x10000-#x10FFFF]`

以下元素是每个 `<AUDIT_RECORD>` 元素中的必需元素：

- `<NAME>`

  表示生成审计事件的指令类型的字符串，例如服务器从客户端收到的命令。

  示例：

  ```xml
  <NAME>Query</NAME>
  ```

  一些常见的 `<NAME>` 值：

  - `Audit`：审计启动时（可能是服务器启动时间）
  - `Connect`：客户端连接时，也称为登录
  - `Query`：SQL 语句（直接执行）
  - `Prepare`：SQL 语句的准备；通常紧跟着 `Execute`
  - `Execute`：SQL 语句的执行；通常紧跟在 `Prepare` 后
  - `Shutdown`：服务器关闭
  - `Quit`：客户端断开连接
  - `NoAudit`：审计已关闭

  可能的值包括 `Audit`、`Binlog Dump`、`Change user`、`Close stmt`、`Connect Out`、`Connect`、`Create DB`、`Daemon`、`Debug`、`Delayed insert`、`Drop DB`、`Execute`、`Fetch`、`Field List`、`Init DB`、`Kill`、`Long Data`、`NoAudit`、`Ping`、`Prepare`、`Processlist`、`Query`、`Quit`、`Refresh`、`Register Slave`、

`Reset stmt`、`Set option`、`Shutdown`、`Sleep`、`Statistics`、`Table Dump`、`TableDelete`、`TableInsert`、`TableRead`、`TableUpdate`、`Time`。

  其中许多值对应于 `my_command.h` 头文件中列出的 `COM_xxx` 命令值。例如，`Create DB` 和 `Change user` 分别对应 `COM_CREATE_DB` 和 `COM_CHANGE_USER`。

  具有 `TableXXX` 的事件与 `Query` 事件一起出现。例如，以下语句生成一个 `Query` 事件、两个 `TableRead` 事件和一个 `TableInsert` 事件：

  ```sql
  INSERT INTO t3 SELECT t1.* FROM t1 JOIN t2;
  ```

  每个 `TableXXX` 事件包含 `<TABLE>` 和 `<DB>` 元素，以标识事件所引用的表和包含该表的数据库。

- `<RECORD_ID>`

  审计记录的唯一标识符。值由序列号和时间戳组成，格式为 `SEQ_TIMESTAMP`。当审计日志插件打开审计日志文件时，它将序列号初始化为审计日志文件的大小，然后对每个记录递增 1。时间戳是一个 UTC 值，格式为 `YYYY-MM-DDThh:mm:ss`，表示审计日志插件打开文件的日期和时间。

  示例：

  ```xml
  <RECORD_ID>12_2019-10-03T14:06:33</RECORD_ID>
  ```

- `<TIMESTAMP>`

  表示生成审计事件的日期和时间的 UTC 值字符串，格式为 `YYYY-MM-DDThh:mm:ss UTC`。例如，客户端收到的 SQL 语句的执行事件的 `<TIMESTAMP>` 值在语句完成后发生，而不是在接收到语句时。

  示例：

  ```xml
  <TIMESTAMP>2019-10-03T14:09:45 UTC</TIMESTAMP>
  ```

以下元素在 `<AUDIT_RECORD>` 元素中是可选的。许多元素仅在特定 `<NAME>` 元素值的情况下出现。

- `<COMMAND_CLASS>`

  表示执行的操作类型的字符串。

  示例：

  ```xml
  <COMMAND_CLASS>drop_table</COMMAND_CLASS>
  ```

  这些值对应于 `statement/sql/xxx` 命令计数器。例如，`xxx` 分别为 `drop_table` 和 `select`，表示 `DROP TABLE` 和 `SELECT` 语句。以下语句显示可能的名称：

  ```sql
  SELECT REPLACE(EVENT_NAME, 'statement/sql/', '') AS name
  FROM performance_schema.events_statements_summary_global_by_event_name
  WHERE EVENT_NAME LIKE 'statement/sql/%'
  ORDER BY name;
  ```

- `<CONNECTION_ATTRIBUTES>`

  从 MySQL 8.0.19 开始，具有 `connect` 的 `<COMMAND_CLASS>` 值的事件可能包括一个 `<CONNECTION_ATTRIBUTES>` 元素，以显示客户端在连接时传递的连接属性。（有关这些属性的信息，这些属性也在性能模式表中公开，请参见 [29.12.9 性能模式连接属性表](#29.12.9-性能模式连接属性表)。）

  `<CONNECTION_ATTRIBUTES>` 元素包含一个 `<ATTRIBUTE>` 元素，用于表示每个属性，每个 `<ATTRIBUTE>` 元素包含 `<NAME>` 和 `<VALUE>` 元素，分别表示属性名称和值。

  示例：

  ```xml
  <CONNECTION_ATTRIBUTES>
   <ATTRIBUTE>
    <NAME>_pid</NAME>
    <VALUE>42794</VALUE>
   </ATTRIBUTE>
   <ATTRIBUTE>
    <NAME>_os</NAME>
    <VALUE>macos0.14</VALUE>
   </ATTRIBUTE>
   <ATTRIBUTE>
    <NAME>_platform</NAME>
    <VALUE>x86_64</VALUE>
   </ATTRIBUTE>
   <ATTRIBUTE>
    <NAME>_client_version</NAME>
    <VALUE>8.0.19</VALUE>
   </ATTRIBUTE>
   <ATTRIBUTE>
    <NAME>_client_name</NAME>
    <VALUE>libmysql</VALUE>
   </ATTRIBUTE>
   <ATTRIBUTE>
    <NAME>program_name</NAME>
    <VALUE>mysqladmin</VALUE>
   </ATTRIBUTE>
  </CONNECTION_ATTRIBUTES>
  ```

  如果事件中没有连接属性，则不会记录任何连接属性，也不会出现 `<CONNECTION_ATTRIBUTES>` 元素。这可能发生在连接尝试不成功时，客户端没有传递属性时，或者连接在服务器启动期间或由插件发起时发生。

- `<CONNECTION_ID>`

  表示客户端连接标识符的无符号整数。这与会话中的 `CONNECTION_ID()` 函数返回的值相同。

  示例：

  ```xml
  <CONNECTION_ID>127</CONNECTION_ID>
  ```

- `<CONNECTION_TYPE>`

  表示与服务器的连接的安全状态。允许的值有：TCP/IP（未加密的 TCP/IP 连接）、SSL/TLS（加密的 TCP/IP 连接）、Socket（Unix 套接字文件连接）、Named Pipe（Windows 命名管道连接）和 Shared Memory（Windows 共享内存连接）。

  示例：

  ```xml
  <CONNECTION_TYPE>SSL/TLS</CONNECTION_TYPE>
  ```

- `<DB>`

  表示数据库名称的字符串。

  示例：

  ```xml
  <DB>test</DB>
  ```

  对于连接事件，此元素指示默认数据库；如果没有默认数据库，则元素为空。对于表访问事件，该元素指示访问的表所属的数据库。

- `<HOST>`

  表示客户端主机名的字符串。

  示例：

  ```xml
  <HOST>localhost</HOST>
  ```

- `<IP>`

  表示客户端 IP 地址的字符串。

  示例：

  ```xml
  <IP>127.0.0.1</IP>
  ```

- `<MYSQL_VERSION>`

  表示 MySQL 服务器版本的字符串。这与 `VERSION()` 函数或 `version` 系统变量的值相同。

  示例：

  ```xml
  <MYSQL_VERSION>5.7.21-log</MYSQL_VERSION>
  ```

- `<OS_LOGIN>`

  表示在身份验证过程中使用的外部用户名的字符串，由用于验证客户端的插件设置。使用 MySQL 内置身份验证，或者如果插件未设置该值，则此元素为空。该值与 `external_user` 系统变量的值相同（参见 [8.2.19 代理用户](#8.2.19-代理用户)）。

  示例：

  ```xml
  <OS_LOGIN>jeffrey</OS_LOGIN>
  ```

- `<OS_VERSION>`

  表示服务器构建或运行的操作系统的字符串。

  示例：

  ```xml
  <OS_VERSION>x86_64-Linux</OS_VERSION>
  ```

- `<PRIV_USER>`

  表示服务器验证客户端的用户的字符串。这是服务器用于权限检查的用户名，可能与 `<USER>` 值不同。

  示例：

  ```xml
  <PRIV_USER>jeffrey</PRIV_USER>
  ```

- `<PROXY_USER>`

  表示代理用户的字符串（参见 [8.2.19 代理用户](#8.2.19-代理用户)）。如果未启用用户代理，则该值为空。

  示例：

  ```xml
  <PROXY_USER>developer</PROXY_USER>
  ```

- `<SERVER_ID>`

  表示服务器 ID 的无符号整数。这与 `server_id` 系统变量的值相同。

  示例：

  ```xml
  <SERVER_ID>1</SERVER_ID>
  ```

- `<SQLTEXT>`

  表示 SQL 语句文本的字符串。该值可以为空。长值可能会被截断。字符串与审计日志文件本身一样，使用 UTF-8 编码（每个字符最多 4 个字节），因此该值可能是转换的结果。例如，原始语句可能是以 SJIS 字符串从客户端接收的。

  示例：

  ```xml
  <SQLTEXT>DELETE FROM t1</SQLTEXT>
  ```

- `<STARTUP_OPTIONS>`

  表示启动 MySQL 服务器时在命令行或选项文件中给出的选项的字符串。第一个选项是服务器可执行文件的路径。

  示例：

  ```xml
  <STARTUP_OPTIONS>/usr/local/mysql/bin/mysqld
    --port=3306 --log_output=FILE</STARTUP_OPTIONS>
  ```

- `<STATUS>`

  表示命令状态的无符号整数：0 表示成功，非零表示发生错误。这与 `mysql_errno()` C API 函数的值相同。有关 `STATUS_CODE` 的描述，请参见其与 `STATUS` 的不同之处。

  审计日志不包含 `SQLSTATE` 值或错误消息。要查看错误代码、`SQLSTATE` 值和消息之间的关联，请参见服务器错误消息参考。

  不记录警告。

  示例：

  ```xml
  <STATUS>1051</STATUS>
  ```

- `<STATUS_CODE>`

  表示命令状态的无符号整数：0 表示成功