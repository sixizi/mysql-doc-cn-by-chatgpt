### 8.4.5.5 配置审计日志特性

本节描述如何配置审计日志特性，例如审计日志插件写入事件的文件、写入事件的格式、是否启用日志文件压缩和加密以及空间管理。

#### 审计日志文件命名约定

#### 选择审计日志文件格式

#### 启用审计日志刷新任务

#### 添加异常检测的查询统计信息

#### 压缩审计日志文件

#### 加密审计日志文件

#### 手动解压和解密审计日志文件

#### MySQL 8.0.17 之前的审计日志文件加密

#### 审计日志文件的空间管理

#### 审计日志的写入策略

> **注意**
> 此处描述的加密功能适用于 MySQL 8.0.17 及更高版本，除了与之前较有限的加密功能进行比较的部分；参见[MySQL 8.0.17 之前的审计日志文件加密](#MySQL-8.0.17-之前的审计日志文件加密)。

有关影响审计日志记录的函数和系统变量的附加信息，请参见[审计日志函数](#审计日志函数)和[审计日志选项和变量](#审计日志选项和变量)。

审计日志插件还可以基于事件内容或事件来源的帐户控制哪些审计事件被写入审计日志文件。参见[8.4.5.7 审计日志过滤](#8.4.5.7-审计日志过滤)。

#### 审计日志文件命名约定

要配置审计日志文件名，请在服务器启动时设置 `audit_log_file` 系统变量。默认名称为服务器数据目录中的 `audit.log`。为了最佳安全性，应将审计日志写入只有 MySQL 服务器和有合法理由查看日志的用户才能访问的目录。

插件将 `audit_log_file` 值解释为由可选的前导目录名称、基本名称和可选的后缀组成。如果启用压缩或加密，则实际使用的文件名（用于创建日志文件的名称）与配置的文件名不同，因为它具有附加的后缀：

- 如果启用压缩，插件会添加 `.gz` 后缀。
- 如果启用加密，插件会添加 `.pwd_id.enc` 后缀，其中 `pwd_id` 指示用于日志文件操作的加密密码。审计日志插件将加密密码存储在密钥环中；参见[加密审计日志文件](#加密审计日志文件)。

有效的审计日志文件名是将适用的压缩和加密后缀添加到配置文件名后的名称。例如，如果配置的 `audit_log_file` 值为 `audit.log`，则有效文件名如下表所示。

| 启用的功能   | 有效文件名                |
| ------------ | ------------------------- |
| 无压缩或加密 | `audit.log`               |
| 压缩         | `audit.log.gz`            |
| 加密         | `audit.log.pwd_id.enc`    |
| 压缩和加密   | `audit.log.gz.pwd_id.enc` |

`pwd_id` 表示用于加密或解密文件的密码 ID。`pwd_id` 格式为 `pwd_timestamp-seq`，其中：

- `pwd_timestamp` 是一个 UTC 值，格式为 `YYYYMMDDThhmmss`，表示创建密码的时间。
- `seq` 是序列号。对于具有相同 `pwd_timestamp` 值的密码，序列号从 1 开始递增。

以下是一些示例 `pwd_id` 密码 ID 值：

- `20190403T142359-1`
- `20190403T142400-1`
- `20190403T142400-2`

要构建在密钥环中存储密码的对应密钥环 ID，审计日志插件会将前缀 `audit_log-` 添加到 `pwd_id` 值。例如，对于上面显示的密码 ID，对应的密钥环 ID 为：

- `audit_log-20190403T142359-1`
- `audit_log-20190403T142400-1`
- `audit_log-20190403T142400-2`

审计日志插件当前使用的密码 ID 是具有最大 `pwd_timestamp` 值的密码的 ID。如果多个密码具有相同的 `pwd_timestamp` 值，则当前密码 ID 是具有最大序列号的密码 ID。例如，在前面的密码 ID 集中，有两个具有最大时间戳 `20190403T142400` 的密码，因此当前密码 ID 是具有最大序列号的密码（2）。

审计日志插件在初始化和终止期间基于有效的审计日志文件名执行某些操作：

- 在初始化期间，插件检查是否已存在具有审计日志文件名的文件，如果存在，则重命名它。（在这种情况下，插件假定先前的服务器调用在运行审计日志插件时意外退出。）然后插件写入一个新的空审计日志文件。
- 在终止期间，插件重命名审计日志文件。

文件重命名（无论是在插件初始化还是终止期间）均根据常规基于大小的日志文件轮换规则进行；参见[手动审计日志文件轮换（MySQL 8.0.31 之前）](#手动审计日志文件轮换（MySQL-8.0.31-之前）)。

#### 选择审计日志文件格式

要配置审计日志文件格式，请在服务器启动时设置 `audit_log_format` 系统变量。可用的格式如下：

- `NEW`：新样式 XML 格式。这是默认设置。
- `OLD`：旧样式 XML 格式。
- `JSON`：JSON 格式。将审计日志写入为 JSON 数组。仅此格式支持可选的查询时间和大小统计数据，这些数据从 MySQL 8.0.30 开始提供。

有关每种格式的详细信息，请参见[8.4.5.4 审计日志文件格式](#8.4.5.4-审计日志文件格式)。

#### 启用审计日志刷新任务

从 MySQL 8.0.34 开始，MySQL 企业审计提供了设置刷新间隔以自动处理内存缓存的功能。使用 `audit_log_flush_interval_seconds` 系统变量配置的刷新任务默认值为 0，这意味着任务未计划运行。

当任务配置为运行（值非零）时，MySQL 企业审计在初始化时尝试调用调度程序组件并配置定期刷新其内存缓存：

- 如果审计日志找不到调度程序注册服务的实现，则不会安排刷新并继续加载。
- 审计日志实现 `dynamic_loader_services_loaded_notification` 服务并监听 `mysql_scheduler` 的新注册，以便审计日志可以将其计划任务注册到新加载的调度程序中。
- 审计日志仅注册到加载的第一个调度程序实现中。

同样，MySQL 企业审计在去初始化时调用调度程序组件并取消其计划的定期刷新。它保持对调度程序注册服务的活动引用，直到取消注册计划任务，确保在有活动计划任务时无法卸载调度程序组件。执行调度程序及其任务的所有结果均写入服务器错误日志。

要安排审计日志刷新任务：

1. 确认调度程序组件已加载并启用。默认情况下启用该组件（ON）（参见 `component_scheduler.enabled`）。

   ```sql
   SELECT * FROM mysql.components;
   +--------------+--------------------+----------------------------+
   | component_id | component_group_id | component_urn              |
   +--------------+--------------------+----------------------------+
   |            1 |                  1 | file://component_scheduler |
   +--------------+--------------------+----------------------------+
   ```

2. 安装 `audit_log` 插件（如果尚未安装）（参见[8.4.5.2 安装或卸载 MySQL 企业审计](#8.4.5.2-安装或卸载-MySQL-企业审计)）。

3. 使用 `audit_log_flush_interval_seconds` 启动服务器，并将值设置为大于 59 的数字。值的上限因平台而异。例如，要配置刷新任务每两分钟重复一次：

   ```bash
   $> mysqld --audit_log_flush_interval_seconds=120
   ```

有关更多信息，请参见 `audit_log_flush_interval_seconds` 系统变量。

#### 添加异常检测的查询统计信息

从 MySQL 8.0.30 开始，您可以扩展 JSON 格式的日志文件，添加可选的数据字段，以显示查询时间、发送和接收的字节数、返回给客户端的行数以及检查的行数。这些数据在慢查询日志中可用于合格查询，在审计日志的上下文中，它类似地有助于检测活动分析中的异常。仅当审计日志为 JSON 格式（`audit_log_format=JSON`）时，才可以添加扩展数据字段，这不是默认设置。

通过组件服务将查询统计信息传递到审计日志中，这些服务作为审计日志