# 8.4.1.8 Kerberos 可插拔认证

> 注意
> Kerberos 可插拔认证是 MySQL 企业版（商业产品）中的一个扩展。了解更多关于商业产品的信息，请参见 https://www.mysql.com/products/。

MySQL 企业版支持一种认证方法，该方法允许用户使用 Kerberos 进行认证，只要能够获取或获得适当的 Kerberos 票证即可。

此认证方法在 MySQL 8.0.26 及更高版本中可用，适用于 Linux 上的 MySQL 服务器和客户端。在 MySQL 8.0.27（MySQL 8.0.32 对于 MIT Kerberos）及更高版本中，客户端插件也支持 Windows。服务器端插件仍然仅支持 Linux。

Kerberos 可插拔认证提供以下功能：

- **外部认证**：Kerberos 认证允许 MySQL 服务器接受从 Kerberos 获取到适当票证的用户连接，这些用户定义在 MySQL 授权表之外。
- **安全性**：Kerberos 使用票证和对称密钥加密，实现不通过网络传输密码的认证。Kerberos 认证支持无用户和无密码场景。

下表显示了插件和库文件的名称。文件名后缀可能因系统而异。文件必须位于 `plugin_dir` 系统变量指定的目录中。有关安装信息，请参见 [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证)。

表 8.24 Kerberos 认证的插件和库文件名称

| 插件或文件   | 插件或文件名称                                               |
| ------------ | ------------------------------------------------------------ |
| 服务器端插件 | `authentication_kerberos`                                    |
| 客户端插件   | `authentication_kerberos_client`                             |
| 库文件       | `authentication_kerberos.so`, `authentication_kerberos_client.so` |

服务器端 Kerberos 认证插件仅包含在 MySQL 企业版中，不包含在 MySQL 社区版中。客户端插件包含在所有版本中，包括社区版。这使得任何版本的客户端都可以连接到已加载服务器端插件的服务器。

以下部分提供特定于 Kerberos 可插拔认证的安装和使用信息：

- [Kerberos 可插拔认证的先决条件](#kerberos-可插拔认证的先决条件)
- [MySQL 用户的 Kerberos 认证工作原理](#mysql-用户的-kerberos-认证工作原理)
- [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证)
- [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)
- [Kerberos 认证调试](#kerberos-认证调试)

有关 MySQL 可插拔认证的一般信息，请参见 [8.2.17，可插拔认证](8.2.17-可插拔认证)。

## Kerberos 可插拔认证的先决条件

使用 MySQL 的 Kerberos 可插拔认证，需要满足以下先决条件：

- 必须有一个 Kerberos 服务，供 Kerberos 认证插件通信使用。
- 每个由 MySQL 认证的 Kerberos 用户（主体）必须存在于 KDC 服务器管理的数据库中。
- 在使用服务器端或客户端 Kerberos 认证插件的系统上，必须有一个 Kerberos 客户端库。此外，GSSAPI 用作访问 Kerberos 认证的接口，因此必须有一个 GSSAPI 库。

## MySQL 用户的 Kerberos 认证工作原理

本节概述了 MySQL 和 Kerberos 如何协同工作来认证 MySQL 用户。有关如何设置 MySQL 账户以使用 Kerberos 认证插件的示例，请参见 [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)。

假定读者熟悉 Kerberos 的概念和操作。以下列表简要定义了几个常见的 Kerberos 术语。您也可以参见 [RFC 4120](https://tools.ietf.org/html/rfc4120) 的术语表部分以获取更多信息。

- **主体**：一个命名实体，例如用户或服务器。在本文中，经常出现以下与主体相关的术语：
  - **SPN**：服务主体名称；表示服务的主体名称。
  - **UPN**：用户主体名称；表示用户的主体名称。
- **KDC**：密钥分发中心，包括 AS 和 TGS：
  - **AS**：认证服务器；提供获取额外票证所需的初始票证授权票（TGT）。
  - **TGS**：票证授权服务器；为拥有有效 TGT 的 Kerberos 客户端提供额外的票证。
- **TGT**：票证授权票；用于向 TGS 申请服务票证。
- **ST**：服务票证；提供对 MySQL 等服务的访问。

使用 Kerberos 进行认证需要一个 KDC 服务器，例如 Microsoft Active Directory 提供的服务器。

MySQL 中的 Kerberos 认证使用通用安全服务应用程序接口（GSSAPI），这是一个安全抽象接口。Kerberos 是通过该抽象接口使用的特定安全协议的一个实例。使用 GSSAPI，应用程序可以认证到 Kerberos 以获取服务凭据，然后使用这些凭据安全地访问其他服务。

在 Windows 上，`authentication_kerberos_client` 认证插件支持两种模式，客户端用户可以在运行时设置或在选项文件中指定：

- **SSPI 模式**：安全支持提供者接口（SSPI）实现了 GSSAPI（参见 [SSPI 模式下的 Windows 客户端命令](#sspi-模式下的-windows-客户端命令)）。SSPI 虽然在协议层面上与 GSSAPI 兼容，但仅支持 Windows 单点登录场景，且仅涉及登录用户。SSPI 是大多数 Windows 客户端的默认模式。
- **GSSAPI 模式**：通过 MIT Kerberos 库支持 GSSAPI（参见 [GSSAPI 模式下的 Windows 客户端命令](#gssapi-模式下的-windows-客户端命令)）。

使用 Kerberos 认证插件，应用程序和 MySQL 服务器能够使用 Kerberos 认证协议相互认证用户和 MySQL 服务。这样，用户和服务器都可以验证对方的身份。没有密码通过网络传输，并且 Kerberos 协议消息受到窃听和重放攻击的保护。

Kerberos 认证按以下步骤进行，服务器端和客户端部分分别由 `authentication_kerberos` 和 `authentication_kerberos_client` 认证插件执行：

1. MySQL 服务器将其服务主体名称发送给客户端应用程序。此 SPN 必须在 Kerberos 系统中注册，并通过服务器端的 `authentication_kerberos_service_principal` 系统变量进行配置。
2. 使用 GSSAPI，客户端应用程序创建 Kerberos 客户端认证会话，并与 Kerberos KDC 交换 Kerberos 消息：
   - 客户端从认证服务器获得一个 TGT。
   - 使用 TGT，客户端从票证授权服务获得 MySQL 的 ST。
   - 如果 TGT、ST 或两者已经本地缓存，可以跳过或部分跳过此步骤。客户端可以选择使用客户端 keytab 文件获取 TGT 和 ST，而无需提供密码。
3. 使用 GSSAPI，客户端应用程序将 MySQL ST 提供给 MySQL 服务器。
4. 使用 GSSAPI，MySQL 服务器创建 Kerberos 服务器认证会话。服务器验证用户身份和用户请求的有效性。它使用服务 keytab 文件中配置的服务密钥认证 ST 以确定认证是否成功，并将认证结果返回给客户端。

应用程序可以使用提供的用户名和密码进行认证，也可以使用本地缓存的 TGT 或 ST（例如，使用 `kinit` 或类似工具创建）。这种设计涵盖了从完全无用户和无密码的连接（在本地存储的 Kerberos 缓存中获取 Kerberos 服务票）到使用用户名和密码获取有效 Kerberos 服务票并发送到 MySQL 服务器的各种使用场景。

如上所述，MySQL Kerberos 认证使用两种类型的 keytab 文件：

- 在客户端主机上，客户端 keytab 文件可以用来获取 TGT 和 ST，而无需提供密码。详见 [客户端配置参数](#客户端配置参数)。
- 在 MySQL 服务器主机上，服务器端服务 keytab 文件用于验证从客户端收到的服务票。通过 `authentication_kerberos_service_key_tab` 系统变量配置 keytab 文件名。

有关 keytab 文件的信息，请参见 https://web.mit.edu/kerberos/krb5-latest/doc/basic/keytab_def.html。

## 安装 Kerberos 可插拔认证

本节描述如何安装服务器端 Kerberos 认证插件。有关安装插件的一般信息，请参见 [7.6.1，安装和卸载插件](7.6.1-安装和卸载插件)。

> 注意
> 服务器端插件仅支持 Linux 系统。Windows 系统仅支持客户端插件（从 MySQL 8.0.27 开始），可用于 Windows 系统连接到使用 Kerberos 认证的 Linux 服务器。

为了使服务器能够使用插件，插件库文件必须位于 `plugin_dir` 系统变量指定的目录中。如果有必要，通过在服务器启动时设置 `

plugin_dir` 的值来配置插件目录位置。

服务器端插件库文件的基本名称为 `authentication_kerberos`。类 Unix 系统的文件名后缀为 `.so`。

要在服务器启动时加载插件，请使用 `--plugin-load-add` 选项来指定包含插件的库文件。使用这种插件加载方法时，每次服务器启动时都必须指定该选项。此外，指定您希望配置的任何插件提供的系统变量值。插件公开以下系统变量，允许配置其操作：

- `authentication_kerberos_service_principal`：MySQL 服务主体名称（SPN）。此名称会发送给尝试使用 Kerberos 认证的客户端。SPN 必须存在于 KDC 服务器管理的数据库中。默认值为 `mysql/host_name@realm_name`。
- `authentication_kerberos_service_key_tab`：用于认证从客户端收到的票证的 keytab 文件。此文件必须存在，并包含 SPN 的有效密钥，否则客户端认证将失败。默认值为数据目录中的 `mysql.keytab`。

有关所有 Kerberos 认证系统变量的详细信息，请参见 [8.4.1.13，可插拔认证系统变量](8.4.1.13-可插拔认证系统变量)。

要加载插件并配置它，请在 `my.cnf` 文件中添加如下行，并使用适合您安装的系统变量值：

```ini
[mysqld]
plugin-load-add=authentication_kerberos.so
authentication_kerberos_service_principal=mysql/krbauth.example.com@MYSQL.LOCAL
authentication_kerberos_service_key_tab=/var/mysql/data/mysql.keytab
```

修改 `my.cnf` 后，重启服务器以使新设置生效。

或者，可以在运行时使用以下语句加载插件：

```sql
INSTALL PLUGIN authentication_kerberos
  SONAME 'authentication_kerberos.so';
```

`INSTALL PLUGIN` 立即加载插件，并将其注册到 `mysql.plugins` 系统表中，使服务器在每次正常启动时加载插件，而无需 `--plugin-load-add`。

当您在运行时安装插件而未在 `my.cnf` 文件中配置其系统变量时，`authentication_kerberos_service_key_tab` 系统变量设置为默认值（数据目录中的 `mysql.keytab`）。此系统变量的值不能在运行时更改，因此如果需要指定不同的文件，您需要将设置添加到 `my.cnf` 文件中，然后重启 MySQL 服务器。例如：

```ini
[mysqld]
authentication_kerberos_service_key_tab=/var/mysql/data/mysql.keytab
```

如果 keytab 文件不在正确位置或不包含有效的 SPN 密钥，MySQL 服务器不会验证此文件，但客户端会返回认证错误，直到您修复问题。

`authentication_kerberos_service_principal` 系统变量可以在运行时使用 `SET PERSIST` 语句设置并持久化，无需重启服务器：

```sql
SET PERSIST authentication_kerberos_service_principal='mysql/krbauth.example.com@MYSQL.LOCAL';
```

`SET PERSIST` 为正在运行的 MySQL 实例设置一个值。它还保存该值，使其在后续服务器重启时继续有效。要更改运行 MySQL 实例的值而不让其在后续重启时继续有效，请使用 `GLOBAL` 关键字而不是 `PERSIST`。详见 [15.7.6.1，变量赋值的 SET 语法](15.7.6.1-变量赋值的-set-语法)。

要验证插件安装情况，请检查 `Information Schema` 的 `PLUGINS` 表或使用 `SHOW PLUGINS` 语句（详见 [7.6.2，获取服务器插件信息](7.6.2-获取服务器插件信息)）。例如：

```sql
mysql> SELECT PLUGIN_NAME, PLUGIN_STATUS
       FROM INFORMATION_SCHEMA.PLUGINS
       WHERE PLUGIN_NAME = 'authentication_kerberos';
+-------------------------+---------------+
| PLUGIN_NAME             | PLUGIN_STATUS |
+-------------------------+---------------+
| authentication_kerberos | ACTIVE        |
+-------------------------+---------------+
```

如果插件初始化失败，请检查服务器错误日志中的诊断消息。

要将 MySQL 账户与 Kerberos 插件关联，请参见 [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)。

## 使用 Kerberos 可插拔认证

本节描述如何启用 MySQL 账户通过 Kerberos 可插拔认证连接到 MySQL 服务器。假定服务器已按 [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证) 所述启用服务器端插件，并且客户端主机上有客户端插件。

- [验证 Kerberos 的可用性](#验证-kerberos-的可用性)
- [创建使用 Kerberos 认证的 MySQL 账户](#创建使用-kerberos-认证的-mysql-账户)
- [使用 MySQL 账户连接到 MySQL 服务器](#使用-mysql-账户连接到-mysql-服务器)
- [Kerberos 认证的客户端配置参数](#kerberos-认证的客户端配置参数)

### 验证 Kerberos 的可用性

以下示例展示了如何在 Active Directory 中测试 Kerberos 的可用性。示例假定：

- Active Directory 运行在名为 `krbauth.example.com`、IP 地址为 `198.51.100.11` 的主机上。
- MySQL 相关的 Kerberos 认证使用 `MYSQL.LOCAL` 域，并使用 `MYSQL.LOCAL` 作为领域名称。
- 一个名为 `karl@MYSQL.LOCAL` 的主体已在 KDC 注册。（在后续讨论中，此主体名称与使用 Kerberos 认证到 MySQL 服务器的 MySQL 账户相关联。）

满足上述假定后，按照以下步骤进行操作：

1. 验证操作系统中是否正确安装并配置了 Kerberos 库。例如，要配置在 MySQL 认证期间使用的 `MYSQL.LOCAL` 域和领域，`/etc/krb5.conf` Kerberos 配置文件应包含类似内容：

    ```ini
    [realms]
      MYSQL.LOCAL = {
        kdc = krbauth.example.com
        admin_server = krbauth.example.com
        default_domain = MYSQL.LOCAL
      }
    ```

    可能需要在 `/etc/hosts` 文件中为服务器主机添加一条条目：

    ```plaintext
    198.51.100.11 krbauth krbauth.example.com
    ```

2. 检查 Kerberos 认证是否正常工作：

    使用 `kinit` 认证到 Kerberos：

    ```shell
    $> kinit karl@MYSQL.LOCAL
    Password for karl@MYSQL.LOCAL: (enter password here)
    ```

    该命令为名为 `karl@MYSQL.LOCAL` 的 Kerberos 主体进行认证。在命令提示时输入主体的密码。KDC 返回一个 TGT，缓存到客户端以供其他支持 Kerberos 的应用程序使用。

    使用 `klist` 检查是否正确获取了 TGT。输出应类似于：

    ```shell
    $> klist
    Ticket cache: FILE:/tmp/krb5cc_244306
    Default principal: karl@MYSQL.LOCAL
    
    Valid starting       Expires              Service principal
    03/23/2021 08:18:33  03/23/2021 18:18:33  krbtgt/MYSQL.LOCAL@MYSQL.LOCAL
    ```

### 创建使用 Kerberos 认证的 MySQL 账户

使用 `authentication_kerberos` 认证插件的 MySQL 认证基于 Kerberos 用户主体名称（UPN）。这里的说明假定 MySQL 用户 `karl` 使用 Kerberos 进行认证，Kerberos 领域名为 `MYSQL.LOCAL`，用户主体名称为 `karl@MYSQL.LOCAL`。此 UPN 必须在多个地方注册：

- Kerberos 管理员应将用户名注册为 Kerberos 主体。该名称包括一个领域名。客户端使用主体名称和密码进行 Kerberos 认证，以获取 TGT。
- MySQL DBA 应创建一个与 Kerberos 主体名称对应的账户，并使用 Kerberos 插件进行认证。

假定 Kerberos 用户主体名称已由相关服务管理员注册，并且如前所述在 [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证) 中描述的服务器端插件配置适当的情况下，MySQL DBA 使用类似以下语句创建一个与用户@realm_name 的 Kerberos UPN 相对应的 MySQL 账户：

```sql
CREATE USER user
  IDENTIFIED WITH authentication_kerberos
  BY 'realm_name';
```

由 `user` 命名的账户可以包含或省略主机名部分。如果省略主机名，则默认使用 `%`。`realm_name` 作为账户在 `mysql.user` 系统表中的 `authentication_string` 值存储。

要创建一个对应于 UPN `karl@MYSQL.LOCAL` 的 MySQL 账户，请使用以下语句：

```sql
CREATE USER 'karl'
  IDENTIFIED WITH authentication_kerberos
  BY 'MYSQL.LOCAL';
```

如果 MySQL 必须为此账户构造 UPN，例如获取或验证票

证（TGT 或 ST），则通过组合账户名（忽略主机名部分）和领域名来实现。例如，前述 `CREATE USER` 语句生成的完整账户名为 `'karl'@'%'`。MySQL 通过组合用户名部分 `karl`（忽略主机名部分）和领域名 `MYSQL.LOCAL` 来生成 `karl@MYSQL.LOCAL`。

> 注意
> 创建使用 `authentication_kerberos` 进行认证的账户时，`CREATE USER` 语句不包含 UPN 领域作为用户名的一部分。而是将领域（此处为 `MYSQL.LOCAL`）作为 `BY` 子句中的认证字符串指定。这与使用 `authentication_ldap_sasl` SASL LDAP 认证插件和 GSSAPI/Kerberos 认证方法创建账户时不同。在后者情况下，`CREATE USER` 语句包含 UPN 领域作为用户名的一部分。参见 [创建使用 GSSAPI/Kerberos 进行 LDAP 认证的 MySQL 账户](#创建使用-gssapi-kerberos-进行-ldap-认证的-mysql-账户)。

账户设置完毕后，客户端可以使用它连接到 MySQL 服务器。具体步骤取决于客户端主机是运行 Linux 还是 Windows，详细见下文。

使用 `authentication_kerberos` 受限于具有相同用户部分但不同领域部分的 UPN 不受支持的限制。例如，不能创建对应于以下两个 UPN 的 MySQL 账户：

- `kate@MYSQL.LOCAL`
- `kate@EXAMPLE.COM`

两个 UPN 的用户部分均为 `kate`，但领域部分不同（`MYSQL.LOCAL` 与 `EXAMPLE.COM`）。这是不允许的。

### 使用 MySQL 账户连接到 MySQL 服务器

设置好使用 Kerberos 认证的 MySQL 账户后，客户端可以按以下步骤连接到 MySQL 服务器：

1. 使用用户主体名称（UPN）和密码认证到 Kerberos，以获取票证授权票（TGT）。
2. 使用 TGT 获取 MySQL 服务票证（ST）。
3. 通过提供 MySQL ST 认证到 MySQL 服务器。

第一步（认证到 Kerberos）可以通过各种方式执行：

- 在连接 MySQL 之前：
  - 在 Linux 上或 Windows 的 GSSAPI 模式下，调用 `kinit` 获取 TGT 并将其保存到 Kerberos 凭证缓存中。
  - 在 Windows 的 SSPI 模式下，认证可能已在登录时完成，TGT 为登录用户保存到 Windows 内存缓存中。不使用 `kinit`，也没有 Kerberos 缓存。

- 在连接 MySQL 时，客户端程序本身可以获取 TGT，如果它能确定所需的 Kerberos UPN 和密码：
  - 信息可以来自命令选项或操作系统等来源。
  - 在 Linux 上，客户端还可以使用 keytab 文件或 `/etc/krb5.conf` 配置文件。Windows 客户端在 GSSAPI 模式下使用配置文件。Windows 客户端在 SSPI 模式下不使用配置文件。

连接到 MySQL 服务器的客户端命令的详细信息因 Linux 和 Windows 主机而异，因此每种主机类型分别讨论，但以下命令属性适用于所有主机类型：

- 每个命令包含以下选项，但在某些情况下可以省略：
  - `--default-auth` 选项指定客户端认证插件的名称（`authentication_kerberos_client`）。如果指定了 `--user` 选项，可以省略此选项，因为在这种情况下 MySQL 可以从 MySQL 服务器发送的用户账户信息中确定插件。
  - `--plugin-dir` 选项向客户端程序指示 `authentication_kerberos_client` 插件的位置。如果插件安装在默认（编译时设置）位置，可以省略此选项。
- 命令还应包括任何其他选项，例如 `--host` 或 `--port`，以指定要连接的 MySQL 服务器。
- 在一行上输入每个命令。如果命令包含 `--password` 选项以请求密码，则在提示时输入与 MySQL 用户关联的 Kerberos UPN 的密码。

#### Linux 客户端的连接命令

在 Linux 上，适当的客户端命令因是否使用 Kerberos 缓存中的 TGT 进行认证或基于 MySQL 用户名和 UPN 密码的命令选项进行认证而异：

- 在调用 MySQL 客户端程序之前，客户端用户可以独立于 MySQL 从 KDC 获取 TGT。例如，客户端用户可以使用 `kinit` 通过提供 Kerberos 用户主体名称和主体密码认证到 Kerberos：

    ```shell
    $> kinit karl@MYSQL.LOCAL
    Password for karl@MYSQL.LOCAL: (enter password here)
    ```

    生成的 UPN 的 TGT 被缓存，并可供其他支持 Kerberos 的应用程序使用，例如使用客户端 Kerberos 认证插件的程序。在这种情况下，调用客户端时无需指定用户名或密码选项：

    ```shell
    mysql
      --default-auth=authentication_kerberos_client
      --plugin-dir=path/to/plugin/directory
    ```

    客户端插件在缓存中找到 TGT，使用 TGT 获取 MySQL ST，并使用 ST 认证到 MySQL 服务器。

如上所述，当缓存了 UPN 的 TGT 时，客户端命令中不需要用户名和密码选项。如果命令中包含它们，则处理方式如下：

- 此命令包含用户名选项：

    ```shell
    mysql
      --default-auth=authentication_kerberos_client
      --plugin-dir=path/to/plugin/directory
      --user=karl
    ```

    在这种情况下，如果选项指定的用户名与 TGT 中的 UPN 用户名部分不匹配，则认证失败。

- 此命令包含密码选项（在提示时输入密码）：

    ```shell
    mysql
      --default-auth=authentication_kerberos_client
      --plugin-dir=path/to/plugin/directory
      --password
    ```

    在这种情况下，客户端插件忽略密码。由于认证基于 TGT，即使用户提供的密码不正确，也可能成功。因此，如果找到有效的 TGT 并导致密码被忽略，插件会生成警告。

- 如果 Kerberos 缓存中没有 TGT，客户端 Kerberos 认证插件本身可以从 KDC 获取 TGT。调用客户端时使用 MySQL 用户名和密码选项，然后在提示时输入 UPN 密码：

    ```shell
    mysql --default-auth=authentication_kerberos_client
      --plugin-dir=path/to/plugin/directory
      --user=karl
      --password
    ```

    客户端 Kerberos 认证插件组合用户名（`karl`）和用户账户中指定的领域（`MYSQL.LOCAL`）来构造 U

## 8.4.1.8 Kerberos 可插拔认证

> 注意
> Kerberos 可插拔认证是 MySQL 企业版中的一个扩展功能，这是一个商业产品。要了解更多关于商业产品的信息，请参见 https://www.mysql.com/products/。

MySQL 企业版支持一种认证方法，使用户可以使用 Kerberos 认证到 MySQL 服务器，前提是可以获得或获取适当的 Kerberos 凭证。

该认证方法在 MySQL 8.0.26 及更高版本中可用，适用于 Linux 上的 MySQL 服务器和客户端。它在应用程序可以访问启用 Kerberos 的 Microsoft Active Directory 的 Linux 环境中特别有用。从 MySQL 8.0.27（MySQL 8.0.32 用于 MIT Kerberos）开始，客户端插件也支持 Windows。服务器端插件仍然仅支持 Linux。

Kerberos 可插拔认证提供以下功能：

- **外部认证**：Kerberos 认证使 MySQL 服务器可以接受已获得适当 Kerberos 凭证的用户的连接，这些用户定义在 MySQL 授权表之外。
- **安全性**：Kerberos 使用凭证和对称密钥加密技术，允许认证过程中不在网络上传递密码。Kerberos 认证支持无用户和无密码场景。

下表显示了插件和库文件的名称。文件名后缀可能因系统而异。文件必须位于 `plugin_dir` 系统变量命名的目录中。有关安装信息，请参见 [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证)。

| 插件或文件   | 插件或文件名                                                 |
| ------------ | ------------------------------------------------------------ |
| 服务器端插件 | `authentication_kerberos`                                    |
| 客户端插件   | `authentication_kerberos_client`                             |
| 库文件       | `authentication_kerberos.so`, `authentication_kerberos_client.so` |

服务器端 Kerberos 认证插件仅包含在 MySQL 企业版中。它不包含在 MySQL 社区版本中。客户端插件包含在所有版本中，包括社区版本中。这使得任何版本的客户端都可以连接到加载了服务器端插件的服务器。

以下各节提供特定于 Kerberos 可插拔认证的安装和使用信息：

- [Kerberos 可插拔认证的先决条件](#kerberos-可插拔认证的先决条件)
- [MySQL 用户的 Kerberos 认证工作原理](#mysql-用户的-kerberos-认证工作原理)
- [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证)
- [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)
- [Kerberos 认证调试](#kerberos-认证调试)

有关 MySQL 中可插拔认证的一般信息，请参见 [8.2.17，可插拔认证](8.2.17-可插拔认证)。

### Kerberos 可插拔认证的先决条件

要使用 Kerberos 可插拔认证，必须满足以下先决条件：

- 必须有 Kerberos 服务可供 Kerberos 认证插件通信。
- 每个由 MySQL 认证的 Kerberos 用户（主体）必须存在于 KDC 服务器管理的数据库中。
- 在使用服务器端或客户端 Kerberos 认证插件的系统上，必须有 Kerberos 客户端库。此外，GSSAPI 用作访问 Kerberos 认证的接口，因此必须有 GSSAPI 库。

### MySQL 用户的 Kerberos 认证工作原理

本节概述 MySQL 和 Kerberos 如何协同工作来认证 MySQL 用户。有关如何设置使用 Kerberos 认证插件的 MySQL 账户的示例，请参见 [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)。

假定熟悉 Kerberos 概念和操作。以下列表简要定义了一些常见的 Kerberos 术语。您可能还会发现 [RFC 4120 的术语表](https://datatracker.ietf.org/doc/html/rfc4120#section-1.3) 有帮助。

- **Principal（主体）**：一个命名实体，例如用户或服务器。在本讨论中，某些与主体相关的术语经常出现：
  - **SPN**：服务主体名称；表示服务的主体名称。
  - **UPN**：用户主体名称；表示用户的主体名称。
- **KDC**：密钥分发中心，包括 AS 和 TGS：
  - **AS**：认证服务器；提供获取其他票证所需的初始票证授权票（TGT）。
  - **TGS**：票证授权服务器；向拥有有效 TGT 的 Kerberos 客户端提供其他票证。
- **TGT**：票证授权票；提供给 TGS 以获取服务票证（ST）。
- **ST**：服务票证；提供对某项服务（如 MySQL 服务器）的访问。

使用 Kerberos 进行认证需要一个 KDC 服务器，例如 Microsoft Active Directory 提供的服务器。

MySQL 中的 Kerberos 认证使用通用安全服务应用程序编程接口（GSSAPI），这是一个安全抽象接口。Kerberos 是可以通过该抽象接口使用的特定安全协议的实例。通过 GSSAPI，应用程序认证到 Kerberos 以获取服务凭证，然后使用这些凭证来启用对其他服务的安全访问。

在 Windows 上，`authentication_kerberos_client` 认证插件支持两种模式，客户端用户可以在运行时设置或在选项文件中指定：

- **SSPI 模式**：安全支持提供者接口（SSPI）实现 GSSAPI（参见 [SSPI 模式下的 Windows 客户端命令](#sspi-模式下的-windows-客户端命令)）。SSPI 虽然在网络级别与 GSSAPI 兼容，但仅支持 Windows 单点登录场景，并且特指已登录的用户。SSPI 是大多数 Windows 客户端的默认模式。
- **GSSAPI 模式**：通过 MIT Kerberos 库在 Windows 上支持 GSSAPI（参见 [GSSAPI 模式下的 Windows 客户端命令](#gssapi-模式下的-windows-客户端命令)）。

使用 Kerberos 认证插件，应用程序和 MySQL 服务器能够使用 Kerberos 认证协议互相认证用户和 MySQL 服务。这样，用户和服务器都能验证彼此的身份。网络中不会传递密码，Kerberos 协议消息受到防窃听和重放攻击的保护。

Kerberos 认证遵循以下步骤，服务器端和客户端部分分别由 `authentication_kerberos` 和 `authentication_kerberos_client` 认证插件执行：

1. MySQL 服务器将其服务主体名称发送给客户端应用程序。此 SPN 必须在 Kerberos 系统中注册，并通过服务器端配置的 `authentication_kerberos_service_principal` 系统变量进行配置。
2. 使用 GSSAPI，客户端应用程序创建 Kerberos 客户端认证会话，并与 Kerberos KDC 交换 Kerberos 消息：
   - 客户端从认证服务器获取票证授权票（TGT）。
   - 使用 TGT，客户端从票证授权服务获取 MySQL 服务票证（ST）。

   如果 TGT、ST 或两者都已在本地缓存，可以跳过或部分跳过此步骤。客户端可以选择使用客户端 keytab 文件获取 TGT 和 ST，而无需提供密码。

3. 使用 GSSAPI，客户端应用程序向 MySQL 服务器呈现 MySQL 服务票证（ST）。
4. 使用 GSSAPI，MySQL 服务器创建 Kerberos 服务器认证会话。服务器验证用户身份和用户请求的有效性。它使用服务 keytab 文件配置中的服务密钥认证 ST，以确定认证是否成功，并将认证结果返回给客户端。

应用程序能够使用提供的用户名和密码进行认证，或者使用本地缓存的 TGT 或 ST（例如，使用 `kinit` 或类似工具创建）。因此，这种设计涵盖了从完全无用户和无密码的连接（在本地存储 Kerberos 缓存中获取 Kerberos 服务票证）到提供用户名和密码的连接（使用它们从 KDC 获取有效的 Kerberos 服务票证并发送到 MySQL 服务器）的用例。

如上所述，MySQL Kerberos 认证使用两种 keytab 文件：

- 在客户端主机上，客户端 keytab 文件可用于获取 TGT 和 ST，而无需提供密码。详见 [Kerberos keytab 文件](https://web.mit.edu/kerberos/krb5-latest/doc/basic/keytab_def.html)。
- 在 MySQL 服务器主机上，服务器端服务 keytab 文件用于验证从客户端接收到的服务票证。keytab 文件名通过 `authentication_kerberos_service_key_tab` 系统变量进行配置。

### 安装 Kerberos 可插拔认证

本节描述如何安装服务器端 Kerberos 认证插件。有关安装插件的一般信息，请参见 [7.6.1，安装和卸载插件](7.6.1-安装和卸载插件)。

> 注意
> 服务器端插件仅支持 Linux 系统。在 Windows 系统上，仅支持客户端插件（从 MySQL 8.0.z

27 开始），它可用于在 Windows 系统上连接到使用 Kerberos 认证的 Linux 服务器。

为了使服务器可以使用，插件库文件必须位于 MySQL 插件目录（由 `plugin_dir` 系统变量命名的目录）中。如果需要，可以通过在服务器启动时设置 `plugin_dir` 的值来配置插件目录位置。

服务器端插件库文件的基本名称是 `authentication_kerberos`。Unix 和类 Unix 系统的文件名后缀是 `.so`。

要在服务器启动时加载插件，请使用 `--plugin-load-add` 选项命名包含插件的库文件。使用此插件加载方法，每次服务器启动时都必须给出该选项。此外，指定任何希望配置的插件提供的系统变量的值。插件公开这些系统变量，允许配置其操作：

- `authentication_kerberos_service_principal`：MySQL 服务主体名称（SPN）。该名称发送给尝试使用 Kerberos 认证的客户端。SPN 必须存在于 KDC 服务器管理的数据库中。默认值是 `mysql/host_name@realm_name`。
- `authentication_kerberos_service_key_tab`：用于认证从客户端接收到的票证的 keytab 文件。该文件必须存在并包含 SPN 的有效密钥，否则客户端认证将失败。默认值是数据目录中的 `mysql.keytab`。

有关所有 Kerberos 认证系统变量的详细信息，请参见 [8.4.1.13，可插拔认证系统变量](8.4.1.13-可插拔认证系统变量)。

要加载插件并进行配置，请在 `my.cnf` 文件中添加类似以下的行，使用适合您安装的系统变量值：

```ini
[mysqld]
plugin-load-add=authentication_kerberos.so
authentication_kerberos_service_principal=mysql/krbauth.example.com@MYSQL.LOCAL
authentication_kerberos_service_key_tab=/var/mysql/data/mysql.keytab
```

修改 `my.cnf` 后，重新启动服务器以使新设置生效。

或者，可以在运行时使用以下语句加载插件：

```sql
INSTALL PLUGIN authentication_kerberos
  SONAME 'authentication_kerberos.so';
```

`INSTALL PLUGIN` 会立即加载插件，并将其注册到 `mysql.plugins` 系统表中，使服务器在每次后续正常启动时加载插件，而无需 `--plugin-load-add`。

在运行时安装插件时，如果未在 `my.cnf` 文件中配置其系统变量，则 `authentication_kerberos_service_key_tab` 系统变量将设置为数据目录中的默认值 `mysql.keytab`。此系统变量的值在运行时无法更改，因此如果需要指定其他文件，需要将设置添加到 `my.cnf` 文件中，然后重新启动 MySQL 服务器。例如：

```ini
[mysqld]
authentication_kerberos_service_key_tab=/var/mysql/data/mysql.keytab
```

如果 keytab 文件未放置在正确的位置或不包含有效的 SPN 密钥，MySQL 服务器不会验证此信息，但客户端会返回认证错误，直到您修复此问题。

可以通过 `SET PERSIST` 语句在运行时设置并持久化 `authentication_kerberos_service_principal` 系统变量，而无需重新启动服务器：

```sql
SET PERSIST authentication_kerberos_service_principal='mysql/krbauth.example.com@MYSQL.LOCAL';
```

`SET PERSIST` 为正在运行的 MySQL 实例设置值。它还会保存该值，使其在后续服务器重新启动时继续生效。要在不希望在后续重启时继续生效的情况下为正在运行的 MySQL 实例更改值，请使用 `GLOBAL` 关键字，而不是 `PERSIST`。参见 [15.7.6.1，变量赋值的 SET 语法](15.7.6.1-变量赋值的-set-语法)。

要验证插件的安装，请检查信息架构 PLUGINS 表或使用 `SHOW PLUGINS` 语句（参见 [7.6.2，获取服务器插件信息](7.6.2-获取服务器插件信息)）。例如：

```sql
mysql> SELECT PLUGIN_NAME, PLUGIN_STATUS
       FROM INFORMATION_SCHEMA.PLUGINS
       WHERE PLUGIN_NAME = 'authentication_kerberos';
+-------------------------+---------------+
| PLUGIN_NAME             | PLUGIN_STATUS |
+-------------------------+---------------+
| authentication_kerberos | ACTIVE        |
+-------------------------+---------------+
```

如果插件初始化失败，请检查服务器错误日志中的诊断消息。

要将 MySQL 账户与 Kerberos 插件关联，请参见 [使用 Kerberos 可插拔认证](#使用-kerberos-可插拔认证)。

### 使用 Kerberos 可插拔认证

本节描述如何启用 MySQL 账户以使用 Kerberos 可插拔认证连接到 MySQL 服务器。假设服务器已启用服务器端插件，如 [安装 Kerberos 可插拔认证](#安装-kerberos-可插拔认证) 所述，并且客户端主机上已安装客户端插件。

#### 验证 Kerberos 可用性

以下示例显示如何在 Active Directory 中测试 Kerberos 的可用性。示例假设以下情况：

- Active Directory 正在名为 `krbauth.example.com` 且 IP 地址为 `198.51.100.11` 的主机上运行。
- MySQL 相关的 Kerberos 认证使用 `MYSQL.LOCAL` 领域，并使用 `MYSQL.LOCAL` 作为领域名。
- 一个名为 `karl@MYSQL.LOCAL` 的主体已在 KDC 中注册。（在后面的讨论中，此主体名称与使用 Kerberos 认证到 MySQL 服务器的 MySQL 账户相关联。）

满足上述假设后，请按照以下步骤操作：

1. 验证 Kerberos 库是否已安装并在操作系统中正确配置。例如，要配置在 MySQL 认证期间使用的 `MYSQL.LOCAL` 领域和领域名，`/etc/krb5.conf` Kerberos 配置文件应包含类似以下内容：

    ```ini
    [realms]
      MYSQL.LOCAL = {
        kdc = krbauth.example.com
        admin_server = krbauth.example.com
        default_domain = MYSQL.LOCAL
      }
    ```

2. 您可能需要在 `/etc/hosts` 中为服务器主机添加条目：

    ```plaintext
    198.51.100.11 krbauth krbauth.example.com
    ```

3. 检查 Kerberos 认证是否正常工作：

    使用 `kinit` 认证到 Kerberos：

    ```shell
    $> kinit karl@MYSQL.LOCAL
    Password for karl@MYSQL.LOCAL: (enter password here)
    ```

    该命令为名为 `karl@MYSQL.LOCAL` 的 Kerberos 主体进行认证。在命令提示时输入主体的密码。KDC 返回一个 TGT，并在客户端缓存，用于其他支持 Kerberos 的应用程序。

    使用 `klist` 检查是否正确获取了 TGT。输出应类似于：

    ```shell
    $> klist
    Ticket cache: FILE:/tmp/krb5cc_244306
    Default principal: karl@MYSQL.LOCAL
    
    Valid starting       Expires              Service principal
    03/23/2021 08:18:33  03/23/2021 18:18:33  krbtgt/MYSQL.LOCAL@MYSQL.LOCAL
    ```

#### 创建使用 Kerberos 认证的 MySQL 账户

使用 `authentication_kerberos` 认证插件的 MySQL 认证基于 Kerberos 用户主体名称（UPN）。此处的说明假定名为 `karl` 的 MySQL 用户使用 Kerberos 认证到 MySQL，Kerberos 领域名为 `MYSQL.LOCAL`，用户主体名称为 `karl@MYSQL.LOCAL`。此 UPN 必须在多个地方注册：

- Kerberos 管理员应将用户名注册为 Kerberos 主体。此名称包括一个领域名。客户端使用主体名称和密码认证到 Kerberos 并获取票证授权票（T