### 8.4.1.7 LDAP 可插拔认证

> **注意**
>
> LDAP 可插拔认证是 MySQL 企业版中的一个扩展功能，这是一款商业产品。要了解更多关于商业产品的信息，请参见 https://www.mysql.com/products/。

MySQL 企业版支持一种认证方法，使 MySQL 服务器能够使用 LDAP（轻量目录访问协议）通过访问目录服务（如 X.500）来认证 MySQL 用户。MySQL 使用 LDAP 来获取用户、凭据和组信息。

LDAP 可插拔认证提供以下功能：

- **外部认证**：LDAP 认证使 MySQL 服务器可以接受从 LDAP 目录中定义的 MySQL 授权表之外的用户的连接。
- **代理用户支持**：基于外部用户所属的 LDAP 组，LDAP 认证可以向 MySQL 返回与客户端程序传递的外部用户名不同的用户名。这意味着 LDAP 插件可以返回定义了外部 LDAP 认证用户应具有的权限的 MySQL 用户。例如，如果 joe 的 LDAP 组是 developer，则名为 joe 的 LDAP 用户可以连接并拥有名为 developer 的 MySQL 用户的权限。
- **安全性**：使用 TLS，连接到 LDAP 服务器可以是安全的。

服务器和客户端插件可用于基于简单和 SASL 的 LDAP 认证。在 Microsoft Windows 上，不支持基于 SASL 的 LDAP 认证的服务器插件，但支持客户端插件。

以下表格显示了简单和基于 SASL 的 LDAP 认证的插件和库文件名称。文件名后缀可能因系统而异。文件必须位于 `plugin_dir` 系统变量指定的目录中。

表 8.22 简单 LDAP 认证的插件和库名称

| 插件或文件     | 插件或文件名                    |
| -------------- | ------------------------------- |
| 服务器端插件名 | `authentication_ldap_simple`    |
| 客户端插件名   | `mysql_clear_password`          |
| 库文件名       | `authentication_ldap_simple.so` |

表 8.23 基于 SASL 的 LDAP 认证的插件和库名称

| 插件或文件     | 插件或文件名                                                 |
| -------------- | ------------------------------------------------------------ |
| 服务器端插件名 | `authentication_ldap_sasl`                                   |
| 客户端插件名   | `authentication_ldap_sasl_client`                            |
| 库文件名       | `authentication_ldap_sasl.so`, `authentication_ldap_sasl_client.so` |

库文件仅包括 `authentication_ldap_XXX` 认证插件。客户端 `mysql_clear_password` 插件内置于 `libmysqlclient` 客户端库中。

每个服务器端 LDAP 插件与特定的客户端插件配合使用：

- 服务器端 `authentication_ldap_simple` 插件执行简单的 LDAP 认证。对于使用此插件的账户的连接，客户端程序使用客户端 `mysql_clear_password` 插件，该插件以明文形式将密码发送到服务器。不使用密码哈希或加密，因此建议在 MySQL 客户端和服务器之间使用安全连接以防止密码暴露。
- 服务器端 `authentication_ldap_sasl` 插件执行基于 SASL 的 LDAP 认证。对于使用此插件的账户的连接，客户端程序使用客户端 `authentication_ldap_sasl_client` 插件。客户端和服务器端 SASL LDAP 插件使用 SASL 消息在 LDAP 协议中安全传输凭据，避免在 MySQL 客户端和服务器之间发送明文密码。

> **注意**
>
> 在 Microsoft Windows 上，不支持基于 SASL 的 LDAP 认证的服务器插件，但支持客户端插件。在其他平台上，支持服务器和客户端插件。

服务器端 LDAP 认证插件仅包含在 MySQL 企业版中。MySQL 社区版不包含这些插件。客户端 SASL LDAP 插件包含在所有发行版中，包括社区版，如前所述，客户端 `mysql_clear_password` 插件内置于 `libmysqlclient` 客户端库中，该库也包含在所有发行版中。这使得任何发行版的客户端都可以连接到加载了相应服务器端插件的服务器。

以下部分提供了 LDAP 可插拔认证的安装和使用信息：

- 使用 LDAP 可插拔认证的先决条件
- MySQL 用户的 LDAP 认证工作原理
- 安装 LDAP 可插拔认证
- 卸载 LDAP 可插拔认证
- LDAP 可插拔认证和 `ldap.conf`
- 使用 LDAP 可插拔认证
- 简单 LDAP 认证
- 基于 SASL 的 LDAP 认证
- 具有代理功能的 LDAP 认证
- LDAP 认证组优先级和映射规范
- LDAP 用户 DN 后缀的认证
- LDAP 认证方法
- GSSAPI/Kerberos 认证方法
- LDAP 搜索引用

有关 MySQL 中可插拔认证的一般信息，请参见 [8.2.17 节, “可插拔认证”](#8.2.17-可插拔认证)。有关 `mysql_clear_password` 插件的信息，请参见 [8.4.1.4 节, “客户端明文可插拔认证”](#8.4.1.4-客户端明文可插拔认证)。有关代理用户的信息，请参见 [8.2.19 节, “代理用户”](#8.2.19-代理用户)。

> **注意**
>
> 如果您的系统支持 PAM 并允许 LDAP 作为 PAM 认证方法，另一种使用 LDAP 进行 MySQL 用户认证的方法是使用服务器端 `authentication_pam` 插件。参见 [8.4.1.5 节, “PAM 可插拔认证”](#8.4.1.5-pam-可插拔认证)。

#### 使用 LDAP 可插拔认证的先决条件

要使用 LDAP 可插拔认证进行 MySQL，请满足以下先决条件：

- 必须有一个 LDAP 服务器供 LDAP 认证插件通信使用。
- 由 MySQL 认证的 LDAP 用户必须存在于由 LDAP 服务器管理的目录中。
- 在使用 `authentication_ldap_sasl` 或 `authentication_ldap_simple` 插件的系统上，必须有 LDAP 客户端库。目前，支持的库是 Windows 本地 LDAP 库或非 Windows 系统上的 OpenLDAP 库。
- 要使用基于 SASL 的 LDAP 认证：
  - 必须配置 LDAP 服务器以与 SASL 服务器通信。
  - 在使用 `authentication_ldap_sasl_client` 插件的系统上，必须有 SASL 客户端库。目前，唯一支持的库是 Cyrus SASL 库。
  - 要使用特定的 SASL 认证方法，必须有该方法所需的其他服务。例如，要使用 GSSAPI/Kerberos，必须有 GSSAPI 库和 Kerberos 服务。

#### MySQL 用户的 LDAP 认证工作原理

本节概述了 MySQL 和 LDAP 如何协同工作以认证 MySQL 用户。有关如何设置 MySQL 账户以使用特定 LDAP 认证插件的示例，请参见“使用 LDAP 可插拔认证”。有关 LDAP 插件可用的认证方法的信息，请参见“LDAP 认证方法”。

客户端连接到 MySQL 服务器，提供 MySQL 客户端用户名和密码：

- 对于简单的 LDAP 认证，客户端和服务器端插件以明文形式传输密码。建议在 MySQL 客户端和服务器之间使用安全连接以防止密码暴露。
- 对于基于 SASL 的 LDAP 认证，客户端和服务器端插件避免在 MySQL 客户端和服务器之间发送明文密码。例如，插件可能使用 SASL 消息在 LDAP 协议中安全传输凭据。对于 GSSAPI 认证方法，客户端和服务器端插件通过 Kerberos 安全通信，而不直接使用 LDAP 消息。

如果客户端用户名和主机名不匹配任何 MySQL 账户，则连接被拒绝。

如果有匹配的 MySQL 账户，则进行 LDAP 认证。LDAP 服务器查找匹配用户并根据 LDAP 密码进行认证：

- 如果 MySQL 账户指定了 LDAP 用户专有名称（DN），则 LDAP 认证使用该值和客户端提供的 LDAP 密码。（要将 LDAP 用户 DN 与 MySQL 账户关联，请在创建账户的 `CREATE USER` 语句中包含一个指定认证字符串的 `BY` 子句。）
- 如果 MySQL 账户没有指定 LDAP 用户 DN，则 LDAP 认证使用客户端提供的用户名和 LDAP 密码。在这种情况下，认证插件首先使用根 DN 和密码作为凭据绑定到 LDAP 服务器，以根据客户端用户名查找用户 DN，然后使用 LDAP 密码认证该用户 DN。如果根 DN 和密码设置为不正确的值，或为空（未设置）且 LDAP 服务器不允许匿名连接，则此绑定将失败。

如果 LDAP 服务器找不到匹配项或找到多个匹配项，则认证失败，客户端连接被拒绝。

如果 LDAP 服务器找到一个匹配项，且密码正确，则 LDAP 认证成功，LDAP 服务器返回 LDAP 条目，认证插件根据该条目确定认证用户的名称：

- 如果 LDAP 条目有一个组属性（默认情况下为 `cn` 属性），则插件返回其值作为认证用户名。
- 如果 LDAP 条目没有组属性，则认证插件返回客户端用户名作为认证用户名。

MySQL 服务器比较客户端用户名和认证用户名，以确定客户端会话是否发生代理：

- 如果名称相同，则