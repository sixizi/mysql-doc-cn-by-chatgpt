### 8.4.1.5 PAM 可插拔认证

> **注意**
>
> PAM 可插拔认证是 MySQL 企业版中的一个扩展功能，这是一款商业产品。要了解更多关于商业产品的信息，请参见 https://www.mysql.com/products/。

MySQL 企业版支持一种认证方法，使 MySQL 服务器可以使用 PAM（可插拔认证模块）来认证 MySQL 用户。PAM 使系统可以使用标准接口访问各种认证方法，如传统的 Unix 密码或 LDAP 目录。

PAM 可插拔认证提供以下功能：

- **外部认证**：PAM 认证使 MySQL 服务器可以接受从 MySQL 授权表之外定义的用户连接，并使用 PAM 支持的方法进行认证。
- **代理用户支持**：PAM 认证可以根据外部用户所属的 PAM 组和提供的认证字符串，向 MySQL 返回一个与客户端程序传递的外部用户名不同的用户名。这意味着插件可以返回定义了外部 PAM 认证用户应具有的权限的 MySQL 用户。例如，一个名为 joe 的操作系统用户可以连接并拥有名为 developer 的 MySQL 用户的权限。

PAM 可插拔认证已在 Linux 和 macOS 上进行了测试；请注意，Windows 不支持 PAM。

下表显示了插件和库文件的名称。文件名后缀可能因系统而异。文件必须位于 `plugin_dir` 系统变量指定的目录中。有关安装信息，请参见“安装 PAM 可插拔认证”。

表 8.20 PAM 认证的插件和库名称

| 插件或文件   | 插件或文件名            |
| ------------ | ----------------------- |
| 服务器端插件 | `authentication_pam`    |
| 客户端插件   | `mysql_clear_password`  |
| 库文件       | `authentication_pam.so` |

与服务器端 PAM 插件通信的客户端明文插件 `mysql_clear_password` 内置于 `libmysqlclient` 客户端库中，并包含在所有发行版中，包括社区版。所有 MySQL 发行版中都包含客户端明文插件，使任何发行版的客户端都可以连接到加载了服务器端 PAM 插件的服务器。

以下部分提供了 PAM 可插拔认证的安装和使用信息：

- PAM 认证 MySQL 用户的工作原理
- 安装 PAM 可插拔认证
- 卸载 PAM 可插拔认证
- 使用 PAM 可插拔认证
- 无代理用户的 PAM Unix 密码认证
- 无代理用户的 PAM LDAP 认证
- 带代理用户和组映射的 PAM Unix 密码认证
- PAM 认证访问 Unix 密码存储
- PAM 认证调试

有关 MySQL 可插拔认证的一般信息，请参见 [8.2.17 节, “可插拔认证”](#8.2.17-可插拔认证)。有关 `mysql_clear_password` 插件的信息，请参见 [8.4.1.4 节, “客户端明文可插拔认证”](#8.4.1.4-客户端明文可插拔认证)。有关代理用户的信息，请参见 [8.2.19 节, “代理用户”](#8.2.19-代理用户)。

#### PAM 认证 MySQL 用户的工作原理

本节概述了 MySQL 和 PAM 如何协作认证 MySQL 用户。有关如何设置 MySQL 账户以使用特定 PAM 服务的示例，请参见“使用 PAM 可插拔认证”。

客户端程序和服务器进行通信，客户端将客户端用户名（默认情况下为操作系统用户名）和密码发送到服务器：

- 客户端用户名是外部用户名。
- 对于使用 PAM 服务器端认证插件的账户，相应的客户端插件是 `mysql_clear_password`。此客户端插件不进行密码哈希，因此客户端以明文形式将密码发送到服务器。

服务器根据外部用户名和客户端连接的主机查找匹配的 MySQL 账户。PAM 插件使用 MySQL 服务器传递给它的信息（如用户名、主机名、密码和认证字符串）。当您定义使用 PAM 认证的 MySQL 账户时，认证字符串包含：

- PAM 服务名，即系统管理员用于引用特定应用程序的认证方法的名称。单个数据库服务器实例可以关联多个应用程序，因此服务名的选择留给 SQL 应用程序开发人员决定。
- 可选地，如果要使用代理，则需要一个从 PAM 组到 MySQL 用户名的映射。

插件使用认证字符串中指定的 PAM 服务名检查用户凭证，并返回“认证成功，用户名是 `user_name`”或“认证失败”。密码必须适用于 PAM 服务使用的密码存储。例如：

- 对于传统的 Unix 密码，服务查找存储在 `/etc/shadow` 文件中的密码。
- 对于 LDAP，服务查找存储在 LDAP 目录中的密码。

如果凭证检查失败，服务器将拒绝连接。

否则，认证字符串指示是否发生代理。如果字符串不包含 PAM 组映射，则不会发生代理。在这种情况下，MySQL 用户名与外部用户名相同。

否则，基于 PAM 组映射指示代理，MySQL 用户名基于映射列表中的第一个匹配组确定。“PAM 组”的含义取决于 PAM 服务。例如：

- 对于传统的 Unix 密码，组是定义在 `/etc/group` 文件中的 Unix 组，可能会补充 `/etc/security/group.conf` 文件中的其他 PAM 信息。
- 对于 LDAP，组是定义在 LDAP 目录中的 LDAP 组。

如果代理用户（外部用户）对代理的 MySQL 用户名具有 PROXY 权限，则会发生代理，代理用户将获得代理用户的权限。

#### 安装 PAM 可插拔认证

本节描述如何安装服务器端 PAM 认证插件。有关安装插件的一般信息，请参见 [7.6.1 节, “安装和卸载插件”](#7.6.1-安装和卸载插件)。

要使服务器能够使用插件库文件，文件必须位于 MySQL 插件目录中（由 `plugin_dir` 系统变量指定的目录）。如有必要，通过在服务器启动时设置 `plugin_dir` 的值来配置插件目录位置。

插件库文件的基本名称是 `authentication_pam`，通常编译后带有 `.so` 后缀。

要在服务器启动时加载插件，请使用 `--plugin-load-add` 选项指定包含它的库文件。使用这种插件加载方法，每次服务器启动时都必须给出该选项。例如，将这些行放入服务器的 `my.cnf` 文件中：

```ini
[mysqld]
plugin-load-add=authentication_pam.so
```

修改 `my.cnf` 后，重新启动服务器以使新设置生效。

或者，要在运行时加载插件，请使用此语句，必要时调整 `.so` 后缀：

```sql
INSTALL PLUGIN authentication_pam SONAME 'authentication_pam.so';
```

`INSTALL PLUGIN` 立即加载插件，并在 `mysql.plugins` 系统表中注册它，使服务器在每次后续正常启动时加载它，而无需 `--plugin-load-add`。

要验证插件安装，请检查 Information Schema PLUGINS 表或使用 `SHOW PLUGINS` 语句（参见 [7.6.2 节, “获取服务器插件信息”](#7.6.2-获取服务器插件信息)）。例如：

```sql
mysql> SELECT PLUGIN_NAME, PLUGIN_STATUS
       FROM INFORMATION_SCHEMA.PLUGINS
       WHERE PLUGIN_NAME LIKE '%pam%';
+--------------------+---------------+
| PLUGIN_NAME        | PLUGIN_STATUS |
+--------------------+---------------+
| authentication_pam | ACTIVE        |
+--------------------+---------------+
```

如果插件未能初始化，请检查服务器错误日志中的诊断消息。

要将 MySQL 账户与 PAM 插件关联，请参见“使用 PAM 可插拔认证”。

#### 卸载 PAM 可插拔认证

卸载 PAM 认证插件的方法取决于您如何安装它：

- 如果您在服务器启动时使用 `--plugin-load-add` 选项安装插件，请在没有该选项的情况下重新启动服务器。
- 如果您在运行时使用 `INSTALL PLUGIN` 语句安装插件，则插件在服务器重启后仍保持安装状态。要卸载它，请使用 `UNINSTALL PLUGIN`：

```sql
UNINSTALL PLUGIN authentication_pam;
```

#### 使用 PAM 可插拔认证

本节概述了如何使用 PAM 认证插件从 MySQL 客户端程序连接到服务器。以下部分提供了以特定方式使用 PAM 认证的说明。假设服务器已启用服务器端 PAM 插件，如“安装 PAM 可插拔认证”中所述。

要在 `CREATE USER` 语句的 `IDENTIFIED WITH` 子句中引用 PAM 认证插件，请使用名称 `authentication_pam`。例如：

```sql
CREATE USER user
  IDENTIFIED WITH authentication_pam
  AS 'auth_string';
```

认证字符串指定以下类型的信息：

- PAM 服务名（参见 PAM 认证 MySQL 用户的工作原理）。以下讨论中的示例使用服务名 `mysql-unix` 进行传统 Unix 密码认证，使用 `mysql-ldap` 进行 LDAP 认证。
- 对于代理支持，PAM 提供了一种方式，使 PAM 模块可以返回给服务器一个与客户端