### 8.4.2 连接控制插件

MySQL 服务器包含一个插件库，使管理员能够在连续多次失败尝试后逐渐增加服务器响应连接尝试的延迟。此功能提供了一种威慑措施，减缓了对 MySQL 用户帐户的暴力攻击。插件库包含两个插件：

- `CONNECTION_CONTROL`：检查传入的连接尝试，并在必要时增加服务器响应的延迟。此插件还暴露了一些系统变量，用于配置其操作，以及一个状态变量，用于提供基本的监控信息。
  
- `CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS`：实现了一个 INFORMATION_SCHEMA 表，用于暴露有关失败连接尝试的更详细的监控信息。

### 8.4.2.1 连接控制插件安装

连接控制插件的安装步骤如下：

1. **在服务器启动时加载插件**：

    要在服务器启动时加载插件，请使用 `--plugin-load-add` 选项来指定包含插件的库文件名。使用此插件加载方法时，每次服务器启动时都必须指定该选项。例如，将这些行放在服务器的 `my.cnf` 文件中：

    ```ini
    [mysqld]
    plugin-load-add=connection_control.so
    plugin-load-add=connection_control_failed_login_attempts.so
    ```

    修改 `my.cnf` 后，重新启动服务器以使新设置生效。

2. **在运行时加载插件**：

    也可以在运行时使用以下语句加载插件：

    ```sql
    INSTALL PLUGIN connection_control SONAME 'connection_control.so';
    INSTALL PLUGIN connection_control_failed_login_attempts SONAME 'connection_control_failed_login_attempts.so';
    ```

    `INSTALL PLUGIN` 语句会立即加载插件，并将其注册在 `mysql.plugins` 系统表中，使服务器在每次后续正常启动时加载它，而无需使用 `--plugin-load-add`。

3. **验证插件安装**：

    要验证插件安装情况，可以检查 Information Schema `PLUGINS` 表或使用 `SHOW PLUGINS` 语句。例如：

    ```sql
    mysql> SELECT PLUGIN_NAME, PLUGIN_STATUS
           FROM INFORMATION_SCHEMA.PLUGINS
           WHERE PLUGIN_NAME LIKE '%connection_control%';
    +----------------------------------------+---------------+
    | PLUGIN_NAME                            | PLUGIN_STATUS |
    +----------------------------------------+---------------+
    | connection_control                     | ACTIVE        |
    | connection_control_failed_login_attempts | ACTIVE      |
    +----------------------------------------+---------------+
    ```

    如果插件未能初始化，请检查服务器错误日志中的诊断消息。

### 8.4.2.2 连接控制系统和状态变量

连接控制插件通过暴露一些系统变量来配置其操作，并提供一个状态变量用于基本监控。以下是一些主要的系统变量：

- **`connection_control_failed_connections_threshold`**: 设置在开始增加响应延迟之前的连续失败连接尝试次数。

- **`connection_control_min_connection_delay`**: 设置开始增加的最小延迟时间。

- **`connection_control_max_connection_delay`**: 设置增加的最大延迟时间。

- **`connection_control_delay_increment`**: 设置每次失败连接尝试后延迟增加的时间。

这些变量可以通过在 MySQL 配置文件 `my.cnf` 中进行设置，或者在运行时使用 `SET GLOBAL` 语句来动态更改。例如：

```sql
SET GLOBAL connection_control_failed_connections_threshold = 5;
SET GLOBAL connection_control_min_connection_delay = 1000;
SET GLOBAL connection_control_max_connection_delay = 10000;
SET GLOBAL connection_control_delay_increment = 1000;
```

### 监控

- **`Connection_control_failed_login_attempts`**: 提供有关失败连接尝试的详细监控信息。该信息通过 `INFORMATION_SCHEMA` 中的 `CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS` 表提供。有关该表的更多信息，请参见[第 28.6.2 节, “INFORMATION_SCHEMA CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS 表”](#information-schema-connection-control-failed-login-attempts-table)。

这些配置和监控工具帮助管理员有效地管理和保护 MySQL 服务器免受暴力攻击。