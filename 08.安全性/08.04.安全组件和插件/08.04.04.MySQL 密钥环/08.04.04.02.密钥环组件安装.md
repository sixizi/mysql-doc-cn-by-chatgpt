### 8.4.4.2 密钥环组件安装

密钥环服务的使用者需要安装一个密钥环组件或插件：

- 要使用密钥环组件，请从这里的说明开始。
- 要使用密钥环插件，请参阅[8.4.4.3节, “密钥环插件安装”](#8.4.4.3)。

如果您打算在所选择的密钥环组件或插件中使用密钥环功能，请在安装该组件或插件后，按照[8.4.4.15节, “通用密钥环密钥管理功能”](#8.4.4.15)中的说明安装这些功能。

> **注意**
> 一次只能启用一个密钥环组件或插件。不支持启用多个密钥环组件或插件，结果可能不会如预期。

MySQL 提供以下密钥环组件选择：

- `component_keyring_file`：将密钥环数据存储在服务器主机的本地文件中。在 MySQL Community Edition 和 MySQL Enterprise Edition 版本中可用。
  
- `component_keyring_encrypted_file`：将密钥环数据存储在服务器主机的加密、密码保护的本地文件中。在 MySQL Enterprise Edition 版本中可用。
  
- `component_keyring_oci`：将密钥环数据存储在 Oracle 云基础设施保管库中。在 MySQL Enterprise Edition 版本中可用。

要使服务器能够使用，组件库文件必须位于 MySQL 插件目录中（由系统变量 `plugin_dir` 指定的目录）。如有必要，可以通过在服务器启动时设置 `plugin_dir` 的值来配置插件目录位置。

在服务器启动序列的早期阶段必须加载一个密钥环组件或插件，以便其他组件在其自身初始化期间可以根据需要访问它。例如，InnoDB 存储引擎使用密钥环进行表空间加密，因此必须在 InnoDB 初始化之前加载并启用一个密钥环组件或插件。

> **注意**
> 如果需要支持持久化系统变量值的安全存储，必须在 MySQL 服务器实例上启用密钥环组件。密钥环插件不支持此功能。请参阅[持久化敏感系统变量](#persisting-sensitive-system-variables)。

与密钥环插件不同，密钥环组件不是使用 `--early-plugin-load` 服务器选项加载或使用系统变量配置的。相反，服务器在启动期间使用清单文件确定要加载的密钥环组件，并在初始化时加载的组件会参考其自己的配置文件。因此，要安装密钥环组件，您必须：

1. 编写一个清单文件，告诉服务器要加载哪个密钥环组件。
2. 编写该密钥环组件的配置文件。

安装密钥环组件的第一步是编写一个清单文件，指示要加载哪个组件。在启动期间，服务器读取全局清单文件或全局清单文件与本地清单文件配对：

- 服务器尝试从服务器安装目录读取其全局清单文件。
- 如果全局清单文件指示使用本地清单文件，服务器尝试从数据目录读取其本地清单文件。

尽管全局和本地清单文件位于不同的目录中，但文件名在两个位置都是 `mysqld.my`。

清单文件不存在并不是错误。在这种情况下，服务器不会尝试加载与该文件相关的任何组件。

本地清单文件允许为多个服务器实例设置组件加载，使每个服务器实例的加载指令特定于给定的数据目录实例。这使不同的 MySQL 实例可以使用不同的密钥环组件。

服务器清单文件具有以下属性：

- 清单文件必须是有效的 JSON 格式。
- 清单文件允许以下项目：
  - `"read_local_manifest"`：此项目仅在全局清单文件中允许。如果该项目不存在，服务器仅使用全局清单文件。如果该项目存在，其值为 `true` 或 `false`，指示服务器是否应读取本地清单文件中的组件加载信息。
  - 如果全局清单文件中存在 `"read_local_manifest"` 项以及其他项目，服务器首先检查 `"read_local_manifest"` 项的值：
    - 如果值为 `false`，服务器处理全局清单文件中的其他项目，忽略本地清单文件。
    - 如果值为 `true`，服务器忽略全局清单文件中的其他项目，并尝试读取本地清单文件。
  - `"components"`：此项目指示要加载的组件。项目值是一个字符串，指定有效的组件 URN，例如 `"file://component_keyring_file"`。组件 URN 以 `file://` 开头，并指示位于 MySQL 插件目录中的库文件的基本名称，该文件实现了该组件。

服务器对清单文件的访问应为只读。例如，一个 `mysqld.my` 服务器清单文件可能由 root 拥有，并且对 root 具有读/写权限，但应对运行 MySQL 服务器的帐户为只读。如果在启动期间发现清单文件对该帐户具有读/写权限，服务器会向错误日志写入警告，建议将该文件设置为只读。

数据库管理员负责创建要使用的任何清单文件，并确保其访问模式和内容正确。如果发生错误，服务器启动失败，管理员必须根据服务器错误日志中的诊断信息纠正任何问题。

根据上述清单文件的属性，要配置服务器加载 `component_keyring_file`，请在 `mysqld` 安装目录中创建一个名为 `mysqld.my` 的全局清单文件，并可选地在数据目录中创建一个同样名为 `mysqld.my` 的本地清单文件。以下说明描述了如何加载 `component_keyring_file`。要加载不同的密钥环组件，请替换其名称。

要仅使用全局清单文件，文件内容如下所示：

```json
{
  "components": "file://component_keyring_file"
}
```

在 `mysqld` 安装目录中创建此文件。

或者，要使用全局和本地清单文件对，全局文件如下所示：

```json
{
  "read_local_manifest": true
}
```

在 `mysqld` 安装目录中创建此文件。

本地文件如下所示：

```json
{
  "components": "file://component_keyring_file"
}
```

在数据目录中创建此文件。

清单文件就位后，继续配置密钥环组件。为此，请检查所选密钥环组件的注释以获取该组件的配置说明：

- `component_keyring_file`：请参阅[8.4.4.4节, “使用 component_keyring_file 文件基础的密钥环组件”](#8.4.4.4)。
- `component_keyring_encrypted_file`：请参阅[8.4.4.5节, “使用 component_keyring_encrypted_file 加密文件基础的密钥环组件”](#8.4.4.5)。
- `component_keyring_oci`：请参阅[8.4.4.11节, “使用 Oracle 云基础设施保管库密钥环组件”](#8.4.4.11)。

在执行任何组件特定的配置后，启动服务器。通过检查 Performance Schema `keyring_component_status` 表来验证组件安装：

```sql
mysql> SELECT * FROM performance_schema.keyring_component_status;
+---------------------+-------------------------------------------------+
| STATUS_KEY          | STATUS_VALUE                                    |
+---------------------+-------------------------------------------------+
| Component_name      | component_keyring_file                          |
| Author              | Oracle Corporation                              |
| License             | GPL                                             |
| Implementation_name | component_keyring_file                          |
| Version             | 1.0                                             |
| Component_status    | Active                                          |
| Data_file           | /usr/local/mysql/keyring/component_keyring_file |
| Read_only           | No                                              |
+---------------------+-------------------------------------------------+
```

`Component_status` 值为 `Active` 表示组件初始化成功。

如果无法加载组件，服务器启动失败。检查服务器错误日志中的诊断消息。如果组件加载但由于配置问题无法初始化，服务器启动但 `Component_status` 值为 `Disabled`。检查服务器错误日志，纠正配置问题，并使用 `ALTER INSTANCE RELOAD KEYRING` 语句重新加载配置。

密钥环组件应仅通过使用清单文件加载，而不是使用 `INSTALL COMPONENT` 语句加载。使用该语句加载的密钥环组件可能在服务器启动序列中为某些使用密钥环的组件（如 InnoDB）可用得太晚，因为它们在 `mysql.component` 系统表中注册，并在后续服务器重启时自动加载。但是 `mysql.component` 是一个 InnoDB 表，因此任何在其中命名的组件只能在 InnoDB 初始化后加载。

如果在组件尝试访问密钥环服务时没有可用的密钥环组件或插件，该服务无法被该组件使用。结果，组件可能无法初始化或以有限的功能初始化。例如，如果 InnoDB 在初始化时发现存在加密表空间，它会尝试访问密钥环。如果密钥环不可用，InnoDB 只能访问未加密的表空间。