#### 20.5.3.1 理解事务一致性保证

就分布式一致性保证而言，无论是在正常操作还是故障修复操作中，群组复制始终是一个最终一致性系统。这意味着只要传入流量减慢或停止，所有群组成员都将具有相同的数据内容。与系统一致性相关的事件可以分为控制操作（手动或由故障自动触发）和数据流操作。

对于群组复制，可以从一致性角度评估的控制操作包括：

- 成员加入或离开，涉及群组复制的“分布式恢复”和写保护。
- 网络故障，涉及围栏模式。
- 在单主群组中，主故障转移，也可能是由`group_replication_set_as_primary()`触发的操作。

##### 一致性保证和主故障转移

在单主群组中，如果发生主故障转移，从被提升为主，新主要么可以立即对应用流量开放，无论复制积压有多大；要么可以限制访问，直到积压被应用完毕。

使用第一种方法，群组在主失败后尽可能最短时间内确保稳定的群组成员身份，通过选举新的主，然后在还在应用旧主的可能积压时立即允许数据访问。写一致性得到保证，但读取可能暂时检索到旧数据，直到新主应用完积压。例如，如果客户端C1在旧主失败前刚写了`A=2 WHERE A=1`，当客户端C1重新连接到新主时，可能暂时读到`A=1`，直到新主应用完积压并赶上旧主离开群组前的状态。

使用第二种方法，系统在主失败后以同样的方式确保稳定的群组成员身份并选举新的主，但在这种情况下，群组会等到新主应用完所有积压，然后才允许数据访问。这确保了在前面描述的情况下，当客户端C1重新连接到新主时，它读到的是A=2。然而，权衡是故障转移所需的时间与积压的大小成正比，这在正确配置的群组中应该是小的。

在MySQL 8.0.14之前，没有办法配置故障转移策略，默认情况下，像第一种方法描述的那样最大化可用性。在运行MySQL 8.0.14及更高版本的群组成员中，您可以使用`group_replication_consistency`变量配置成员在主故障转移期间提供的事务一致性保证级别。参见一致性对主选举的影响。

##### 数据流操作

由于对群组执行的读写操作，特别是当这些操作分布在所有成员上时，数据流与群组一致性保证相关。数据流操作适用于群组复制的单主和多主两种模式，但为了使这种解释更清晰，它仅限于单主模式。将传入的读或写事务分布在单主群组成员上的常见方式是将写操作路由到主，将读操作均匀分布到从库。由于群组应该表现为单一实体，可以合理期望在主上的写入立即在从库上可用。尽管群组复制是使用实现Paxos算法的群组通信系统（GCS）协议编写的，但群组复制的某些部分是异步的，这意味着数据是异步应用到从库的。这意味着客户端C2可以在主上写`B=2 WHERE B=1`，立即连接到从并读到`B=1`。这是因为从库还在应用积压，并且尚未应用主上已应用的事务。

##### 事务同步点

您可以根据希望在群组中同步事务的点来配置群组的一致性保证。为了帮助您理解这个概念，本节简化了在群组中同步事务的点，将其归结为在读操作或写操作时。如果在读取时同步数据，则当前客户端会话必须等到给定点（所有先前更新事务已应用的点）才能开始执行。使用这种方法，只有这个会话受到影响，所有其他并发数据操作都不受影响。

如果在写入时同步数据，则写入会话需要等到所有从库写入数据。群组复制使用对写入的总排序，因此这意味着等待此次及所有先前写入在从库队列中应用。因此，当使用此同步点时，写入会话需要等待所有从库队列应用。

任何一种替代方法都确保在之前描述的客户端C2的情况下，即使立即连接到从库，也总是读到B=2。每种替代方法都有其优缺点，这直接与您的系统工作负载有关。以下示例描述了不同类型的工作负载，并建议哪种同步点是合适的。

想象以下情况：

- 您想要在不部署额外限制（以避免读到陈旧数据）的情况下平衡读取，群组写入比群组读取少得多。
- 您有一个主要是只读数据的群组，您希望读写事务一旦提交就在各处应用，以便后续读取在包含最新写入的最新数据上进行。这确保您不会为每个RO事务支付同步成本，而只是RW事务。

在这些情况下，您应该选择在写入时同步。

想象以下情况：

- 您想要在不部署额外限制（以避免读到陈旧数据）的情况下平衡读取，群组写入比群组读取多得多。
- 您希望工作负载中的特定事务始终从群组读取最新数据，例如每当更新敏感数据（如文件凭据或类似数据）时，您希望强制读取最新值。

在这些情况下，您应该选择在读取时同步。