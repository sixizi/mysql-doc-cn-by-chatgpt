### 20.5.4.1 分布式恢复的连接

当加入成员在分布式恢复期间连接到在线的现有成员以进行状态传输时，加入成员在连接上充当客户端，而现有成员充当服务器。当通过此连接进行捐赠者二进制日志的状态传输时（使用异步复制通道`group_replication_recovery`），加入成员充当副本，现有成员充当源。在此连接上进行远程克隆操作时，加入成员充当接收者，现有成员充当捐赠者。在组复制上下文之外应用于这些角色的配置设置，也可以应用于组复制，除非它们被组复制特定的配置设置或行为覆盖。

现有成员提供给加入成员进行分布式恢复的连接，与组复制用于组内在线成员之间通信的连接不同。

组复制的组通信引擎（XCom，Paxos变体）用于远程XCom实例之间的TCP通信的连接，由`group_replication_local_address`系统变量指定。此连接用于在线成员之间的TCP/IP消息。与本地实例的通信是通过使用共享内存的输入通道进行的。

对于分布式恢复，直到MySQL 8.0.20，组成员向加入成员提供他们的标准SQL客户端连接，如MySQL服务器的主机名和端口系统变量所指定。如果通过`report_port`系统变量指定了另一个端口号，则使用该端口号。

从MySQL 8.0.21开始，组成员可以宣传另一个分布式恢复端点列表作为加入成员的专用客户端连接，允许您单独控制分布式恢复流量，与成员的常规客户端用户连接分开。您可以使用`group_replication_advertise_recovery_endpoints`系统变量指定此列表，成员在加入组时将其分布式恢复端点列表传输给组。默认情况下，成员继续提供标准SQL客户端连接，如之前版本中一样。

> **重要提示**
>
> 如果加入成员无法使用MySQL服务器的`hostname`系统变量定义的主机名正确识别其他成员，分布式恢复可能会失败。建议运行MySQL的操作系统配置有正确的唯一主机名，无论是使用DNS还是本地设置。服务器用于SQL客户端连接的主机名可以在性能模式表`replication_group_members`的`Member_host`列中进行验证。如果多个组成员外化了操作系统设置的默认主机名，则加入成员可能无法将其解析为正确的成员地址，无法连接进行分布式恢复。在这种情况下，您可以使用MySQL服务器的`report_host`系统变量配置一个唯一的主机名，由每个服务器外化。

加入成员建立分布式恢复连接的步骤如下：

1. 成员加入组时，它首先使用其`group_replication_group_seeds`系统变量中的列表中的一个种子成员进行连接，最初使用该列表中指定的`group_replication_local_address`连接。种子成员可能是组的一个子集。

2. 通过此连接，种子成员使用组复制的成员资格服务为加入成员提供组中所有在线成员的列表，以视图形式。成员资格信息包括每个成员提供的分布式恢复端点或标准SQL客户端连接的详细信息，用于分布式恢复。

3. 加入成员从此列表中选择一个合适的组成员作为其分布式恢复的捐赠者，按照第18.5.4.4节“分布式恢复的容错”中描述的行为进行。

4. 然后，加入成员尝试使用捐赠者宣传的分布式恢复端点连接到捐赠者，按照列表中指定的顺序依次尝试每个端点。如果捐赠者没有提供端点，则加入成员尝试使用捐赠者的标准SQL客户端连接。连接的SSL要求如第18.5.4.1.4节“分布式恢复的SSL和认证”中描述的`group_replication_recovery_ssl_*`选项所指定。

5. 如果加入成员无法连接到所选的捐赠者，它会按照第18.5.4.4节“分布式恢复的容错”中描述的行为，重试其他合适的捐赠者。注意，如果加入成员耗尽宣传的端点列表而未建立连接，它不会回退到捐赠者的标准SQL客户端连接，而是切换到另一个捐赠者。

6. 当加入成员与捐赠者建立分布式恢复连接时，它将使用该连接进行状态传输，如第18.5.4节“分布式恢复”中所述。连接使用的主机和端口将显示在加入成员的日志中。注意，如果使用远程克隆操作，当加入成员在操作结束时重新启动，它将与新的捐赠者建立连接，以从二进制日志中进行状态传输。这可能是与原始用于远程克隆操作的捐赠者不同的成员的连接，或者可能是与原始捐赠者的不同连接。无论如何，分布式恢复过程继续，就像它会与原始捐赠者一样。

##### 18.5.4.1.1 为分布式恢复端点选择地址

通过`group_replication_advertise_recovery_endpoints`系统变量提供的分布式恢复端点的IP地址不必为MySQL服务器配置（即，它们不必由`admin_address`系统变量指定或在`bind_address`系统变量的列表中指定）。但它们必须分配给服务器。使用的任何主机名必须解析为本地IP地址。可以使用IPv4和IPv6地址。

为分布式恢复端点提供的端口必须为MySQL服务器配置，因此它们必须由`port`、`report_port`或`admin_port`系统变量指定。服务器必须在这些端口上监听TCP/IP连接。如果您指定`admin_port`，则分布式恢复的复制用户需要`SERVICE_CONNECTION_ADMIN`权限才能连接。选择`admin_port`可将分布式恢复连接与常规MySQL客户端连接分开。

加入成员按照列表中指定的顺序依次尝试每个端点。如果`group_replication_advertise_recovery_endpoints`设置为DEFAULT而不是端点列表，则提供标准SQL客户端连接。请注意，标准SQL客户端连接不会自动包含在分布式恢复端点列表中，并且如果未连接耗尽捐赠者的端点列表，则不会作为后备提供。如果您想将标准SQL客户端连接作为多个分布式恢复端点之一提供，则必须在`group_replication_advertise_recovery_endpoints`指定的列表中明确包含它。您可以将其放在最后一个位置，以便作为连接的最后手段。

组成员的分布式恢复端点（或如果未提供端点，则为标准SQL客户端连接）不需要添加到由`group_replication_ip_allowlist`（从MySQL 8.0.22开始）或`group_replication_ip_whitelist`系统变量指定的组复制允许列表中。允许列表仅用于每个成员的`group_replication_local_address`指定的地址。加入成员必须使其最初连接到组被允许列表允许，以检索用于分布式恢复的地址或地址。

您列出的分布式恢复端点在设置系统变量时和发出`START GROUP_REPLICATION`语句时会被验证。如果列表无法正确解析，或者如果服务器因为不在它们上监听而无法在主机上访问任何端点，则组复制将记录错误并不会启动。

##### 18.5.4.1.2 分布式恢复的压缩

从MySQL 8.0.18开始，您可以选择性地为从捐赠者的二进制日志进行的状态传输配置分布式恢复的压缩。当网络带宽有限且捐赠者必须向加入成员传输许多事务时，压缩可以促进分布式恢复。`group_replication_recovery_compression_algorithms`和`group_replication_recovery_zstd_compression_level`系统变量配置用于从捐赠者的二进制日志执行状态传输时使用的允许压缩算法和zstd压缩级别。有关更多信息，请参阅第4.2.8节“连接压缩控制”。

请注意，这些压缩设置不适用于远程克隆操作。当分布式恢复使用远程克隆操作时，适用克隆插件的`clone_enable_compression`设置。

##### 18.5.4.1.3 分布式恢复的复制用户

分布式恢复需要一个具有正确权限的复制用户，以便组复制可以建立直接的成员间复制通道。复制用户还必须具备作为远程克隆操作中捐赠者的克隆用户的正确权限。分布式恢复在每个组成员上必须使用相同的复制用户。有关设置此复制用户的说明，请参阅第18.2.1.3节“分布式恢复的用户凭据”。有关保护复制用户凭据的说明，请参阅第18.6.3.1节“保护分布式恢复的用户凭据”。

##### 18.5.4.1.4 分布式恢复的SSL和认证

分布式恢复的SSL配置与正常组通信的SSL配置分开，后者由服务器的SSL设置和`group_replication_ssl_mode`系统变量决定。对于分布式恢复连接，可用的专用组复制分布式恢复SSL系统变量，用于特别为分布式恢复配置证书和密码。

默认情况下，分布式恢复连接不使用SSL。要激活它，请将`group_replication_recovery_use_ssl`设置为ON，并按照第18.6.3节“保护分布式恢复连接”中所述配置组复制分布式恢复SSL系统变量。您需要一个设置为使用SSL的复制用户。

当配置分布式恢复以使用SSL时，组复制将此设置应用于远程克隆操作以及从捐赠者的二进制日志的状态传输。组复制自动配置克隆SSL选项（`clone_ssl_ca`、`clone_ssl_cert`和`clone_ssl_key`）的设置，以匹配您为相应的组复制分布式恢复选项（`group_replication_recovery_ssl_ca`、`group_replication_recovery_ssl_cert`和`group_replication_recovery_ssl_key`）设置的设置。

如果您未使用SSL进行分布式恢复（即`group_replication_recovery_use_ssl`设置为OFF），并且组复制的复制用户帐户使用`caching_sha2_password`插件（这是MySQL 8.0中的默认值）或`sha256_password`插件进行认证，则使用RSA密

钥对进行密码交换。在这种情况下，可以使用`group_replication_recovery_public_key_path`系统变量指定RSA公钥文件，或者使用`group_replication_recovery_get_public_key`系统变量从源请求公钥，如第18.6.3.1.1节“具有缓存SHA-2认证插件的复制用户”中所述。