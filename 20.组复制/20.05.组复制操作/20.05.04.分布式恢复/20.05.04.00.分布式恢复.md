### 20.5.4 分布式恢复

[20.5.4.1 分布式恢复的连接](./20.05.04.01.分布式恢复的连接.md)
[20.5.4.2 分布式恢复的克隆](./20.05.04.02.分布式恢复的克隆.md)
[20.5.4.3 配置分布式恢复](./20.05.04.03.配置分布式恢复.md)
[20.5.4.4 分布式恢复的容错](./20.05.04.04.分布式恢复的容错.md)
[20.5.4.5 分布式恢复的工作原理](./20.05.04.05.分布式恢复的工作原理.md)

每当一个成员加入或重新加入复制组时，它必须追赶组内其他成员在它加入前或不在时应用的事务。这个过程称为分布式恢复。

加入的成员首先检查其`group_replication_applier`通道的中继日志，看是否有它已经从组中接收但尚未应用的事务。如果加入的成员之前在组中，它可能会发现它离开前未应用的事务，在这种情况下，它会作为第一步应用这些事务。对于新加入组的成员而言，则没有任何事务需要应用。

之后，加入的成员连接到一个在线的现有成员以进行状态传输。加入的成员传输在其加入组之前或不在时发生的所有事务，这些事务由现有成员（称为捐赠者）提供。接下来，加入的成员应用在此状态传输进行期间组内发生的事务。当此过程完成后，加入的成员就追上了组内的其他服务器，并开始正常参与组内活动。

组复制在分布式恢复期间使用以下方法组合进行状态传输：

- 使用从MySQL 8.0.17开始提供的克隆插件的功能进行远程克隆操作。要启用这种状态传输方式，您必须在组成员和加入成员上安装克隆插件。组复制自动配置所需的克隆插件设置，并管理远程克隆操作。

- 从捐赠者的二进制日志中复制并在加入的成员上应用事务。这种方法使用名为`group_replication_recovery`的标准异步复制通道，该通道在捐赠者和加入的成员之间建立。

组复制在您对加入的成员发出`START GROUP_REPLICATION`后，自动选择这些方法的最佳组合进行状态传输。为此，组复制会检查哪些现有成员适合作为捐赠者，加入的成员从捐赠者那里需要多少事务，以及任何所需的事务是否不再存在于任何组成员的二进制日志文件中。如果加入的成员与适当的捐赠者之间的事务差异较大，或者某些所需的事务不在任何捐赠者的二进制日志文件中，组复制将以远程克隆操作开始分布式恢复。如果事务差异不大，或者未安装克隆插件，组复制将直接进行从捐赠者的二进制日志的状态传输。

在远程克隆操作期间，加入成员上的现有数据将被移除，并替换为捐赠者数据的副本。当远程克隆操作完成且加入的成员重新启动后，将执行从捐赠者的二进制日志的状态传输，以获取在远程克隆操作进行期间组应用的事务。

在从捐赠者的二进制日志进行状态传输期间，加入的成员复制并应用捐赠者二进制日志中所需的事务，将事务应用到加入组的二进制日志记录点（视图更改事件）。在此进行时，加入的成员会缓冲组应用的新事务。当从二进制日志的状态传输完成后，加入的成员应用这些缓冲的事务。

当加入的成员与组的所有事务都是最新的时，它被声明为在线状态，并可以作为正常成员参与组，此时分布式恢复完成。

> **提示**
>
> 从二进制日志的状态传输是组复制分布式恢复的基本机制，如果您的复制组中的捐赠者和加入成员未设置为支持克隆，则这是唯一可用的选项。由于从二进制日志的状态传输基于经典的异步复制，如果加入组的服务器根本没有组的数据，或者数据来自非常旧的备份镜像，这可能需要很长时间。在这种情况下，因此建议在将服务器添加到组之前，您应该通过传输组内已有服务器的相对较新的快照来设置它，以便具备组的数据。这样可以最大程度地减少分布式恢复所需的时间，并减少对捐赠者服务器的影响，因为它们需要保留并传输的二进制日志文件更少。