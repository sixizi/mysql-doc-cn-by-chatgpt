#### 20.1.3.1 单主模式

在单主模式（`group_replication_single_primary_mode=ON`）下，群组有一个单一的主服务器，设置为读写模式。群组中的所有其他成员都设置为只读模式（`super_read_only=ON`）。主服务器通常是首个引导群组的服务器。所有加入群组的其他服务器了解到主服务器，并自动设置为只读模式。

在单主模式下，群组复制确保只有一个服务器对群组进行写操作，因此与多主模式相比，一致性检查可以不那么严格，DDL（数据定义语言）语句不需要特别小心处理。选项`group_replication_enforce_update_everywhere_checks`用于启用或禁用群组的严格一致性检查。在单主模式下部署或将群组更改为单主模式时，必须将此系统变量设置为OFF。

被指定为主服务器的成员可以通过以下方式更改：

- 如果现有的主服务器自愿或意外地离开群组，将自动选举出新的主服务器。
- 您可以使用`group_replication_set_as_primary()`函数指定特定成员作为新的主服务器。
- 如果您使用`group_replication_switch_to_single_primary_mode()`函数将在多主模式下运行的群组更改为单主模式，将自动选举出新的主服务器，或者您可以通过指定该函数来任命新的主服务器。

这些函数只能在所有群组成员运行MySQL 8.0.13或更高版本时使用。当新的主服务器自动选举或手动任命时，它会自动设置为读写模式，而其他群组成员保持为从属服务器，因此是只读的。图18.4“新主服务器选举”展示了这一过程。

**图18.4 新主服务器选举**

![](single-primary-election.png)

当新的主服务器被选举或任命时，它可能有一些变更积压，这些变更已在旧主服务器上应用但尚未在该服务器上应用。在这种情况下，直到新主服务器赶上旧主服务器，读写事务可能会导致冲突并被回滚，只读事务可能导致陈旧的读取。群组复制的流控制机制，旨在减少快速成员和慢速成员之间的差异，如果激活并适当调整，可以减少这种情况的发生概率。有关流控制的更多信息，请参见第18.7.2节，“流控制”。从MySQL 8.0.14开始，您还可以使用`group_replication_consistency`系统变量来配置群组的事务一致性级别，以防止这个问题。设置为`BEFORE_ON_PRIMARY_FAILOVER`（或更高的一致性级别）会在新选举的主服务器上保持新事务，直到积压的变更被应用。有关事务一致性的更多信息，请参见第18.5.3节，“事务一致性保证”。如果群组没有使用流控制和事务一致性保证，那么在将客户端应用程序重新路由到新主服务器之前，等待新主服务器应用其复制相关的中继日志是一个好习惯。

##### 18.1.3.1.1 主服务器选举算法

自动主成员选举过程涉及到每个成员查看群组的新视图，对潜在的新主成员进行排序，并选择最合适的成员。每个成员根据其MySQL服务器版本中的主选举算法本地做出决策。因为所有成员都必须达成相同的决策，所以如果其他群组成员运行较低版本的MySQL服务器，成员会调整他们的主选举算法，使其与群组中最低MySQL服务器版本的成员行为一致。

成员在选举主服务器时考虑的因素依次如下：

1. 首先考虑的因素是哪些成员运行着最低版本的MySQL服务器。如果所有群组成员都运行MySQL 8.0.17或更高版本，成员首先按照其版本的补丁版本进行排序。如果任何成员运行MySQL服务器5.7或MySQL 8.0.16或更低版本，成员首先按照其版本的主版本排序，补丁版本被忽略。

2. 如果有多于一个成员运行着最低版本的MySQL服务器，第二个考虑的因素是每个成员的`group_replication_member_weight`系统变量指定的成员权重。如果群组中有任何成员运行MySQL服务器5.7，其中该系统变量不可用，这个因素将被忽略。

   `group_replication_member_weight`系统变量指定了一个0-100范围内的数字。所有成员默认权重为50，因此设置权重低于此值将降低其排序，权重高于此值将提高其排序。您可以使用这个权重功能来优先使用更好的硬件，或在主服务器计划维护期间确保故障转移到特定成员。

3. 如果有多于一个成员运行着最低版本的MySQL服务器，并且其中超过一个成员具有最高的成员权重（或忽略成员权重），第三个考虑的因素是每个成员的`server_uuid`系统变量指定的生成的服务器UUID的字典顺序。选择具有最低服务器UUID的成员作为主服务器。这个因素作为一个有保证且可预测的决胜因素，以便所有群组成员在无法通过任何重要因素确定时达成相同的决策。

##### 18.1.3.1.2 查找主服务器

要在单主模式下部署时了解哪台服务器当前是主服务器，请使用`performance_schema.replication_group_members`表中的`MEMBER_ROLE`列。例如：

```sql
mysql> SELECT MEMBER_HOST, MEMBER_ROLE FROM performance_schema.replication_group_members;
+-------------------------+-------------+
| MEMBER_HOST             | MEMBER_ROLE |
+-------------------------+-------------+
| remote1.example.com     | PRIMARY     |
| remote2.example.com     | SECONDARY   |
| remote3.example.com     | SECONDARY   |
+-------------------------+-------------+
```

> **警告**
>
> `group_replication_primary_member`状态变量已被弃用，并计划在未来版本中移除。

或者使用`group_replication_primary_member`状态变量。

```sql
mysql> SHOW STATUS LIKE 'group_replication_primary_member'
```