#### 20.1.3.2 多主模式

在**多主模式**（`group_replication_single_primary_mode=OFF`）中，没有任何成员扮演特殊角色。当任何与其他群组成员兼容的成员加入群组时，它们会被设置为**读写模式**，并且能够处理写事务，即使这些事务是同时发出的。

如果某个成员停止接受写事务，例如在意外的服务器退出事件中，连接到该成员的客户端可以被**重定向**或**故障转移**到任何处于读写模式的其他成员。群组复制本身不处理客户端侧的故障转移，因此你需要使用中间件框架（如**MySQL Router 8.0**）、代理、连接器或应用程序本身来安排这一点。

**图18.5，“客户端故障转移”** 展示了如果某成员离开群组，客户端如何重新连接到另一个群组成员。

**图18.5，“客户端故障转移”** 

![](multi-primary.png)

群组复制是一个最终一致性系统。这意味着，一旦传入流量减慢或停止，所有群组成员将拥有相同的数据内容。在流量流动时，某些成员可能会比其他成员更早地处理事务，尤其是在一些成员的写入吞吐量低于其他成员的情况下，这可能导致陈旧读取。在多主模式下，较慢的成员也可能积累过多的待认证和应用的事务，从而导致冲突和认证失败的风险更大。为了限制这些问题，您可以激活并调整群组复制的流量控制机制，以最小化快速和慢速成员之间的差异。有关流量控制的更多信息，请参见第18.7.2节，“流量控制”。

从MySQL 8.0.14开始，如果您希望对群组中的每个事务都有事务一致性保证，可以使用`group_replication_consistency`系统变量来实现。您可以选择适合您群组工作负载和对数据读写的优先级的设置，同时考虑到提高一致性所需的同步对性能的影响。您还可以为特别需要并发性保护的事务设置单独会话的系统变量。有关事务一致性的更多信息，请参见第18.5.3节，“事务一致性保证”。

##### 18.1.3.2.1 事务检查

当群组以多主模式部署时，会检查事务以确保它们与模式兼容。在多主模式下部署群组复制时，将进行以下严格的一致性检查：

- 如果事务在`SERIALIZABLE`隔离级别下执行，则在与群组同步时其提交将失败。
- 如果事务针对具有级联约束的外键的表执行，则在与群组同步时其提交将失败。

这些检查由`group_replication_enforce_update_everywhere_checks`系统变量控制。在多主模式下，通常应将系统变量设置为`ON`，但可以通过将系统变量设置为`OFF`来选择性地停用检查。在单主模式部署时，系统变量必须设置为`OFF`。

##### 18.1.3.2.2 数据定义语句

在多主模式的群组复制拓扑中，执行数据定义语句（也常称为数据定义语言DDL）时需要格外小心。

MySQL 8.0引入了对原子数据定义语言（DDL）语句的支持，其中完整的DDL语句作为单个原子事务提交或回滚。然而，DDL语句（无论是原子性的还是其他类型的）隐式地结束当前会话中的任何活动事务，就好像在执行语句之前执行了`COMMIT`一样。这意味着DDL语句不能在另一个事务内执行，不能在`START TRANSACTION ... COMMIT`等事务控制语句内执行，也不能与同一事务内的其他语句组合执行。

群组复制基于乐观复制范式，其中语句被乐观地执行，并在必要时稍后回滚。每个服务器在没有先获得群组协议的情况下执行。因此，在多主模式下复制DDL语句时需要更加小心。如果您对同一对象进行架构更改（使用DDL）和包含该对象的数据更改（使用DML），则需要在架构操作尚未完成并且在各处复制之前通过同一服务器处理这些更改。如果不这样做，当操作被中断或只部分完成时，可能会导致数据不一致。如果群组以单主模式部署，则不会出现此问题，因为所有更改都通过同一服务器（即主服务器）执行。

有关MySQL 8.0中原子DDL支持的详细信息，以及复制某些语句行为的变化，请参见第13.1.1节，“原子数据定义语句支持”。

##### 18.1.3.2.3 版本兼容性

为了获得最佳兼容性和性能，群组的所有成员都应运行相同版本的MySQL服务器，因此也是群组复制的相同版本。在多主模式下，这一点更为重要，因为所有成员通常都以读写模式加入群组。如果群组包含运行多个MySQL服务器版本的成员，则可能存在某些成员与其他成员不兼容的风险，因为它们支持其他成员不支持的功能，或缺乏其他成员拥有的功能。为了防范这种情况，当新成员加入时（包括已升级并重启的前成员），该成员将对群组中的其他成员进行兼容性检查。

这些兼容性检查的一个特别重要的结果是在多主模式中。如果加入的成员运行的MySQL服务器版本高于现有群组成员运行的最低版本，则它加入群组但保持只读模式。（在以单主模式运行的群组中，新添加的成员默认情况下无论如何都是只读的。）运行MySQL 8.0.17或更高版本的成员在检查其兼容性时会考虑发布的补丁版本。运行MySQL 8.0.16或更低版本，或MySQL 5.7的成员，只考虑主版本。

在以多主模式运行且成员使用不同MySQL服务器版本的群组中，群组复制自动管理运行MySQL 8.0.17或更高版本的成员的读写和只读状态。如果成员离开群组，则运行现在是最低版本的成员自动设置为读写模式。当您将以单主模式运行的群组更改为以多主模式运行时，使用`group_replication_switch_to_multi_primary_mode()`函数，群组复制会自动将成员设置为正确的模式。如果成员运行的MySQL服务器版本高于群组中存在的最低版本，则自动将其置于只读模式；运行最低版本的成员则置于读写模式。

有关群组中版本兼容性的完整信息以及这如何影响群组在升级过程中的行为，请参见第18.8.1节，“在群组中结合不同成员版本”。
