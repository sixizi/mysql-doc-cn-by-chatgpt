### 20.4.1 GTIDs和群组复制

群组复制使用GTIDs（全局事务标识符）来准确跟踪每个服务器实例上已提交的事务。所有群组成员都需要设置`gtid_mode=ON`和`enforce_gtid_consistency=ON`。从客户端接收的传入事务由接收它们的群组成员分配GTID。从群组外部源服务器通过异步复制通道接收的任何复制事务保留它们到达群组成员时所拥有的GTIDs。

分配给来自客户端的传入事务的GTIDs使用`group_replication_group_name`系统变量指定的群组名称作为标识符的UUID部分，而不是接收事务的单个群组成员的服务器UUID。因此，直接由群组接收的所有事务都可以被识别并在GTID集合中分组，而且无关紧要的是哪个成员最初接收了它们。每个群组成员都为其使用预留了一系列连续的G经、TIDs，并在这些被消耗时预留更多。`group_replication_gtid_assignment_block_size`系统变量设置块的大小，默认为每个块100万个GTIDs。

群组自身在新成员加入时生成的视图更改事件（View_change_log_event）在记录到二进制日志时被赋予GTIDs。默认情况下，这些事件的GTIDs也使用`group_replication_group_name`系统变量指定的群组名称作为标识符的UUID部分。从MySQL 8.0.26开始，您可以设置群组复制系统变量`group_replication_view_change_uuid`来在视图更改事件的GTIDs中使用替代UUID，以便于将它们与群组从客户端接收的事务区分开来。如果您的设置允许在群组之间进行故障转移，并且您需要识别和丢弃特定于备份群组的事务，这可能很有用。替代UUID必须与成员的服务器UUID不同。它还必须与使用`CHANGE REPLICATION SOURCE TO`语句的`ASSIGN_GTIDS_TO_ANONYMOUS_TRANSACTIONS`选项应用于匿名事务的GTIDs中的任何UUID不同。

从MySQL 8.0.27开始，对于群组复制通道`group_replication_applier`和`group_replication_recovery`，应用了`GTID_ONLY=1`、`REQUIRE_ROW_FORMAT = 1`和`SOURCE_AUTO_POSITION = 1`设置。当创建群组复制通道或将复制群组中的成员服务器升级到8.0.27或更高版本时，这些设置会自动进行。这些选项通常使用`CHANGE REPLICATION SOURCE TO`语句设置，但请注意，您不能为群组复制通道禁用它们。设置这些选项后，群组成员不会在这些通道的复制元数据存储库中持久化文件名和文件位置。必要时使用GTID自动定位和GTID自动跳过来定位正确的接收者和应用者位置。

#### 额外的事务

如果加入成员的GTID集合中有现有群组成员没有的事务，则不允许其完成分布式恢复过程，并且不能加入群组。如果进行了远程克隆操作，这些事务将被删除并丢失，因为加入成员的数据目录被擦除。如果进行了从捐赠者的二进制日志的状态转移，则这些事务可能与群组的事务冲突。

如果成员在停止群组复制时在实例上进行了管理事务，则成员上可能存在额外的事务。为了避免以这种方式引入新事务，在发出管理语句之前，请始终将`sql_log_bin`系统变量的值设置为OFF，然后再设置回ON：

```mysql
SET SQL_LOG_BIN=0;
<administrator action>
SET SQL_LOG_BIN=1;
```

将此系统变量设置为OFF意味着从那时起直到您将其设置回ON的事务不会写入二进制日志，并且不会分配GTIDs。

如果加入成员上存在额外的事务，请检查受影响服务器的二进制日志，以查看额外的事务实际包含什么。与群组中的成员数据和GTID集合协调加入成员的最安全方法是使用MySQL的克隆功能将群组中服务器的内容传输到受影响的服务器。有关执行此操作的说明，请参见第5.6.7.3节，“克隆远程数据”。如果需要该事务，请在成员成功重新加入后重新运行它。