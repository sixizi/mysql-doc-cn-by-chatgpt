### 20.7.7 响应故障检测和网络分区

- [20.7.7.1 驱逐超时](./20.07.07.01.驱逐超时.md)
- [20.7.7.2 无法达到多数超时](./20.07.07.02.无法达到多数超时.md)
- [20.7.7.3 自动重新加入](./20.07.07.03.自动重新加入.md)
- [20.7.7.4 退出行为](./20.07.07.04.退出行为.md)

组复制的故障检测机制旨在识别不再与组通信的组成员，并在看似有可能失败时将其驱逐。具有故障检测机制可以增加组包含大多数正常工作成员的可能性，因此客户端的请求能够被正确处理。

通常，所有组成员会定期与其他所有组成员交换消息。如果一个组成员在 5 秒内没有收到特定同伴成员的任何消息，当这个检测周期结束时，它会对该同伴成员产生怀疑。当怀疑超时时，怀疑的成员被认为已经失败，并从组中驱逐。被驱逐的成员被从其他成员看到的成员列表中移除，但它不知道自己已经从组中被驱逐，所以它认为自己在线，而其他成员无法访问。如果该成员实际上并没有失败（例如，因为它仅仅由于临时网络问题而断开连接），并且能够恢复与其他成员的通信，它会收到一个包含被驱逐信息的视图。

组成员对这些情况的响应可以在过程中的多个点进行配置。默认情况下，如果怀疑成员失败，将发生以下行为：

- 在 MySQL 8.0.20 及之前版本中，当怀疑被创建时，它会立即超时。一旦过期怀疑被组识别，怀疑的成员立即面临驱逐的风险。成员在超时后可能还能生存几秒，因为检查过期怀疑是定期进行的。从 MySQL 8.0.21 开始，在怀疑超时并使怀疑成员面临驱逐之前增加了 5 秒的等待期。
- 如果被驱逐的成员恢复通信并意识到自己被驱逐，那么在 MySQL 8.0.20 及之前的版本中，它不会尝试重新加入组。从 MySQL 8.0.21 开始，它会自动尝试重新加入组三次（每次尝试间隔 5 分钟），如果自动重新加入程序不起作用，那么它就停止尝试重新加入组。
- 当被驱逐的成员不尝试重新加入组时，它会切换到超级只读模式并等待操作员处理。（MySQL 8.0.12 到 8.0.15 的版本例外，其中默认行为是让成员自行关闭。从 MySQL 8.0.16 开始，行为被更改为与 MySQL 5.7 中的行为相匹配。）

您可以使用本节中描述的组复制配置选项来更改这些行为，以适应您的系统需求和优先级。如果您经历了由于网络或机器较慢、意外短暂中断频繁的网络或计划中的网络中断而导致的不必要驱逐，可以考虑增加驱逐超时和自动重新加入尝试。从 MySQL 8.0.21 开始，默认设置已朝这个方向改变，以减少在这些情况下需要操作员干预重新安置被驱逐成

员的频率。请注意，在成员经历上述任何默认行为期间，尽管它不接受写操作，但如果成员仍与客户端通信，仍可以进行读取操作，随着时间的推移，陈旧读取的可能性越来越大。如果避免陈旧读取比避免操作员干预更为重要，可以考虑减少驱逐超时和自动重新加入尝试，或将它们设置为零。

由于网络分区，未失败的成员可能与复制组的部分成员（但不是全部）失去联系。例如，在一个由 5 台服务器（S1、S2、S3、S4、S5）组成的组中，如果（S1、S2）和（S3、S4、S5）之间发生断开，则存在网络分区。第一组（S1、S2）现在处于少数，因为它无法联系到超过一半的组成员。由少数组成员处理的任何事务都被阻塞，因为大多数组成员无法联系，因此该组无法达到仲裁。有关此场景的详细描述，请参见第 18.7.8 节，“处理网络分区和失去仲裁”。在这种情况下，默认行为是使少数和多数组成员都留在组中，继续接受事务（尽管它们在少数成员上被阻塞），并等待操作员干预。这种行为也是可以配置的。

请注意，如果组成员处于不支持相关设置的较旧的 MySQL 服务器版本，或处于具有不同默认值的版本，他们会根据上述默认行为对自己和其他组成员采取行动。例如，不支持 `group_replication_member_expel_timeout` 系统变量的成员在检测到过期的怀疑后立即将其他成员驱逐，即使其他成员支持该系统变量并设置了更长的超时时间，这种驱逐也会被其他成员接受。