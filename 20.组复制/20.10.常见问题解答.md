## 20.10 常见问题解答

本节提供了常见问题的答案。

**MySQL服务器组的最大数量是多少？**

一个组最多可以包含9个服务器。尝试将另一个服务器添加到已有9个成员的组中，将导致加入请求被拒绝。这个限制是通过测试和基准测试确定的，作为组在稳定的局域网上可靠运行的安全边界。

**组中的服务器如何连接？**

组中的服务器通过打开点对点的 TCP 连接来连接组中的其他服务器。这些连接仅用于组中服务器之间的内部通信和消息传递。此地址由 `group_replication_local_address` 变量配置。

**`group_replication_bootstrap_group` 选项用于什么？**

引导标志指示成员创建一个组并充当初始种子服务器。加入组的第二个成员需要请求引导组的成员动态更改配置，以便将其添加到组中。

在两种情况下需要成员引导组：当组最初创建时，或者当整个组关闭并重新启动时。

**如何为分布式恢复过程设置凭据？**

您可以使用 `CHANGE REPLICATION SOURCE TO` 语句（从 MySQL 8.0.23 开始）或 `CHANGE MASTER TO` 语句（在 MySQL 8.0.23 之前），将用户凭据永久性地设置为 `group_replication_recovery` 频道的凭据。或者，从 MySQL 8.0.21 开始，您可以在每次启动组复制时通过 `START GROUP_REPLICATION` 语句指定它们。

使用 `CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO` 设置的用户凭据存储在服务器上的复制元数据仓库中的明文中，但在 `START GROUP_REPLICATION` 上指定的用户凭据仅保存在内存中，并通过 `STOP GROUP_REPLICATION` 语句或服务器关闭被移除。因此，使用 `START GROUP_REPLICATION` 来指定用户凭据有助于保护组复制服务器免受未授权访问。然而，这种方法与通过 `group_replication_start_on_boot` 系统变量指定的自动启动组复制不兼容。有关详细信息，请参阅第 18.6.3.1 节，“分布式恢复的安全用户凭据”。

**我可以使用组复制来扩展我的写入负载吗？**

不直接，但 MySQL 组复制是一个共享无存储的完全复制解决方案，组中的所有服务器复制相同数量的数据。因此，如果组中一个成员作为事务提交操作的结果将 N 字节写入存储，则其他成员也将大约写入 N 字节到存储，因为事务到处复制。

然而，考虑到其他成员在应用更改时不需要做与原始成员在最初执行事务时相同的处理量，他们应用更改更快。事务以用于仅应用行转换的格式复制，无需再次执行事务（基于行的格式）。

此外，鉴于更改以基于行的格式传播和应用，这意味着它们以优化和紧凑的格式接收，并且可能比起始成员所需的 IO 操作数量减少。

总而言之，您可以通过在组中不同成员间传播无冲突的事务来扩展处理能力。并且您可能可以在小部分 IO 操作中实现扩展，因为远程服务器仅接收对稳定存储进行读-修改-写更改所需的更改。

**与简单复制相比，在相同工作负载下，组复制是否需要更多的网络带宽和 CPU？**

由于服务器需要不断相互交互以进行同步，因此预计会有一些额外负载。很难量化需要多少额外数据。这也取决于组的大小（三台服务器对带宽要求的压力小于组中的九台服务器）。

此外，内存和 CPU 占用率也更大，因为服务器同步部分和组消息传递所做的工作更复杂。

**我可以在广域网上部署组复制吗？**

可以，但每个成员之间的网络连接必须可靠并具有合适的性能。低延迟、高带宽的网络连接是实现最佳性能的要求。

如果仅网络带宽是问题，那么第 18.7.4 节，“消息压缩” 可用于降低所需带宽。然而，如果网络丢包，导致重新传输和更高的端到端延迟，吞吐量和延迟都会受到负面影响。

> **警告**
>
> 当任何组成员之间的网络往返时间（RTT）为 5 秒或更长时，您可能会遇到问题，因为内置的故障检测机制可能会被错误触发。

**成员在临时连接问题的情况下会自动重新加入组吗？**

这取决于连接问题的原因。如果连接问题是短暂的并且重新连接足够快以至于故障检测器没有意识到它，那么服务器可能不会从组中被移除。如果是“长时间”的连接问题，那么故障检测器最终会怀疑存在问题，并将服务器从组中移除。

从 MySQL 8.0 开始，有两个设置可用来增加成员保持在组中或重新加入组的机会：

`group_replication_member_expel_timeout` 增加了从产生怀疑（在最初的 5 秒检测期之后发生）到驱逐成员之间的时间。您可以设置最长 1 小时的等待时间。从 MySQL 8.0.21 开始，默认设置为 5 秒的等待时间。

`group_replication_autorejoin_tries` 使成员在驱逐或无法联系多数超时后尝试重新加入组。成员在五分钟间隔内进行指定次数的自动重新加入尝试。从 MySQL 8.0.21 开始，默认激活此功能，成员进行三次自动重新加入尝试。

如果服务器从组中被驱逐并且任何自动重新加入尝试都没有成功，您需要再次加入它。换句话说，服务器被明确从组中移除后，您需要手动重新加入它（或有脚本自动执行）。

**何时会将成员从组中排除？**

如果成员变得沉默，其他成员将其从组配置中移除。实际上，这可能发生在成员崩溃或存在网络断开时。

故障在给定超时时间内对于给定成员检测后被侦测到，并创建了一个不包含沉默成员的新配置。

**当一个节点明显落后时会发生什么？**

没有定义何时自动将成员从组中驱逐的策略方法。您需要找出为什么一个成员落后并解决问题，或从组中移除该成员。否则，如果服务器太慢以至于触发流控，则整个组也会放慢速度。流控可以根据您的需求进行配置。

**在组中怀疑存在问题时，是否有特定的成员负责触发重新配置？**

不，组中没有特定的成员负责触发重新配置。

任何成员都可以怀疑存在问题。所有成员需要（自动地）同意某个给定成员已失败。一个成员负责将其从组中驱逐，通过触发重新配置。哪个成员负责驱逐成员并不是您可以控制或设置的。

**我可以使用组复制进行分片吗？**

组复制旨在提供高可用的副本集；数据和写入在组中的每个成员上都有复制。要超出单个系统所能提供的规模，您需要围绕多个组复制集建立编排和分片框架，其中每个副本集维护和管理您总数据集的特定分片或分区。这种类型的设置通常称为“分片集群”，它允许您线性且无限制地扩展读写。

**我如何在 SELinux 中使用组复制？**

如果启用了 SELinux（可以使用 `sestatus -v` 验证），则需要启用组复制通信端口的使用。请参阅“设置组复制的 TCP 端口上下文”。

**我如何在 iptables 中使用组复制？**

如果启用了 iptables，则需要打开组复制端口，以便在机器之间进行通信。要查看每台机器上当前的规则，请执行 `iptables -L`。假设配置的端口是 33061，通过执行 `iptables -A INPUT -p tcp --dport 33061 -j ACCEPT` 启用必要端口上的通信。

**我如何恢复组成员使用的复制频道的中继日志？**

组复制使用的复制频道的行为与异步源到副本复制中使用的复制频道相同，因此依赖于中继日志。在更改 `relay_log` 变量的情况下，或者当该选项未设置并且主机名更改时，可能会出现错误。请参阅第 17.2.4.1 节，“中继日志”，了解这种情况下的恢复程序。或者，另一种专门针对组复制的解决方法是发出 `STOP GROUP_REPLICATION` 语句，然后发出 `START GROUP_REPLICATION` 语句重新启动实例。组复制插件再次创建 `group_replication_applier` 频道。

**为什么组复制使用两个绑定地址？**

组复制使用两个绑定地址是为了将 SQL 地址（客户端用来与成员通信）和 `group_replication_local_address`（组成员内部通信使用）之间的网络流量分开。例如，假设一台服务器有两个网络接口，分配给网络地址 203.0.113.1 和 198.51.100.179。在这种情况下，您可以使用 203.0.113.1:33061 作为内部组网络地址，通过设置 `group_replication_local_address=203.0.113.1:33061`。然后可以使用 198.51.100.179 作为 hostname 和 3306 作为端口。客户端 SQL 应用程序将连接到 198.51.100.179:3306 上的成员。这使您能够在不同网络上配置不同规则。类似地，内部组通信可以与客户端应用程序使用的网络连接分开，以提高安全性。

**组复制如何使用网络地址和主机名？**

组复制使用成员之间的网络连接，因此其功能直接受到您如何配置主机名和端口的影响。例如，组复制的分布式恢复过程使用服务器的主机名和端口创建与现有组成员的连接。当成员加入组时，它会接收到

组成员信息，使用在 `performance_schema.replication_group_members` 中列出的网络地址信息。表中列出的一个成员被选为从组中缺少的数据到加入成员的数据捐赠者。

这意味着您使用主机名配置的任何值，例如 SQL 网络地址或组种子地址，必须是完全合格的名称，并且每个组成员都能解析。例如，您可以通过 DNS、正确配置的 /etc/hosts 文件或其他本地过程来确保这一点。如果您想在服务器上配置 `MEMBER_HOST` 值，请在将其加入组之前使用 `--report-host` 选项指定它。

> **重要**
>
> 分配的值直接使用，不受 `skip_name_resolve` 系统变量的影响。

要在服务器上配置 `MEMBER_PORT`，请使用 `report_port` 系统变量指定。

**为什么服务器上的自增设置更改了？**

当在服务器上启动组复制时，`auto_increment_increment` 的值会更改为 `group_replication_auto_increment_increment` 的值，默认为 7，而 `auto_increment_offset` 的值会更改为服务器 ID。当组复制停止时，这些更改会还原。这些设置避免了组成员上的写操作选择重复的自增值，这会导致事务回滚。对于组复制，默认的自增值 7 表示了可用值数量和复制组允许的最大大小（9个成员）之间的平衡。

只有在 `auto_increment_increment` 和 `auto_increment_offset` 各自具有默认值 1 的情况下，这些更改才会进行和还原。如果它们的值已经从默认值修改，则组复制不会更改它们。从 MySQL 8.0 开始，当组复制处于单主模式时，系统变量也不会修改，在单主模式下，只有一个服务器进行写操作。

**我如何找到主节点？**

如果组以单主模式运行，了解哪个成员是主节点可能很有用。请参见第 18.1.3.1.2 节，“寻找主节点”。