## 10.3.3 空间索引优化

MySQL 允许在 `NOT NULL` 的几何值列上创建空间索引（参见[第 13.4.10 节, “创建空间索引”](#13.4.10-创建空间索引)）。优化器检查被索引列的 `SRID` 属性，以确定在比较时使用哪个空间参考系统（SRS），并使用适合该 SRS 的计算方法。（在 MySQL 8.0 之前，优化器使用笛卡尔计算进行空间索引值的比较；如果列包含非笛卡尔 SRID 的值，这些操作的结果是未定义的。）

为了使比较正常工作，空间索引中的每一列必须是 `SRID` 限制的。也就是说，列定义必须包含明确的 `SRID` 属性，并且所有列值必须具有相同的 `SRID`。

优化器仅考虑 `SRID` 限制的列上的空间索引：

- 限制为笛卡尔 `SRID` 的列上的索引启用笛卡尔边界框计算。
- 限制为地理 `SRID` 的列上的索引启用地理边界框计算。

优化器忽略没有 `SRID` 属性（因此不受 `SRID` 限制）的列上的空间索引。MySQL 仍然维护这些索引，如下所示：

- 它们会在表修改（`INSERT`、`UPDATE`、`DELETE` 等）时更新。即使列可能包含笛卡尔和地理值的混合，更新也会像索引是笛卡尔一样进行。
- 它们仅为了向后兼容而存在（例如，能够在 MySQL 5.7 中执行转储并在 MySQL 8.0 中恢复）。由于不受 `SRID` 限制的列上的空间索引对优化器没有用处，因此应修改每个这样的列：

  1. 验证列中的所有值是否具有相同的 `SRID`。要确定几何列 `col_name` 中包含的 `SRID`，使用以下查询：

     ```sql
     SELECT DISTINCT ST_SRID(col_name) FROM tbl_name;
     ```

     如果查询返回多行，则列包含混合的 `SRID`。在这种情况下，修改其内容，使所有值具有相同的 `SRID`。

  2. 重新定义该列以具有明确的 `SRID` 属性。

  3. 重新创建空间索引。