## 10.3.8 InnoDB 和 MyISAM 索引统计信息收集

存储引擎收集表的统计信息供优化器使用。表统计信息基于值组，其中值组是一组具有相同键前缀值的行。对于优化器来说，一个重要的统计信息是平均值组大小。

MySQL 以以下方式使用平均值组大小：

- 估算每次 `ref` 访问需要读取的行数。
- 估算部分连接产生的行数，即以下形式操作产生的行数：

  ```sql
  (...) JOIN tbl_name ON tbl_name.key = expr
  ```

随着索引的平均值组大小增加，该索引在这两种用途上变得不那么有用了，因为每次查找的平均行数增加了：为了使索引对优化目的有用，最好每个索引值针对表中的行数较少。当给定索引值产生大量行时，该索引不太有用，MySQL 也不太可能使用它。

平均值组大小与表基数相关，表基数是值组的数量。`SHOW INDEX` 语句显示的基数值基于 N/S，其中 N 是表中的行数，S 是平均值组大小。该比率产生表中值组的大致数量。

对于基于 `<=>` 比较运算符的连接，`NULL` 与任何其他值没有区别：`NULL <=> NULL`，就像 `N <=> N` 对任何其他 N 一样。

然而，对于基于 `=` 运算符的连接，`NULL` 与非 `NULL` 值不同：当 `expr1` 或 `expr2`（或两者）为 `NULL` 时，`expr1 = expr2` 不为真。这会影响比较形式为 `tbl_name.key = expr` 的 `ref` 访问：如果当前值 `expr` 为 `NULL`，MySQL 不会访问表，因为比较不能为真。

对于 `=` 比较，无论表中有多少 `NULL` 值都无关紧要。对于优化目的，相关值是非 `NULL` 值组的平均大小。然而，MySQL 目前不允许收集或使用该平均大小。

对于 `InnoDB` 和 `MyISAM` 表，可以通过分别使用 `innodb_stats_method` 和 `myisam_stats_method` 系统变量对表统计信息的收集进行一些控制。这些变量有三个可能的值，不同之处如下：

- 当变量设置为 `nulls_equal` 时，所有 `NULL` 值被视为相同（即它们都形成一个值组）。

  如果 `NULL` 值组大小远高于平均非 `NULL` 值组大小，则此方法会将平均值组大小向上偏斜。这使得索引对优化器来说显得不如实际上在查找非 `NULL` 值时有用。因此，`nulls_equal` 方法可能导致优化器在应使用索引时不使用索引进行 `ref` 访问。

- 当变量设置为 `nulls_unequal` 时，`NULL` 值不被视为相同。相反，每个 `NULL` 值形成一个大小为 1 的单独值组。

  如果有很多 `NULL` 值，此方法会将平均值组大小向下偏斜。如果平均非 `NULL` 值组大小较大，则每个 `NULL` 值都计为大小为 1 的组，会导致优化器高估索引在查找非 `NULL` 值时的价值。因此，`nulls_unequal` 方法可能导致优化器在其他方法更好的情况下使用该索引进行 `ref` 查找。

- 当变量设置为 `nulls_ignored` 时，忽略 `NULL` 值。

  如果您倾向于使用很多使用 `<=>` 而不是 `=` 的连接，`NULL` 值在比较中并不特殊，一个 `NULL` 等于另一个 `NULL`。在这种情况下，`nulls_equal` 是合适的统计方法。

`innodb_stats_method` 系统变量具有全局值；`myisam_stats_method` 系统变量具有全局和会话值。设置全局值会影响相应存储引擎表的统计信息收集。设置会话值只影响当前客户端连接的统计信息收集。这意味着您可以通过设置 `myisam_stats_method` 的会话值强制表的统计信息使用特定方法重新生成，而不影响其他客户端。

要重新生成 `MyISAM` 表统计信息，可以使用以下任一方法：

- 执行 `myisamchk --stats_method=method_name --analyze`
- 更改表以使其统计信息过期（例如，插入一行然后删除它），然后设置 `myisam_stats_method` 并发出 `ANALYZE TABLE` 语句

有关使用 `innodb_stats_method` 和 `myisam_stats_method` 的一些注意事项：

- 您可以按上述方式强制显式收集表统计信息。然而，MySQL 也可能自动收集统计信息。例如，如果在执行表的语句过程中，有些语句修改了表，MySQL 可能会收集统计信息（例如，批量插入或删除，或一些 `ALTER TABLE` 语句）。如果发生这种情况，统计信息会使用当时的 `innodb_stats_method` 或 `myisam_stats_method` 值进行收集。因此，如果使用一种方法收集统计信息，但在表的统计信息稍后自动收集时系统变量设置为另一种方法，则会使用另一种方法。

- 无法确定生成特定表的统计信息所使用的方法。

这些变量仅适用于 `InnoDB` 和 `MyISAM` 表。其他存储引擎只有一种方法收集表统计信息。通常它更接近 `nulls_equal` 方法。