### 10.11.5 外部锁定

外部锁定是使用文件系统锁定来管理多个进程对 `MyISAM` 数据库表的争用。在单个进程（如 MySQL 服务器）不能被假定为唯一需要访问表的进程的情况下，使用外部锁定。以下是一些示例：

- 如果运行多个使用相同数据库目录的服务器（不推荐），则每个服务器必须启用外部锁定。
- 如果使用 `myisamchk` 对 `MyISAM` 表执行表维护操作，必须确保服务器未运行，或服务器已启用外部锁定，以便根据需要锁定表文件以与 `myisamchk` 协调访问表。对 `myisampack` 打包 `MyISAM` 表也是如此。
- 如果服务器在启用外部锁定的情况下运行，可以随时使用 `myisamchk` 进行如检查表这样的读取操作。在这种情况下，如果服务器尝试更新 `myisamchk` 正在使用的表，服务器会等待 `myisamchk` 完成后再继续。
- 如果使用 `myisamchk` 进行写操作（如修复或优化表），或使用 `myisampack` 打包表，必须始终确保 `mysqld` 服务器不使用该表。如果不停止 `mysqld`，至少在运行 `myisamchk` 之前执行 `mysqladmin flush-tables`。如果服务器和 `myisamchk` 同时访问表，表可能会损坏。

启用外部锁定后，每个需要访问表的进程在访问表之前都会为表文件获取一个文件系统锁。如果无法获取所有必要的锁，进程将被阻止访问表，直到可以获得锁（在当前持有锁的进程释放它们之后）。

外部锁定会影响服务器性能，因为服务器有时必须等待其他进程才能访问表。

如果运行单个服务器来访问给定的数据目录（通常情况），并且没有其他程序（如 `myisamchk`）在服务器运行时需要修改表，则无需外部锁定。如果只使用其他程序读取表，则不需要外部锁定，尽管如果服务器在 `myisamchk` 读取表时更改了表，`myisamchk` 可能会报告警告。

禁用外部锁定的情况下，使用 `myisamchk` 时，必须在 `myisamchk` 执行期间停止服务器，或者在运行 `myisamchk` 之前锁定并刷新表。为避免此要求，使用 `CHECK TABLE` 和 `REPAIR TABLE` 语句来检查和修复 `MyISAM` 表。

对于 `mysqld`，外部锁定由 `skip_external_locking` 系统变量的值控制。启用该变量时，禁用外部锁定，反之亦然。默认情况下，外部锁定是禁用的。

可以通过在服务器启动时使用 `--external-locking` 或 `--skip-external-locking` 选项来控制外部锁定的使用。

如果使用外部锁定选项以启用来自多个 MySQL 进程对 `MyISAM` 表的更新，请勿在服务器启动时将 `delay_key_write` 系统变量设置为 `ALL` 或对任何共享表使用 `DELAY_KEY_WRITE=1` 表选项。否则，可能会发生索引损坏。

满足此条件的最简单方法是始终将 `--external-locking` 与 `--delay-key-write=OFF` 一起使用。（默认情况下不这样做是因为在许多设置中，使用上述选项的混合是有用的。）