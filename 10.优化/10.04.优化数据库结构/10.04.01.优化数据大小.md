### 10.4.1 优化数据大小

设计表格时应尽量减少其在磁盘上的空间。这可以通过减少读写磁盘的数据量带来巨大的改进。较小的表通常在查询执行过程中需要较少的主内存来处理其内容。减少表数据的空间也会导致索引变小，从而加快处理速度。

MySQL 支持多种不同的存储引擎（表类型）和行格式。对于每个表，您可以决定使用哪种存储和索引方法。为您的应用程序选择合适的表格格式可以带来显著的性能提升。请参阅第17章《InnoDB存储引擎》和第18章《替代存储引擎》。

您可以通过以下技巧来提高表的性能并最小化存储空间：

表列

#### 表列

使用最有效（最小）的数据类型。MySQL 有许多节省磁盘空间和内存的专用类型。例如，使用较小的整数类型可以得到较小的表。`MEDIUMINT` 通常比 `INT` 更好，因为 `MEDIUMINT` 列使用的空间少25%。

尽可能将列声明为 `NOT NULL`。这可以加快 SQL 操作，通过更好地利用索引并消除每个值是否为 `NULL` 的测试开销，还可以节省一些存储空间，每列节省一位。如果确实需要在表中使用 `NULL` 值，请使用它们。只需避免默认设置允许每列为 `NULL` 的情况。

#### 行格式

InnoDB 表默认使用 `DYNAMIC` 行格式。要使用其他行格式，可以配置 `innodb_default_row_format`，或在 `CREATE TABLE` 或 `ALTER TABLE` 语句中明确指定 `ROW_FORMAT` 选项。

紧凑型行格式系列（包括 `COMPACT`、`DYNAMIC` 和 `COMPRESSED`）通过增加某些操作的 CPU 使用量来减少行存储空间。如果您的工作负载主要受缓存命中率和磁盘速度限制，则可能更快。如果受 CPU 速度限制，则可能会变慢。

紧凑型行格式系列在使用可变长度字符集（如 `utf8mb3` 或 `utf8mb4`）时也优化了 `CHAR` 列的存储。使用 `ROW_FORMAT=REDUNDANT` 时，`CHAR(N)` 占用的空间为 N × 字符集的最大字节长度。许多语言可以主要使用单字节 `utf8mb3` 或 `utf8mb4` 字符书写，因此固定存储长度通常会浪费空间。使用紧凑型行格式系列，InnoDB 为这些列分配的存储空间在 N 到 N × 字符集的最大字节长度之间，通过剥离尾随空格来实现。最小存储长度为 N 字节，以便在典型情况下进行就地更新。有关更多信息，请参阅第17.10节《InnoDB行格式》。

要通过以压缩形式存储表数据进一步减少空间，在创建 InnoDB 表时指定 `ROW_FORMAT=COMPRESSED`，或对现有 MyISAM 表运行 `myisampack` 命令。（InnoDB 压缩表是可读写的，而 MyISAM 压缩表是只读的。）

对于 MyISAM 表，如果没有可变长度列（`VARCHAR`、`TEXT` 或 `BLOB` 列），则使用固定大小的行格式。这更快，但可能会浪费一些空间。请参阅第18.2.3节《MyISAM表存储格式》。即使有 `VARCHAR` 列，您也可以通过 `CREATE TABLE` 选项 `ROW_FORMAT=FIXED` 提示希望使用固定长度行。

#### 索引

表的主索引应尽可能短。这样可以使每行的识别变得简单高效。对于 InnoDB 表，主键列会在每个次级索引条目中重复，因此如果有许多次级索引，短主键可以节省大量空间。

只创建需要的索引以提高查询性能。索引有助于检索，但会减慢插入和更新操作。如果主要通过在多列上搜索来访问表，请为这些列创建单个复合索引，而不是为每个列创建单独的索引。索引的第一部分应为使用最频繁的列。如果选择表时总是使用许多列，索引中的第一列应为重复最多的列，以获得更好的索引压缩。

如果长字符串列的前几个字符有唯一前缀，最好只索引此前缀，使用 MySQL 支持在列的最左部分创建索引（参见第15.1.15节《CREATE INDEX 语句》）。较短的索引更快，不仅因为它们占用的磁盘空间更少，还因为它们在索引缓存中的命中更多，从而减少磁盘查找。参见第7.1.1节《配置服务器》。

#### 连接

在某些情况下，拆分频繁扫描的表可能是有益的。这尤其适用于动态格式表，如果可以使用较小的静态格式表来查找扫描表时的相关行。

在不同表中使用相同的数据类型声明具有相同信息的列，以加快基于相应列的连接。

保持列名简单，以便在不同表中使用相同的名称并简化连接查询。例如，在名为 `customer` 的表中，使用 `name` 作为列名，而不是 `customer_name`。为了使名称可以移植到其他 SQL 服务器，考虑将其保持在18个字符以内。

#### 规范化

通常，尝试保持所有数据非冗余（遵循数据库理论中的第三范式）。不要重复冗长的值（如名称和地址），而是为它们分配唯一 ID，根据需要在多个较小的表中重复这些 ID，并通过在连接子句中引用 ID 来连接表。

如果速度比磁盘空间和维护多个数据副本的成本更重要，例如在商业智能场景中分析来自大型表的所有数据时，您可以放宽规范化规则，重复信息或创建汇总表以获得更高的速度。