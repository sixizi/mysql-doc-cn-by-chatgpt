## 10.5.4 优化 InnoDB 重做日志记录

请考虑以下优化重做日志记录的指南：

- **增大重做日志文件的大小**：当 InnoDB 写满重做日志文件时，它必须在检查点将缓冲池中的修改内容写入磁盘。小的重做日志文件会导致许多不必要的磁盘写入。

  从 MySQL 8.0.30 开始，重做日志文件的大小由 `innodb_redo_log_capacity` 设置决定。InnoDB 尝试保持 32 个相同大小的重做日志文件，每个文件的大小等于 `1/32 * innodb_redo_log_capacity`。因此，更改 `innodb_redo_log_capacity` 设置会更改重做日志文件的大小。

  在 MySQL 8.0.30 之前，重做日志文件的大小和数量通过 `innodb_log_file_size` 和 `innodb_log_files_in_group` 变量进行配置。

  有关修改重做日志文件配置的信息，请参见第 17.6.5 节，“`Redo Log`”。

- **增加日志缓冲区的大小**：大的日志缓冲区允许大事务在提交前运行，而不需要将日志写入磁盘。因此，如果您有更新、插入或删除许多行的事务，增大日志缓冲区可以节省磁盘 I/O。日志缓冲区大小由 `innodb_log_buffer_size` 配置选项配置，该选项在 MySQL 8.0 中可以动态配置。

- **配置 `innodb_log_write_ahead_size` 以避免“读写冲突”**：此选项定义了重做日志的预写块大小。将 `innodb_log_write_ahead_size` 设置为与操作系统或文件系统缓存块大小匹配。当重做日志块没有完全缓存到操作系统或文件系统时，由于预写块大小与操作系统或文件系统缓存块大小不匹配，会发生读写冲突。

  `innodb_log_write_ahead_size` 的有效值是 InnoDB 日志文件块大小的倍数（2 的 n 次方）。最小值是 InnoDB 日志文件块大小（512）。当指定最小值时，不会发生预写。最大值等于 `innodb_page_size` 值。如果指定的 `innodb_log_write_ahead_size` 值大于 `innodb_page_size` 值，则 `innodb_log_write_ahead_size` 设置会被截断为 `innodb_page_size` 值。

  将 `innodb_log_write_ahead_size` 值设置得太低相对于操作系统或文件系统缓存块大小会导致读写冲突。将值设置得太高可能会对日志文件写入的 `fsync` 性能产生轻微影响，因为一次会写入多个块。

- **专用日志写入线程**：MySQL 8.0.11 引入了专用日志写入线程，用于将重做日志记录从日志缓冲区写入系统缓冲区并将系统缓冲区刷新到重做日志文件中。之前，单个用户线程负责这些任务。从 MySQL 8.0.22 开始，您可以使用 `innodb_log_writer_threads` 变量启用或禁用日志写入线程。专用日志写入线程可以提高高并发系统的性能，但对于低并发系统，禁用专用日志写入线程可以提供更好的性能。

- **优化等待刷新重做的用户线程的旋转延迟**：旋转延迟有助于减少延迟。在低并发期间，减少延迟可能不是优先事项，避免在这些期间使用旋转延迟可能会减少能耗。在高并发期间，您可能希望避免在旋转延迟上消耗处理能力，以便将其用于其他工作。以下系统变量允许设置高水位和低水位值，定义旋转延迟的使用范围。

  - `innodb_log_wait_for_flush_spin_hwm`：定义用户线程在等待刷新重做时不再旋转的最大平均日志刷新时间。默认值为400微秒。
  - `innodb_log_spin_cpu_abs_lwm`：定义用户线程在等待刷新重做时不再旋转的最小 CPU 使用量。该值以 CPU 核心使用量的总和表示。例如，默认值 80 是单个 CPU 核心的 80% 使用量。在多核处理器的系统上，值 150 表示一个 CPU 核心的 100% 使用量加上第二个 CPU 核心的 50% 使用量。
  - `innodb_log_spin_cpu_pct_hwm`：定义用户线程在等待刷新重做时不再旋转的最大 CPU 使用量。该值以所有 CPU 核心的总处理能力的百分比表示。默认值为 50%。例如，在具有四个 CPU 核心的服务器上，两个 CPU 核心的 100% 使用量是总 CPU 处理能力的 50%。

  `innodb_log_spin_cpu_pct_hwm` 配置选项遵循处理器关联。例如，如果服务器有 48 个核心，但 `mysqld` 进程仅固定到四个 CPU 核心，其他 44 个 CPU 核心将被忽略。