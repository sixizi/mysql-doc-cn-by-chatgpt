10.2.1.11 多范围读取优化

在辅助索引上使用范围扫描读取行时，如果表很大且未存储在存储引擎的缓存中，可能会导致对基表的多次随机磁盘访问。通过磁盘扫描多范围读取（MRR）优化，MySQL尝试通过首先仅扫描索引并收集相关行的键来减少范围扫描的随机磁盘访问次数。然后对键进行排序，最后按照主键的顺序从基表中检索行。磁盘扫描MRR的动机是减少随机磁盘访问次数，而是实现基表数据的更顺序扫描。

多范围读取优化提供以下好处：

MRR使得数据行可以根据索引元组顺序访问，而不是随机顺序。服务器获取满足查询条件的一组索引元组，根据数据行 ID 顺序对它们进行排序，并使用排序后的元组顺序检索数据行。这使数据访问更加高效和低成本。

MRR支持批量处理密钥访问请求，用于需要通过索引元组访问数据行的操作，如范围索引扫描和使用索引的等值连接属性的等值连接。MRR遍历一系列索引范围以获得符合条件的索引元组。随着这些结果的积累，它们被用来访问相应的数据行。在开始读取数据行之前，不需要获取所有索引元组。

MRR优化不支持在虚拟生成列上创建的辅助索引。InnoDB支持在虚拟生成列上的辅助索引。

以下情景说明了何时MRR优化可能具有优势：

情景 A：MRR可用于InnoDB和MyISAM表的索引范围扫描和等值连接操作。

- 索引元组的一部分在缓冲区中累积。
- 缓冲区中的元组按其数据行 ID 排序。
- 根据排序的索引元组序列访问数据行。

情景 B：MRR可用于NDB表的多范围索引扫描或执行按属性的等值连接。

- 在提交查询的中心节点上，可能的单键范围的一部分在缓冲区中累积。
- 范围被发送到访问数据行的执行节点。
- 访问的行被打包成包并发送回中心节点。
- 接收到的包含数据行的包放置在缓冲区中。
- 从缓冲区读取数据行。

当使用MRR时，`EXPLAIN`输出中的`Extra`列会显示`Using MRR`。

如果不需要访问完整的表行来产生查询结果，InnoDB和MyISAM不使用MRR。这种情况是如果结果可以完全基于索引元组中的信息生成（通过覆盖索引）；MRR无益处。

两个`optimizer_switch`系统变量标志提供了使用MRR优化的接口。`mrr`标志控制是否启用MRR。如果启用了`mrr`（开），则`mrr_cost_based`标志控制优化器是尝试在使用和不使用MRR之间做出基于成本的选择（开），还是尽可能使用MRR（关）。默认情况下，`mrr`为开，`mrr_cost_based`也为开。参见第10.9.2节，“可切换的优化”。

对于MRR，存储引擎使用`read_rnd_buffer_size`

系统变量的值作为其可以为缓冲区分配多少内存的指南。引擎使用高达`read_rnd_buffer_size`字节，并确定单次处理的范围数量。