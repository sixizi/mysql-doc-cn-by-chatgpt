10.2.1.20 函数调用优化

MySQL内部将函数标记为确定性（deterministic）或非确定性（nondeterministic）。如果给定固定值的参数，函数可以在不同调用中返回不同结果，则该函数为非确定性函数。非确定性函数的例子包括：RAND()、UUID()。

如果函数被标记为非确定性，在WHERE子句中对它的引用需要在每一行（当从一个表选择时）或每种行的组合（当从多表连接选择时）上评估。

MySQL还根据参数的类型来决定何时评估函数，无论参数是表列还是常量值。需要每当该列值发生变化时就评估以表列作为参数的确定性函数。

非确定性函数可能影响查询性能。例如，某些优化可能无法使用，或者可能需要更多的锁定。下面的讨论使用RAND()，但也适用于其他非确定性函数。

假设有一个表t定义如下：

```sql
CREATE TABLE t (id INT NOT NULL PRIMARY KEY, col_a VARCHAR(100));
```

考虑以下两个查询：

```sql
SELECT * FROM t WHERE id = POW(1,2);
SELECT * FROM t WHERE id = FLOOR(1 + RAND() * 49);
```

这两个查询看起来都是因为与主键的等值比较而使用主键查找，但实际上只有第一个查询是这样：

第一个查询总是产生最多一行，因为带有常数参数的POW()是一个常数值，并用于索引查找。

第二个查询包含一个使用非确定性函数RAND()的表达式，该函数在查询中不是常数，实际上对表t的每一行都有一个新值。因此，该查询读取表的每一行，评估每一行的谓词，并输出主键匹配随机值的所有行。这可能是零行、一行或多行，这取决于id列的值和RAND()序列中的值。

非确定性的影响不限于SELECT语句。