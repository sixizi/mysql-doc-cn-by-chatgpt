#### 10.2.1.12 块嵌套循环和批量关键访问连接

在 MySQL 中，批量关键访问（BKA）连接算法利用索引访问连接表和连接缓冲区。BKA算法支持内连接、外连接和半连接操作，包括嵌套外连接。BKA的好处包括由于更高效的表扫描而改善的连接性能。此外，之前仅用于内连接的块嵌套循环（BNL）连接算法已扩展，现在也可用于外连接和半连接操作，包括嵌套外连接。

以下部分讨论了连接缓冲区管理，这是原始BNL算法的扩展、扩展的BNL算法和BKA算法的基础。有关半连接策略的信息，请参见第10.2.2.1节，“使用半连接转换优化IN和EXISTS子查询谓词”。

##### 块嵌套循环和批量关键访问算法的连接缓冲区管理

- 块嵌套循环算法用于外连接和半连接
- 批量关键访问连接
- 块嵌套循环和批量关键访问算法的优化器提示

##### 块嵌套循环和批量关键访问算法的连接缓冲区管理

MySQL不仅可以使用连接缓冲区执行无需索引访问内表的内连接，还可以执行子查询扁平化后的外连接和半连接。此外，当内表有索引访问时，也可以有效使用连接缓冲区。

连接缓冲区管理代码在存储感兴趣行列的值时更有效地利用连接缓冲区空间：如果行列的值为NULL，则不在缓冲区中为该行列分配额外的字节，并且为VARCHAR类型的任何值分配最少数量的字节。

代码支持两种类型的缓冲区，常规和增量。假设使用连接缓冲区B1连接表t1和t2，然后使用连接缓冲区B2与表t3连接此操作的结果：

- 常规连接缓冲区包含每个连接操作数的列。如果B2是常规连接缓冲区，则放入B2的每行r由来自B1的行r1的列和与表t3的匹配行r2的感兴趣列组成。
- 增量连接缓冲区仅包含由第二个连接操作数生成的表的行的列。也就是说，它是对第一个操作数缓冲区中的行的增量。如果B2是增量连接缓冲区，它包含行r2的感兴趣列以及与来自B1的行r1的链接。

增量连接缓冲区始终是相对于较早连接操作的连接缓冲区的增量，因此第一个连接操作的缓冲区始终是常规缓冲区。在刚给出的示例中，用于连接表t1和t2的缓冲区B1必须是常规缓冲区。

用于连接操作的增量缓冲区中的每行仅包含要连接的表的行的感兴趣列。这些列通过对第一个连接操作数生成的表的匹配行的感兴趣列的引用进行扩展。增量缓冲区中的几行可以引用存储在前一个连接缓冲区中的相同行r的列，只要所有这些行都与行r匹配。

增量缓冲区使得来自用于之前连接操作的缓冲区的列的复制更少发生。这节省了缓冲区空间，因为一般情况下，由第一个连接操作数产生的行可以由第二个连接操作数产生的几行匹配。没有必要制作第一个操作数的行的几个副本。增量缓冲区还由于减少了复制时间而节省了处理时间。

在MySQL 8.0中，`optimizer_switch`系统变量的`block_nested_loop`标志的工作方式如下：

- 在MySQL 8.0.20之前，它控制优化器如何使用块嵌套循环连接算法。
- 从MySQL 8.0.18开始，它还控制哈希连接的使用（见第10.2.1.4节，“哈希连接优化”）。
- 从MySQL 8.0.20开始，该标志仅控制哈希连接，块嵌套循环算法不再受支持。

`batched_key_access`标志控制优化器如何使用批量关键访问连接算法。

默认情况下，`block_nested_loop`开启，`batched_key_access`关闭。参见第10.9.2节，“可切换的优化”。也可以应用优化器提示；见块嵌套循环和批量关键访问算法的优化器提示。

有关半连接策略的信息，请参见第10.2.2.1节，“使用半连接转换优化IN和EXISTS子查询谓词”。

##### 批量关键访问连接

MySQL实现了一种称为批量关键访问（BKA）连接算法的表连接方法。当第二个连接操作数产生的表有索引访问时，可以应用BKA。与BNL连接算法一样，BKA连接算法使用连接缓冲区积累连接操作的第一个操作数产生的行的感兴趣列。然后，BKA算法为缓冲区中所有行的要连接的表构建键，并将这些键作为一批提交给数据库引擎进行索引查找。键通过多范围读取（MRR）接口提交给引擎（见第10.2.1.11节，“多范围读取优化”）。提交键后，MRR引擎功能以最佳方式执行索引查找，获取由这些键找到的已连接表的行，并开始向BKA连接算法提供匹配的行。每个匹配的行都与连接缓冲区中的行的引用相关联。

当使用BKA时，`join_buffer_size`的值定义了每次请求到存储引擎的键的批量大小。缓冲区越大，对连接操作的右表的顺序访问就越多，这可以显著提高性能。

要使用BKA，`optimizer_switch`系统变量的`batched_key_access`标志必须设置为开启。BKA使用MRR，因此`mrr`标志也必须开启。当前，MRR的成本估算过于悲观。因此，还需要将`mrr_cost_based`设置为关闭才能使用BKA。以下设置启用BKA：

```sql
mysql> SET optimizer_switch='mrr=on,mrr_cost_based=off,batched_key_access=on';
```

MRR功能有两种执行场景：

- 第一种场景用于常规磁盘存储引擎，例如InnoDB和MyISAM。对于这些引擎，通常将连接缓冲区中所有行的键一次提交给MRR接口。引擎特定的MRR功能执行提交键的索引查找，从中获取行 ID（或主键），然后按请求一一获取这些选定行 ID 的行。每行都返回一个关联引用，使得可以访问连接缓冲区中的匹配行。MRR函数以最优方式获取行：按行 ID（主键）顺序获取。这改善了性能，因为读取是按磁盘顺序而不是随机顺序进行的。

- 第二种场景用于远程存储引擎，如NDB。MySQL Server（SQL节点）将一部分行的键和它们的关联打包发送到MySQL Cluster数据节点。作为回报，SQL节点接收一个（或几个）匹配行的包，这些行与相应的关联捆绑在一起。BKA连接算法接收这些行并构建新的连接行。然后将一组新的键发送到数据节点，返回包中的行被用来构建新的连接行。这一过程持续到连接缓冲区中的最后一个键被发送到数据节点，SQL节点已接收并连接了与这些键匹配的所有行。这提高了性能，因为SQL节点发送给数据节点的带键包更少意味着执行连接操作时它与数据节点之间的往返次数更少。