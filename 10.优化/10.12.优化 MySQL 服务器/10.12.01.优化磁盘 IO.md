### 10.12.1 优化磁盘 I/O

本节描述了在可以为数据库服务器提供更多和更快存储硬件时如何配置存储设备。有关优化 InnoDB 配置以提高 I/O 性能的信息，请参阅 [第 10.5.8 节 “优化 InnoDB 磁盘 I/O”](#10.5.8-优化-InnoDB-磁盘-IO)。

磁盘寻道是一个巨大的性能瓶颈。当数据量变得如此之大以至于有效缓存变得不可能时，这个问题变得更加明显。对于需要随机访问数据的大型数据库，可以确定的是读取数据至少需要一次磁盘寻道，写入数据则需要几次磁盘寻道。为了尽量减少这个问题，使用低寻道时间的磁盘。

通过符号链接文件到不同的磁盘或条带化磁盘，可以增加可用磁盘主轴的数量（从而减少寻道开销）：

#### 使用符号链接

对于 MyISAM 表，这意味着将索引文件和数据文件从数据目录中的常规位置符号链接到另一个磁盘（该磁盘也可以是条带化的）。假设该磁盘未用于其他用途，这样可以改善寻道和读取时间。参见 [第 10.12.2 节 “使用符号链接”](#10.12.2-使用符号链接)。

符号链接不支持 InnoDB 表。但是，可以将 InnoDB 数据文件和日志文件放在不同的物理磁盘上。有关详细信息，请参阅 [第 10.5.8 节 “优化 InnoDB 磁盘 I/O”](#10.5.8-优化-InnoDB-磁盘-IO)。

#### 条带化

条带化意味着你有许多磁盘，第一个块放在第一块磁盘上，第二个块放在第二块磁盘上，第 N 个块放在 (N MOD 磁盘数) 的磁盘上，以此类推。这意味着如果你的正常数据大小小于条带大小（或完全对齐），你会获得更好的性能。条带化非常依赖于操作系统和条带大小，因此需要用不同的条带大小对应用程序进行基准测试。参见 [第 10.13.2 节 “使用自己的基准测试”](#10.13.2-使用自己的基准测试)。

条带化的速度差异非常依赖于参数。根据你设置条带化参数和磁盘数量的不同，可能会产生数量级的差异。你需要选择优化随机访问还是顺序访问。

为了可靠性，你可能希望使用 RAID 0+1（条带化加镜像），但在这种情况下，你需要 2 × N 个驱动器来存储 N 个驱动器的数据。如果你有足够的资金，这是最佳选择。然而，你可能还需要投资一些卷管理软件以高效处理。

一个好的选择是根据数据类型的重要性来变更 RAID 级别。例如，将可以再生成的次要数据存储在 RAID 0 磁盘上，但将非常重要的数据如主机信息和日志存储在 RAID 0+1 或 RAID N 磁盘上。如果有大量写操作，RAID N 可能会是个问题，因为更新奇偶校验位需要时间。

你还可以设置数据库使用的文件系统的参数：

如果你不需要知道文件的最后访问时间（在数据库服务器上这并不真的有用），你可以使用 `-o noatime` 选项挂载文件系统。这会跳过更新文件系统中 inode 的最后访问时间，从而避免一些磁盘寻道。

在许多操作系统上，你可以通过使用 `-o async` 选项挂载文件系统来设置其异步更新。如果你的计算机相对稳定，这应该会在不牺牲太多可靠性的情况下提供更好的性能。（在 Linux 上，此标志默认开启。）

#### 使用 NFS 和 MySQL

在考虑是否使用 NFS 和 MySQL 时应谨慎。潜在的问题因操作系统和 NFS 版本而异，包括以下几点：

- 放置在 NFS 卷上的 MySQL 数据和日志文件可能会被锁定而无法使用。如果多个 MySQL 实例访问同一个数据目录，或者 MySQL 因电源故障等原因不正常关闭，可能会发生锁定问题。NFS 版本 4 通过引入建议性和基于租约的锁定解决了潜在的锁定问题。然而，不推荐在 MySQL 实例之间共享数据目录。
- 由于消息接收顺序错误或网络流量丢失而引入的数据不一致。为避免此问题，请使用带有硬挂载和内部挂载选项的 TCP。
- 最大文件大小限制。NFS 版本 2 客户端只能访问文件的最低 2GB（有符号 32 位偏移）。NFS 版本 3 客户端支持更大的文件（最多 64 位偏移）。最大支持的文件大小还取决于 NFS 服务器的本地文件系统。

在专业 SAN 环境或其他存储系统中使用 NFS 往往比在这种环境外使用 NFS 更可靠。然而，在 SAN 环境中的 NFS 可能比直接附加或总线附加的非旋转存储慢。

如果选择使用 NFS，建议使用 NFS 版本 4 或更高版本，并在部署到生产环境之前彻底测试你的 NFS 设置。