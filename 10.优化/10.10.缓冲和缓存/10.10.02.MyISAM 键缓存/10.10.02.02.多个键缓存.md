### 10.10.2.2 多个键缓存

> 注意
> 从 MySQL 8.0 开始，这里讨论的用于引用多个 MyISAM 键缓存的复合部分结构变量语法已弃用。

共享对键缓存的访问提高了性能，但不能完全消除会话之间的争用。会话仍然会争夺管理键缓存缓冲区访问的控制结构。为了进一步减少键缓存访问争用，MySQL 还提供了多个键缓存功能。此功能使您能够将不同表的索引分配给不同的键缓存。

当存在多个键缓存时，服务器必须知道在处理给定 MyISAM 表的查询时使用哪个缓存。默认情况下，所有 MyISAM 表索引都缓存到默认键缓存中。要将表索引分配给特定的键缓存，可以使用 `CACHE INDEX` 语句（请参见[第 15.7.8.2 节，“CACHE INDEX 语句”](#)）。例如，以下语句将表 t1、t2 和 t3 的索引分配给名为 `hot_cache` 的键缓存：

```sql
mysql> CACHE INDEX t1, t2, t3 IN hot_cache;
+---------+--------------------+----------+----------+
| Table   | Op                 | Msg_type | Msg_text |
+---------+--------------------+----------+----------+
| test.t1 | assign_to_keycache | status   | OK       |
| test.t2 | assign_to_keycache | status   | OK       |
| test.t3 | assign_to_keycache | status   | OK       |
+---------+--------------------+----------+----------+
```

可以通过设置其大小的 `SET GLOBAL` 参数设置语句或使用服务器启动选项来创建 `CACHE INDEX` 语句中引用的键缓存。例如：

```sql
mysql> SET GLOBAL keycache1.key_buffer_size=128*1024;
```

要销毁键缓存，将其大小设置为零：

```sql
mysql> SET GLOBAL keycache1.key_buffer_size=0;
```

您不能销毁默认键缓存。任何试图这样做的操作都将被忽略：

```sql
mysql> SET GLOBAL key_buffer_size = 0;

mysql> SHOW VARIABLES LIKE 'key_buffer_size';
+-----------------+---------+
| Variable_name   | Value   |
+-----------------+---------+
| key_buffer_size | 8384512 |
+-----------------+---------+
```

键缓存变量是具有名称和组件的结构化系统变量。对于 `keycache1.key_buffer_size`，`keycache1` 是缓存变量名，`key_buffer_size` 是缓存组件。有关引用结构化键缓存系统变量的语法说明，请参见[第 7.1.9.5 节，“结构化系统变量”](#)。

默认情况下，表索引分配给服务器启动时创建的主（默认）键缓存。当键缓存被销毁时，所有分配给它的索引将重新分配给默认键缓存。

对于繁忙的服务器，您可以使用以下策略涉及三个键缓存：

- 一个“热”键缓存，占所有键缓存分配空间的 20%。用于频繁搜索但不更新的表。
- 一个“冷”键缓存，占所有键缓存分配空间的 20%。用于中等大小、密集修改的表，例如临时表。
- 一个“温”键缓存，占键缓存空间的 60%。用作默认键缓存，默认情况下用于所有其他表。

使用三个键缓存的好处之一是访问一个键缓存结构不会阻止访问其他缓存。访问分配给一个缓存的表的语句不会与访问分配给另一个缓存的表的语句竞争。性能提升还由于其他原因：

- 热缓存仅用于检索查询，因此其内容从不修改。因此，每当需要从磁盘中拉入索引块时，选择替换的缓存块的内容无需先刷新。
- 对于分配给热缓存的索引，如果没有需要索引扫描的查询，则索引 B-树非叶节点对应的索引块很可能仍在缓存中。
- 对于临时表执行的最频繁的更新操作，当更新的节点在缓存中且无需先从磁盘读取时，执行速度会快得多。如果临时表索引的大小与冷键缓存的大小相当，则更新的节点在缓存中的概率非常高。

`CACHE INDEX` 语句在表和键缓存之间建立关联，但每次服务器重新启动时，该关联都会丢失。如果希望每次服务器启动时都生效，可以使用选项文件：包括配置键缓存的变量设置，以及包含要执行的 `CACHE INDEX` 语句的 `init_file` 系统变量。例如：

```ini
key_buffer_size = 4G
hot_cache.key_buffer_size = 2G
cold_cache.key_buffer_size = 2G
init_file=/path/to/data-directory/mysqld_init.sql
```

`mysqld_init.sql` 中的语句在每次服务器启动时执行。该文件应包含每行一个 SQL 语句。以下示例将多个表分配给 `hot_cache` 和 `cold_cache`：

```sql
CACHE INDEX db1.t1, db1.t2, db2.t3 IN hot_cache;
CACHE INDEX db1.t4, db2.t5, db2.t6 IN cold_cache;
```