### 10.10.2 MyISAM 键缓存

- [10.10.2.1 共享键缓存访问](./10.10.02.01.共享键缓存访问.md)
- [10.10.2.2 多个键缓存](./10.10.02.02.多个键缓存.md)
- [10.10.2.3 中点插入策略](./10.10.02.03.中点插入策略.md)
- [10.10.2.4 索引预加载](./10.10.02.04.索引预加载.md)
- [10.10.2.5 键缓存块大小](./10.10.02.05.键缓存块大小.md)
- [10.10.2.6 重构键缓存](./10.10.02.06.重构键缓存.md)

为了最小化磁盘 I/O，MyISAM 存储引擎采用了许多数据库管理系统使用的策略。它使用缓存机制将最常访问的表块保存在内存中：

- 对于索引块，维护了一个称为键缓存（或键缓冲区）的特殊结构。该结构包含许多块缓冲区，用于放置最常用的索引块。
- 对于数据块，MySQL 不使用特殊缓存，而是依赖本地操作系统文件系统缓存。

本节首先描述 MyISAM 键缓存的基本操作。然后讨论一些提高键缓存性能和使您能够更好地控制缓存操作的特性：

- 多个会话可以同时访问缓存。
- 您可以设置多个键缓存并将表索引分配给特定的缓存。

要控制键缓存的大小，请使用 `key_buffer_size` 系统变量。如果该变量设置为零，则不使用键缓存。如果 `key_buffer_size` 的值太小，无法分配最小数量的块缓冲区（8），也不会使用键缓存。

当键缓存未运行时，索引文件仅使用操作系统提供的本地文件系统缓冲区进行访问。换句话说，表索引块的访问策略与表数据块的访问策略相同。

索引块是访问 MyISAM 索引文件的连续单位。通常，索引块的大小等于索引 B-tree 节点的大小。（索引在磁盘上使用 B-tree 数据结构表示。树底部的节点是叶子节点。叶子节点之上的节点是非叶子节点。）

键缓存结构中的所有块缓冲区大小相同。此大小可以等于、大于或小于表索引块的大小。通常，这两个值中的一个是另一个的倍数。

当需要访问任何表索引块的数据时，服务器首先检查它是否在某个键缓存的块缓冲区中可用。如果可用，服务器将访问键缓存中的数据而不是磁盘上的数据。即，从缓存中读取或写入，而不是从磁盘读取或写入。否则，服务器选择包含不同表索引块（或块）的缓存块缓冲区，并用所需的表索引块的副本替换那里的数据。一旦新的索引块进入缓存，就可以访问索引数据。

如果选中的替换块已经被修改，则该块被视为“脏”块。在这种情况下，在被替换之前，其内容会被刷新到其来源的表索引中。

通常，服务器遵循 LRU（最近最少使用）策略：在选择替换块时，它选择最近最少使用的索引块。为了使这个选择更容易，键缓存模块将所有已使用的块维护在一个特殊列表（LRU 链）中，按使用时间排序。当一个块被访问时，它是最近使用的块，放在列表的末尾。当需要替换块时，列表开头的块是最近最少使用的，成为驱逐的第一个候选者。

InnoDB 存储引擎也使用 LRU 算法来管理其缓冲池。参见 第 17.5.1 节 “缓冲池”。