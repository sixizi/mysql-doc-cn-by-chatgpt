### 10.9.5 优化器成本模型

为了生成执行计划，优化器使用基于查询执行期间各种操作成本估算的成本模型。优化器有一组编译时默认的“成本常量”用于决定执行计划。

优化器还有一个成本估算数据库用于执行计划构建期间。这些估算值存储在 `mysql` 系统数据库中的 `server_cost` 和 `engine_cost` 表中，可以随时配置。这些表的目的是使调整优化器在生成查询执行计划时使用的成本估算变得容易。

[成本模型的常规操作](#成本模型的常规操作)

[成本模型数据库](#成本模型数据库)

[修改成本模型数据库](#修改成本模型数据库)

#### 成本模型的常规操作

可配置的优化器成本模型的工作原理如下：

- 服务器在启动时将成本模型表读入内存，并在运行时使用内存中的值。表中指定的任何非 NULL 成本估算值优先于相应的编译时默认成本常量。任何 NULL 估算值表示优化器使用编译时默认值。

- 在运行时，服务器可能会重新读取成本表。这发生在动态加载存储引擎或执行 `FLUSH OPTIMIZER_COSTS` 语句时。

- 成本表使服务器管理员可以通过更改表中的条目轻松调整成本估算。将条目的成本设置为 NULL 也可以很容易地恢复为默认值。优化器使用内存中的成本值，因此对表的更改应在执行 `FLUSH OPTIMIZER_COSTS` 后生效。

- 在客户端会话开始时当前的内存中成本估算值在整个会话期间适用，直到会话结束。特别是，如果服务器重新读取成本表，任何更改的估算值仅适用于随后启动的会话。现有会话不受影响。

- 成本表特定于给定的服务器实例。服务器不会将成本表更改复制到副本。

#### 成本模型数据库

优化器成本模型数据库由 `mysql` 系统数据库中的两个表组成，这些表包含查询执行期间发生的操作的成本估算信息：

- `server_cost`

  用于一般服务器操作的优化器成本估算。

- `engine_cost`

  用于特定存储引擎操作的优化器成本估算。

`server_cost` 表包含以下列：

- `cost_name`

  成本估算的名称。名称不区分大小写。如果服务器在读取此表时无法识别成本名称，它会向错误日志中写入警告。

- `cost_value`

  成本估算值。如果值为非 NULL，则服务器使用它作为成本。否则，它使用默认估算值（编译时值）。DBA 可以通过更新此列来更改成本估算。如果服务器在读取此表时发现成本值无效（非正值），它会向错误日志中写入警告。

- `last_update`

  最后一次行更新的时间。

- `comment`

  与成本估算相关的描述性注释。DBA 可以使用此列提供有关成本估算行存储特定值的原因的信息。

- `default_value`

  成本估算的默认（编译时）值。此列是只读生成列，即使关联的成本估算被更改，它也会保留其值。对于在运行时添加到表中的行，此列的值为 NULL。

`server_cost` 表的主键是 `cost_name` 列，因此无法为任何成本估算创建多个条目。

服务器识别 `server_cost` 表中的以下 `cost_name` 值：

- `disk_temptable_create_cost`，`disk_temptable_row_cost`

  用于内部创建的存储在基于磁盘的存储引擎（InnoDB 或 MyISAM）中的临时表的成本估算。增加这些值会增加使用内部临时表的成本估算，使优化器倾向于选择较少使用它们的查询计划。有关此类表的信息，请参见第 10.4.4 节《MySQL 中的内部临时表使用》。

- `key_compare_cost`

  比较记录键的成本。增加此值会使比较许多键的查询计划变得更昂贵。例如，执行文件排序的查询计划相比使用索引避免排序的查询计划会变得更昂贵。

- `memory_temptable_create_cost`，`memory_temptable_row_cost`

  用于内部创建的存储在 MEMORY 存储引擎中的临时表的成本估算。增加这些值会增加使用内部临时表的成本估算，使优化器倾向于选择较少使用它们的查询计划。有关此类表的信息，请参见[第 10.4.4 节](#)《MySQL 中的内部临时表使用》。

- `row_evaluate_cost`

  评估记录条件的成本。增加此值会使检查许多行的查询计划相比检查较少行的查询计划变得更昂贵。例如，表扫描相比读取较少行的范围扫描会变得更昂贵。

`engine_cost` 表包含以下列：

- `engine_name`

  此成本估算适用的存储引擎的名称。名称不区分大小写。如果值为 `default`，它适用于所有没有自己名称条目的存储引擎。如果服务器在读取此表时无法识别引擎名称，它会向错误日志中写入警告。

- `device_type`

  此成本估算适用的设备类型。此列用于为不同存储设备类型（如硬盘驱动器与固态驱动器）指定不同的成本估算。目前，此信息未使用，0 是唯一允许的值。

- `cost_name`

  同 `server_cost` 表中的列。

- `cost_value`

  同 `server_cost` 表中的列。

- `last_update`

  同 `server_cost` 表中的列。

- `comment`

  同 `server_cost` 表中的列。

- `default_value`

  成本估算的默认（编译时）值。此列是只读生成列，即使关联的成本估算被更改，它也会保留其值。对于在运行时添加到表中的行，此列的值为 NULL，除非该行与原始行具有相同的 `cost_name` 值，在这种情况下，`default_value` 列的值与该行相同。

`engine_cost` 表的主键是 (cost_name, engine_name, device_type) 列的元组，因此无法为这些列中的任何组合创建多个条目。

服务器识别 `engine_cost` 表中的以下 `cost_name` 值：

- `io_block_read_cost`

  从磁盘读取索引或数据块的成本。增加此值会使读取许多磁盘块的查询计划相比读取较少磁盘块的查询计划变得更昂贵。例如，表扫描相比读取较少块的范围扫描会变得更昂贵。

- `memory_block_read_cost`

  类似于 `io_block_read_cost`，但表示从内存数据库缓冲区读取索引或数据块的成本。如果 `io_block_read_cost` 和 `memory_block_read_cost` 值不同，同一查询的两次运行之间的执行计划可能会改变。假设内存访问成本小于磁盘访问成本。在这种情况下，在服务器启动时数据尚未读入缓冲池之前，您可能会得到不同的计划，因为数据在内存中。

#### 修改成本模型数据库

希望将成本模型参数从默认值更改的 DBA，可以尝试将值加倍或减半并测量效果。

对 `io_block_read_cost` 和 `memory_block_read_cost` 参数的更改最有可能产生有价值的结果。这些参数值使数据访问方法的成本模型能够考虑从不同来源读取信息的成本；即，从磁盘读取信息的成本与从内存缓冲区中读取信息的成本。例如，所有其他条件相同，将 `io_block_read_cost` 设置为大于 `memory_block_read_cost` 的值会使优化器更倾向于选择读取已存储在内存中的信息的查询计划，而不是必须从磁盘读取的计划。

此示例显示如何更改 `io_block_read_cost` 的默认值：

```sql
UPDATE mysql.engine_cost
  SET cost_value = 2.0
  WHERE cost_name = 'io_block_read_cost';
FLUSH OPTIMIZER_COSTS;
```

此示例显示如何仅为 InnoDB 存储引擎更改 `io_block_read_cost` 的值：

```sql
INSERT INTO mysql.engine_cost
  VALUES ('InnoDB', 0, 'io_block_read_cost', 3.0,
  CURRENT_TIMESTAMP, 'Using a slower disk for InnoDB');
FLUSH OPTIMIZER_COSTS;