### 10.9.2 切换优化选项

`optimizer_switch` 系统变量用于控制优化器的行为。其值是一组标志，每个标志的值为 `on` 或 `off`，以指示是否启用或禁用相应的优化器行为。该变量具有全局和会话值，并且可以在运行时进行更改。全局默认值可以在服务器启动时设置。

要查看当前的优化器标志集，可以选择变量值：

```sql
mysql> SELECT @@optimizer_switch\G
*************************** 1. row ***************************
@@optimizer_switch: index_merge=on,index_merge_union=on,
                    index_merge_sort_union=on,index_merge_intersection=on,
                    engine_condition_pushdown=on,index_condition_pushdown=on,
                    mrr=on,mrr_cost_based=on,block_nested_loop=on,
                    batched_key_access=off,materialization=on,semijoin=on,
                    loosescan=on,firstmatch=on,duplicateweedout=on,
                    subquery_materialization_cost_based=on,
                    use_index_extensions=on,condition_fanout_filter=on,
                    derived_merge=on,use_invisible_indexes=off,skip_scan=on,
                    hash_join=on,subquery_to_derived=off,
                    prefer_ordering_index=on,hypergraph_optimizer=off,
                    derived_condition_pushdown=on
1 row in set (0.00 sec)
```

要更改 `optimizer_switch` 的值，请分配一个由一个或多个命令组成的逗号分隔列表的值：

```sql
SET [GLOBAL|SESSION] optimizer_switch='command[,command]...';
```

每个命令值应具有以下表中所示的形式。

| 命令语法           | 含义                       |
| ------------------ | -------------------------- |
| `default`          | 将每个优化重置为其默认值   |
| `opt_name=default` | 将指定的优化设置为其默认值 |
| `opt_name=off`     | 禁用指定的优化             |
| `opt_name=on`      | 启用指定的优化             |

命令值的顺序无关紧要，尽管 `default` 命令（如果存在）首先执行。将 `opt_name` 标志设置为 `default` 会将其设置为其默认值 `on` 或 `off`。在值中多次指定任何给定的 `opt_name` 是不允许的，并会导致错误。值中的任何错误都会导致赋值失败，并使 `optimizer_switch` 的值保持不变。

以下列表描述了允许的 `opt_name` 标志名称，按优化策略分组：

#### 批量键访问标志

- `batched_key_access`（默认 `off`）

  控制是否使用 BKA 连接算法。

  要使 `batched_key_access` 在设置为 `on` 时生效，`mrr` 标志也必须为 `on`。目前，MRR 的成本估计过于悲观。因此，必须将 `mrr_cost_based` 设置为 `off` 才能使用 BKA。

  有关更多信息，请参阅 [10.2.1.12 节，“块嵌套循环和批量键访问连接”](#)。

#### 块嵌套循环标志

- `block_nested_loop`（默认 `on`）

  控制是否使用 BNL 连接算法。在 MySQL 8.0.18 及更高版本中，这还控制哈希连接的使用，就像 BNL 和 NO_BNL 优化器提示一样。在 MySQL 8.0.20 及更高版本中，从 MySQL 服务器中删除块嵌套循环支持，此标志仅控制哈希连接的使用，就像参考的优化器提示一样。

  有关更多信息，请参阅 [10.2.1.12 节，“块嵌套循环和批量键访问连接”](#)。

#### 条件过滤标志

- `condition_fanout_filter`（默认 `on`）

  控制条件过滤的使用。

  有关更多信息，请参阅 [10.2.1.13 节，“条件过滤”](#)。

#### 派生条件下推标志

- `derived_condition_pushdown`（默认 `on`）

  控制派生条件下推。

  有关更多信息，请参阅 [10.2.2.5 节，“派生条件下推优化”](#)。

#### 派生表合并标志

- `derived_merge`（默认 `on`）

  控制将派生表和视图合并到外部查询块。

  `derived_merge` 标志控制优化器是否尝试合并派生表、视图引用和公共表表达式到外部查询块，假设没有其他规则阻止合并；例如，视图的 `ALGORITHM` 指令优先于 `derived_merge` 设置。默认情况下，该标志为 `on` 以启用合并。

  有关更多信息，请参阅 [10.2.2.4 节，“使用合并或物化优化派生表、视图引用和公共表表达式”](#)。

#### 引擎条件下推标志

- `engine_condition_pushdown`（默认 `on`）

  控制引擎条件下推。

  有关更多信息，请参阅 [10.2.1.5 节，“引擎条件下推优化”](#)。

#### 哈希连接标志

- `hash_join`（默认 `on`）

  在 MySQL 8.0.18 中控制哈希连接，并且在任何后续版本中没有效果。在 MySQL 8.0.19 及更高版本中，要控制哈希连接的使用，请使用 `block_nested_loop` 标志。

  有关更多信息，请参阅 [10.2.1.4 节，“哈希连接优化”](#)。

#### 索引条件下推标志

- `index_condition_pushdown`（默认 `on`）

  控制索引条件下推。

  有关更多信息，请参阅 [10.2.1.6 节，“索引条件下推优化”](#)。

#### 索引扩展标志

- `use_index_extensions`（默认 `on`）

  控制是否使用索引扩展。

  有关更多信息，请参阅 [10.3.10 节，“使用索引扩展”](#)。

#### 索引合并标志

- `index_merge`（默认 `on`）

  控制所有索引合并优化。

- `index_merge_intersection`（默认 `on`）

  控制索引合并交集访问优化。

- `index_merge_sort_union`（默认 `on`）

  控制索引合并排序联合访问优化。

- `index_merge_union`（默认 `on`）

  控制索引合并联合访问优化。

  有关更多信息，请参阅 [10.2.1.3 节，“索引合并优化”](#)。

#### 索引可见性标志

- `use_invisible_indexes`（默认 `off`）

  控制是否使用不可见索引。

  有关更多信息，请参阅 [10.3.12 节，“不可见索引”](#)。

#### 限制优化标志

- `prefer_ordering_index`（默认 `on`）

  控制在查询具有 `ORDER BY` 或 `GROUP BY` 以及 `LIMIT` 子句时，优化器是否尝试使用有序索引而不是无序索引、文件排序或其他优化。当优化器确定使用该优化可以更快地执行查询时，默认会执行此优化。

  由于用于做出此决定的算法无法处理所有可能的情况（部分原因是该算法假定数据分布总是或多或少是均匀的），因此在某些情况下，此优化可能不理想。在 MySQL 8.0.21 之前，不可能禁用此优化，但在 MySQL 8.0.21 及更高版本中，尽管这仍然是默认行为，但可以通过将 `prefer_ordering_index` 标志设置为 `off` 来禁用此优化。

  有关更多信息和示例，请参阅 [10.2.1.19 节，“LIMIT 查询优化”](#)。

#### 多范围读取标志

- `mrr`（默认 `on`）

  控制多范围读取策略。

- `mrr_cost_based`（默认 `on`）

  控制是否使用基于成本的 MRR（如果 `mrr=on`）。

  有关更多信息，请参阅 [10.2.1.11 节，“多范围读取优化”](#)。

#### 半连接标志

- `duplicateweedout`（默认 `on`）

  控制半连接重复消除策略。

- `firstmatch`（默认 `on`）

  控制半连接首匹配策略。

- `loosescan`（默认 `on`）

  控制半连接松散扫描策略（不应与 `GROUP BY` 的松散索引扫描混淆）。

- `semijoin`（默认 `on`）

  控制所有半连接策略