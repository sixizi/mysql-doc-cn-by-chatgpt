### 25.2.4 MySQL NDB Cluster 8.0 新功能

以下部分描述了 NDB Cluster 8.0（至 8.0.38 版本）的实现变化，与早期版本相比的变化。NDB Cluster 8.0 从 NDB 8.0.19 开始作为 General Availability (GA) 版本提供。NDB Cluster 7.6 和 7.5 是之前仍支持的 GA 版本；有关 NDB Cluster 7.6 的信息，请参阅 [NDB Cluster 7.6 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-6.html)。有关 NDB Cluster 7.5 的类似信息，请参阅 [NDB Cluster 7.5 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-5.html)。NDB Cluster 7.4 和 7.3 是之前的 GA 版本，但已达到生命周期终点，不再支持或维护。我们建议新的生产部署使用 MySQL NDB Cluster 8.0。

#### NDB Cluster 8.0 的新特性

NDB Cluster 8.0 中主要的变更和新特性如下：

- **兼容性增强**：以下更改减少了 NDB 与其他 MySQL 存储引擎行为之间的长期非必要差异：

- **与 MySQL 服务器并行开发**：从此版本开始，MySQL NDB Cluster 与标准 MySQL 8.0 服务器并行开发，并采用新的统一发布模型，具有以下特点：
  - NDB 8.0 在 MySQL 8.0 源代码树中开发、构建和发布。
  - NDB Cluster 8.0 版本的编号方案与 MySQL 8.0 一致。
  - 构建带有 NDB 支持的源代码会在 `mysql -V` 返回的版本字符串中附加 `-cluster`，如以下示例所示：
    ```shell
    $> mysql -V
    mysql  Ver 8.0.38-cluster for Linux on x86_64 (Source distribution)
    ```
  - NDB 二进制文件继续显示 MySQL 服务器版本和 NDB 引擎版本，如下所示：
    ```shell
    $> ndb_mgm -V
    MySQL distrib mysql-8.0.38 ndb-8.0.38, for Linux (x86_64)
    ```
    在 MySQL Cluster NDB 8.0 中，这两个版本号总是相同的。
  - 要构建带有 NDB Cluster 支持的 MySQL 源代码，请使用 CMake 选项 `-DWITH_NDB`（NDB 8.0.31 及以后版本；对于更早的版本，使用 `-DWITH_NDBCLUSTER`）。

- **平台支持说明**：
  - NDB 8.0 不再支持 32 位平台。从 NDB 8.0.21 开始，NDB 构建过程会检查系统架构，如果不是 64 位平台则会中止。
  - 现在可以为 64 位 ARM CPU 从源代码构建 NDB。目前，该支持仅限于源代码，我们不提供此平台的预编译二进制文件。

- **数据库和表名**：
  - NDB 8.0 取消了以前对数据库和表标识符的 63 字节限制。这些标识符现在可以使用多达 64 字节，与其他 MySQL 存储引擎相同。详见[第 25.2.7.11 节，"NDB Cluster 8.0 中解决的先前 NDB Cluster 问题"](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-ndb-8-0-issues.html)。

- **自动生成的外键名称**：
  - NDB 现在使用 `tbl_name_fk_N` 模式为内部生成的外键命名，这与 InnoDB 使用的模式类似。

- **架构和元数据分发与同步**：
  - NDB 8.0 使用 MySQL 数据字典将架构信息分发到加入集群的 SQL 节点，并在现有 SQL 节点之间同步新的架构更改。以下是与此集成工作相关的个别增强功能：

    - **架构分发增强**：NDB 架构分发协调器在 NDB 8.0 中得到了扩展，以确保在架构操作结束时释放所用资源。以前，这些工作的一部分由架构分发客户端完成；由于客户端并不总是拥有所有必要的状态信息，当客户端决定在完成之前放弃架构操作而不通知协调器时，可能会导致资源泄漏。为了解决这个问题，架构操作超时检测已从架构分发客户端转移到协调器，使协调器有机会清理架构操作期间使用的任何资源。协调器现在会定期检查正在进行的架构操作是否超时，并在检测到超时时将尚未完成给定架构操作的参与者标记为失败。每当发生架构操作超时时，协调器还会提供适当的警告（应注意，在检测到此类超时后，架构操作本身会继续进行）。另外，当有一个或多个架构操作正在进行时，协调器会定期打印活动架构操作列表。

    - **磁盘数据文件分发**：NDB Cluster 8.0.14 使用 MySQL 数据字典确保磁盘数据文件和相关结构（如表空间和日志文件组）在所有连接的 SQL 节点之间正确分发。

    - **表空间对象的架构同步**：当 MySQL 服务器作为 SQL 节点连接到 NDB 集群时，它会将其数据字典与 NDB 字典中的信息进行检查和同步。以前，仅在连接新 SQL 节点时同步 NDB 对象（如数据库和表）；MySQL NDB Cluster 8.0 还实现了磁盘数据对象（包括表空间和日志文件组）的架构同步。这消除了 MySQL 数据字典和 NDB 字典在本地备份和恢复后可能出现的不匹配情况。

    - **数据库 DDL 同步增强**：NDB 8.0 中的工作确保新加入（或重新加入）的 SQL 节点与现有 SQL 节点上的数据库同步时，正确使用数据字典，以便在该 SQL 节点连接（或重新连接）到集群时，任何可能遗漏的数据库级操作（如 `CREATE DATABASE`、`ALTER DATABASE` 或 `DROP DATABASE`）都能正确地在该节点上复制。作为启动时执行的架构同步程序的一部分，SQL 节点现在会将集群数据节点上的所有数据库与其自己的数据字典进行比较，如果发现这些数据库中的任何一个在 SQL 节点的数据字典中缺失，SQL 节点会通过执行 `CREATE DATABASE` 语句在本地安装它。这样创建的数据库使用在执行语句时该 SQL 节点上生效的默认 MySQL 服务器数据库属性（如 `character_set_database` 和 `collation_database`）。

    - **NDB 元数据更改检测和同步**：NDB 8.0 实现了一种新的机制，用于检测 NDB 字典与 MySQL 数据字典之间的数据对象（如表、表空间和日志文件组）元数据的更新。这是通过一个后台线程完成的，该线程定期检查 NDB 字典和 MySQL 数据字典之间的一致性。该线程默认每 60 秒执行一次元数据检查。可以通过设置 `ndb_metadata_check_interval` 系统变量来调整轮询间隔；通过设置 `ndb_metadata_check` 系统变量为 `OFF` 可以完全禁用轮询。状态变量 `Ndb_metadata_detected_count` 显示自上次启动 mysqld 以来检测到的不一致次数。NDB 确保 NDB 数据库、表、日志文件组和表空间对象在启动后的操作过程中由元数据更改监控线程提交时，自动检查是否存在不匹配并由 NDB binlog 线程同步。NDB 8.0 增加了两个与自动同步相关的状态变量：`Ndb_metadata_synced_count` 显示自动同步的对象数量；`Ndb_metadata_excluded_count` 显示同步失败的对象数量（NDB 8.0.22 之前，该变量名为 `Ndb_metadata_blacklist_size`）。此外，您可以通过检查集群日志来查看哪些对象已同步。将 `ndb_metadata_sync` 系统变量设置为 true 会覆盖为 `ndb_metadata_check_interval` 和 `ndb_metadata_check` 所做的任何设置，使更改监控线程开始连续元数据更改检测。

    - **NDB 表额外元数据的变化**：NDB 表的额外元数据属性用于存储 MySQL 数据字典的序列化元数据，而不是像以前版本那样存储表的二进制表示（这是一个不再被 MySQL 服务器使用的 `.frm` 文件）。作为
    
    - 支持此更改工作的一部分，表的额外元数据的可用大小已增加。这意味着在 NDB Cluster 8.0 中创建的 NDB 表与以前的 NDB Cluster 版本不兼容。在以前版本中创建的表可以在 NDB 8.0 中使用，但之后无法再被早期版本打开。此元数据可通过 NDB API 方法 `getExtraMetadata()` 和 `setExtraMetadata()` 访问。
    
        - **在线升级使用 .frm 文件的表**：在 NDB 7.6 及以前版本中创建的表包含 `.frm` 文件形式的元数据，MySQL 8.0 不再支持此文件。为了促进在线升级到 NDB 8.0，NDB 在后台对这些元数据进行转换，并将其写入 MySQL 服务器的数据字典，这使得 NDB Cluster 8.0 中的 `mysqld` 能够处理表，同时不会阻止早期版本的 NDB 软件使用该表。
    
          > **重要**
          > 一旦在 NDB 8.0 中修改了表的结构，其元数据将使用数据字典存储，早期版本的 NDB 将无法再访问该表。
    
        - **元数据一致性检查错误日志记录**：作为 NDB 8.0 之前工作的一部分，自动同步过程中执行的元数据检查包括表名、存储引擎和内部 ID。从 NDB 8.0.23 开始，检查范围扩展到列、索引和外键等数据对象的属性。此外，任何元数据属性不匹配的详细信息现在会写入 MySQL 服务器错误日志。错误日志消息的格式略有不同，具体取决于不匹配是出现在表级别还是列、索引或外键级别。日志错误消息格式如下，其中 `property` 是属性名，`ndb_value` 是 NDB 字典中存储的属性值，`mysqld_value` 是 MySQL 数据字典中存储的属性值：
    
          ```plaintext
          Diff in 'property' detected, 'ndb_value' != 'mysqld_value'
          ```
          对于列、索引和外键属性的不匹配，格式如下，其中 `obj_type` 是列、索引或外键之一，`obj_name` 是对象名称：
    
          ```plaintext
          Diff in obj_type 'obj_name.property' detected, 'ndb_value' != 'mysqld_value'
          ```
          在 NDB Cluster 中，任何 mysqld 作为 SQL 节点安装的数据字典中的 NDB 表在自动同步期间会执行元数据检查。如果 mysqld 是调试编译的，则还会在执行 `CREATE TABLE` 语句时以及每次打开 NDB 表时进行检查。
    
        - **NDB_STORED_USER 的用户权限同步**：NDB 8.0 引入了一种新机制，使用 `NDB_STORED_USER` 权限在 SQL 节点之间共享和同步用户、角色和权限。NDB 7.6 及更早版本中的分布式权限不再受支持。创建用户帐户后，可以通过如下的 `GRANT` 语句将用户及其权限存储在 NDB 中，从而在集群的所有 SQL 节点之间共享：
          ```sql
          GRANT NDB_STORED_USER ON *.* TO 'jon'@'localhost';
          ```
    
        - **INFORMATION_SCHEMA 更改**：对 INFORMATION_SCHEMA FILES 表中有关磁盘数据文件的信息显示进行以下更改：
          - FILES 表中不再表示表空间和日志文件组。（这些结构实际上不是文件。）
          - 现在每个数据文件在 FILES 表中表示为一行。每个撤销日志文件也现在在此表中仅表示一行。（以前，表中的每个数据节点上的每个文件副本都显示一行。）此外，INFORMATION_SCHEMA 表现在填充了 MySQL Cluster 表的表空间统计信息。
    
        - **ndb_perror 错误信息**：已删除 `perror` 的已弃用 `--ndb` 选项。相反，使用 `ndb_perror` 从 NDB 错误代码中获取错误信息。
    
        - **条件下推增强**：以前，条件下推仅限于引用条件被推到的同一表中的列值。NDB 8.0 取消了此限制，使得条件推送可以引用查询计划中较早的表的列值。NDB 8.0 支持比较列表达式以及同一表中的列之间的比较。列和列表达式进行比较时必须完全相同类型；这意味着它们在适用时必须具有相同的符号、长度、字符集、精度和刻度。
    
          条件下推允许数据节点过滤掉更多行，从而减少 mysqld 在联接处理期间必须处理的行数。此增强功能的另一个好处是可以在 LDM 线程中并行执行过滤，而不是在 SQL 节点上的单个 mysqld 进程中；这有可能显著提高查询性能。
    
          现有规则继续适用于被比较的列值的类型兼容性。
    
        - **外联接和半联接的下推**：NDB 8.0.20 中的工作允许许多外联接和半联接（不仅仅是使用主键或唯一键查找的联接）下推到数据节点。
    
          现在可以下推的使用扫描的外联接包括符合以下条件的联接：
    
          - 表上没有未推送的条件
          - 同一联接嵌套中的其他表上没有未推送的条件，或在其上依赖的上层联接嵌套中
          - 同一联接嵌套中的所有其他表，或在其上依赖的上层联接嵌套中，也被推送
    
          如果使用索引扫描并满足上述下推外联接的条件，且使用 `firstMatch` 策略，则可以下推半联接。
    
          NDB 8.0.21 中的其他改进：
    
          - 通过 `NOT EXISTS` 和 `NOT IN` 查询的转换生成的 MySQL 优化器反联接可以下推到数据节点。
          - 当表上没有未推送的条件且查询满足任何其他条件时，可以下推反联接。
          - NDB 尝试在尝试从附加到的表中检索任何行之前识别和评估非依赖标量子查询。如果可以这样做，则使用获得的值作为推送条件的一部分，而不是使用提供该值的子查询。
    
          从 NDB 8.0.27 开始，作为推送查询一部分推送的条件现在可以引用同一推送查询内的祖先表中的列，条件如下：
    
          - 推送条件可以包括比较运算符 `<`、`<=`、`>`、`>=`、`=` 和 `<>`。
          - 被比较的值必须是相同类型，包括长度、精度和刻度。
          - NULL 处理根据 ISO SQL 标准指定的比较语义进行；任何与 NULL 的比较返回 NULL。
    
          例如，使用以下语句创建的表：
    
          ```sql
          CREATE TABLE t (
              x INT PRIMARY KEY,
              y INT
          ) ENGINE=NDB;
          ```
    
          现在，查询 `SELECT * FROM t AS m JOIN t AS n ON m.x >= n.y` 可以使用引擎条件下推优化将条件列 `y` 下推。
    
          当无法下推联接时，`EXPLAIN` 应提供原因。
    
        - **NDB API 方法** `branch_col_eq_param()`、`branch_col_ne_param()`、`branch_col_lt_param()`、`branch_col_le_param()`、`branch_col_gt_param()` 和 `branch_col_ge_param()` 在 NDB 8.0.27 中添加，作为此工作的组成部分。这些 `NdbInterpretedCode` 方法可以用于将列值与参数值进行比较。
    
          此外，`NdbScanFilter::cmp_param()` 也在 NDB 8.0.27 中添加，使得可以定义列值与参数值之间的比较，以用于执行扫描。
    
        - **增加最大行大小**：NDB 8.0 将 NDBCLUSTER 表中可以存储的最大字节数从 14000 增加到 30000 字节。BLOB 或 TEXT 列继续使用此总数的 264 字节，与以前一样。固定宽度列的最大偏移量仍为 8188 字节，与以前版本相比没有变化。
    
        - **`ndb_mgm SHOW` 命令和单用户模式**：在 NDB 8.0 中，当集群处于单用户模式时，管理客户端的 `SHOW` 命令输出指示哪个 API 或 SQL 节点在此模式生效期间具有独占访问权。
    
        - **在线列重命名**：NDB 表的列现在可以在线重命名，使用 `ALGORITHM=INPLACE`。详细信息请参阅[第 25.6.12 节，“NDB Cluster 中的 ALTER TABLE 在线操作”](https://dev.mysql.com/doc/refman/
    
      - 8.0/en/mysql-cluster-alter-table-online.html)。
    
          - **提高 `ndb_mgmd` 启动时间**：NDB 8.0 中，以下方式显著提高了管理节点守护进程的启动时间：
            - 由于用哈希表替换了 `ndb_mgmd` 用于处理配置数据中的节点属性的列表数据结构，管理服务器的总体启动时间减少了 6 倍以上。
            - 此外，在集群配置文件中使用管理服务器主机文件中不存在的数据和 SQL 节点主机名的情况下，`ndb_mgmd` 启动时间比以前减少了多达 20 倍。
    
          - **NDB API 增强**：`NdbScanFilter::cmp()` 和几个 `NdbInterpretedCode` 的比较方法现在可以用于比较表列值。受影响的 `NdbInterpretedCode` 方法列在这里：
            - `branch_col_eq()`
            - `branch_col_ge()`
            - `branch_col_gt()`
            - `branch_col_le()`
            - `branch_col_lt()`
            - `branch_col_ne()`
    
            对于上述所有方法，被比较的表列值必须完全匹配类型，包括长度、精度、符号、刻度、字符集和排序规则。
    
          - **离线多线程索引构建**：现在可以为执行离线多线程构建有序索引的 I/O 线程指定一组核心，而不是正常的 I/O 任务，如文件 I/O、压缩或解压缩。“离线”在此上下文中指的是在父表未被写入时执行的有序索引构建；此类构建在 NDB 集群执行节点或系统重启时，或作为使用 `ndb_restore --rebuild-indexes` 从备份恢复集群的一部分进行。
    
            此外，离线索引构建工作的默认行为已修改为使用 `ndbmtd` 可用的所有核心，而不是限制在为 I/O 线程保留的核心上。这可以提高重启和恢复时间、性能、可用性和用户体验。
    
            此增强功能实现如下：
            - `BuildIndexThreads` 的默认值从 0 更改为 128。这意味着离线有序索引构建现在默认是多线程的。
            - `TwoPassInitialNodeRestartCopy` 的默认值从 false 更改为 true。这意味着初始节点重启首先将所有数据从“活动”节点复制到正在启动的节点——不创建任何索引——然后离线构建有序索引，然后再次与活动节点同步数据，即同步两次，并在两次同步之间离线构建索引。这使得初始节点重启的行为更像正常的节点重启，并减少了构建索引所需的时间。
            - 为 `ThreadConfig` 配置参数定义了一个新线程类型（`idxbld`），以允许将离线索引构建线程锁定到特定 CPU。
    
            此外，NDB 现在通过以下两个标准区分可供 `ThreadConfig` 使用的线程类型：
            - 线程是否是执行线程。`main`、`ldm`、`recv`、`rep`、`tc` 和 `send` 类型的线程是执行线程；`io`、`watchdog` 和 `idxbld` 类型的线程不是执行线程。
            - 将线程分配给给定任务是永久性的还是临时性的。目前，除 `idxbld` 之外的所有线程类型都是永久性的。
    
          - **`logbuffers` 表备份过程信息**：执行 NDB 备份时，`ndbinfo.logbuffers` 表现在显示备份过程中每个数据节点的缓冲区使用信息。这是通过显示除 REDO 和 DD-UNDO 之外的两个新日志类型的行实现的。其中一个行的日志类型为 `BACKUP-DATA`，显示在备份过程中用于将片段复制到备份文件的数据缓冲区使用量。另一个行的日志类型为 `BACKUP-LOG`，显示在备份过程中用于记录备份开始后进行的更改的日志缓冲区使用量。`logbuffers` 表中每个数据节点显示这两个日志类型之一的行。这些日志类型的行仅在当前进行 NDB 备份时存在于表中。
    
          - **Windows 平台上的 `ndbinfo.processes` 表**：Windows 平台上使用 `RESTART` 生成和重启 `mysqld` 的监控进程的进程 ID 现在显示在 `processes` 表中的 `angel_pid` 列中。
    
          - **字符串哈希改进**：在 NDB 8.0 之前，所有字符串哈希都是基于首先将字符串转换为规范形式，然后对结果二进制图像进行 MD5 哈希。这可能会导致一些性能问题，原因如下：
            - 规范化字符串始终用空格填充到其完整长度。对于 `VARCHAR`，这通常涉及添加比原始字符串更多的空格。
            - 字符串库未针对这种空格填充进行优化，在某些用例中增加了大量开销。
            - 填充语义在字符集之间有所不同，有些字符集未填充到其完整长度。
            - 即使没有空格填充，转换后的字符串也可能变得非常大；一些 Unicode 9.0 排序规则可以将单个代码点转换为 100 字节或更多字符数据。
            - 随后的 MD5 哈希主要由填充空格组成，并不特别高效，可能导致刷新大量 L1 缓存，从而进一步影响性能。
    
            排序规则提供了自己的哈希函数，可以直接对字符串进行哈希，而无需先创建规范化字符串。此外，对于 Unicode 9.0 排序规则，哈希是在不进行填充的情况下计算的。NDB 现在在哈希使用 Unicode 9.0 排序规则的字符串时利用此内置函数。
    
            由于对于其他排序规则，现有数据库在转换字符串时基于哈希分区，因此 NDB 继续对这些字符串使用以前的方法，以保持兼容性。
    
          - **`RESET MASTER` 更改**：由于 MySQL 服务器现在使用全局读锁执行 `RESET MASTER`，使用此语句与 NDB Cluster 的行为在以下两个方面有所不同：
            - 不再保证是同步的；也就是说，可能在发出 `RESET MASTER` 之前立即进行的读取直到二进制日志旋转之后才被记录。
            - 无论语句是在哪个 SQL 节点上发出的，都以相同方式操作，无论该节点是否正在写入二进制日志。
    
            > **注意**
            > `SHOW BINLOG EVENTS`、`FLUSH LOGS` 和大多数数据定义语句继续以同步方式操作，正如在以前的 NDB 版本中一样。
    
          - **`ndb_restore` 选项使用**：调用 `ndb_restore` 时，`--nodeid` 和 `--backupid` 选项现在都必需。
    
          - **`ndb_log_bin` 默认值**：NDB 8.0 将 `ndb_log_bin` 系统变量的默认值从 `TRUE` 更改为 `FALSE`。
    
          - **动态事务资源分配**：现在使用动态内存池分配事务协调器中的资源。这意味着由数据节点配置参数（如 `MaxDMLOperationsPerTransaction`、`MaxNoOfConcurrentIndexOperations`、`MaxNoOfConcurrentOperations`、`MaxNoOfConcurrentScans`、`MaxNoOfConcurrentTransactions`、`MaxNoOfFiredTriggers`、`MaxNoOfLocalScans` 和 `TransactionBufferMemory`）确定的资源分配现在以一种方式进行分配，即如果每个参数代表的负载在所有这些资源的目标负载之内，则其他资源可以受到限制，以不超过可用总资源。
    
            作为此工作的一部分，添加了几个控制 DBTC 中事务资源的新数据节点参数，包括：
            - `ReservedConcurrentIndexOperations`
            - `ReservedConcurrentOperations`
            - `ReservedConcurrentScans`
            - `ReservedConcurrentTransactions`
            - `ReservedFiredTriggers`
            - `ReservedLocalScans`
            - `ReservedTransactionBufferMemory`
    
          - **使用多个 LDM 的备份**：现在可以使用多个本地数据管理器（LDM）在单个数据节点上并行执行 NDB 备份。（以前，备份在数据节点之间是并行进行的，但在数据节点进程内始终是串行的。）启用此功能不需要在 `ndb_mgm` 客户端的 `START BACKUP` 命令中使用特殊语法，但所有数据节点必须使用多个 LDM。这意味着数据节点必须运行 `ndbmtd`（`ndbd` 是单线程的，因此始终只有一个 LDM），并且必须在进行备份之前配置为使用多个 LDM；您可以通过选择适当的多线程数据节点配置参数 `MaxNoOfExecutionThreads` 或 `ThreadConfig` 设置来实现这一点。
    
            使用多个 LDM 创建备份时，会在 `BACKUP/BACKUP-backup_id/` 目录下创建多个子目录，每个 LDM 一个。`ndb_restore` 现在会自动检测这些子目录，如果它们存在，则尝试并行恢复备份；请参阅[第 25.5.23.3 节，“从并行备份恢复”](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-backup-restoring.html#mysql-cluster-backup-restoring-parallel) 了解详细信息。（单线程备份恢复与以前版本的 NDB 一样。）还可以通过修改常规恢复过程来使用早期版本的 NDB Cluster 的 `ndb_restore` 二进制文件恢复并行备份；[第 25.5.23.3.2 节，“串行恢复并行备份”](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-backup-restoring.html#mysql-cluster-backup-restoring-serial) 提供了如何执行此操作的信息。
            
                您可以通过在集群全局配置文件（`config.ini`）的 `[ndbd default]` 部分中为所有数据节点设置 `EnableMultithreadedBackup` 数据节点参数为 0 来强制创建单线程备份。
            
              - **二进制配置文件增强**：NDB 8.0 对管理服务器的二进制配置文件格式进行了新的改进。以前，集群配置文件中的最大部分数为 16381；现在，最大部分数为 4G。这旨在支持比此更改之前更大数量的节点。
            
                升级到新格式相对无缝，通常不需要手动干预，因为管理服务器继续能够读取旧格式而不会出现问题。从 NDB 8.0 降级到 NDB Cluster 软件的旧版本需要手动删除任何二进制配置文件，或者，启动旧的管理服务器二进制文件时使用 `--initial` 选项。
            
              - **增加数据节点数量**：NDB 8.0 将每个集群支持的数据节点最大数量从 48 增加到 144。数据节点现在可以使用 1 到 144 范围内的节点 ID。
            
                以前，管理节点的推荐节点 ID 为 49 和 50。这些节点 ID 仍然支持作为管理节点使用，但将它们用作管理节点会将数据节点的最大数量限制为 142；因此，现在建议使用节点 ID 145 和 146 作为管理节点。
            
                作为此工作的组成部分，用于数据节点 sysfile 的格式已更新为版本 2。此文件记录信息，如最后的全局检查点索引、重启状态和每个节点的节点组成员资格。
            
              - **`RedoOverCommitCounter` 和 `RedoOverCommitLimit` 更改**：由于将其设置为 0 的语义含糊不清，因此数据节点配置参数 `RedoOverCommitCounter` 和 `RedoOverCommitLimit` 的最小值已增加到 1。
            
              - **`ndb_autoincrement_prefetch_sz` 更改**：`ndb_autoincrement_prefetch_sz` 服务器系统变量的默认值增加到 512。
            
              - **参数最大值和默认值的更改**：NDB 8.0 对配置参数最大值和默认值进行了以下更改：
                - `DataMemory` 的最大值增加到 16 TB。
                - `DiskPageBufferMemory` 的最大值也增加到 16 TB。
                - `StringMemory` 的默认值增加到 25%。
                - `LcpScanProgressTimeout` 的默认值增加到 180 秒。
            
              - **磁盘数据检查点改进**：NDB Cluster 8.0 提供了一些新的增强功能，帮助减少使用固态驱动器（SSD）和 NVMe 规范等非易失性存储设备进行磁盘数据表和表空间检查点的延迟。这些改进包括以下内容：
                - 避免检查点磁盘写入的突发
                - 在重做日志或撤销日志变满时加快磁盘数据表空间的检查点速度
                - 必要时平衡磁盘和内存中的检查点
                - 保护磁盘设备免受过载，帮助确保在高负载下的低延迟
            
                作为此工作的一部分，添加了两个数据节点配置参数：
                - `MaxDiskDataLatency`：限制磁盘访问的允许延迟程度，并导致超过此时长的事务中止。
                - `DiskDataUsingSameDisk`：通过增加磁盘数据表空间检查点的执行速度，使得可以利用将磁盘数据表空间放置在单独磁盘上的优势。
            
                此外，`ndbinfo` 数据库中添加了三个新表，用于提供有关磁盘数据性能的信息：
                - `diskstat`：报告过去一秒钟内对磁盘数据表空间的写入
                - `diskstats_1sec`：报告过去 20 秒内每秒对磁盘数据表空间的写入
                - `pgman_time_track_stats`：报告与磁盘数据表空间相关的磁盘操作延迟
            
              - **内存分配和 `TransactionMemory`**：新参数 `TransactionMemory` 简化了事务的数据节点内存分配，作为将事务内存和本地数据管理器（LDM）内存池化工作的组成部分。此参数旨在取代几个已弃用的旧事务内存参数。
            
                现在可以通过以下三种方式之一设置事务内存：
                - 设置 `TransactionMemory`。如果设置了 `TransactionMemory`，则使用此值确定事务内存。
                - 如果未设置 `TransactionMemory`，且未设置任何与 `TransactionMemory` 不兼容的参数，则由 NDB 设置事务内存。
                - 不能同时设置 `TransactionMemory` 和任何不兼容的参数（如 `MaxNoOfConcurrentOperations`、`MaxNoOfConcurrentScans`、`MaxNoOfConcurrentTransactions`、`MaxNoOfFiredTriggers`、`MaxNoOfLocalScans`、`TransactionBufferMemory`），否则管理服务器无法启动。
            
                了解更多信息，请参阅 `TransactionMemory` 描述以及[第 25.4.3.13 节，“数据节点内存管理”](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-data-node-memory-management.html)。
            
              - **支持额外的分片副本**：NDB 8.0 将生产环境中支持的最大分片副本数量从两个增加到四个（以前可以将 `NoOfReplicas` 设置为 3 或 4，但这未得到官方支持或验证）。
            
              - **切片恢复**：从 NDB 8.0.20 开始，可以将备份分成大致相等的部分（切片），并使用 ndb_restore 的两个新选项并行恢复这些切片：
                - `--num-slices`：确定备份应分成的切片数量。
                - `--slice-id`：提供当前 `ndb_restore` 实例要恢复的切片 ID。
            
                这使得可以使用多个 `ndb_restore` 实例并行恢复备份的子集，从而可能减少执行恢复操作所需的时间。
            
                了解更多信息，请参阅 `ndb_restore --num-slices` 选项描述。
            
              - **启用从任何分片副本读取**：默认情况下，所有 NDB 表启用从任何分片副本读取。这意味着系统变量 `ndb_read_backup` 的默认值现在是 `ON`，并且在创建新 NDB 表时，NDB 表注释选项 `READ_BACKUP` 的值为 1。启用从任何分片副本读取显著提高 NDB 表的读取性能，对写入影响最小。
            
                了解更多信息，请参阅 `ndb_read_backup` 系统变量描述以及[第 15.1.20.12 节，“设置 NDB 注释选项”](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-comment-options.html)。
            
              - **`ndb_blob_tool` 增强**：从 NDB 8.0.20 开始，`ndb_blob_tool` 工具可以检测存在内联部分但缺失 BLOB 部分的情况，并用占位符 BLOB 部分（由空格字符组成）替换这些部分。使用 `--check-missing` 选项检查是否缺少 BLOB 部分。使用 `--add-missing` 选项用占位符替换任何缺失的 BLOB 部分。
            
                了解更多信息，请参阅[第 25.5.6 节，“ndb_blob_tool — 检查和修复 NDB Cluster 表的 BLOB 和 TEXT 列”](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-ndb-blob-tool.html)。
            
              - **`ndbinfo` 版本控制**：NDB 8.0.20 及以后版本支持 `ndbinfo` 表的版本控制，并在内部维护其表的当前定义。启动时，NDB 将支持的 `ndbinfo` 版本与数据字典中存储的版本进行比较。如果版本不同，NDB 将删除任何旧的 `ndbinfo` 表，并使用当前定义重新创建它们
            
            - 。
            
                - **支持 Fedora Linux**：从 NDB 8.0.20 开始，Fedora Linux 是 NDB Cluster Community 版本的受支持平台，可以使用 Oracle 提供的 RPM 安装。这些 RPM 可从 [NDB Cluster 下载页面](https://dev.mysql.com/downloads/cluster/) 获得。
            
                - **NDB 程序 — NDBT 依赖关系移除**：删除了许多 NDB 实用程序程序对 NDBT 库的依赖。此库在内部用于开发，不需要用于正常使用；其包含在这些程序中可能在测试时导致问题。
            
                  受影响的程序如下所示，列出了移除依赖关系的 NDB 版本：
                  - `ndb_restore`
                  - `ndb_delete_all`
                  - `ndb_show_tables`（NDB 8.0.20）
                  - `ndb_waiter`（NDB 8.0.20）
            
                  这一更改对用户的主要影响是这些程序在运行完成后不再打印 `NDBT_ProgramExit - status`。升级到指定版本时依赖此行为的应用程序应进行相应更新。
            
                - **外键和字母大小写**：NDB 使用定义时的大小写存储外键的名称。以前，当系统变量 `lower_case_table_names` 的值设置为 0 时，它执行外键名称在 SQL 语句中的使用与存储的名称的大小写敏感比较。从 NDB 8.0.20 开始，这种比较现在始终以大小写不敏感的方式执行，而不考虑 `lower_case_table_names` 的值。
            
                - **多传输器**：NDB 8.0.20 引入了支持多个传输器处理数据节点之间的节点到节点通信。这有助于提高每个节点组的更新操作速率，并有助于避免系统或其他限制对使用单个套接字进行节点间通信的限制。
            
                  默认情况下，NDB 现在根据本地数据管理（LDM）线程或事务协调器（TC）线程的数量（以较大者为准）使用多个传输器。默认情况下，传输器数量等于该数量的一半。虽然默认设置对于大多数工作负载应表现良好，但可以通过设置 `NodeGroupTransporters` 数据节点配置参数（也在 NDB 8.0.20 中引入）来调整每个节点组使用的传输器数量，最多可以是 LDM 线程数或 TC 线程数中较大者的数量。将其设置为 0 会导致传输器数量与 LDM 线程数量相同。
            
                - **`ndb_restore`：主键架构更改**：NDB 8.0.21（及以后版本）支持在 `ndb_restore` 恢复 NDB 原生备份时使用 `--allow-pk-changes` 选项，源表和目标表具有不同的主键定义。支持增加和减少构成原始主键的列数量。

当主键扩展了额外的列时，添加的列必须定义为 `NOT NULL`，并且在备份期间这些列中的值不能更改。因为某些应用程序在更新行时会设置该行的所有列值，不论是否实际更改了所有值，这可能会导致恢复操作失败，即使主键中添加的列的值没有更改。您可以使用 NDB 8.0.21 中新增的 `--ignore-extended-pk-updates` 选项来覆盖此行为；在这种情况下，您必须确保没有更改这些值。

无论某列是否仍然是表的一部分，都可以从表的主键中删除该列。

有关更多信息，请参见 `ndb_restore` 的 `--allow-pk-changes` 选项的说明。

### 合并备份与 `ndb_restore`

在某些情况下，可能需要将最初存储在不同 NDB Cluster 实例中的数据（均使用相同的模式）合并到单个目标 NDB Cluster 中。这在使用 `ndb_mgm` 客户端创建的备份（参见 [第 25.6.8.2 节, “使用 NDB Cluster 管理客户端创建备份”](#)）并使用 `ndb_restore` 进行恢复时，通过使用 NDB 8.0.21 中新增的 `--remap-column` 选项以及 `--restore-data` 选项（以及可能需要或希望的其他兼容选项）来实现。`--remap-column` 可用于处理源集群之间主键和唯一键值重叠的情况，并确保它们在目标集群中不重叠，同时保持表之间的其他关系（例如外键）。

`--remap-column` 的参数格式为 `db.tbl.col:fn:args`，其中 `db`、`tbl` 和 `col` 分别是数据库、表和列的名称，`fn` 是重新映射函数的名称，`args` 是 `fn` 的一个或多个参数。没有默认值。仅支持 `offset` 作为函数名称，`args` 为在从备份插入到目标表时应用于列值的整数偏移量。该列必须是 `INT` 或 `BIGINT` 类型；偏移量的允许范围与该类型的有符号版本相同（如果需要，可以是负值）。

在同一次 `ndb_restore` 调用中，可以多次使用此新选项，以便可以重新映射同一表、不同表或两者的多个列的新值。偏移值不必在所有选项实例中都相同。

此外，从 NDB 8.0.21 开始，`ndb_desc` 提供了两个新选项：

- `--auto-inc`（简写为 `-a`）：如果表具有 `AUTO_INCREMENT` 列，则在输出中包括下一个自增值。
- `--context`（简写为 `-x`）：提供有关表的额外信息，包括模式、数据库名称、表名称和内部 ID。

有关更多信息和示例，请参见 `--remap-column` 选项的说明。

### 发送线程改进

从 NDB 8.0.20 开始，每个发送线程现在处理一个子集的传输器，每个块线程现在仅协助一个发送线程，从而增加了发送线程的数量，从而提高了性能和数据节点的可扩展性。

### 使用 `SpinMethod` 进行自适应旋转控制

一个简单的接口，用于在支持的平台上设置自适应 CPU 旋转，使用数据节点参数 `SpinMethod`。该参数（在 NDB 8.0.20 中添加，NDB 8.0.24 开始可用）有四个设置，分别用于静态旋转、基于成本的自适应旋转、延迟优化的自适应旋转以及为每个线程都有自己的 CPU 的数据库机器优化的自适应旋转。每个设置使数据节点使用一组预定值来启用自适应旋转、设置旋转时间和设置旋转开销，以适应给定场景，从而无需为常见使用情况直接设置这些值。

要精细调整旋转行为，还可以直接设置这些和其他旋转参数，使用现有的 `SchedulerSpinTimer` 数据节点配置参数以及 `ndb_mgm` 客户端中的以下 `DUMP` 命令：

- `DUMP 104000 (SetSchedulerSpinTimerAll)`：设置所有线程的旋转时间
- `DUMP 104001 (SetSchedulerSpinTimerThread)`：设置指定线程的旋转时间
- `DUMP 104002 (SetAllowedSpinOverhead)`：设置旋转开销为允许的 CPU 时间单位数，以获得 1 单位的延迟
- `DUMP 104003 (SetSpintimePerCall)`：设置调用旋转的时间
- `DUMP 104004 (EnableAdaptiveSpinning)`：启用或禁用自适应旋转

NDB 8.0.20 还增加了一个新的 TCP 配置参数 `TcpSpinTime`，用于设置给定 TCP 连接的旋转时间。

`ndb_top` 工具也进行了增强，提供每个线程的旋转时间信息。

有关详细信息，请参见 `SpinMethod` 参数、列出的 `DUMP` 命令和 [第 25.5.29 节, “ndb_top — 查看 NDB 线程的 CPU 使用信息”](#)。

### 磁盘数据和集群重启

从 NDB 8.0.21 开始，集群的初始重启会强制删除所有磁盘数据对象，如表空间和日志文件组，包括与这些对象关联的任何数据文件和撤消日志文件。

有关更多信息，请参见 [第 25.6.11 节, “NDB Cluster 磁盘数据表”](#)。

### 磁盘数据范围分配

从 NDB 8.0.20 开始，数据文件中的范围分配在给定表空间使用的所有数据文件中以循环方式进行。这有望在使用多个存储设备进行磁盘数据存储的情况下改善数据分布。

有关更多信息，请参见 [第 25.6.11.1 节, “NDB Cluster 磁盘数据对象”](#)。

### `--ndb-log-fail-terminate` 选项

从 NDB 8.0.21 开始，您可以在无法完全记录所有行事件时使 SQL 节点终止。可以通过启动 `mysqld` 并带有 `--ndb-log-fail-terminate` 选项来实现此目的。

### `AllowUnresolvedHostNames` 参数

默认情况下，当管理节点无法解析全局配置文件中存在的主机名时，拒绝启动，这在某些环境（如 Kubernetes）中可能会出现问题。从 NDB 8.0.22 开始，可以通过在集群全局配置文件（config.ini 文件）的 `[tcp default]` 部分中设置 `AllowUnresolvedHostNames=true` 来覆盖此行为。这样做会将此类错误视为警告，并允许 `ndb_mgmd` 继续启动。

### Blob 写入性能增强

NDB 8.0.22 实现了一系列改进，使在修改同一行中的多个 blob 列或在同一语句中修改包含 blob 列的多行时，可以更高效地进行批处理，从而减少在应用这些修改时 SQL 或其他 API 节点与数据节点之间所需的往返次数。因此，许多 `INSERT`、`UPDATE` 和 `DELETE` 语句的性能可以得到提高。此类语句的示例如下，其中 `table` 是包含一个或多个 Blob 列的 NDB 表：

- `INSERT INTO table VALUES ROW(1, blob_value1, blob_value2, ...)`，即插入包含一个或多个 Blob 列的行
- `INSERT INTO table VALUES ROW(1, blob_value1), ROW(2, blob_value2), ROW(3, blob_value3), ...`，即插入包含一个或多个 Blob 列的多行
- `UPDATE table SET blob_column1 = blob_value1, blob_column2 = blob_value2, ...`
- `UPDATE table SET blob_column = blob_value WHERE primary_key_column IN (value_list)`，其中主键列不是 Blob 类型
- `DELETE FROM table WHERE primary_key_column = value`，其中主键列不是 Blob 类型
- `DELETE FROM table WHERE primary_key_column IN (value_list)`，其中主键列不是 Blob 类型

其他 SQL 语句也可能受益于这些改进。这些包括 `LOAD DATA INFILE` 和 `CREATE TABLE ... SELECT ...`。此外，当 `table` 在执行语句之前使用其他存储引擎而非 NDB 时，`ALTER TABLE table ENGINE = NDB` 也可能执行得更有效率。

此增强适用于影响 MySQL 类型为 `BLOB`、`MEDIUMBLOB`、`LONGBLOB`、`TEXT`、`MEDIUMTEXT` 和 `LONGTEXT` 的列的语句。仅更新 `TINYBLOB` 或 `TINYTEXT` 列（或两者）的语句不受此工作影响，其性能也不会有变化。

由于需要扫描表 Blob 列，某些 SQL 语句的性能不会因该增强而显著提高，从而打破批处理。这类语句包括以下类型：

- `SELECT FROM table [WHERE key_column IN (blob_value_list)]`，其中按使用 Blob 类型的主键或唯一键列进行匹配选择行
- `UPDATE table SET blob_column = blob_value WHERE condition`，使用不依赖唯一值的条件
- `DELETE FROM table WHERE condition`，使用不依赖唯一值的条件删除包含一个或多个 Blob 列的行
- 在执行语句之前已使用 NDB 存储引擎的表上执行复制的 `ALTER TABLE` 语句，并且在执行语句之前或之后（或两者）其行包含一个或多个 Blob 列

为了充分利用这一改进，您可能希望增加 `mysqld` 的 `--ndb-batch-size` 和 `--ndb-blob-write-batch-bytes` 选项的值，以最小化修改 blobs 所需的往返次数。对于复制，还建议您启用 `slave_allow_batching` 系统变量，这可以最大限度地减少副本集群应用 epoch 事务所需的往返次数。

> 注意
> 从 NDB 8.0.30 开始，您应使用 `ndb_replica_batch_size` 代替 `--ndb-batch-size`，使用 `ndb_replica_blob_write_batch_bytes` 代替 `--ndb-blob-write-batch-bytes`。有关这些变量的说明以及 [第 25.7.5 节, “为复制准备 NDB Cluster”](#) 的更多信息，请参见这些变量的说明。

### Node.js 更新

从 NDB 8.0.22 开始，Node.js 的 NDB 适配器是使用 12.18.3 版本构建的，现在仅支持该版本（或更高版本）的 Node.js。

### 加密备份

NDB 8.0.22 增加了对使用 `AES-256-CBC` 加密的备份文件的支持；这旨在防止未授权方访问备份后恢复数据的风险。加密时，备份数据由用户提供的密码保护。密码可以是包含最多 256 个可打印 ASCII 字符（不包括 `!`、`'`、`"`、`$`、`%`、`\` 和 `^`）的任何字符串。用户或应用程序必须保留用于加密任何给定 NDB Cluster 备份的密码；NDB 不保存密码。密码可以为空，尽管不推荐这样做。

进行 NDB Cluster 备份时，可以通过使用管理客户端 `START BACKUP` 命令中的 `ENCRYPT PASSWORD=password` 进行加密。MGM API 用户还可以通过调用 `ndb_mgm_start_backup4()` 发起加密备份。

您可以使用 NDB Cluster 8.0.22 发行版中新增的 `ndbxfrm` 实用程序加密现有备份文件；此程序还可用于解密加密备份文件。此外，`ndbxfrm` 可以使用与 NDB Cluster 创建备份时设置 `CompressedBackup` 配置参数为 1 时采用的方法相同的方法压缩备份文件并解压缩压缩的备份文件。

要从加密备份恢复，请使用 `ndb_restore` 并带有 `--decrypt` 和 `--backup-password` 选项。这两个选项都是必需的，以及其他在备份未加密时恢复同一备份所需的任何其他选项。`ndb_print_backup_file` 和 `ndbxfrm` 也可以使用 `-P password` 和 `--decrypt-password=password` 读取加密文件。

在所有需要提供密码并带有加密或解密选项的情况下，必须引用密码；您可以使用单引号或双引号来限定密码。

从 NDB 8.0.24 开始，以下列出的几个 NDB 程序也支持从标准输入输入密码，类似于使用 `--password` 选项以交互方式登录 mysql 客户端的方式：

- 对于 `ndb_restore` 和 `ndb_print_backup_file`，`--backup-password-from-stdin` 选项使能以安全方式输入密码，类似于 mysql 客户端的 `--password` 选项。对于 `ndb_restore`，将该选项与 `--decrypt` 选项一起使用；对于 `ndb_print_backup_file`，使用该选项代替 `-P` 选项。
- 对于 `ndb_mgm`，`--backup-password-from-stdin` 选项与 `--execute "START BACKUP [options]"` 一起使用，以便从系统 shell 启动集群备份。
- `ndbxfrm` 选项 `--encrypt-password-from-stdin` 和 `--decrypt-password-from-stdin` 在使用该程序加密或解密备份文件时导致类似的行为。

有关更多信息，请参见所列程序的说明。

从 NDB 8.0.22 开始，还可以通过在集群全局配置文件的 `[ndbd default]` 部分中设置 `RequireEncryptedBackup=1` 来强制加密备份。这样做时，`ndb_mgm` 客户端会拒绝执行任何未加密的备份尝试。

从 NDB 8.0.24 开始，您可以通过启动时使用 `--encrypt-backup` 选项来使 `ndb_mgm` 在创建备份时使用加密。在这种情况下，如果没有提供密码，则在调用 `START BACKUP` 时会提示用户输入密码。

### IPv6 支持

从 NDB 8.0.22 开始，IPv6 地址支持管理节点和数据节点的连接；这包括管理节点和数据节点与 SQL 节点之间的连接。在配置集群时，可以使用数字 IPv6 地址、解析为 IPv6 地址的主机名或两者。

IPv6 地址能够正常工作，前提是部署集群的操作平台和网络支持 IPv6。与使用 IPv4 地址时一样，操作平台必须提供主机名解析为 IPv6 地址的功能。

在 Linux 平台上运行 NDB 8.0.22 及更高版本时的一个已知问题是，即使未使用 IPv6 地址，操作系统内核仍需要提供 IPv6 支持。此问题已在 NDB 8.0.34 及更高版本中修复，您可以在不打算使用 IPv6 地址的情况下安全地在 Linux 内核中禁用 IPv6 支持（Bug #33324817，Bug #33870642）。

NDB 继续支持 IPv4 地址。不推荐同时使用 IPv4 和 IPv6 地址，但在以下情况下可以正常工作：

- 当管理节点配置为使用 IPv6，数据节点配置为在 `config.ini` 文件中使用 IPv4 地址时：如果未使用 `--bind-address` 启动 `mgmd`，并且数据节点以 `--ndb-connectstring` 设置为管理节点的 IPv4 地址启动，则此方法有效。
- 当管理节点配置为使用 IPv4，数据节点配置为在 `config.ini` 文件中使用 IPv6 地址时：同样，如果未将 `--bind-address` 传递给 `mgmd`，并且数据节点以 `--ndb-connectstring` 设置为管理节点的 IPv6 地址启动，则此方法有效。

这些情况有效，因为 `ndb_mgmd` 默认不绑定到任何 IP 地址。

要从不支持 IPv6 地址的 NDB 版本升级到支持 IPv6 地址的版本，前提是网络支持 IPv4 和 IPv6，首先执行软件升级；完成后，您可以将 `config.ini` 文件中使用的 IPv4 地址更新为 IPv6 地址。之后，为了使配置更改生效并使集群开始使用 IPv6 地址，需要执行集群的系统重启。

### 自动安装程序弃用和移除

MySQL NDB Cluster 自动安装程序网页安装工具（`ndb_setup.py`）在 NDB 8.0.22 中弃用，并在 NDB 8.0.23 及更高版本中移除。它不再受支持。

### `ndbmemcache` 弃用和移除

`ndbmemcache` 不再受支持。`ndbmemcache` 在 NDB 8.0.22 中弃用，并在 NDB 8.0.23 中移除。

### `ndbinfo` `backup_id` 表

NDB 8.0.24 在 `ndbinfo` 信息数据库中添加了一个 `backup_id` 表。这是为了替代使用 `ndb_select_all` 转储内部 `SYSTAB_0` 表内容的方式，这种方式容易出错且执行时间过长。

该表包含一个单列单行，其中包含使用管理客户端命令 `START BACKUP` 进行的集群最近一次备份的 ID。如果找不到该集群的任何备份，该表包含单行，其列值为 0。

### 表分区增强

NDB 8.0.23 引入了一种新的表分区和碎片处理