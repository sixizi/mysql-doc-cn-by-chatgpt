### 25.2.4 MySQL NDB Cluster 8.0 新功能

以下部分描述了 NDB Cluster 8.0（至 8.0.38 版本）的实现变化，与早期版本相比的变化。NDB Cluster 8.0 从 NDB 8.0.19 开始作为 General Availability (GA) 版本提供。NDB Cluster 7.6 和 7.5 是之前仍支持的 GA 版本；有关 NDB Cluster 7.6 的信息，请参阅 [NDB Cluster 7.6 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-6.html)。有关 NDB Cluster 7.5 的类似信息，请参阅 [NDB Cluster 7.5 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-5.html)。NDB Cluster 7.4 和 7.3 是之前的 GA 版本，但已达到生命周期终点，不再支持或维护。我们建议新的生产部署使用 MySQL NDB Cluster 8.0。

#### NDB Cluster 8.0 的新特性

NDB Cluster 8.0 中主要的变更和新特性如下：

- **兼容性增强**：以下更改减少了 NDB 与其他 MySQL 存储引擎行为之间的长期非必要差异：

- **与 MySQL 服务器并行开发**：从此版本开始，MySQL NDB Cluster 与标准 MySQL 8.0 服务器并行开发，并采用新的统一发布模型，具有以下特点：
  - NDB 8.0 在 MySQL 8.0 源代码树中开发、构建和发布。
  - NDB Cluster 8.0 版本的编号方案与 MySQL 8.0 一致。
  - 构建带有 NDB 支持的源代码会在 `mysql -V` 返回的版本字符串中附加 `-cluster`，如以下示例所示：
    ```shell
    $> mysql -V
    mysql  Ver 8.0.38-cluster for Linux on x86_64 (Source distribution)
    ```
  - NDB 二进制文件继续显示 MySQL 服务器版本和 NDB 引擎版本，如下所示：
    ```shell
    $> ndb_mgm -V
    MySQL distrib mysql-8.0.38 ndb-8.0.38, for Linux (x86_64)
    ```
    在 MySQL Cluster NDB 8.0 中，这两个版本号总是相同的。
  - 要构建带有 NDB Cluster 支持的 MySQL 源代码，请使用 CMake 选项 `-DWITH_NDB`（NDB 8.0.31 及以后版本；对于更早的版本，使用 `-DWITH_NDBCLUSTER`）。

- **平台支持说明**：
  - NDB 8.0 不再支持 32 位平台。从 NDB 8.0.21 开始，NDB 构建过程会检查系统架构，如果不是 64 位平台则会中止。
  - 现在可以为 64 位 ARM CPU 从源代码构建 NDB。目前，该支持仅限于源代码，我们不提供此平台的预编译二进制文件。

- **数据库和表名**：
  - NDB 8.0 取消了以前对数据库和表标识符的 63 字节限制。这些标识符现在可以使用多达 64 字节，与其他 MySQL 存储引擎相同。详见[第 25.2.7.11 节，"NDB Cluster 8.0 中解决的先前 NDB Cluster 问题"](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-ndb-8-0-issues.html)。

- **自动生成的外键名称**：
  - NDB 现在使用 `tbl_name_fk_N` 模式为内部生成的外键命名，这与 InnoDB 使用的模式类似。

- **架构和元数据分发与同步**：
  - NDB 8.0 使用 MySQL 数据字典将架构信息分发到加入集群的 SQL 节点，并在现有 SQL 节点之间同步新的架构更改。以下是与此集成工作相关的个别增强功能：

    - **架构分发增强**：NDB 架构分发协调器在 NDB 8.0 中得到了扩展，以确保在架构操作结束时释放所用资源。以前，这些工作的一部分由架构分发客户端完成；由于客户端并不总是拥有所有必要的状态信息，当客户端决定在完成之前放弃架构操作而不通知协调器时，可能会导致资源泄漏。为了解决这个问题，架构操作超时检测已从架构分发客户端转移到协调器，使协调器有机会清理架构操作期间使用的任何资源。协调器现在会定期检查正在进行的架构操作是否超时，并在检测到超时时将尚未完成给定架构操作的参与者标记为失败。每当发生架构操作超时时，协调器还会提供适当的警告（应注意，在检测到此类超时后，架构操作本身会继续进行）。另外，当有一个或多个架构操作正在进行时，协调器会定期打印活动架构操作列表。

    - **磁盘数据文件分发**：NDB Cluster 8.0.14 使用 MySQL 数据字典确保磁盘数据文件和相关结构（如表空间和日志文件组）在所有连接的 SQL 节点之间正确分发。

    - **表空间对象的架构同步**：当 MySQL 服务器作为 SQL 节点连接到 NDB 集群时，它会将其数据字典与 NDB 字典中的信息进行检查和同步。以前，仅在连接新 SQL 节点时同步 NDB 对象（如数据库和表）；MySQL NDB Cluster 8.0 还实现了磁盘数据对象（包括表空间和日志文件组）的架构同步。这消除了 MySQL 数据字典和 NDB 字典在本地备份和恢复后可能出现的不匹配情况。

    - **数据库 DDL 同步增强**：NDB 8.0 中的工作确保新加入（或重新加入）的 SQL 节点与现有 SQL 节点上的数据库同步时，正确使用数据字典，以便在该 SQL 节点连接（或重新连接）到集群时，任何可能遗漏的数据库级操作（如 `CREATE DATABASE`、`ALTER DATABASE` 或 `DROP DATABASE`）都能正确地在该节点上复制。作为启动时执行的架构同步程序的一部分，SQL 节点现在会将集群数据节点上的所有数据库与其自己的数据字典进行比较，如果发现这些数据库中的任何一个在 SQL 节点的数据字典中缺失，SQL 节点会通过执行 `CREATE DATABASE` 语句在本地安装它。这样创建的数据库使用在执行语句时该 SQL 节点上生效的默认 MySQL 服务器数据库属性（如 `character_set_database` 和 `collation_database`）。

    - **NDB 元数据更改检测和同步**：NDB 8.0 实现了一种新的机制，用于检测 NDB 字典与 MySQL 数据字典之间的数据对象（如表、表空间和日志文件组）元数据的更新。这是通过一个后台线程完成的，该线程定期检查 NDB 字典和 MySQL 数据字典之间的一致性。该线程默认每 60 秒执行一次元数据检查。可以通过设置 `ndb_metadata_check_interval` 系统变量来调整轮询间隔；通过设置 `ndb_metadata_check` 系统变量为 `OFF` 可以完全禁用轮询。状态变量 `Ndb_metadata_detected_count` 显示自上次启动 mysqld 以来检测到的不一致次数。NDB 确保 NDB 数据库、表、日志文件组和表空间对象在启动后的操作过程中由元数据更改监控线程提交时，自动检查是否存在不匹配并由 NDB binlog 线程同步。NDB 8.0 增加了两个与自动同步相关的状态变量：`Ndb_metadata_synced_count` 显示自动同步的对象数量；`Ndb_metadata_excluded_count` 显示同步失败的对象数量（NDB 8.0.22 之前，该变量名为 `Ndb_metadata_blacklist_size`）。此外，您可以通过检查集群日志来查看哪些对象已同步。将 `ndb_metadata_sync` 系统变量设置为 true 会覆盖为 `ndb_metadata_check_interval` 和 `ndb_metadata_check` 所做的任何设置，使更改监控线程开始连续元数据更改检测。

    - **NDB 表额外元数据的变化**：NDB 表的额外元数据属性用于存储 MySQL 数据字典的序列化元数据，而不是像以前版本那样存储表的二进制表示（这是一个不再被 MySQL 服务器使用的 `.frm` 文件）。作为
    
    - 支持此更改工作的一部分，表的额外元数据的可用大小已增加。这意味着在 NDB Cluster 8.0 中创建的 NDB 表与以前的 NDB Cluster 版本不兼容。在以前版本中创建的表可以在 NDB 8.0 中使用，但之后无法再被早期版本打开。此元数据可通过 NDB API 方法 `getExtraMetadata()` 和 `setExtraMetadata()` 访问。
    
        - **在线升级使用 .frm 文件的表**：在 NDB 7.6 及以前版本中创建的表包含 `.frm` 文件形式的元数据，MySQL 8.0 不再支持此文件。为了促进在线升级到 NDB 8.0，NDB 在后台对这些元数据进行转换，并将其写入 MySQL 服务器的数据字典，这使得 NDB Cluster 8.0 中的 `mysqld` 能够处理表，同时不会阻止早期版本的 NDB 软件使用该表。
    
          > **重要**
          > 一旦在 NDB 8.0 中修改了表的结构，其元数据将使用数据字典存储，早期版本的 NDB 将无法再访问该表。
    
        - **元数据一致性检查错误日志记录**：作为 NDB 8.0 之前工作的一部分，自动同步过程中执行的元数据检查包括表名、存储引擎和内部 ID。从 NDB 8.0.23 开始，检查范围扩展到列、索引和外键等数据对象的属性。此外，任何元数据属性不匹配的详细信息现在会写入 MySQL 服务器错误日志。错误日志消息的格式略有不同，具体取决于不匹配是出现在表级别还是列、索引或外键级别。日志错误消息格式如下，其中 `property` 是属性名，`ndb_value` 是 NDB 字典中存储的属性值，`mysqld_value` 是 MySQL 数据字典中存储的属性值：
    
          ```plaintext
          Diff in 'property' detected, 'ndb_value' != 'mysqld_value'
          ```
          对于列、索引和外键属性的不匹配，格式如下，其中 `obj_type` 是列、索引或外键之一，`obj_name` 是对象名称：
    
          ```plaintext
          Diff in obj_type 'obj_name.property' detected, 'ndb_value' != 'mysqld_value'
          ```
          在 NDB Cluster 中，任何 mysqld 作为 SQL 节点安装的数据字典中的 NDB 表在自动同步期间会执行元数据检查。如果 mysqld 是调试编译的，则还会在执行 `CREATE TABLE` 语句时以及每次打开 NDB 表时进行检查。
    
        - **NDB_STORED_USER 的用户权限同步**：NDB 8.0 引入了一种新机制，使用 `NDB_STORED_USER` 权限在 SQL 节点之间共享和同步用户、角色和权限。NDB 7.6 及更早版本中的分布式权限不再受支持。创建用户帐户后，可以通过如下的 `GRANT` 语句将用户及其权限存储在 NDB 中，从而在集群的所有 SQL 节点之间共享：
          ```sql
          GRANT NDB_STORED_USER ON *.* TO 'jon'@'localhost';
          ```
    
        - **INFORMATION_SCHEMA 更改**：对 INFORMATION_SCHEMA FILES 表中有关磁盘数据文件的信息显示进行以下更改：
          - FILES 表中不再表示表空间和日志文件组。（这些结构实际上不是文件。）
          - 现在每个数据文件在 FILES 表中表示为一行。每个撤销日志文件也现在在此表中仅表示一行。（以前，表中的每个数据节点上的每个文件副本都显示一行。）此外，INFORMATION_SCHEMA 表现在填充了 MySQL Cluster 表的表空间统计信息。
    
        - **ndb_perror 错误信息**：已删除 `perror` 的已弃用 `--ndb` 选项。相反，使用 `ndb_perror` 从 NDB 错误代码中获取错误信息。
    
        - **条件下推增强**：以前，条件下推仅限于引用条件被推到的同一表中的列值。NDB 8.0 取消了此限制，使得条件推送可以引用查询计划中较早的表的列值。NDB 8.0 支持比较列表达式以及同一表中的列之间的比较。列和列表达式进行比较时必须完全相同类型；这意味着它们在适用时必须具有相同的符号、长度、字符集、精度和刻度。
    
          条件下推允许数据节点过滤掉更多行，从而减少 mysqld 在联接处理期间必须处理的行数。此增强功能的另一个好处是可以在 LDM 线程中并行执行过滤，而不是在 SQL 节点上的单个 mysqld 进程中；这有可能显著提高查询性能。
    
          现有规则继续适用于被比较的列值的类型兼容性。
    
        - **外联接和半联接的下推**：NDB 8.0.20 中的工作允许许多外联接和半联接（不仅仅是使用主键或唯一键查找的联接）下推到数据节点。
    
          现在可以下推的使用扫描的外联接包括符合以下条件的联接：
    
          - 表上没有未推送的条件
          - 同一联接嵌套中的其他表上没有未推送的条件，或在其上依赖的上层联接嵌套中
          - 同一联接嵌套中的所有其他表，或在其上依赖的上层联接嵌套中，也被推送
    
          如果使用索引扫描并满足上述下推外联接的条件，且使用 `firstMatch` 策略，则可以下推半联接。
    
          NDB 8.0.21 中的其他改进：
    
          - 通过 `NOT EXISTS` 和 `NOT IN` 查询的转换生成的 MySQL 优化器反联接可以下推到数据节点。
          - 当表上没有未推送的条件且查询满足任何其他条件时，可以下推反联接。
          - NDB 尝试在尝试从附加到的表中检索任何行之前识别和评估非依赖标量子查询。如果可以这样做，则使用获得的值作为推送条件的一部分，而不是使用提供该值的子查询。
    
          从 NDB 8.0.27 开始，作为推送查询一部分推送的条件现在可以引用同一推送查询内的祖先表中的列，条件如下：
    
          - 推送条件可以包括比较运算符 `<`、`<=`、`>`、`>=`、`=` 和 `<>`。
          - 被比较的值必须是相同类型，包括长度、精度和刻度。
          - NULL 处理根据 ISO SQL 标准指定的比较语义进行；任何与 NULL 的比较返回 NULL。
    
          例如，使用以下语句创建的表：
    
          ```sql
          CREATE TABLE t (
              x INT PRIMARY KEY,
              y INT
          ) ENGINE=NDB;
          ```
    
          现在，查询 `SELECT * FROM t AS m JOIN t AS n ON m.x >= n.y` 可以使用引擎条件下推优化将条件列 `y` 下推。
    
          当无法下推联接时，`EXPLAIN` 应提供原因。
    
        - **NDB API 方法** `branch_col_eq_param()`、`branch_col_ne_param()`、`branch_col_lt_param()`、`branch_col_le_param()`、`branch_col_gt_param()` 和 `branch_col_ge_param()` 在 NDB 8.0.27 中添加，作为此工作的组成部分。这些 `NdbInterpretedCode` 方法可以用于将列值与参数值进行比较。
    
          此外，`NdbScanFilter::cmp_param()` 也在 NDB 8.0.27 中添加，使得可以定义列值与参数值之间的比较，以用于执行扫描。
    
        - **增加最大行大小**：NDB 8.0 将 NDBCLUSTER 表中可以存储的最大字节数从 14000 增加到 30000 字节。BLOB 或 TEXT 列继续使用此总数的 264 字节，与以前一样。固定宽度列的最大偏移量仍为 8188 字节，与以前版本相比没有变化。
    
        - **`ndb_mgm SHOW` 命令和单用户模式**：在 NDB 8.0 中，当集群处于单用户模式时，管理客户端的 `SHOW` 命令输出指示哪个 API 或 SQL 节点在此模式生效期间具有独占访问权。
    
        - **在线列重命名**：NDB 表的列现在可以在线重命名，使用 `ALGORITHM=INPLACE`。详细信息请参阅[第 25.6.12 节，“NDB Cluster 中的 ALTER TABLE 在线操作”](https://dev.mysql.com/doc/refman/