### 25.2.4 MySQL NDB Cluster 8.0 新功能

以下部分描述了 NDB Cluster 8.0（至 8.0.38 版本）的实现变化，与早期版本相比的变化。NDB Cluster 8.0 从 NDB 8.0.19 开始作为 General Availability (GA) 版本提供。NDB Cluster 7.6 和 7.5 是之前仍支持的 GA 版本；有关 NDB Cluster 7.6 的信息，请参阅 [NDB Cluster 7.6 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-6.html)。有关 NDB Cluster 7.5 的类似信息，请参阅 [NDB Cluster 7.5 的新特性](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-what-is-new-7-5.html)。NDB Cluster 7.4 和 7.3 是之前的 GA 版本，但已达到生命周期终点，不再支持或维护。我们建议新的生产部署使用 MySQL NDB Cluster 8.0。

#### NDB Cluster 8.0 的新特性

NDB Cluster 8.0 中主要的变更和新特性如下：

- **兼容性增强**：以下更改减少了 NDB 与其他 MySQL 存储引擎行为之间的长期非必要差异：

- **与 MySQL 服务器并行开发**：从此版本开始，MySQL NDB Cluster 与标准 MySQL 8.0 服务器并行开发，并采用新的统一发布模型，具有以下特点：
  - NDB 8.0 在 MySQL 8.0 源代码树中开发、构建和发布。
  - NDB Cluster 8.0 版本的编号方案与 MySQL 8.0 一致。
  - 构建带有 NDB 支持的源代码会在 `mysql -V` 返回的版本字符串中附加 `-cluster`，如以下示例所示：
    ```shell
    $> mysql -V
    mysql  Ver 8.0.38-cluster for Linux on x86_64 (Source distribution)
    ```
  - NDB 二进制文件继续显示 MySQL 服务器版本和 NDB 引擎版本，如下所示：
    ```shell
    $> ndb_mgm -V
    MySQL distrib mysql-8.0.38 ndb-8.0.38, for Linux (x86_64)
    ```
    在 MySQL Cluster NDB 8.0 中，这两个版本号总是相同的。
  - 要构建带有 NDB Cluster 支持的 MySQL 源代码，请使用 CMake 选项 `-DWITH_NDB`（NDB 8.0.31 及以后版本；对于更早的版本，使用 `-DWITH_NDBCLUSTER`）。

- **平台支持说明**：
  - NDB 8.0 不再支持 32 位平台。从 NDB 8.0.21 开始，NDB 构建过程会检查系统架构，如果不是 64 位平台则会中止。
  - 现在可以为 64 位 ARM CPU 从源代码构建 NDB。目前，该支持仅限于源代码，我们不提供此平台的预编译二进制文件。

- **数据库和表名**：
  - NDB 8.0 取消了以前对数据库和表标识符的 63 字节限制。这些标识符现在可以使用多达 64 字节，与其他 MySQL 存储引擎相同。详见[第 25.2.7.11 节，"NDB Cluster 8.0 中解决的先前 NDB Cluster 问题"](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-ndb-8-0-issues.html)。

- **自动生成的外键名称**：
  - NDB 现在使用 `tbl_name_fk_N` 模式为内部生成的外键命名，这与 InnoDB 使用的模式类似。

- **架构和元数据分发与同步**：
  - NDB 8.0 使用 MySQL 数据字典将架构信息分发到加入集群的 SQL 节点，并在现有 SQL 节点之间同步新的架构更改。以下是与此集成工作相关的个别增强功能：

    - **架构分发增强**：NDB 架构分发协调器在 NDB 8.0 中得到了扩展，以确保在架构操作结束时释放所用资源。以前，这些工作的一部分由架构分发客户端完成；由于客户端并不总是拥有所有必要的状态信息，当客户端决定在完成之前放弃架构操作而不通知协调器时，可能会导致资源泄漏。为了解决这个问题，架构操作超时检测已从架构分发客户端转移到协调器，使协调器有机会清理架构操作期间使用的任何资源。协调器现在会定期检查正在进行的架构操作是否超时，并在检测到超时时将尚未完成给定架构操作的参与者标记为失败。每当发生架构操作超时时，协调器还会提供适当的警告（应注意，在检测到此类超时后，架构操作本身会继续进行）。另外，当有一个或多个架构操作正在进行时，协调器会定期打印活动架构操作列表。

    - **磁盘数据文件分发**：NDB Cluster 8.0.14 使用 MySQL 数据字典确保磁盘数据文件和相关结构（如表空间和日志文件组）在所有连接的 SQL 节点之间正确分发。

    - **表空间对象的架构同步**：当 MySQL 服务器作为 SQL 节点连接到 NDB 集群时，它会将其数据字典与 NDB 字典中的信息进行检查和同步。以前，仅在连接新 SQL 节点时同步 NDB 对象（如数据库和表）；MySQL NDB Cluster 8.0 还实现了磁盘数据对象（包括表空间和日志文件组）的架构同步。这消除了 MySQL 数据字典和 NDB 字典在本地备份和恢复后可能出现的不匹配情况。

    - **数据库 DDL 同步增强**：NDB 8.0 中的工作确保新加入（或重新加入）的 SQL 节点与现有 SQL 节点上的数据库同步时，正确使用数据字典，以便在该 SQL 节点连接（或重新连接）到集群时，任何可能遗漏的数据库级操作（如 `CREATE DATABASE`、`ALTER DATABASE` 或 `DROP DATABASE`）都能正确地在该节点上复制。作为启动时执行的架构同步程序的一部分，SQL 节点现在会将集群数据节点上的所有数据库与其自己的数据字典进行比较，如果发现这些数据库中的任何一个在 SQL 节点的数据字典中缺失，SQL 节点会通过执行 `CREATE DATABASE` 语句在本地安装它。这样创建的数据库使用在执行语句时该 SQL 节点上生效的默认 MySQL 服务器数据库属性（如 `character_set_database` 和 `collation_database`）。

    - **NDB 元数据更改检测和同步**：NDB 8.0 实现了一种新的机制，用于检测 NDB 字典与 MySQL 数据字典之间的数据对象（如表、表空间和日志文件组）元数据的更新。这是通过一个后台线程完成的，该线程定期检查 NDB 字典和 MySQL 数据字典之间的一致性。该线程默认每 60 秒执行一次元数据检查。可以通过设置 `ndb_metadata_check_interval` 系统变量来调整轮询间隔；通过设置 `ndb_metadata_check` 系统变量为 `OFF` 可以完全禁用轮询。状态变量 `Ndb_metadata_detected_count` 显示自上次启动 mysqld 以来检测到的不一致次数。NDB 确保 NDB 数据库、表、日志文件组和表空间对象在启动后的操作过程中由元数据更改监控线程提交时，自动检查是否存在不匹配并由 NDB binlog 线程同步。NDB 8.0 增加了两个与自动同步相关的状态变量：`Ndb_metadata_synced_count` 显示自动同步的对象数量；`Ndb_metadata_excluded_count` 显示同步失败的对象数量（NDB 8.0.22 之前，该变量名为 `Ndb_metadata_blacklist_size`）。此外，您可以通过检查集群日志来查看哪些对象已同步。将 `ndb_metadata_sync` 系统变量设置为 true 会覆盖为 `ndb_metadata_check_interval` 和 `ndb_metadata_check` 所做的任何设置，使更改监控线程开始连续元数据更改检测。

    - **NDB 表额外元数据的变化**：NDB 表的额外元数据属性用于存储 MySQL 数据字典的序列化元数据，而不是像以前版本那样存储表的二进制表示（这是一个不再被 MySQL 服务器使用的 `.frm` 文件）。作为