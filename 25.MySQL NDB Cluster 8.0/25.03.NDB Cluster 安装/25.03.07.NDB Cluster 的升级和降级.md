### 25.3.7 升级和降级 NDB Cluster

#### 升级到 NDB 8.0 支持的版本

#### 恢复 NDB Cluster 8.0 升级

#### 升级或降级 NDB Cluster 时的已知问题

本节提供关于 NDB Cluster 软件和不同 NDB Cluster 8.0 版本之间的兼容性的信息，涉及执行升级和降级。在尝试升级或降级之前，您应已熟悉 NDB Cluster 的安装和配置。请参阅第 25.4 节，“NDB Cluster 的配置”。

> **重要**
> 在 NDB 8.0 内的次要版本之间支持在线升级和降级。也支持包含的 MySQL 服务器（SQL 节点 `mysqld`）的就地升级；对于多个 SQL 节点，可以在重新启动单个 `mysqld` 进程时保持 SQL 应用程序在线。不支持包含的 MySQL 服务器的就地降级（请参阅第 4 章，降级 MySQL）。

在某些情况下，可能可以将最近从一个 NDB 8.0 次要版本升级到更高版本的操作恢复到先前版本，并恢复作为 SQL 节点运行的任何 MySQL 服务器实例所需的状态。鉴于可能需要或必要进行此操作，强烈建议在升级 NDB Cluster 之前对每个 SQL 节点进行完整备份。同样的原因，您还应使用 `--ndb-schema-dist-upgrade-allowed=0` 启动新版本的 `mysqld` 二进制文件，并且在确保不可能恢复到较旧版本之前，不允许将其设置回 `1`。有关更多信息，请参阅“恢复 NDB Cluster 8.0 升级”。

有关从早期版本升级到 NDB 8.0 的信息，请参阅“升级到 NDB 8.0 支持的版本”。

有关升级或降级 NDB 8.0 时遇到的已知问题的信息，请参阅“升级或降级 NDB Cluster 时的已知问题”。

#### 升级到 NDB 8.0 支持的版本

支持升级到 NDB Cluster 8.0 GA 版本（8.0.19 及更高版本）的 NDB Cluster 版本如下：

- NDB Cluster 7.6：NDB 7.6.4 及更高版本
- NDB Cluster 7.5：NDB 7.5.4 及更高版本
- NDB Cluster 7.4：NDB 7.4.6 及更高版本

要从 NDB 7.4 之前的版本系列升级，必须分阶段升级，首先升级到上述版本之一，然后从该版本升级到最新的 NDB 8.0 版本。在这种情况下，建议首先升级到最新的 NDB 7.6 版本。有关从以前版本升级到 NDB 7.6 的信息，请参阅“升级和降级 NDB 7.6”。

#### 恢复 NDB Cluster 8.0 升级

在最近将 NDB Cluster 软件升级到 NDB 8.0 版本后，可以将 NDB 软件恢复到先前版本，前提是满足某些条件，这些条件包括在升级前、运行新版本期间和将 NDB Cluster 软件恢复到先前版本之后的操作。具体情况取决于本地条件；本节提供关于在上述每个阶段应执行的操作的一般信息。

在大多数情况下，如前所述，升级和降级数据节点可以没有问题地完成；请参阅第 25.6.5 节，“执行 NDB Cluster 的滚动重启”。（在执行升级或降级之前，您应进行 NDB 备份；有关如何执行此操作的信息，请参阅第 25.6.8 节，“NDB Cluster 的在线备份”。）由于以下问题，不支持在线降级 SQL 节点：

- 如果 `mysqld` 从版本 8.0 版本检测到文件系统来自更高版本的 MySQL，则无法启动。
- 在许多情况下，`mysqld` 无法打开由更高版本的 MySQL 创建或修改的表。
- 在大多数情况下，`mysqld` 无法读取由更高版本的 MySQL 创建或修改的二进制日志文件。

接下来的过程提供了从版本 X 升级到版本 Y 所需的基本步骤，同时允许将来可能恢复到版本 X。（稍后本节中将介绍将升级后的集群恢复到版本 X 的过程。）为此，版本 X 是任何 NDB 8.0 GA 版本，或任何支持升级到 NDB 8.0 的早期 NDB 版本（请参阅“升级到 NDB 8.0 支持的版本”），版本 Y 是晚于 X 的 NDB 8.0 版本。

**升级前：** 备份 NDB X SQL 节点状态。这可以通过以下一种或多种方式完成：

- 使用一个或多个系统工具（如 `cp`、`rsync`、`fwbackups`、`Amanda` 等）复制版本 X SQL 节点文件系统的静态状态。
- 转储不存储在 NDB 中的任何版本 X 表。可以使用 `mysqldump` 生成此转储。
- 使用 MySQL 企业备份创建的备份；有关更多信息，请参阅第 32.1 节，“MySQL 企业备份概述”。

在任何升级之前都建议备份 SQL 节点，无论是否打算稍后将集群恢复到先前的 NDB 版本。

**升级到 NDB Y：** 必须使用 `--ndb-schema-dist-upgrade-allowed=0` 启动所有 NDB Y `mysqld` 二进制文件，以防止任何自动架构升级。（一旦确认不可能降级后，可以安全地在 `mysql` 客户端中将相应的系统变量 `ndb_schema_dist_upgrade_allowed` 改回 `1`，即默认值。）每个 NDB Y SQL 节点启动时，它会连接到集群并同步其 NDB 表架构。之后，可以从备份中恢复 MySQL 表和状态数据。

为了确保 NDB 复制的连续性，有必要以一种方式升级集群的 SQL 节点，以确保在升级过程中始终至少有一个 `mysqld` 充当复制源节点。对于两个 SQL 节点 A 和 B，可以按如下方式进行：

- 使用 SQL 节点 B 作为复制通道，将 SQL 节点 A 从 NDB 版本 X 升级到版本 Y。这会在 A 上的二进制日志中产生一个间隙，在 E1 时段。
- 在所有复制应用程序使用 SQL 节点 B 的二进制日志超过 E1 时段后，将复制通道切换为使用 SQL 节点 A。
- 将 SQL 节点 B 升级到 NDB 版本 Y。这会在 B 上的二进制日志中产生一个间隙，在 E2 时段。
- 在所有复制应用程序使用 SQL 节点 A 的二进制日志超过 E2 时段后，可以再次根据需要切换复制通道以使用任意 SQL 节点。

不要对任何现有 NDB 表使用 `ALTER TABLE`；不要创建在降级之前不能安全删除的任何新 NDB 表。

以下过程显示了在执行上述升级后，将 NDB Cluster 从版本 X 恢复到版本 Y 所需的基本步骤。在此，版本 X 是任何 NDB 8.0 GA 版本，或任何支持升级到 NDB 8.0 的早期 NDB 版本（请参阅“升级到 NDB 8.0 支持的版本”）；版本 Y 是晚于 X 的 NDB 8.0 版本。

**恢复前：** 从 NDB Y SQL 节点收集应保留的 `mysqld` 状态信息。在大多数情况下，可以使用 `mysqldump` 执行此操作。

在备份状态数据后，删除自升级以来创建或更改的所有 NDB 表。

在任何 NDB Cluster 软件版本更改之前，始终建议备份 SQL 节点。

您必须为每个 `mysqld`（SQL 节点）提供与 MySQL X 兼容的文件系统。可以使用以下两种方法之一：

- 通过重新初始化版本 X SQL 节点的磁盘状态来创建一个新的、兼容的文件系统状态。可以通过删除 SQL 节点文件系统，然后运行 `mysqld --initialize` 来完成此操作。
- 从升级前的备份恢复兼容的文件系统（请参阅第 9.4 节，“使用 mysqldump 进行备份”）。

**NDB 降级后：** 将数据节点降级到 NDB X 后，启动版本 X SQL 节点（`mysqld` 实例）。恢复或修复每个 SQL 节点上所需的任何其他本地状态信息。可以通过以下某些（0 个或多个）操作来对齐 `MySQLD` 状态：

- 初始化命令，例如 `mysqld --initialize`。
- 恢