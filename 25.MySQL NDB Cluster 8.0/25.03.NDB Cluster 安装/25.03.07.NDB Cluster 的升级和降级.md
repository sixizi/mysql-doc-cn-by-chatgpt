### 25.3.7 升级和降级 NDB Cluster

#### 升级到 NDB 8.0 支持的版本

#### 恢复 NDB Cluster 8.0 升级

#### 升级或降级 NDB Cluster 时的已知问题

本节提供关于 NDB Cluster 软件和不同 NDB Cluster 8.0 版本之间的兼容性的信息，涉及执行升级和降级。在尝试升级或降级之前，您应已熟悉 NDB Cluster 的安装和配置。请参阅第 25.4 节，“NDB Cluster 的配置”。

> **重要**
> 在 NDB 8.0 内的次要版本之间支持在线升级和降级。也支持包含的 MySQL 服务器（SQL 节点 `mysqld`）的就地升级；对于多个 SQL 节点，可以在重新启动单个 `mysqld` 进程时保持 SQL 应用程序在线。不支持包含的 MySQL 服务器的就地降级（请参阅第 4 章，降级 MySQL）。

在某些情况下，可能可以将最近从一个 NDB 8.0 次要版本升级到更高版本的操作恢复到先前版本，并恢复作为 SQL 节点运行的任何 MySQL 服务器实例所需的状态。鉴于可能需要或必要进行此操作，强烈建议在升级 NDB Cluster 之前对每个 SQL 节点进行完整备份。同样的原因，您还应使用 `--ndb-schema-dist-upgrade-allowed=0` 启动新版本的 `mysqld` 二进制文件，并且在确保不可能恢复到较旧版本之前，不允许将其设置回 `1`。有关更多信息，请参阅“恢复 NDB Cluster 8.0 升级”。

有关从早期版本升级到 NDB 8.0 的信息，请参阅“升级到 NDB 8.0 支持的版本”。

有关升级或降级 NDB 8.0 时遇到的已知问题的信息，请参阅“升级或降级 NDB Cluster 时的已知问题”。

#### 升级到 NDB 8.0 支持的版本

支持升级到 NDB Cluster 8.0 GA 版本（8.0.19 及更高版本）的 NDB Cluster 版本如下：

- NDB Cluster 7.6：NDB 7.6.4 及更高版本
- NDB Cluster 7.5：NDB 7.5.4 及更高版本
- NDB Cluster 7.4：NDB 7.4.6 及更高版本

要从 NDB 7.4 之前的版本系列升级，必须分阶段升级，首先升级到上述版本之一，然后从该版本升级到最新的 NDB 8.0 版本。在这种情况下，建议首先升级到最新的 NDB 7.6 版本。有关从以前版本升级到 NDB 7.6 的信息，请参阅“升级和降级 NDB 7.6”。

#### 恢复 NDB Cluster 8.0 升级

在最近将 NDB Cluster 软件升级到 NDB 8.0 版本后，可以将 NDB 软件恢复到先前版本，前提是满足某些条件，这些条件包括在升级前、运行新版本期间和将 NDB Cluster 软件恢复到先前版本之后的操作。具体情况取决于本地条件；本节提供关于在上述每个阶段应执行的操作的一般信息。

在大多数情况下，如前所述，升级和降级数据节点可以没有问题地完成；请参阅第 25.6.5 节，“执行 NDB Cluster 的滚动重启”。（在执行升级或降级之前，您应进行 NDB 备份；有关如何执行此操作的信息，请参阅第 25.6.8 节，“NDB Cluster 的在线备份”。）由于以下问题，不支持在线降级 SQL 节点：

- 如果 `mysqld` 从版本 8.0 版本检测到文件系统来自更高版本的 MySQL，则无法启动。
- 在许多情况下，`mysqld` 无法打开由更高版本的 MySQL 创建或修改的表。
- 在大多数情况下，`mysqld` 无法读取由更高版本的 MySQL 创建或修改的二进制日志文件。

接下来的过程提供了从版本 X 升级到版本 Y 所需的基本步骤，同时允许将来可能恢复到版本 X。（稍后本节中将介绍将升级后的集群恢复到版本 X 的过程。）为此，版本 X 是任何 NDB 8.0 GA 版本，或任何支持升级到 NDB 8.0 的早期 NDB 版本（请参阅“升级到 NDB 8.0 支持的版本”），版本 Y 是晚于 X 的 NDB 8.0 版本。

**升级前：** 备份 NDB X SQL 节点状态。这可以通过以下一种或多种方式完成：

- 使用一个或多个系统工具（如 `cp`、`rsync`、`fwbackups`、`Amanda` 等）复制版本 X SQL 节点文件系统的静态状态。
- 转储不存储在 NDB 中的任何版本 X 表。可以使用 `mysqldump` 生成此转储。
- 使用 MySQL 企业备份创建的备份；有关更多信息，请参阅第 32.1 节，“MySQL 企业备份概述”。

在任何升级之前都建议备份 SQL 节点，无论是否打算稍后将集群恢复到先前的 NDB 版本。

**升级到 NDB Y：** 必须使用 `--ndb-schema-dist-upgrade-allowed=0` 启动所有 NDB Y `mysqld` 二进制文件，以防止任何自动架构升级。（一旦确认不可能降级后，可以安全地在 `mysql` 客户端中将相应的系统变量 `ndb_schema_dist_upgrade_allowed` 改回 `1`，即默认值。）每个 NDB Y SQL 节点启动时，它会连接到集群并同步其 NDB 表架构。之后，可以从备份中恢复 MySQL 表和状态数据。

为了确保 NDB 复制的连续性，有必要以一种方式升级集群的 SQL 节点，以确保在升级过程中始终至少有一个 `mysqld` 充当复制源节点。对于两个 SQL 节点 A 和 B，可以按如下方式进行：

- 使用 SQL 节点 B 作为复制通道，将 SQL 节点 A 从 NDB 版本 X 升级到版本 Y。这会在 A 上的二进制日志中产生一个间隙，在 E1 时段。
- 在所有复制应用程序使用 SQL 节点 B 的二进制日志超过 E1 时段后，将复制通道切换为使用 SQL 节点 A。
- 将 SQL 节点 B 升级到 NDB 版本 Y。这会在 B 上的二进制日志中产生一个间隙，在 E2 时段。
- 在所有复制应用程序使用 SQL 节点 A 的二进制日志超过 E2 时段后，可以再次根据需要切换复制通道以使用任意 SQL 节点。

不要对任何现有 NDB 表使用 `ALTER TABLE`；不要创建在降级之前不能安全删除的任何新 NDB 表。

以下过程显示了在执行上述升级后，将 NDB Cluster 从版本 X 恢复到版本 Y 所需的基本步骤。在此，版本 X 是任何 NDB 8.0 GA 版本，或任何支持升级到 NDB 8.0 的早期 NDB 版本（请参阅“升级到 NDB 8.0 支持的版本”）；版本 Y 是晚于 X 的 NDB 8.0 版本。

**恢复前：** 从 NDB Y SQL 节点收集应保留的 `mysqld` 状态信息。在大多数情况下，可以使用 `mysqldump` 执行此操作。

在备份状态数据后，删除自升级以来创建或更改的所有 NDB 表。

在任何 NDB Cluster 软件版本更改之前，始终建议备份 SQL 节点。

您必须为每个 `mysqld`（SQL 节点）提供与 MySQL X 兼容的文件系统。可以使用以下两种方法之一：

- 通过重新初始化版本 X SQL 节点的磁盘状态来创建一个新的、兼容的文件系统状态。可以通过删除 SQL 节点文件系统，然后运行 `mysqld --initialize` 来完成此操作。
- 从升级前的备份恢复兼容的文件系统（请参阅第 9.4 节，“使用 mysqldump 进行备份”）。

**NDB 降级后：** 将数据节点降级到 NDB X 后，启动版本 X SQL 节点（`mysqld` 实例）。恢复或修复每个 SQL 节点上所需的任何其他本地状态信息。可以通过以下某些（0 个或多个）操作来对齐 `MySQLD` 状态：

- 初始化命令，例如 `mysqld --initialize`。
- 恢
- 复从版本 X SQL 节点捕获的任何所需或必需的状态信息。
  - 恢复从版本 Y SQL 节点捕获的任何所需或必需的状态信息。
  - 执行清理操作，例如删除过时的日志（二进制日志或中继日志），并删除不再有效的任何时间相关状态。

  与升级一样，在降级时为了保持 NDB 复制的连续性，有必要以一种方式降级集群的 SQL 节点，以确保在降级过程中始终至少有一个 `mysqld` 充当复制源节点。这可以以与之前描述的升级 SQL 节点非常相似的方式进行。对于两个 SQL 节点 A 和 B，可以按如下方式在降级期间保持二进制日志记录的连续性：

  - 使用 SQL 节点 B 作为复制通道，将 SQL 节点 A 从 NDB 版本 Y 降级到版本 X。这会在 A 上的二进制日志中产生一个间隙，在 F1 时段。
  - 在所有复制应用程序使用 SQL 节点 B 的二进制日志超过 F1 时段后，将复制通道切换为使用 SQL 节点 A。
  - 将 SQL 节点 B 降级到 NDB 版本 X。这会在 B 上的二进制日志中产生一个间隙，在 F2 时段。
  - 在所有复制应用程序使用 SQL 节点 A 的二进制日志超过 F2 时段后，恢复二进制日志记录的冗余，并且可以根据需要再次使用任意 SQL 节点作为复制通道。

  另请参阅第 25.7.7 节，“使用两个复制通道进行 NDB Cluster 复制”。

  #### 升级或降级 NDB Cluster 时的已知问题

  本节提供了在升级或降级到、从或在 NDB 8.0 版本之间时已知发生的问题的信息。

  我们建议在任何 NDB Cluster 软件升级或降级期间不要尝试任何架构更改。以下是一些原因：

  - 在数据节点启动的某些阶段，无法对 NDB 表执行 DDL 语句。
  - 如果在执行期间停止了任何数据节点，可能会拒绝对 NDB 表执行 DDL 语句；在升级或降级过程中，需要停止每个数据节点二进制文件（以便可以用目标版本的二进制文件替换它们）。
  - 在同一集群中运行不同版本 NDB Cluster 软件的数据节点时，不允许对 NDB 表执行 DDL 语句。

  有关执行在线升级或降级数据节点所使用的滚动重启过程的其他信息，请参阅第 25.6.5 节，“执行 NDB Cluster 的滚动重启”。

  在执行 NDB 8.0 的次要版本之间的在线升级时，您应了解以下列表中的问题。这些问题在从先前的主要版本 NDB Cluster 升级到任何 NDB 8.0 版本时也适用。

  NDB 8.0.22 增加了对在 `config.ini` 文件中管理节点和数据节点使用 IPv6 地址的支持。要在升级过程中开始使用 IPv6 地址，请执行以下步骤：

  1. 按常规方式将集群升级到 NDB 8.0.22 或更高版本的 NDB Cluster 软件。
  2. 将 `config.ini` 文件中使用的地址更改为 IPv6 地址。
  3. 执行系统重启集群。

  在运行 NDB 8.0.22 及更高版本时，Linux 平台上的一个已知问题是，即使不使用 IPv6 地址，操作系统内核也需要提供 IPv6 支持。此问题在 NDB 8.0.34 及更高版本中已修复（错误 #33324817，错误 #33870642）。

  如果使用受影响的版本，并且希望禁用系统上的 IPv6 支持（因为您不打算为 NDB Cluster 节点使用任何 IPv6 地址），可以在系统启动后执行以下操作：

  ```sh
  $> sysctl -w net.ipv6.conf.all.disable_ipv6=1
  $> sysctl -w net.ipv6.conf.default.disable_ipv6=1
  ```

  （或者，可以将相应的行添加到 `/etc/sysctl.conf`。）在 NDB Cluster 8.0.34 及更高版本中，不再需要上述操作，如果不需要，可以简单地在 Linux 内核中禁用 IPv6 支持。

  由于内部 `mysql.ndb_schema` 表的更改，如果升级到 NDB 8.0 版本之前的 8.0.24 版本，则建议使用 `--ndb-schema-dist-upgrade-allowed=0` 以避免意外中断（错误 #30876990，错误 #31016905）。

  此外，如果在升级到新版本后可能恢复到先前版本，则必须使用 `--ndb-schema-dist-upgrade-allowed=0` 启动所有 `mysqld` 进程，以防止对 `ndb_schema` 表进行与较旧版本不兼容的更改。有关如何执行此操作的信息，请参阅“恢复 NDB Cluster 8.0 升级”。

  在某些情况下，即使将 `EncryptedFileSystem` 配置参数明确设置为 0，也可能导致撤销日志文件被加密，这可能导致使用磁盘数据表时出现问题，并尝试升级或降级到 NDB 8.0.29。在这种情况下，可以通过在滚动重启过程中执行数据节点的初始重启来解决问题。

  如果使用多线程数据节点（`ndbmtd`）和 `ThreadConfig` 配置参数，则在从早期版本升级到 NDB 8.0.30 或更高版本时，可能需要更改 `config.ini` 文件中为此设置的值。从 NDB 8.0.23 或更早版本升级时，必须显式设置早期版本中隐含使用的主线程、复制线程、接收线程或 LDM 线程的使用。在从 NDB 8.0.23 或更高版本升级到 NDB 8.0.30 或更高版本时，必须显式设置接收线程的使用。此外，要避免在 NDB 8.0.30 或更高版本中使用主线程、复制线程或 LDM 线程，必须将给定类型的线程计数显式设置为 0。

  以下是一个示例。

  NDB 8.0.22 及更早版本：

  - `config.ini` 文件包含 `ThreadConfig=ldm`。
  - 这些 NDB 版本解释为 `ThreadConfig=main,ldm,recv,rep`。

  在 NDB 8.0.30 或更高版本中匹配效果所需的 `config.ini`：`ThreadConfig=main,ldm,recv,rep`。

  NDB 8.0.23—8.0.29：

  - `config.ini` 文件包含 `ThreadConfig=ldm`。
  - 这些 NDB 版本解释为 `ThreadConfig=ldm,recv`。

  在 NDB 8.0.30 或更高版本中匹配效果所需的 `config.ini`：`ThreadConfig=main={count=0},ldm,recv,rep={count=0}`。

  有关详细信息，请参阅 `ThreadConfig` 配置参数的描述。

  支持从以前的 NDB Cluster 主要版本（7.4、7.5、7.6）升级到 NDB 8.0；有关具体版本，请参阅“升级到 NDB 8.0 支持的版本”。这些升级受此处列出的问题的约束：

  - 在 NDB 8.0 中，`log_bin` 的默认值为 1，这是与早期版本的变化。此外，从 NDB 8.0.16 开始，`ndb_log_bin` 的默认值从 1 变为 0，这意味着在此版本及更高版本中，必须显式将 `ndb_log_bin` 设置为 1 以启用二进制日志记录。
  - 在早期发布系列中实现的 MySQL 服务器之间共享的分布式权限（请参阅“使用共享授权表的分布式权限”）在 NDB Cluster 8.0 中不受支持。启动时，NDB 8.0 及更高版本中提供的 `mysqld` 检查是否存在使用 NDB 存储引擎的授权表；如果发现任何授权表，则会使用 InnoDB 创建这些表的本地副本（“影子表”）。对于每个连接到 NDB Cluster 的 MySQL 服务器，都是如此。在所有作为 NDB Cluster SQL 节点的 MySQL 服务器上执行此操作后，可以使用 NDB Cluster 分发中提供的 `ndb_drop_table` 实用程序安全地删除 NDB 授权表，如下所示：

  ```sh
  ndb_drop_table -d mysql user db columns_priv tables_priv proxies_priv procs_priv
  ```

  保留 NDB 授权表是安全的，但它们不会用于访问控制，实际上会被忽略。

  有关 NDB 8.0 中使用的 MySQL 权限系统的更多信息，请参阅第 25.6.13 节，“权限同步和 NDB_STORED_USER”，以及第 8.2.3 节，“授权表”。

  在将任何版本早于 NDB 7.6 的版本升级到 NDB 8.0 版本时，有必要使用 `--initial` 重新启动所有数据节点。这是由于在 NDB 8.0 中增加了对更多节点数的支持。

  尝试从 NDB 8.0 降级到以前的主要版本时遇到的问题可以在以下列表中找到：

  - 在 NDB 8.0 中创建的表由于使用了额外的元数据属性以提供对 MySQL 数据字典的完全支持，而与 NDB 7.6 及更早版本不兼容。这意味着在降级之前需要采取额外步骤，以保留集群 SQL 节点的任何所需状态信息，然后恢复它。
  - 更具体地说，支持 NDBCLUSTER 存储引擎（即数据节点）的在线降级，但 SQL 节点不能在线降级。这是因为给定版本的 MySQL 服务器（`mysqld`）不能使用来自（更高）8.0 版本的系统文件，并且不能打开由更高版本创建的表。可能可以恢复最近从以前 NDB 版本升级的集群；有关何时以及如何执行此操作的信息，请参阅“恢复 NDB Cluster 8.0 升级”。

  有关这些问题的其他信息，请参阅“更改 NDB 表的额外元数据”；另请参阅第 16 章，MySQL 数据字典。

  在 NDB 8.0 中，二进制配置文件格式已增强，以支持比以前版本更多的节点数。新格式对运行旧版本 NDB 的节点不可访问，尽管较新的管理服务器可以检测到旧节点并使用适当的格式与它们通信。

  虽然升级到 NDB 8.0 在这方面不应有问题，但旧的管理服务器无法读取较新的二进制配置文件格式，因此在从 NDB 8.0 降级到以前的主要版本时需要进行一些手动干预。在执行这种降级时，必须在使用旧 NDB 软件版本启动管理服务器之前删除任何缓存的二进制配置文件，并让管理服务器读取明文配置文件。或者，可以使用 `--initial` 选项启动旧的管理服务器（再次需要提供 `config.ini`）。如果集群使用多个管理服务器，则必须对每个管理服务器二进制文件执行其中之一。

  此外，由于支持更多节点数，并且由于在 NDB 8.0 中对数据节点 LCP 系统文件的不可兼容更改，在从 NDB 8.0 到先前主要版本的在线降级时，必须使用 `--initial` 选项重新启动所有数据节点。

  运行超过 48 个数据节点或数据节点使用节点 ID 大于 48 的集群从 NDB 8.0 到早期 NDB Cluster 发布版的在线降级不受支持。在这种情况下，有必要减少数据节点数量，更改所有数据节点的配置，使它们使用的节点 ID 小于或等于 48，或者同时进行这两项操作，以确保不超过旧的最大值。

  如果从 NDB 8.0 降级到 NDB 7.5 或 NDB 7.4，则必须为集群配置文件中的 `IndexMemory` 设置显式值（如果尚未设置）。这是因为 NDB 8.0 不使用此参数（在 NDB 7.6 中已删除），默认情况下将其设置为 0，而在 NDB 7.5 和 NDB 7.4 中是必需的，这两个版本中如果 `IndexMemory` 未设置为非零值，集群会拒绝启动并显示“从管理服务器接收到的配置无效...”消息。

  从 NDB 8.0 降级到 NDB 7.6 不需要设置 `IndexMemory`。