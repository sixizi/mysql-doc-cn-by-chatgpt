### 6.2.17 可插拔认证

当客户端连接到MySQL服务器时，服务器使用客户端提供的用户名和客户端主机来从mysql.user系统表中选择相应的账户行。然后服务器对客户端进行认证，根据账户行确定哪个认证插件适用于该客户端：

- 如果服务器找不到插件，将发生错误并拒绝连接尝试。
- 否则，服务器调用该插件对用户进行认证，插件向服务器返回状态，表明用户是否提供了正确的密码并被允许连接。

可插拔认证使得以下重要功能成为可能：

- 认证方法的选择。可插拔认证使得数据库管理员可以轻松选择和更改用于单个MySQL账户的认证方法。
- 外部认证。可插拔认证使得客户端可以使用适用于在mysql.user系统表之外存储凭证的认证方法的凭证连接到MySQL服务器。例如，可以创建插件以使用PAM、Windows登录ID、LDAP或Kerberos等外部认证方法。
- 代理用户：如果允许用户连接，认证插件可以向服务器返回一个与连接用户名称不同的用户名，表明连接用户是另一个用户（被代理用户）的代理。在连接期间，出于访问控制目的，代理用户被视为具有被代理用户的特权。实际上，一个用户模仿了另一个用户。更多信息，请参见第6.2.19节，“代理用户”。

  > **注意**
  >
  > 如果使用`--skip-grant-tables`选项启动服务器，即使加载了认证插件，也不会使用，因为服务器不执行客户端认证，允许任何客户端连接。因为这是不安全的，如果服务器使用`--skip-grant-tables`选项启动，它还通过启用skip_networking禁用远程连接。

- [可用的认证插件](#可用的认证插件)
- [默认认证插件](#默认认证插件)
- [认证插件的使用](#认证插件的使用)
- [认证插件客户端/服务器兼容性](#认证插件客户端/服务器兼容性)
- [认证插件连接器编写考虑因素](#认证插件连接器编写考虑因素)
- [可插拔认证的限制](#可插拔认证的限制)

#### 可用的认证插件

MySQL 8.0 提供了以下认证插件：

- 一种执行本地认证的插件；即，基于在引入可插拔认证之前使用的密码哈希方法的认证。`mysql_native_password`插件基于此本地密码哈希方法实现认证。参见第6.4.1.1节，“本地可插拔认证”。

  > **注意**
  > 从MySQL 8.0.34开始，`mysql_native_password`认证插件已弃用，并可能在MySQL的未来版本中被移除。

- 使用SHA-256密码哈希执行认证的插件。这比本地认证提供更强的加密。参见第6.4.1.2节，“Caching SHA-2 可插拔认证”，和第6.4.1.3节，“SHA-256 可插拔认证”。

- 一种客户端插件，将密码发送到服务器，不进行哈希或加密。该插件与需要访问客户端用户提供的原始密码的服务器端插件一起使用。参见第6.4.1.4节，“客户端明文可插拔认证”。

- 一种使用PAM（可插拔认证模块）执行外部认证的插件，使MySQL服务器能够使用PAM来认证MySQL用户。此插件还支持代理用户。参见第6.4.1.5节，“PAM 可插拔认证”。

- 一种在Windows上执行外部认证的插件，使MySQL服务器能够使用原生Windows服务来认证客户端连接。已登录Windows的用户可以根据其环境中的信息从MySQL客户端程序连接到服务器，而无需指定额外的密码。这个插件也支持代理用户。参见第6.4.1.6节，“Windows 可插拔认证”。

- 使用LDAP（轻量级目录访问协议）执行认证的插件，通过访问如X.500等目录服务来认证MySQL用户。这些插件也支持代理用户。参见第6.4.1.7节，“LDAP 可插拔认证”。

- 使用Kerberos执行认证的插件，用于认证对应于Kerberos主体的MySQL用户。参见第6.4.1.8节，“Kerberos 可插拔认证”。

- 一种阻止使用它的任何账户进行客户端连接的插件。此插件的用例包括不应允许直接登录的代理账户（只能通过代理账户访问）和必须能够执行存储程序和视图以提高特权但不向普通用户暴露这些特权的账户。参见第6.4.1.9节，“无登录可插拔认证”。

- 一种插件，用于通过Unix套接字文件认证从本地主机连接的客户端。参见第6.4.1.10节，“套接字对等凭证可插拔认证”。

- 一种使用FIDO认证来认证MySQL服务器用户的插件。参见第6.4.1.11节，“FIDO 可插拔认证”。

  > **注意**
  > 从MySQL 8.0.35开始，`authentication_fido`和`authentication_fido_client`认证插件已弃用，并可能在MySQL的未来版本中被移除。

- 一种测试插件，检查账户凭证并将成功或失败记录到服务器错误日志。该插件用于测试和开发目的，以及作为编写认证插件的示例。参见第6.4.1.12节，“测试可插拔认证”。


> **注意**
>
> 有关当前对可插拔认证使用的限制信息，包括哪些连接器支持哪些插件，请参见可插拔认证的限制。
>
> 第三方连接器开发者应阅读该部分，以确定连接器可以利用可插拔认证功能的程度，以及采取什么步骤来变得更符合要求。

如果您有兴趣编写自己的认证插件，请参见编写认证插件。

#### 默认认证插件

`CREATE USER`和`ALTER USER`语句具有用于指定账户认证方式的语法。这些语法的某些形式没有显式命名认证插件（没有`IDENTIFIED WITH`子句）。例如：

```
CREATE USER 'jeffrey'@'localhost' IDENTIFIED BY 'password';
```
在这些情况下，服务器会为账户分配默认认证插件。在MySQL 8.0.27之前，此默认值为`default_authentication_plugin`系统变量的值。

从MySQL 8.0.27开始，引入了多因素认证，可以有多达三个子句指定账户的认证方式。为未命名插件的认证方法确定默认认证插件的规则因素具体：

- 因素1：如果`authentication_policy`元素1命名了认证插件，该插件是默认值。如果`authentication_policy`元素1是*，则`default_authentication_plugin`的值是默认值。

  根据上述规则，以下语句创建了一个双因素认证账户，其中第一个因素的认证方法由`authentication_policy`或`default_authentication_plugin`设置决定：

  ```
  CREATE USER 'wei'@'localhost' IDENTIFIED BY 'password'
    AND IDENTIFIED WITH authentication_ldap_simple;
  ```
  同样，这个示例创建了一个三因素认证账户：

  ```
  CREATE USER 'mateo'@'localhost' IDENTIFIED BY 'password'
    AND IDENTIFIED WITH authentication_ldap_simple
    AND IDENTIFIED WITH authentication_fido;
  ```
  您可以使用`SHOW CREATE USER`来查看应用的认证方法。

- 因素2或3：如果相应的`authentication_policy`元素命名了认证插件，该插件是默认值。如果`authentication_policy`元素是*或空，则没有默认值；尝试为因素定义账户认证方法而不命名插件是错误的，如以下示例所示：

  ```
  mysql> CREATE USER 'sofia'@'localhost' IDENTIFIED WITH authentication_ldap_simple 
         AND IDENTIFIED BY 'abc';
  ERROR 1524 (HY000): Plugin '' is not loaded
  
  mysql> CREATE USER 'sofia'@'localhost' IDENTIFIED WITH authentication_ldap_simple 
         AND IDENTIFIED BY 'abc';
  ERROR 1524 (HY000): Plugin '*' is not loaded
  ```

#### 认证插件的使用

本节提供安装和使用认证插件的一般指导。有关特定插件的指导，请参见第6.4.1节，“认证插件”下描述该插件的部分。

通常，可插拔认证使用服务器和客户端的对应插件，因此您可以这样使用给定的认证方法：

- 如有必要，安装包含适当插件的插件库。在服务器主机上，安装包含服务器端插件的库，以便服务器用它来认证客户端连接。类似地，在每个客户端主机上，安装包含客户端插件的库以供客户端程序使用。内置的认证插件不需要安装。
- 为您创建的每个MySQL账户指定适当的服务器端插件用于认证。如果账户将使用默认认证插件，则账户创建语句无需显式指定插件。服务器分配默认认证插件，如“默认认证插件”部分所述。
- 当客户端连接时，服务器端插件告诉客户端程序使用哪个客户端插件进行认证。

对于标准MySQL客户端，如mysql和mysqladmin，可以在命令行上指定`--default-auth=plugin_name`选项，作为程序预期使用的客户端插件的提示，尽管如果用户账户关联的服务器端插件需要不同的客户端插件，服务器会覆盖此设置。

如果客户端程序未找到客户端插件库文件，请指定`--plugin-dir=dir_name`选项以指示插件库目录的位置。

#### 认证插件客户端/服务器兼容性

可插拔认证在MySQL账户的认证方法选择上提供了灵活性，但在某些情况下，由于客户端和服务器之间的认证插件不兼容，无法建立客户端连接。

成功连接到给定服务器上的特定账户的一般兼容原则是，客户端和服务器都必须支持账户所需的认证方法。因为认证方法由认证插件实现，所以客户端和服务器都必须支持账户所需的认证插件。

认证插件不兼容性可能以多种方式出现。例如：

- 使用MySQL 5.7.22或更低版本的5.7客户端连接到使用`caching_sha2_password`进行认证的MySQL 8.0服务器账户。由于5.7客户端不识别这个在MySQL 8.0中引入的插件，连接失败。（在MySQL 5.7的5.7.23版本中解决了这个问题，当时`caching_sha2_password`客户端端支持被添加到MySQL客户端库和客户端程序中。）
- 使用MySQL 5.7客户端连接到使用`mysql_old_password`进行认证的5.7之前服务器账户。这会因多种原因失败。首先，这样的连接需要`--secure-auth=0`，这已不再是一个支持的选项。即使它被支持，5.7客户端也不识别这个插件，因为它在MySQL 5.7中被移除了。

- 使用社区版MySQL 5.7客户端连接到使用仅限企业版的LDAP认证插件之一进行认证的MySQL 5.7企业服务器账户。这会失败，因为社区客户端无法访问企业插件。

通常，当客户端和来自同一MySQL发行版的服务器之间建立连接时，不会出现这些兼容性问题。当客户端和来自不同MySQL系列的服务器之间建立连接时，可能会出现问题。这些问题是MySQL引入新认证插件或移除旧插件时开发过程中固有的。为了尽量减少不兼容性，应定期及时升级服务器、客户端和连接器。

#### 认证插件连接器编写考虑因素

存在多种实现MySQL客户端/服务器协议的实现。libmysqlclient C API客户端库是一种实现。一些MySQL连接器（通常是那些不是用C编写的）提供自己的实现。然而，并非所有协议实现都以相同的方式处理插件认证。本节描述了协议实现者应考虑的认证问题。

在客户端/服务器协议中，服务器告诉连接的客户端它认为默认的认证插件是什么。如果客户端使用的协议实现尝试加载默认插件，而该插件在客户端不存在，则加载操作失败。如果客户端尝试连接到的账户实际上需要的插件不是默认插件，这是一个不必要的失败。

如果客户端/服务器协议实现没有自己的默认认证插件概念，并且总是尝试加载服务器指定的默认插件，那么如果该插件不可用，它将以错误失败。

为了避免这个问题，客户端使用的协议实现应该有自己的默认插件，并应该将其作为首选（或者，在尝试加载服务器指定的默认插件失败的情况下回退到此默认）。例如：

- 在MySQL 5.7中，libmysqlclient将其默认选择设置为`mysql_native_password`或通过`mysql_options()`的`MYSQL_DEFAULT_AUTH`选项指定的插件。
- 当5.7客户端尝试连接到8.0服务器时，服务器指定`caching_sha2_password`作为其默认认证插件，但客户端仍然根据`mysql_native_password`或`MYSQL_DEFAULT_AUTH`发送凭据细节。
- 仅在需要更改插件的请求时，客户端才会加载服务器指定的插件，但在这种情况下，插件可能是任何插件，取决于用户账户。在这种情况下，客户端必须尝试加载插件，如果插件不可用，则错误是不可避免的。

#### 可插拔认证的限制

本节的第一部分描述了适用于第6.2.17节“可插拔认证”所述可插拔认证框架的一般限制。第二部分描述了第三方连接器开发者如何确定连接器可以利用可插拔认证功能的程度，以及采取什么步骤以变得更符合要求。

这里使用的“本地认证”一词指的是针对存储在mysql.user系统表中的密码进行的认证。这是旧版MySQL服务器在实现可插拔认证之前提供的相同认证方法。"Windows 本地认证" 指的是使用已登录到 Windows 的用户的凭据进行认证，如 Windows Native Authentication 插件（简称 "Windows 插件"）所实现的那样。

[一般可插拔认证限制](#一般可插拔认证限制)

[可插拔认证和第三方连接器](#可插拔认证和第三方连接器)

##### 一般可插拔认证限制

- Connector/C++：使用此连接器的客户端只能通过使用本地认证的账户连接到服务器。
  
  异常：如果连接器被构建为动态链接到 libmysqlclient（而不是静态链接），并且如果安装了当前版本的 libmysqlclient，则它加载当前版本的 libmysqlclient，或者如果连接器从源代码重新编译以链接到当前的 libmysqlclient，则连接器支持可插拔认证。

- Connector/NET：使用 Connector/NET 的客户端可以通过使用本地认证或 Windows 本地认证的账户连接到服务器。

- Connector/PHP：当使用 MySQL 原生 PHP 驱动器（mysqlnd）编译时，使用此连接器的客户端只能通过使用本地认证的账户连接到服务器。

- Windows 本地认证：通过使用 Windows 插件的账户进行连接需要 Windows 域设置。如果没有，将使用 NTLM 认证，此时只能进行本地连接；即客户端和服务器必须运行在同一台计算机上。

- 代理用户：代理用户支持取决于客户端是否可以通过使用实现代理用户能力的插件认证的账户进行连接（即，插件可以返回与连接用户不同的用户名）。例如，PAM 和 Windows 插件支持代理用户。mysql_native_password 和 sha256_password 认证插件默认不支持代理用户，但可以配置为支持；参见服务器对代理用户映射的支持。

- 复制：副本不仅可以使用具有本地认证的复制用户账户，还可以通过使用非本地认证的复制用户账户进行连接，前提是所需的客户端插件可用。如果插件内置于 libmysqlclient 中，则默认可用。否则，必须在副本端的 plugin_dir 系统变量指定的目录中安装插件。

- FEDERATED 表：FEDERATED 表只能通过远程服务器上使用本地认证的账户访问远程表。

##### 可插拔认证和第三方连接器

第三方连接器开发者可以使用以下指南来确定连接器利用可插拔认证功能的准备情况以及采取什么步骤变得更符合要求：

- 未进行任何更改的现有连接器使用本地认证，使用该连接器的客户端只能通过使用本地认证的账户连接到服务器。但是，应该对连接器进行测试，以验证是否仍然可以无问题地与最新版本的服务器建立此类连接。

  异常：如果连接器动态链接到 libmysqlclient（而不是静态链接），并且如果安装了当前版本的 libmysqlclient，则可能在不进行任何更改的情况下就能够与可插拔认证一起工作。

- 为了利用可插拔认证功能，基于 libmysqlclient 的连接器应该重新链接到当前版本的 libmysqlclient。这使连接器能够支持通过要求客户端插件的账户进行连接，这些插件现在内置于 libmysqlclient 中（例如，用于 PAM 认证所需的明文插件和用于 Windows 本地认证所需的 Windows 插件）。与当前的 libmysqlclient 链接还使连接器能够访问安装在默认 MySQL 插件目录中的客户端插件（通常是由本地服务器的 plugin_dir 系统变量的默认值指定的目录）。

- 如果连接器动态链接到 libmysqlclient，则必须确保在客户端主机上安装了更新版本的 libmysqlclient，并且连接器在运行时加载它。

- 另一种支持特定认证方法的方式是在客户端/服务器协议中直接实现它。Connector/NET 使用这种方法来提供对 Windows 本地认证的支持。

- 如果连接器应该能够从与默认插件目录不同的目录加载客户端插件，它必须实现某种方法来让客户端用户指定目录。可能的方法包括命令行选项或环境变量，连接器可以从中获取目录名称。标准的 MySQL 客户端程序，如 mysql 和 mysqladmin，实现了一个 `--plugin-dir` 选项。另请参见 C API 客户端插件接口。

- 连接器对代理用户的支持，如前所述，取决于它支持的认证方法是否允许代理用户。例如，PAM 和 Windows 插件支持代理用户。mysql_native_password 和 sha256_password 认证插件默认不支持代理用户，但可以配置为支持；参见服务器对代理用户映射的支持。

- 复制：副本不仅可以使用具有本地认证的复制用户账户，还可以通过使用非本地认证的复制用户账户进行连接，前提是所需的客户端插件可用。如果插件内置于 libmysqlclient 中，则默认可用。否则，必须在副本端的 plugin_dir 系统变量指定的目录中安装插件。

- FEDERATED 表：FEDERATED 表只能通过远程服务器上使用本地认证的账户访问远程表。

#### 可插拔认证和第三方连接器

第三方连接器开发者可以使用以下指南来确定连接器利用可插拔认证功能的准备情况以及采取什么步骤变得更符合要求：

- 未进行任何更改的现有连接器使用本地认证，使用该连接器的客户端只能通过使用本地认证的账户连接到服务器。但是，应该对连接器进行测试，以验证是否仍然可以无问题地与最新版本的服务器建立此类连接。

  异常：如果连接器动态链接到 libmysqlclient（而不是静态链接），并且如果安装了当前版本的 libmysqlclient，则可能在不进行任何更改的情况下就能够与可插拔认证一起工作。

- 为了利用可插拔认证功能，基于 libmysqlclient 的连接器应该重新链接到当前版本的 libmysqlclient。这使连接器能够支持通过要求客户端插件的账户进行连接，这些插件现在内置于 libmysqlclient 中（例如，用于 PAM 认证所需的明文插件和用于 Windows 本地认证所需的 Windows 插件）。与当前的 libmysqlclient 链接还使连接器能够访问安装在默认 MySQL 插件目录中的客户端插件（通常是由本地服务器的 plugin_dir 系统变量的默认值指定的目录）。

- 如果连接器动态链接到 libmysqlclient，则必须确保在客户端主机上安装了更新版本的 libmysqlclient，并且连接器在运行时加载它。

- 另一种支持给定认证方法的方法是在客户端/服务器协议中直接实现它。Connector/NET 使用这种方法来提供对 Windows 本地认证的支持。

- 如果连接器应该能够从不同于默认插件目录的目录加载客户端插件，它必须实现某种方法来让客户端用户指定目录。可能的方法包括命令行选项或环境变量，连接器可以从中获取目录名称。标准的 MySQL 客户端程序，如 mysql 和 mysqladmin，实现了一个 `--plugin-dir` 选项。另请参见 C API 客户端插件接口。

- 连接器对代理用户的支持，如前所述，取决于它支持的认证方法是否允许代理用户。