#### 6.2.3 授权表

MySQL系统数据库包含多个授权表，这些表包含有关用户账户及其拥有的特权的信息。本节描述了这些表。有关系统数据库中其他表的信息，请参见第5.3节，“mysql系统模式”。

此处的讨论描述了授权表的底层结构以及服务器在与客户端交互时如何使用它们的内容。然而，通常你不会直接修改授权表。当你使用诸如CREATE USER、GRANT和REVOKE之类的账户管理语句来设置账户并控制每个账户可用的特权时，会间接地进行修改。参见第13.7.1节，“账户管理语句”。当你使用此类语句进行账户操作时，服务器会代表你修改授权表。

> **注意**
>
> 不鼓励使用诸如INSERT、UPDATE或DELETE等语句直接修改授权表，这样做是自担风险的。如果由于此类修改导致行格式错误，服务器可以自由地忽略这些行。
>
> 对于任何修改授权表的操作，服务器都会检查表是否具有预期的结构，并在不符合时产生错误。要更新表到预期的结构，请执行MySQL升级程序。参见第2.10节，“升级MySQL”。

- [授权表概述](#授权表概述)
- [user和db授权表](#user和db授权表)
- [tables_priv和columns_priv授权表](#tables_priv和columns_priv授权表)
- [procs_priv授权表](#procs_priv授权表)
- [proxies_priv授权表](#proxies_priv授权表)
- [global_grants授权表](#global_grants授权表)
- [default_roles授权表](#default_roles授权表)
- [role_edges授权表](#role_edges授权表)
- [password_history授权表](#password_history授权表)
- [授权表范围列属性](#授权表范围列属性)
- [授权表特权列属性](#授权表特权列属性)
- [授权表并发性](#授权表并发性)

##### 授权表概述

这些mysql数据库表包含授权信息：

- user：用户账户、静态全局特权和其他非特权列。
- global_grants：动态全局特权。
- db：数据库级特权。
- tables_priv：表级特权。
- columns_priv：列级特权。
- procs_priv：存储过程和函数特权。
- proxies_priv：代理用户特权。
- default_roles：用户默认角色。
- role_edges：角色子图的边。
- password_history：密码更改历史。

有关静态和动态全局特权之间差异的信息，请参见静态与动态特权。

在MySQL 8.0中，授权表使用InnoDB存储引擎并且是事务性的。在MySQL 8.0之前，授权表使用MyISAM存储引擎并且是非事务性的。授权表存储引擎的更改使得伴随而来的账户管理语句（如CREATE USER或GRANT）的行为也发生了变化。以前，命名多个用户的账户管理语句可能对某些用户成功而对其他用户失败。现在，每个语句都是事务性的，如果出现任何错误，它要么对所有命名的用户成功，要么回滚并且没有任何效果。

每个授权表包含范围列和特权列：

- 范围列确定表中每行的范围；也就是说，行适用的上下文。例如，具有Host和User值为'h1.example.net'和'bob'的user表行适用于从主机h1.example.net向服务器发起的、指定用户名为bob的客户端的身份验证连接。类似地，具有Host、User和Db列值为'h1.example.net'、'bob'和'reports'的db表行适用于bob从主机h1.example.net连接以访问reports数据库时。tables_priv和columns_priv表包含指示每行适用的表或表/列组合的范围列。procs_priv的范围列指示每行适用的存储例程。

- 特权列指示表行授予的特权；也就是说，它允许执行的操作。服务器结合各种

授权表中的信息，形成用户特权的完整描述。第6.2.7节，“访问控制，第2阶段：请求验证”描述了这一点的规则。

此外，授权表可能包含用于范围或特权评估之外的目的的列。

服务器使用授权表的方式如下：

- user表的范围列决定是拒绝还是允许传入连接。对于被允许的连接，user表中授予的任何特权表示用户的静态全局特权。在这个表中授予的任何特权适用于服务器上的所有数据库。

  > **注意**
  >
  > 因为任何静态全局特权被视为所有数据库的特权，任何静态全局特权使用户能够通过SHOW DATABASES或查看INFORMATION_SCHEMA的SCHEMATA表来查看所有数据库名称，除了那些通过部分撤销在数据库级别受到限制的数据库。

- global_grants表列出了当前分配给用户账户的动态全局特权。对于每一行，范围列确定哪个用户拥有特权列中命名的特权。


- db表的范围列决定哪些用户可以从哪些主机访问哪些数据库。特权列决定允许的操作。在数据库级别授予的特权适用于数据库及其所有对象，如表和存储程序。


- tables_priv和columns_priv表与db表类似，但更细致：它们适用于表和列级别，而不是数据库级别。在表级别授予的特权适用于该表及其所有列。在列级别授予的特权仅适用于特定列。


- procs_priv表适用于存储过程（存储过程和函数）。在例程级别授予的特权仅适用于单个过程或函数。

- proxies_priv表指示哪些用户可以作为其他用户的代理，以及用户是否可以将PROXY特权授予其他用户。

- default_roles和role_edges表包含有关角色关系的信息。

- password_history表保留以前选择的密码，以启用对密码重复使用的限制。参见第6.2.15节，“密码管理”。

服务器在启动时将授权表的内容读入内存。你可以通过发出FLUSH PRIVILEGES语句或执行mysqladmin flush-privileges或mysqladmin reload命令来告诉服务器重新加载这些表。授权表的更改将按照第6.2.13节“特权更改生效时间”中所述生效。

当你修改一个账户时，最好验证你的更改是否具有预期的效果。要检查给定账户的特权，请使用SHOW GRANTS语句。例如，要确定授予用户名和主机名值为bob和pc84.example.com的账户的特权，请使用以下语句：

```
SHOW GRANTS FOR 'bob'@'pc84.example.com';
```

要显示账户的非特权属性，请使用SHOW CREATE USER：

```
SHOW CREATE USER 'bob'@'pc84.example.com';
```

##### user和db授权表

服务器在访问控制的第一和第二阶段（参见第6.2节，“访问控制和账户管理”）都使用mysql数据库中的user和db表。user和db表中的列如下所示。

表6.4 user和db表列

| Table Name                         | `user`                     | `db`                    |
| :--------------------------------- | :------------------------- | :---------------------- |
| ***Scope columns***            | `Host`                     | `Host`                  |
|                                    | `User`                     | `Db`                    |
|                                    |                            | `User`                  |
| ***Privilege columns***     | `Select_priv`              | `Select_priv`           |
|                                    | `Insert_priv`              | `Insert_priv`           |
|                                    | `Update_priv`              | `Update_priv`           |
|                                    | `Delete_priv`              | `Delete_priv`           |
|                                    | `Index_priv`               | `Index_priv`            |
|                                    | `Alter_priv`               | `Alter_priv`            |
|                                    | `Create_priv`              | `Create_priv`           |
|                                    | `Drop_priv`                | `Drop_priv`             |
|                                    | `Grant_priv`               | `Grant_priv`            |
|                                    | `Create_view_priv`         | `Create_view_priv`      |
|                                    | `Show_view_priv`           | `Show_view_priv`        |
|                                    | `Create_routine_priv`      | `Create_routine_priv`   |
|                                    | `Alter_routine_priv`       | `Alter_routine_priv`    |
|                                    | `Execute_priv`             | `Execute_priv`          |
|                                    | `Trigger_priv`             | `Trigger_priv`          |
|                                    | `Event_priv`               | `Event_priv`            |
|                                    | `Create_tmp_table_priv`    | `Create_tmp_table_priv` |
|                                    | `Lock_tables_priv`         | `Lock_tables_priv`      |
|                                    | `References_priv`          | `References_priv`       |
|                                    | `Reload_priv`              |                         |
|                                    | `Shutdown_priv`            |                         |
|                                    | `Process_priv`             |                         |
|                                    | `File_priv`                |                         |
|                                    | `Show_db_priv`             |                         |
|                                    | `Super_priv`               |                         |
|                                    | `Repl_slave_priv`          |                         |
|                                    | `Repl_client_priv`         |                         |
|                                    | `Create_user_priv`         |                         |
|                                    | `Create_tablespace_priv`   |                         |
|                                    | `Create_role_priv`         |                         |
|                                    | `Drop_role_priv`           |                         |
| ***Security columns***      | `ssl_type`                 |                         |
|                                    | `ssl_cipher`               |                         |
|                                    | `x509_issuer`              |                         |
|                                    | `x509_subject`             |                         |
|                                    | `plugin`                   |                         |
|                                    | `authentication_string`    |                         |
|                                    | `password_expired`         |                         |
|                                    | `password_last_changed`    |                         |
|                                    | `password_lifetime`        |                         |
|                                    | `account_locked`           |                         |
|                                    | `Password_reuse_history`   |                         |
|                                    | `Password_reuse_time`      |                         |
|                                    | `Password_require_current` |                         |
|                                    | `User_attributes`          |                         |
| ***Resource control columns*** | `max_questions`            |                         |
|                                    | `max_updates`              |                         |
|                                    | `max_connections`          |                         |
|                                    | `max_user_connections`     |                         |

user表的plugin和authentication_string列存储认证插件和凭证信息。

服务器使用账户行中plugin列中命名的插件来认证该账户的连接尝试。

plugin列必须是非空的。在启动时，以及执行FLUSH PRIVILEGES时，服务器会检查user表的行。对于任何plugin列为空的行，服务器会写入此类警告到错误日志：

```
[Warning] User entry '*user_name*'@'*host_name*' has an empty plugin value. The user will be ignored and no one can login with this user anymore.
```

password_expired列允许DBA使账户密码过期，并要求用户重置密码。password_expired的默认值是'N'，但可以用ALTER USER语句设置为'Y'。在账户密码过期后，该账户在随后连接到服务器时执行的所有操作都会导致错误，直到用户发出ALTER USER语句建立新的账户密码。

> **注意**
>
> 尽管可以通过将过期密码设置为其当前值来“重置”它，但出于良好政策，最好选择不同的密码。DBA可以通过建立适当的密码重用政策来执行非重用。参见密码重用政策。

`password_last_changed`是一个TIMESTAMP列，指示密码最后更改的时间。该值仅对使用MySQL内置认证插件（`mysql_native_password`、`sha256_password`或`caching_sha2_password`）的账户非NULL。对于其他账户，例如使用外部认证系统认证的账户，该值为NULL。

password_last_changed由CREATE USER、ALTER USER和SET PASSWORD语句更新，以及通过GRANT语句创建账户或更改账户密码时更新。

password_lifetime指示账户密码的生命周期，以天为单位。如果密码超过其生命周期（使用password_last_changed列评估），当客户端使用账户连接时，服务器会认为密码已过期。大于零的N值意味着密码必须每N天更改一次。0值禁用自动密码过期。如果该值为NULL（默认值），则适用全局过期政策，由default_password_lifetime系统变量定义。

account_locked指示账户是否被锁定（参见第6.2.20节，“账户锁定”）。

Password_reuse_history是账户的PASSWORD HISTORY选项的值，或者对于默认历史记录为NULL。

Password_reuse_time是账户的PASSWORD REUSE INTERVAL选项的值，或者对于默认间隔为NULL。

Password_require_current（在MySQL 8.0.13中添加）对应于账户的PASSWORD REQUIRE选项的值，如下表所示。

表6.5允许的Password_require_current值

| Password_require_current Value | Corresponding PASSWORD REQUIRE Option |
| :----------------------------- | :------------------------------------ |
| `'Y'`                          | `PASSWORD REQUIRE CURRENT`            |
| `'N'`                          | `PASSWORD REQUIRE CURRENT OPTIONAL`   |
| `NULL`                         | `PASSWORD REQUIRE CURRENT DEFAULT`    |

User_attributes（在MySQL 8.0.14中添加）是一个以JSON格式存储的列，用于存储其他列中未存储的账户属性。截至MySQL 8.0.21，INFORMATION_SCHEMA通过USER_ATTRIBUTES表公开这些属性。

User_attributes列可能包含以下属性：

- additional_password：辅助密码（如果有）。参见双密码支持。

- Restrictions：限制列表（如果有）。限制是通过部分撤销操作添加的。属性值是一个元素数组，每个元素都有Database和Restrictions键，指示受限数据库的名称以及适用于该数据库的限制（参见第6.2.12节，“使用部分撤销的权限限制”）。

- Password_locking：失败登录跟踪和临时账户锁定的条件（如果有）（参见失败登录跟踪和临时账户锁定）。Password_locking属性根据CREATE USER和ALTER USER语句的FAILED_LOGIN_ATTEMPTS和PASSWORD_LOCK_TIME选项进行更新。属性值是一个哈希表，其中failed_login_attempts和password_lock_time_days键指示已为账户指定的此类选项的值。如果键缺失，则其值隐含为0。如果键值隐含或显式为0，则相应的功能被禁用。此属性在MySQL 8.0.19中添加。

- multi_factor_authentication：mysql.user系统表中的行有一个plugin列，指示一个认证插件。对于单因素认证，该插件是唯一的认证因素。对于双因素或三因素形式的多因素认证，该插件对应于第一个认证因素，但需要存储第二和第三因素的额外信息。multi_factor_authentication属性保存此信息。此属性在MySQL 8.0.27中添加。

  multi_factor_authentication的值是一个数组，其中每个数组元素是一个哈希表，使用以下属性描述一个认证因素：

  - plugin：认证插件的名称。
  - authentication_string：认证字符串值。
  - passwordless：表示用户是否意在不使用密码（仅使用安全令牌作为唯一的认证方法）的标志。
  - requires_registration：定义用户账户是否已注册安全令牌的标志。

  第一个和第二个数组元素描述多因素认证因素2和3。

如果没有适用的属性，User_attributes为NULL。

示例：一个拥有辅助密码和部分撤销的数据库权限的账户，在列值中具有additional_password和Restrictions属性：