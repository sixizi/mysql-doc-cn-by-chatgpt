#### 6.2.11 账户分类

从 MySQL 8.0.16 开始，MySQL 引入了基于 `SYSTEM_USER` 权限的用户账户分类概念。

- [系统账户和普通账户](#系统账户和普通账户)
- [SYSTEM_USER权限影响的操作](#SYSTEM_USER权限影响的操作)
- [系统会话和普通会话](#系统会话和普通会话)
- [保护系统账户免受普通账户操纵](#保护系统账户免受普通账户操纵)

##### 系统账户和普通账户

MySQL 引入了用户账户分类的概念，根据是否拥有 `SYSTEM_USER` 权限，将系统用户和普通用户区分开来：

- 拥有 `SYSTEM_USER` 权限的用户是系统用户。
- 没有 `SYSTEM_USER` 权限的用户是普通用户。

`SYSTEM_USER` 权限影响给定用户可以应用其其他权限的账户，以及该用户是否受到其他账户的保护：

- 系统用户可以修改系统账户和普通账户。也就是说，拥有适当权限执行对普通账户进行的给定操作的用户，通过拥有 `SYSTEM_USER`，也能对系统账户执行该操作。系统账户只能被具有适当权限的系统用户修改，而不能被普通用户修改。
- 具有适当权限的普通用户可以修改普通账户，但不能修改系统账户。普通账户可以被具有适当权限的系统用户和普通用户修改。

如果用户具有对普通账户执行给定操作的适当权限，`SYSTEM_USER` 使用户也能对系统账户执行该操作。`SYSTEM_USER` 不暗示任何其他权限，因此执行给定账户操作的能力仍然取决于是否拥有任何其他所需权限。例如，如果用户可以向普通账户授予 `SELECT` 和 `UPDATE` 权限，那么拥有 `SYSTEM_USER` 的用户也可以向系统账户授予 `SELECT` 和 `UPDATE`。

区分系统账户和普通账户使得更好地控制某些账户管理问题成为可能，通过保护拥有 `SYSTEM_USER` 权限的账户免受没有该权限的账户的影响。例如，`CREATE USER` 权限不仅允许创建新账户，还允许修改和删除现有账户。在没有系统用户概念的情况下，拥有 `CREATE USER` 权限的用户可以修改或删除任何现有账户，包括 root 账户。系统用户的概念使得可以限制对 root 账户（本身是系统账户）的修改，使其只能由系统用户进行。拥有 `CREATE USER` 权限的普通用户仍然可以修改或删除现有账户，但只能是普通账户。

##### SYSTEM_USER权限影响的操作

`SYSTEM_USER` 权限影响以下操作：

- 账户操纵。
- 会话和会话中执行的语句的终止。
- 为存储对象设置 `DEFINER` 属性。
- 指定强制角色。
- 在 MySQL Enterprise Audit 的审核日志过滤器中覆盖“中止”项目。

##### 系统会话和普通会话

服务器内执行的会话被区分为系统会话或普通会话，类似于系统用户和普通用户之间的区别：

- 拥有 `SYSTEM_USER` 权限的会话是系统会话。
- 不拥有 `SYSTEM_USER` 权限的会话是普通会话。

普通会话只能执行允许给普通用户的操作。系统会话还能执行仅允许给系统用户的操作。

由于激活和停用角色可以改变会话所拥有的权限，会话可能会从普通会话变为系统会话，反之亦然。如果会话激活或停用具有 `SYSTEM_USER` 权

限的角色，适当的普通和系统会话之间的转换立即发生，仅对该会话有效：

- 如果普通会话激活具有 `SYSTEM_USER` 权限的角色，该会话成为系统会话。
- 如果系统会话停用具有 `SYSTEM_USER` 权限的角色，该会话成为普通会话，除非仍有其他具有 `SYSTEM_USER` 权限的角色处于活动状态。

##### 保护系统账户免受普通账户操纵

账户操纵包括创建和删除账户，授予和撤销权限，更改账户认证特征（如凭据或认证插件），以及更改其他账户特征（如密码过期政策）。

账户操纵可以通过两种方式进行：

- 使用如 `CREATE USER` 和 `GRANT` 这样的账户管理语句。这是首选方法。
- 通过使用如 `INSERT` 和 `UPDATE` 这样的语句直接修改授权表。这种方法不被鼓励，但对于拥有对包含授权表的 mysql 系统架构的适当权限的用户来说是可能的。

为了完全保护系统账户免受给定账户的修改，使其成为普通账户，并且不授予它对 mysql 架构的修改权限：

- `SYSTEM_USER` 权限需要使用如 `CREATE USER` 和 `GRANT` 这样的账户管理语句操纵系统账户。要阻止账户以这种方式修改系统账户，请将其设为普通账户，不授予 `SYSTEM_USER` 权限。这包括不向任何授予给该账户的角色授予 `SYSTEM_USER`。
- mysql 架构的权限允许通过直接修改授权表操纵系统账户，即使修改账户是普通账户。要限制普通账户通过直接修改授权表未经授权地修改系统账户，请不要向该账户（或任何授予给该账户的角色）授予 mysql 架构的修改权限。如果普通账户必须拥有适用于所有架构的全局权限，可以使用部分撤销施加的权限限制来防止对 mysql 架构的修改。参见第 6.2.12 节，“使用部分撤销的权限限制”。

假设您想创建一个名为 u1 的用户，该用户在所有架构上拥有所有权限，但 u1 应该是一个普通用户，没有修改系统账户的能力。假设 `partial_revokes` 系统变量已启用，按如下方式配置 u1：

```sql
CREATE USER u1 IDENTIFIED BY 'password';
GRANT ALL ON *.* TO u1 WITH GRANT OPTION;
-- GRANT ALL 包括 SYSTEM_USER，所以此时
-- u1 可以操纵系统或普通账户
REVOKE SYSTEM_USER ON *.* FROM u1;
-- 撤销 SYSTEM_USER 使 u1 成为普通用户；
-- 现在 u1 可以使用账户管理语句
-- 仅操纵普通账户
REVOKE ALL ON mysql.* FROM u1;
-- 这个部分撤销阻止 u1 直接
-- 修改授权表以操纵账户
```

要阻止账户访问 mysql 系统架构，如上所示，撤销其对 mysql 架构的所有权限。也可以允许对 mysql 架构的部分访问，例如只读访问。以下示例创建了一个账户，该账户在所有架构上具有 `SELECT`、`INSERT`、`UPDATE` 和 `DELETE` 权限，但在 mysql 架构上仅具有 `SELECT` 权限：

```sql
CREATE USER u2 IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON *.* TO u2;
REVOKE INSERT, UPDATE, DELETE ON mysql.* FROM u2;
```

另一种可能是撤销所有对 mysql 架构的权限，但授予对特定 mysql 表或列的访问权限。即使对 mysql 进行部分撤销，这也是可行的。以下语句仅为 u1 在 mysql 架构中提供对 db 表以及 user 表的 Host 和 User 列的只读访问权限：

```mysql
CREATE USER u3 IDENTIFIED BY 'password';
GRANT ALL ON *.* TO u3;
REVOKE ALL ON mysql.* FROM u3;
GRANT SELECT ON mysql.db TO u3;
GRANT SELECT(Host,User) ON mysql.user TO u3;
```

