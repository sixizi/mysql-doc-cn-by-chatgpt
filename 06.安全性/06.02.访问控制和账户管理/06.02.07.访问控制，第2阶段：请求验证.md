#### 6.2.7 访问控制，第 2 阶段：请求验证

服务器接受连接后，进入访问控制的第 2 阶段。对于您通过连接发出的每个请求，服务器确定您想要执行的操作，然后检查您的权限是否足够。这就是授权表中的权限列发挥作用的地方。这些权限可以来自 user、global_grants、db、tables_priv、columns_priv 或 procs_priv 表。（您可能会发现参考第 [6.2.3 节，“授权表”](./06.02.03.授权表.md)，其中列出了每个授权表中存在的列，会有所帮助。）

user 和 global_grants 表授予全局权限。这些表中给定账户的行指示适用于全局范围的账户权限，无论默认数据库是什么。例如，如果 user 表授予您 DELETE 权限，您可以删除服务器主机上任何数据库中的任何表的行。明智的做法是只向需要它们的人（如数据库管理员）授予 user 表中的权限。对于其他用户，将 user 表中的所有权限设置为 'N'，只在更具体的层面（特定数据库、表、列或程序）授予权限。也可以全局授予数据库权限，但使用部分撤销来限制它们在特定数据库上的使用（参见[第 6.2.12 节，“使用部分撤销限制权限”](./06.02.12.使用部分撤销限制权限.md)）。

db 表授予特定于数据库的权限。此表中范围列的值可以采取以下形式：

- 空白的 User 值匹配匿名用户。非空白值按字面意义匹配；用户名中没有通配符。
- 通配符字符 % 和 _ 可以用在 Host 和 Db 列中。它们的含义与使用 LIKE 运算符执行的模式匹配操作相同。如果在授予权限时想要将这两个字符中的任何一个作为字面字符使用，必须用反斜杠转义。例如，要将下划线字符 (_) 作为数据库名称的一部分，需要在 GRANT 语句中将其指定为 \_。
- '%' 或空白的 Host 值意味着“任何主机”。
- '%' 或空白的 Db 值意味着“任何数据库”。

服务器读取 db 表并将其载入内存，并在读取 user 表的同时对其进行排序。服务器根据 Host、Db 和 User 范围列对 db 表进行排序。与 user 表一样，排序将最具体的值放在最前面，最不具体的值放在最后面，当服务器查找匹配行时，它使用它找到的第一个匹配项。

tables_priv、columns_priv 和 procs_priv 表授予特定于表、列和程序的权限。这些表中范围列的值可以采取以下形式：

- 通配符字符 % 和 _ 可以用在 Host 列中。它们的含义与使用 LIKE 运算符执行的模式匹配操作相同。
- '%' 或空白的 Host 值意味着“任何主机”。
- Db、Table_name、Column_name 和 Routine_name 列不能包含通配符或为空。

服务器根据 Host、Db 和 User 列对 tables_priv、columns_priv 和 procs_priv 表进行排序。这与 db 表排序类似，但更简单，因为只有 Host 列可以包含通配符。

服务器使用排序后的表来验证它收到的每个请求。对于需要管理员权限的请求，如 SHUTDOWN 或 RELOAD，服务器仅检查 user 和 global_privilege 表，因为这些表是唯一指定管理员权限的表。如果这些表中的账户行允许请求的操作，服务器将授予访问权限，否则将拒绝访问。

例如，如果您想执行 mysqladmin shutdown，但您的 user 表行没有授予您 SHUTDOWN 权限，服务器会拒绝访问，而不会检查 db 表。（后者表中没有 Shutdown_priv 列，所以无需检查。）

对于与数据库相关的请求（如 INSERT、UPDATE 等），服务器首先检查 user 表行中用户的全局权限（减去部分撤销所施加的任何权限限制）。如果该行允许请求的操作，则授予访问权限。如果 user 表中的全局权限不足，服务器将从 db 表确定用户的特定于数据库的权限：

- 服务器在 db 表中查找 Host、Db 和 User 列的匹配项。
- Host 和 User 列与连接用户的主机名和 MySQL 用户名匹配。
- Db 列与用户希望访问的数据库匹配。
- 如果没有 Host 和 User 的行，则拒绝访问。

在确定 db 表行授予的特定于数据库的权限后，服务器将这些权限添加到 user 表授予的全局权限中。如果结果允许请求的操作，则授予访问权限。否则，服务器依次检查用户的表和列权限，在 tables_priv 和 columns_priv 表中添加这些权限，并根据结果允许或拒绝访问。对于存储程序操作，服务器使用 procs_priv 表而不是 tables_priv 和 columns_priv 表。

用布尔术语表达，上述描述如何计算用户权限的内容可以总结如下：

```
全局权限
OR 数据库权限
OR 表权限
OR 列权限
OR 程序权限
```

如果最初发现全局权限不足以进行请求的操作，为什么服务器稍后会将这些权限添加到数据库、表和列权限中，这可能不太明显。原因是一个请求可能需要多种类型的权限。例如，如果您执行 `INSERT INTO ... SELECT` 语句，您需要 INSERT 和 SELECT 权限。您的权限可能是这样的，user 表行为一个权限授予全局权限，而 db 表行为相关数据库特别授予另一个权限。在这种情况下，您具有执行请求所需的权限，但服务器无法仅从您的全局权限或数据库权限中判断出这一点。它必须基于组合权限做出访问控制决定。