#### 6.1.7 客户端编程安全指南

访问 MySQL 的客户端应用程序应遵循以下指南，以避免错误解释外部数据或泄露敏感信息。

[正确处理外部数据](#正确处理外部数据)

[正确处理 MySQL 错误消息](#正确处理 MySQL 错误消息)

##### 正确处理外部数据

访问 MySQL 的应用程序不应信任用户输入的任何数据，用户可能会尝试通过在 Web 表单、URL 或您构建的任何应用程序中输入特殊或转义字符序列来欺骗您的代码。确保如果用户尝试通过在表单中输入像` ; DROP DATABASE mysql; `这样的内容来进行 SQL 注入，您的应用程序仍然保持安全。这是一个极端的例子，但如果您不为此做准备，黑客使用类似技术可能导致大量安全漏洞和数据丢失。

一个常见的错误是仅保护字符串数据值。记住也要检查数字数据。如果应用程序生成类似 SELECT * FROM table WHERE ID=234 的查询，当用户输入值 234 时，用户可以输入 234 OR 1=1，使应用程序生成查询 SELECT * FROM table WHERE ID=234 OR 1=1。结果，服务器检索表中的每一行。这暴露了每一行并导致服务器过载。防止这种攻击的最简单方法是在数字常量周围使用单引号：SELECT * FROM table WHERE ID='234'。如果用户输入额外的信息，它都成为字符串的一部分。在数字上下文中，MySQL 自动将此字符串转换为数字，并去除其中的任何非数字尾随字符。

有时人们认为，如果数据库只包含公开可用的数据，那么就不需要保护。这是错误的。即使显示数据库中的任何行是允许的，您仍应保护免受拒绝服务攻击（例如，基于前一段所述的技术，导致服务器浪费资源）。否则，您的服务器将无法响应合法用户。

清单：

- 启用严格的 SQL 模式，告诉服务器对它接受的数据值更加限制。参见第 5.1.11 节，“服务器 SQL 模式”。


- 尝试在所有 Web 表单中输入单引号和双引号（' 和 "）。如果您收到任何 MySQL 错误，请立即调查问题。


- 尝试通过添加 %22（"）、%23（#）和 %27（'）来修改动态 URL。


- 尝试通过使用前面示例中显示的字符将动态 URL 中的数据类型从数字类型修改为字符类型。您的应用程序应该安全地防范这些及类似攻击。


- 尝试在数字字段中输入字符、空格和特殊符号而不是数字。您的应用程序应在将它们传递给 MySQL 之前删除它们，否则会产生错误。将未经检查的值传递给 MySQL 非常危险！


- 在将数据传递给 MySQL 之前检查数据大小。


- 让您的应用程序使用与您用于管理目的不同的用户名连接到数据库。不要给您的应用程序授权其不需要的访问权限。


许多应用程序编程接口提供了一种转义数据值中特殊字符的方法。正确使用时，这可以防止应用程序用户输入导致应用程序生成意图之外效果的语句的值：

- MySQL SQL 语句：使用 SQL 预备语句，并仅通过占位符接受数据值；参见第 13.5 节，“预备语句”。

- MySQL C API：使用 mysql_real_escape_string_quote() API 调用。或者，使用 C API 预备语句接口，并仅通过占位符接受数据值；参见 C API 预备语句接口。

- MySQL++：对查询流使用 escape 和 quote 修饰符。

- PHP：使用 mysqli 或 pdo_mysql 扩展，而不是较旧的 ext/mysql 扩展。首选 API 支持改进的 MySQL 认证协议和密码，以及带有占位符的预备语句。另见 MySQL 和 PHP。

  如果必须使用较旧的 ext/mysql 扩展，则用于转义的是 mysql_real_escape_string_quote() 函数，而不是 mysql_escape_string() 或 addslashes()，因为只有 mysql_real_escape_string_quote() 是字符集感知的；使用（无效的）多字节字符集时，其他函数可能被“绕过”。

- Perl DBI：使用占位符或 quote() 方法。
- Java JDBC：使用 PreparedStatement 对象和占位符。

其他编程接口可能有类似的功能。

##### 正确处理 MySQL 错误消息

处理由于在 MySQL 数据库服务器上执行 SQL 语句而发生的错误是应用程序的责任，并适当地处理它们。

MySQL 错误中返回的信息不是无关紧要的，因为该信息是调试使用 MySQL 的应用程序的关键。例如，要调试一个常见的 10 路连接 SELECT 语句而不提供有关涉及问题的数据库、表和其他对象的信息几乎是不可能的。因此，MySQL 错误有时必须包含对这些对象名称的引用。

应用程序在收到 MySQL 的此类错误时，一种简单但不安全的方法是拦截它并逐字地向客户端显示。然而，揭示错误信息是已知的应用程序漏洞类型（CWE-209），应用程序开发者必须确保应用程序没有这种漏洞。

例如，一个显示如下消息的应用程序向客户端暴露了数据库名和表名，这是客户端可能试图利用的信息：

```
ERROR 1146 (42S02): Table 'mydb.mytable' doesn't exist
```

相反，应用程序在收到 MySQL 的此类错误时的适当行为是将适当信息（包括错误信息）记录到仅受信任人员可访问的安全审计位置。应用程序可以向用户返回更通用的内容，如“内部错误”。