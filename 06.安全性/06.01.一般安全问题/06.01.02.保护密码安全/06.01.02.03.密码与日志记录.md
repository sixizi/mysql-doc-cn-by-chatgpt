#### 6.1.2.3 密码与日志记录

密码可以在如 CREATE USER、GRANT 和 SET PASSWORD 这样的 SQL 语句中以明文形式写入。如果 MySQL 服务器按照原样记录这些语句，那么其中的密码对于任何有权访问日志的人都是可见的。

对于以下语句，语句日志记录避免了以明文形式写入密码：

```mysql
CREATE USER ... IDENTIFIED BY ...
ALTER USER ... IDENTIFIED BY ...
SET PASSWORD ...
START SLAVE ... PASSWORD = ...
START REPLICA ... PASSWORD = ...
CREATE SERVER ... OPTIONS(... PASSWORD ...)
ALTER SERVER ... OPTIONS(... PASSWORD ...)
```

这些语句中的密码被重写，以便在写入到常规查询日志、慢查询日志和二进制日志的语句文本中不直接出现。重写不适用于其他语句。特别是，对 mysql.user 系统表的 INSERT 或 UPDATE 语句，如果涉及到明文密码，则会按原样记录，因此应避免使用这样的语句。（直接修改授权表本来就不鼓励。）

对于常规查询日志，通过使用 `--log-raw` 选项启动服务器可以抑制密码重写。出于安全考虑，不建议在生产环境中使用此选项。出于诊断目的，查看服务器收到的语句的确切文本可能是有用的。

默认情况下，由审计日志插件产生的审计日志文件内容不加密，并可能包含敏感信息，如 SQL 语句的文本。出于安全原因，应将审计日志文件写入仅对 MySQL 服务器和有正当理由查看日志的用户可访问的目录中。参见第 6.4.5.3 节，“MySQL Enterprise Audit 安全考虑”。

如果安装了查询重写插件（参见查询重写插件），服务器收到的语句可能会被重写。在这种情况下，--log-raw 选项对语句日志记录的影响如下：

- 没有 --log-raw，服务器记录查询重写插件返回的语句。这可能与收到的语句不同。


- 有 --log-raw，服务器记录原始语句，即收到的语句。


密码重写的一个含义是，不能解析的语句（例如，由于语法错误）不会被写入常规查询日志，因为无法确认它们是否不包含密码。需要记录包括有错误的所有语句的用例应使用 --log-raw 选项，同时记住这也绕过了密码重写。

密码重写只在预期明文密码时发生。对于预期密码哈希值的语法的语句，不进行重写。如果错误地为此类语法提供了明文密码，则密码会按给定的方式记录，不进行重写。

为了保护日志文件不受不当暴露，将它们放置在限制访问的目录中，仅对服务器和数据库管理员可访问。如果服务器记录到 mysql 数据库中的表，仅授予数据库管理员访问这些表的权限。

副本在其连接元数据仓库中存储复制源服务器的密码，该仓库默认是 mysql 数据库中名为 slave_master_info 的表。在数据目录中使用文件作为连接元数据仓库现在已被弃用，但仍然可能（参见第 17.2.4 节，“中继日志和复制元数据仓库”）。确保连接元数据仓库只能被数据库管理员访问。存储密码在连接元数据仓库的一种替代方法是使用 START REPLICA（或在 MySQL 8.0.22 之前，`START SLAVE`）或 `START GROUP_REPLICATION` 语句来指定连接到源的凭据。

使用受限访问模式来保护包含记录密码的日志表或日志文件的数据库备份。
